I"Î<blockquote>
  <p>æœ¬æ–‡æ˜¯å¯¹æˆ‘çš„ã€ŠSwiftUI å’Œ Combine ç¼–ç¨‹ã€‹ä¹¦ç±çš„è¡¥å……ï¼Œå¯¹ä¸€äº›è™½ç„¶å¾ˆé‡è¦ï¼Œä½†å’Œä¹¦ä¸­ä¸Šä¸‹æ–‡å†…å®¹ç›¸å»ç•¥è¿œï¼Œæˆ–è€…ä¸€äº›ä¸å¤ªé€‚åˆä»¥ä¹¦æœ¬çš„ç¯‡å¹…è¯¦ç»†å±•å¼€è§£é‡Šçš„å†…å®¹è¿›è¡Œäº†è¿½åŠ è¯´æ˜ã€‚å¦‚æœä½ å¯¹ SwiftUI å’Œ Combine çš„æ›´å¤šè¯é¢˜æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥è€ƒè™‘<a href="https://objccn.io/products/swift-ui">å‚é˜…åŸä¹¦</a>ã€‚</p>
</blockquote>

<p><a href="https://onevcat.com/2019/12/backpressure-in-combine/">ä¸Šä¸€ç¯‡æ–‡ç« </a>é‡Œï¼Œæˆ‘ä»¬æ¢ç´¢äº† Combine é‡Œå¯¹ back pressure çš„å¤„ç†ã€‚åœ¨é‚£è¾¹ï¼Œä¸»è¦æ¶‰åŠåˆ°çš„æ˜¯å®ç°è‡ªå®šä¹‰çš„ <code class="highlighter-rouge">Subscriber</code>ï¼Œæ¥é€šè¿‡æ§åˆ¶äº‹ä»¶æµç»ˆç«¯çš„ pull è¡Œä¸ºï¼Œå®ç°åˆç†çš„ back pressure æœºåˆ¶ã€‚</p>

<p>å¯¹äºæ•´ä¸ªäº‹ä»¶æµçš„å¦ä¸€ç«¯ï¼Œ<code class="highlighter-rouge">Publisher</code>ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬ä¹Ÿæœ‰è‡ªå®šä¹‰çš„éœ€æ±‚ã€‚åœ¨ã€ŠSwiftUI å’Œ Combine ç¼–ç¨‹ã€‹ä¸­ï¼Œåœ¨â€œæ‰“åŒ…â€å¤šä¸ªè¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ç”¨äº†ä¸€ç§å¾ˆ naive çš„æ–¹æ³•ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">LoadPokemonRequest</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">var</span> <span class="nv">all</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">PokemonViewModel</span><span class="p">],</span> <span class="kt">AppError</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="p">(</span><span class="mi">1</span><span class="o">...</span><span class="mi">30</span><span class="p">)</span>
            <span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">LoadPokemonRequest</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span><span class="o">.</span><span class="n">publisher</span> <span class="p">}</span>
            <span class="o">.</span><span class="n">zipAll</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å…¶ä¸­ï¼Œ<code class="highlighter-rouge">zipAll</code> æ˜¯ <code class="highlighter-rouge">Array</code> ä¸Šçš„ extensionï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Array</span> <span class="k">where</span> <span class="kt">Element</span><span class="p">:</span> <span class="kt">Publisher</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">zipAll</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Element</span><span class="o">.</span><span class="kt">Output</span><span class="p">],</span> <span class="kt">Element</span><span class="o">.</span><span class="kt">Failure</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">initial</span> <span class="o">=</span> <span class="kt">Just</span><span class="p">([</span><span class="kt">Element</span><span class="o">.</span><span class="kt">Output</span><span class="p">]())</span>
            <span class="o">.</span><span class="nf">setFailureType</span><span class="p">(</span><span class="nv">to</span><span class="p">:</span> <span class="kt">Element</span><span class="o">.</span><span class="kt">Failure</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
        <span class="k">return</span> <span class="nf">reduce</span><span class="p">(</span><span class="n">initial</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span><span class="p">,</span> <span class="n">publisher</span> <span class="k">in</span>
            <span class="n">result</span><span class="o">.</span><span class="nf">zip</span><span class="p">(</span><span class="n">publisher</span><span class="p">)</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">+</span> <span class="p">[</span><span class="nv">$1</span><span class="p">]</span> <span class="p">}</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªåšæ³•åˆ›å»ºäº†å¤šä¸ªâ€œä¸´æ—¶â€ <code class="highlighter-rouge">Publisher</code>ï¼Œå¹¶é€šè¿‡ <code class="highlighter-rouge">reduce</code> æŠŠå®ƒä»¬ç»„åˆåœ¨ä¸€èµ·ã€‚å¯¹äº <code class="highlighter-rouge">zip</code> æ¥è¯´ï¼Œè¿™ä¹ˆåšä¾¥å¹¸å¯ä»¥å·¥ä½œï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªä¸€èˆ¬æ€§çš„è§£å†³æ–¹æ¡ˆã€‚å’Œè‡ªå®šä¹‰ <code class="highlighter-rouge">Subscriber</code> ä¸€æ ·ï¼ŒCombine ä¸­çš„ <code class="highlighter-rouge">Publisher</code> ä¹Ÿæ˜¯ protocolï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§éœ€æ±‚å»åˆ›å»ºé‚£äº› Combine åº“ä¸­è¿˜ä¸å­˜åœ¨ã€ä½†æ˜¯å¾ˆæœ‰ç”¨çš„ <code class="highlighter-rouge">Publisher</code>ã€‚åœ¨æœ¬æ–‡é‡Œï¼Œæˆ‘ä»¬å°±ä»¥åˆ›å»ºä¸€ä¸ªçœŸæ­£çš„ <code class="highlighter-rouge">ZipAll</code> ä½œä¸ºä¾‹å­ï¼Œæ¥è¯´æ˜è‡ªå®šä¹‰ <code class="highlighter-rouge">Publisher</code> çš„ä¸€èˆ¬æ–¹æ³•ã€‚</p>

<p>ä½ å¯ä»¥æ‰“å¼€ä¸€ä¸ª Playgroundï¼Œè·Ÿéšæœ¬æ–‡é”®å…¥ä»£ç ï¼Œä¹Ÿå¯ä»¥<a href="https://gist.github.com/onevcat/138ca5a41ee1a7f2994a6c366936744e">åœ¨è¿™é‡Œ</a>ç›´æ¥æŸ¥çœ‹å¹¶å°è¯•å®Œæ•´çš„ä»£ç ã€‚</p>

<p>åœ¨æˆ‘ä»¬æ­£å¼å¼€å§‹ä¹‹å‰ï¼Œæˆ‘è¿˜æ˜¯æƒ³å¼ºè°ƒä¸‹é¢è¿™å¼ å›¾ï¼Œå®ƒæ€»ç»“äº† Combine æ¡†æ¶çš„å®Œæ•´å·¥ä½œæµç¨‹ã€‚å…¶å®å½’æ ¹æº¯æºï¼Œä¸ç®¡æˆ‘ä»¬åªæ˜¯æƒ³å¾ˆåˆçº§åœ°ä½¿ç”¨ Combine çš„å†…å»ºå†…å®¹ï¼Œè¿˜æ˜¯æƒ³æ›´é«˜çº§ä¸€äº›å»è‡ªå®šä¹‰å“åº”å¼çš„æ“ä½œå’Œäº‹ä»¶æµï¼Œå½’æ ¹ç»“åº•ï¼Œæˆ‘ä»¬éƒ½æ˜¯åœ¨å¦‚å›¾å®šä¹‰çš„å·¥ä½œæµä¸­è¿›è¡Œæ“ä½œã€‚åªæœ‰çœŸæ­£ç†è§£å’Œç†Ÿæ‚‰è¿™å¼  Combine çš„å·¥ä½œæµç¨‹å›¾ï¼Œæ‰èƒ½è¯´æ˜¯çœŸæ­£æŒæ¡äº† Combine çš„æ€ç»´æ–¹å¼ã€‚</p>

<p><img src="/assets/images/2019/publisher-subscriber-flow.svg" alt="" /></p>

<h2 id="ä¸»è¦è§’è‰²å’Œå·¥ä½œ">ä¸»è¦è§’è‰²å’Œå·¥ä½œ</h2>

<p>æŒ‰ç…§ä¸Šå›¾ï¼Œæˆ‘ä»¬é€è¡Œæ¥æ¢³ç†åœ¨è‡ªå®šä¹‰ä¸€ä¸ª <code class="highlighter-rouge">Publisher</code> æ—¶éœ€è¦åšäº›ä»€ä¹ˆã€‚è¿™å¯ä»¥ä¸ºè‡ªå®šä¹‰ <code class="highlighter-rouge">Publisher</code> çš„è®¾è®¡æä¾›ä¸€ä¸ªæ¦‚è§ˆæ€§çš„æŒ‡å¯¼ã€‚å¯¹äºå›¾ä¸­çš„æ¯ä¸ªæ­¥éª¤ï¼Œè¯´æ˜å¦‚ä¸‹ï¼š</p>

<ol>
  <li><code class="highlighter-rouge">Subscriber</code> å¯ä»¥é€šè¿‡è°ƒç”¨ <code class="highlighter-rouge">Publisher.subscribe</code> æ¥å‘Šè¯‰ <code class="highlighter-rouge">Publisher</code> è®¢é˜…å¼€å§‹ã€‚è‡ªç„¶åœ°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code class="highlighter-rouge">Publisher</code> ä¸Šå¢åŠ ä¸€ä¸ªæ–¹æ³•ï¼š<code class="highlighter-rouge">subscribe</code>ã€‚</li>
  <li><code class="highlighter-rouge">Publisher</code> éœ€è¦è°ƒç”¨ <code class="highlighter-rouge">Subscriber</code> ä¸Šçš„ <code class="highlighter-rouge">receive(subscription:)</code> æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ª <code class="highlighter-rouge">Subscription</code>ã€‚é‚£ä¹ˆæ˜¾ç„¶ï¼Œ<code class="highlighter-rouge">Publisher</code> éœ€è¦çŸ¥é“å¦‚ä½•åˆ›å»ºä¸€ä¸ª<strong>åˆé€‚çš„</strong> <code class="highlighter-rouge">Subscription</code>ã€‚</li>
  <li><code class="highlighter-rouge">Subscriber</code> é€šè¿‡è°ƒç”¨ 2 ä¸­åˆ›å»ºçš„ <code class="highlighter-rouge">Subscription</code> ä¸Šçš„ <code class="highlighter-rouge">request</code> æ–¹æ³•ï¼Œæ¥é¦–æ¬¡è¡¨æ˜è‡ªå·±éœ€è¦å¤šå°‘ä¸ªäº‹ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code class="highlighter-rouge">Subscription</code> ä¸Šå¿…é¡»è¦æœ‰ä¸€ä¸ª <code class="highlighter-rouge">request</code> æ–¹æ³•ï¼Œå®ƒæ¥å—å¹¶è®°å½• <code class="highlighter-rouge">Subscribers.Demand</code> (è¿™ä¹Ÿæ˜¯ <code class="highlighter-rouge">Subscription</code> åè®®ä¸­æ‰€å®šä¹‰çš„æ–¹æ³•)ã€‚å¦‚æœä½ å¯¹è¿™ä¸ªè¿‡ç¨‹è¿˜ä¸å¤ªç†Ÿæ‚‰ï¼Œå»ºè®®ä½ å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰å…³äºè‡ªå®šä¹‰ <code class="highlighter-rouge">Subscriber</code> å’Œå®ç° back pressure çš„<a href="https://onevcat.com/2019/12/backpressure-in-combine/">æ–‡ç« </a>ï¼Œé‚£è¾¹å¯¹ <code class="highlighter-rouge">Demand</code> çš„ç”¨æ³•å’ŒåŸç†è¿›è¡Œäº†è¯¦ç»†çš„è¯´æ˜ã€‚</li>
  <li>å½“æ–°çš„äº‹ä»¶å‘ç”Ÿï¼Œå¹¶ä¸”å½“å‰çš„ demand æ»¡è¶³è¦æ±‚ (ä¹Ÿå³ <code class="highlighter-rouge">Subscriber</code> è¿˜éœ€è¦æ›´å¤šäº‹ä»¶) æ—¶ï¼Œè°ƒç”¨ <code class="highlighter-rouge">Subscriber.receive(_:)</code> æ¥å‘ä¸‹æ¸¸å‘é€ä¸€ä¸ªäº‹ä»¶ã€‚è¿™ä»¶äº‹æƒ…å¯ä»¥ç”± <code class="highlighter-rouge">Publisher</code> å®Œæˆï¼Œä½†æ˜¯æ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå€¾å‘äºä¿æŒ <code class="highlighter-rouge">Publisher</code> çš„å€¼è¯­ä¹‰ï¼Œç„¶åé€‰æ‹©åœ¨ <code class="highlighter-rouge">Subscription</code> ä¸­å®ç°è¿™äº›é€»è¾‘ã€‚å› ä¸º <code class="highlighter-rouge">Subscription</code> åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šä¿æŒæŸä¸ª bufferï¼Œå¹¶éšç€æ—¶é—´è¿›è¡Œå“åº”å¹¶æ”¹å˜å€¼ (æ¯•ç«Ÿè¿™æ­£æ˜¯ Combine æˆ–è€…è¯´å“åº”å¼ç¼–ç¨‹æ‰€è¦è§£å†³çš„é—®é¢˜é¢†åŸŸ)ï¼Œæ‰€ä»¥ä¸€èˆ¬æˆ‘ä»¬ä¼šé€‰æ‹©å°† <code class="highlighter-rouge">Subscription</code> å£°æ˜ä¸º <code class="highlighter-rouge">class</code> å¹¶ä½¿ç”¨å¼•ç”¨è¯­ä¹‰ã€‚å¦å¤–ï¼Œ<code class="highlighter-rouge">Subscriber.receive(_:)</code> è¿”å›çš„ <code class="highlighter-rouge">Demand</code> å€¼åº”è¯¥è¢«è¿½åŠ åˆ°å‰©ä½™éœ€è¦çš„äº‹ä»¶ä¸ªæ•°ä¸­ã€‚</li>
  <li>åŒ 4ã€‚</li>
  <li>å¦‚æœäº‹ä»¶ç»“æŸ (æ¯”å¦‚å¼‚æ­¥æ“ä½œå®Œå…¨å®Œæˆï¼Œæˆ–è€…å‡ºç°äº†é”™è¯¯)ï¼Œéœ€è¦è°ƒç”¨ <code class="highlighter-rouge">Subscriber.receive(completion:)</code>ã€‚è¿™ä¸€æ­¥ä¹Ÿç»å¸¸æ˜¯ç”± <code class="highlighter-rouge">Subscription</code> æ¥å®ç°çš„ã€‚</li>
</ol>

<p>ä¸Šé¢çš„ 4ï¼Œ5ï¼Œ6 ä¸­æ¶‰åŠçš„éƒ½æ˜¯åœ¨ <code class="highlighter-rouge">Subscription</code> ä¸­è°ƒç”¨ <code class="highlighter-rouge">Subscriber</code> çš„æ–¹æ³•ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬çš„å®ç°ä¸­ï¼Œåœ¨ <code class="highlighter-rouge">Subscription</code> é‡ŒæŒæœ‰ <code class="highlighter-rouge">Subscriber</code> æ˜¯ä¸€ä¸ªè‡ªç„¶è€Œç„¶çš„é€‰æ‹©ã€‚å¯¹äºè‡ªå®šä¹‰çš„å…·ä½“çš„ <code class="highlighter-rouge">Publisher</code> ç±»å‹æ¥è¯´ï¼Œå®ƒåªè´Ÿè´£æä¾›ä¸€ä¸ªç®€å•çš„æ¥å£å°è£…ï¼Œæ¥æ»¡è¶³ <code class="highlighter-rouge">Publisher</code> åè®®çš„è§„å®šï¼Œå¹¶ä¿æŒè¿™ä¸ªè§’è‰²çš„å€¼è¯­ä¹‰ (åœ¨ Combine çš„å®ç°ä¸­ï¼Œç»å¤§éƒ¨åˆ†çš„ <code class="highlighter-rouge">Publisher</code> éƒ½æ‹¥æœ‰å€¼è¯­ä¹‰ï¼Œè¿™è®©è®¢é˜…çš„å£°æ˜å‘¨æœŸå’Œè¡Œä¸ºç›¸å¯¹ç®€å•)ã€‚äº‹ä»¶å‘é€ï¼Œå€¼çš„ä¿æŒç­‰æ¶‰åŠåˆ°å…·ä½“ã€æ—¶åºä¸Šçš„æ“ä½œï¼Œåˆ™ç”±ä¸€ä¸ªç›¸å¯¹å¤æ‚çš„ <code class="highlighter-rouge">Subscription</code> å®ç°ã€‚</p>

<h3 id="publisher">Publisher</h3>

<p>å¯¹äºæˆ‘ä»¬è¦å®ç°çš„æ¥å—æ•°ç»„ç‰ˆæœ¬çš„ <code class="highlighter-rouge">zip</code> æ¥è¯´ï¼Œæœ€ç›´æ¥çš„å°±æ˜¯å®ç°ä¸€ä¸ª <code class="highlighter-rouge">ZipAll</code>ï¼Œè®©å®ƒå®ç° <code class="highlighter-rouge">Publisher</code> åè®®ã€‚éµå¾ª Combine çš„ä¸€èˆ¬æ–¹å¼ï¼Œæˆ‘ä»¬æŠŠ <code class="highlighter-rouge">ZipAll</code> å®šä¹‰åœ¨ <code class="highlighter-rouge">Publishers</code> ä¸­ï¼Œå¹¶æ·»åŠ ä¸Š <code class="highlighter-rouge">Publisher</code> åè®®æ‰€éœ€è¦çš„æ–¹æ³•ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Publishers</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">ZipAll</span><span class="o">&lt;</span><span class="kt">Collection</span><span class="p">:</span> <span class="kt">Swift</span><span class="o">.</span><span class="kt">Collection</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">Publisher</span> 
    <span class="k">where</span> <span class="kt">Collection</span><span class="o">.</span><span class="kt">Element</span><span class="p">:</span> <span class="kt">Publisher</span> 
    <span class="p">{</span>
        <span class="c1">// 1</span>
        <span class="kd">typealias</span> <span class="kt">Output</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Collection</span><span class="o">.</span><span class="kt">Element</span><span class="o">.</span><span class="kt">Output</span><span class="p">]</span>
        <span class="kd">typealias</span> <span class="kt">Failure</span> <span class="o">=</span> <span class="kt">Collection</span><span class="o">.</span><span class="kt">Element</span><span class="o">.</span><span class="kt">Failure</span>
      
        <span class="kd">private</span> <span class="k">let</span> <span class="nv">publishers</span><span class="p">:</span> <span class="kt">Collection</span>

        <span class="nf">init</span><span class="p">(</span><span class="n">_</span> <span class="nv">publishers</span><span class="p">:</span> <span class="kt">Collection</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">publishers</span> <span class="o">=</span> <span class="n">publishers</span>
        <span class="p">}</span>

        <span class="c1">// 2</span>
        <span class="kd">func</span> <span class="n">receive</span><span class="o">&lt;</span><span class="kt">S</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">subscriber</span><span class="p">:</span> <span class="kt">S</span><span class="p">)</span>
            <span class="k">where</span> <span class="kt">S</span> <span class="p">:</span> <span class="kt">Subscriber</span><span class="p">,</span> <span class="kt">Failure</span> <span class="o">==</span> <span class="kt">S</span><span class="o">.</span><span class="kt">Failure</span><span class="p">,</span> <span class="kt">Output</span> <span class="o">==</span> <span class="kt">S</span><span class="o">.</span><span class="kt">Input</span>
        <span class="p">{</span>
            <span class="c1">// 3</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>ä½œä¸ºæ–°çš„ <code class="highlighter-rouge">Publisher</code>ï¼Œ<code class="highlighter-rouge">ZipAll</code> ä¹Ÿéœ€è¦è‡ªå·±çš„ <code class="highlighter-rouge">Output</code>ã€‚é€šè¿‡é™å®š <code class="highlighter-rouge">ZipAll</code> æ‰€æ¥æ”¶çš„å­ <code class="highlighter-rouge">Publisher</code> å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œæ–°çš„ <code class="highlighter-rouge">Publisher</code> çš„ <code class="highlighter-rouge">Output</code> ä¹Ÿä¾¿å¯ä»¥è¢«ç¡®å®šã€‚</li>
  <li>è¿™æ˜¯ <code class="highlighter-rouge">Publisher</code> åè®®æ‰€è§„å®šéœ€è¦å®ç°çš„æ–¹æ³•ï¼Œä¸è®ºä½ è‡ªå®šä¹‰çš„ <code class="highlighter-rouge">Publisher</code> å…·ä½“æ˜¯ä»€ä¹ˆï¼Œè¿™ä¸€éƒ¨åˆ†æ˜¯ä¸ä¼šæ”¹å˜çš„ã€‚</li>
  <li>åœ¨ <code class="highlighter-rouge">receive(subscriber:)</code> é‡Œï¼ŒæŒ‰ç…§ Combine å·¥ä½œæµç¨‹ï¼Œæˆ‘ä»¬åˆ›å»º <code class="highlighter-rouge">Subscription</code> å¹¶è°ƒç”¨ <code class="highlighter-rouge">Subscriber.receive(subscription:)</code> æ¥æŠŠè¿™ä¸ªæ–°åˆ›å»ºçš„ <code class="highlighter-rouge">Subscription</code> å‘é€ç»™ <code class="highlighter-rouge">Subscriber</code>ã€‚(æµç¨‹å›¾ä¸­çš„ 1 å’Œ 2)ï¼Œç„¶åç­‰å¾… <code class="highlighter-rouge">Subscriber</code> é¦–æ¬¡è¯·æ±‚æ•°æ®ã€‚ç°åœ¨æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ›å»ºåˆé€‚çš„ <code class="highlighter-rouge">Subscription</code> ç±»å‹ï¼Œæ‰€ä»¥å…ˆæŠŠå®ƒç•™ç©ºã€‚åœ¨åé¢æˆ‘ä»¬ä¼šå›åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œå¹¶å¡«ä¸Šéœ€è¦çš„å†…å®¹ã€‚</li>
</ol>

<p>åœ¨ <code class="highlighter-rouge">init</code> é‡Œï¼Œæˆ‘ä»¬æ¥æ”¶äº†ä¸€ä¸ªç±»å‹æ»¡è¶³ <code class="highlighter-rouge">Swift.Collection</code>ï¼Œä¸”å…¶ä¸­å…ƒç´ å‡ä¸ºåŒç±»å‹ <code class="highlighter-rouge">Publisher</code> çš„é›†åˆç±»å‹ä½œä¸ºå‚æ•°ã€‚åœ¨å®é™…ä½¿ç”¨è¿™ä¸ª <code class="highlighter-rouge">ZipAll</code> æ—¶ï¼Œæˆ‘ä»¬å¤§æ¦‚ä¼šæƒ³è¦åšçš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>

<ol>
  <li>è®¢é˜…æ¯ä¸ªè¾“å…¥çš„ publisherï¼Œå¹¶è§‚å¯Ÿå®ƒä»¬çš„äº‹ä»¶ã€‚å»ºç«‹ç¬¦åˆè¾“å…¥çš„ publisher ä¸ªæ•°çš„ç¼“å†²åŒºã€‚</li>
  <li>æŸä¸ª publisher å‘å‡ºæ–°çš„å€¼åï¼Œå…ˆå°†å®ƒä¿å­˜åˆ°å¯¹åº”çš„ç¼“å†²åŒºé‡Œã€‚ç„¶åæ£€æŸ¥æ‰€æœ‰è¿™äº›ç¼“å†²åŒºä¸­æ˜¯ä¸æ˜¯éƒ½æœ‰å¾…å¤„ç†çš„å…ƒç´ ã€‚å¦‚æœéƒ½æœ‰ï¼Œåˆ™å°†å®ƒä»¬çš„é¦–ä¸ªå…ƒç´ ç§»å‡ºæ¥ï¼Œå½¢æˆä¸€ä¸ªæ•°ç»„å¹¶ä½œä¸ºæ–°çš„ <code class="highlighter-rouge">ZipAll</code> å€¼å‘é€å‡ºå»ã€‚</li>
  <li>æŸä¸ªè¾“å…¥ publisher å‘å‡ºæˆåŠŸå®Œæˆçš„äº‹ä»¶åï¼Œå°†å®ƒè®°å½•ä¸‹æ¥ï¼Œå¹¶æ£€æŸ¥æ˜¯ä¸æ˜¯æ‰€æœ‰çš„è¾“å…¥ publisher éƒ½å®Œæˆäº†ã€‚å¦‚æœæ˜¯ï¼Œåˆ™å°† <code class="highlighter-rouge">.finish</code> äº‹ä»¶å‘é€å‡ºå»ã€‚</li>
  <li>å¦‚æœæŸä¸ªè¾“å…¥ publisher å‘å‡ºäº†é”™è¯¯ï¼Œé‚£ä¹ˆå°†é”™è¯¯ç›´æ¥ä½œä¸ºæ–° <code class="highlighter-rouge">Publisher</code> çš„ç»“æœå‘å‡ºã€‚</li>
</ol>

<p>æš‚æ—¶æˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“è¦æ€ä¹ˆå¾€ <code class="highlighter-rouge">receive(subscriber:)</code> ä¸­å¡«å†™å†…å®¹ï¼Œè¿™è¦æ±‚æˆ‘ä»¬éœ€è¦çŸ¥é“å¦‚ä½•åˆ›å»º <code class="highlighter-rouge">Subscription</code>ã€‚å¥½æ¶ˆæ¯æ˜¯ï¼Œ<code class="highlighter-rouge">Subscription</code> æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªè¢«ä¸¥æ ¼å®šä¹‰çš„åè®®ï¼Œè¿™ä¸ºæˆ‘ä»¬å®ç°è‡ªå®šä¹‰è®¢é˜…ç±»å‹æä¾›äº†ä¸€äº›åŸºæœ¬çš„ä¾æ®ã€‚</p>

<h3 id="subscription">Subscription</h3>

<p>ç´§æ¥ç€ <code class="highlighter-rouge">ZipAll</code> çš„å®šä¹‰ï¼Œåœ¨ <code class="highlighter-rouge">Publishers</code> ä¸­åˆ›å»ºä¸€ä¸ªç§æœ‰çš„ <code class="highlighter-rouge">ZipAppSubscription</code> ç±»ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Publishers</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">ZipAll</span> <span class="o">...</span> <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">class</span> <span class="kt">ZipAppSubscription</span><span class="o">&lt;</span><span class="kt">Output</span><span class="p">,</span> <span class="kt">Failure</span><span class="p">:</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">Subscription</span>
    <span class="p">{</span>
        <span class="c1">// 1</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Combine ä¸­ï¼Œ<code class="highlighter-rouge">Subscription</code> åè®®å®šä¹‰äº†ä¸¤ä¸ªå¿…é¡»å®ç°çš„æ–¹æ³•ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">demand</span><span class="p">:</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span><span class="p">)</span>
<span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span>
</code></pre></div></div>

<p>å‰è€…ç”¨æ¥æ¥æ”¶ <code class="highlighter-rouge">Subscriber</code> çš„è¯·æ±‚ï¼Œåè€…ç”¨æ¥å–æ¶ˆå½“å‰è®¢é˜…ã€‚</p>

<p>åœ¨ <code class="highlighter-rouge">ZipAppSubscription</code> çš„ <code class="highlighter-rouge">// 1</code> é‡Œæ·»åŠ ä¸‹é¢è¿™äº›å†…å®¹ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1</span>
<span class="kd">private</span> <span class="k">var</span> <span class="nv">leftDemand</span><span class="p">:</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span> <span class="o">=</span> <span class="o">.</span><span class="k">none</span>
<span class="kd">private</span> <span class="k">var</span> <span class="nv">subscriber</span><span class="p">:</span> <span class="kt">AnySubscriber</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">Output</span><span class="p">],</span> <span class="kt">Failure</span><span class="o">&gt;</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kd">private</span> <span class="k">var</span> <span class="nv">buffer</span><span class="p">:</span> <span class="p">[[</span><span class="kt">Output</span><span class="p">]]</span>
<span class="kd">private</span> <span class="k">let</span> <span class="nv">publishers</span><span class="p">:</span> <span class="p">[</span><span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Output</span><span class="p">,</span> <span class="kt">Failure</span><span class="o">&gt;</span><span class="p">]</span>
<span class="kd">private</span> <span class="k">var</span> <span class="nv">childSubscriptions</span><span class="p">:</span> <span class="p">[</span><span class="kt">AnyCancellable</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="kd">private</span> <span class="k">var</span> <span class="nv">finishedCount</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">// 2</span>
<span class="kd">private</span> <span class="k">var</span> <span class="nv">lock</span> <span class="o">=</span> <span class="kt">NSRecursiveLock</span><span class="p">()</span>

<span class="kd">init</span><span class="o">&lt;</span><span class="kt">S</span><span class="p">:</span> <span class="kt">Subscriber</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nv">subscriber</span><span class="p">:</span> <span class="kt">S</span><span class="p">,</span>
    <span class="nv">publishers</span><span class="p">:</span> <span class="p">[</span><span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Output</span><span class="p">,</span> <span class="kt">Failure</span><span class="o">&gt;</span><span class="p">]</span>
<span class="p">)</span> <span class="k">where</span> <span class="kt">Failure</span> <span class="o">==</span> <span class="kt">S</span><span class="o">.</span><span class="kt">Failure</span><span class="p">,</span> <span class="p">[</span><span class="kt">Output</span><span class="p">]</span> <span class="o">==</span> <span class="kt">S</span><span class="o">.</span><span class="kt">Input</span>
<span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="kt">AnySubscriber</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>
    <span class="k">self</span><span class="o">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">count</span><span class="p">:</span> <span class="n">publishers</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
    <span class="k">self</span><span class="o">.</span><span class="n">publishers</span> <span class="o">=</span> <span class="n">publishers</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">demand</span><span class="p">:</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="nf">lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="p">{</span> <span class="n">lock</span><span class="o">.</span><span class="nf">unlock</span><span class="p">()</span> <span class="p">}</span>

    <span class="k">self</span><span class="o">.</span><span class="n">leftDemand</span> <span class="o">+=</span> <span class="n">demand</span>

    <span class="c1">// 3</span>
    <span class="nf">send</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="nf">lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="p">{</span> <span class="n">lock</span><span class="o">.</span><span class="nf">unlock</span><span class="p">()</span> <span class="p">}</span>

    <span class="n">childSubscriptions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subscriber</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>æ—¢ç„¶ç”Ÿæ´»åœ¨ Combine çš„ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬å°±å¾—éµå®ˆ Combine çš„æ¸¸æˆè§„åˆ™ã€‚<code class="highlighter-rouge">leftDemand</code> å°†è®°å½•ä¸‹æ¸¸è®¢é˜…è€…è¿˜éœ€è¦çš„å€¼çš„æ•°é‡ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥éµå®ˆåŸºäº pull çš„è¡Œä¸ºè§„åˆ™ã€‚</li>
  <li>æˆ‘ä»¬ä¸èƒ½ç¡®å®š zip æ“ä½œä¸­æ¶‰åŠçš„å„ä¸ª publisher æœ€ç»ˆä¼šåœ¨å“ªä¸ªçº¿ç¨‹å‘æˆ‘ä»¬å‘é€æ•°æ®ï¼Œè¿™äº›æ•°æ®åœ¨æ¥æ”¶åä¼šè¢«æ”¾åˆ° <code class="highlighter-rouge">buffer</code> ä¸­å¾…ç”¨ï¼Œå› æ­¤è¿™é‡Œå‡ºç°äº†å¤šä¸ªçº¿ç¨‹å…±äº«èµ„æºçš„æƒ…å†µã€‚è®©æ•´ä¸ªæ“ä½œçº¿ç¨‹å®‰å…¨çš„æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä¸Šé”ã€‚</li>
  <li>å½“æ”¶åˆ° <code class="highlighter-rouge">request(_:)</code> è°ƒç”¨æ—¶ï¼Œé™¤äº†å°†ä¸‹æ¸¸å‘ŠçŸ¥çš„éœ€æ±‚ <code class="highlighter-rouge">demand</code> ç´¯åŠ åˆ° <code class="highlighter-rouge">leftDemand</code> ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ£€æŸ¥ <code class="highlighter-rouge">buffer</code> å¹¶å°è¯•è§¦å‘äº‹ä»¶ <code class="highlighter-rouge">send</code> å°±æ˜¯åšè¿™ä»¶äº‹æƒ…çš„ã€‚</li>
</ol>

<p>å¦å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå¼€å§‹è®¢é˜…çš„æ–¹æ³• (<code class="highlighter-rouge">startSubscribing</code>)ï¼Œå®ƒä¼šè´Ÿè´£å¼€å§‹è®¢é˜… <code class="highlighter-rouge">publishers</code> å‘å‡ºçš„å€¼å’Œäº‹ä»¶ã€‚</p>

<p>è¿™ä¸ª <code class="highlighter-rouge">startSubscribing</code> å’Œ 3 ä¸­çš„ <code class="highlighter-rouge">send</code> æ˜¯ <code class="highlighter-rouge">Subscription</code> çš„å…³é”®å†…å®¹ã€‚å‰è€…è´Ÿè´£æŠŠå¯¹åº”çš„äº‹ä»¶è¿›è¡Œè½¬å‘å¤„ç†ï¼šå¯¹äºæ¥æ”¶åˆ°çš„å€¼ï¼Œå°†å®ƒç¼“å­˜åœ¨ <code class="highlighter-rouge">buffer</code> ä¸­ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦åº”å½“è§¦å‘ zip åˆå¹¶åçš„äº‹ä»¶ï¼›å¯¹äºæ¥æ”¶åˆ°çš„ç»“æŸäº‹ä»¶ï¼Œå¦‚æœæ˜¯é”™è¯¯äº‹ä»¶ï¼Œåˆ™ç»“æŸè‡ªèº«äº‹ä»¶æµï¼Œå¦‚æœæ˜¯å­ publisher çš„ç»“æŸäº‹ä»¶ï¼Œåˆ™å°†å®ƒè®°å½•ä¸‹æ¥ï¼Œç›´åˆ°æ‰€æœ‰çš„ publisher éƒ½ç»“æŸåï¼Œå†å‘å¤–å‘é€è‡ªèº«çš„ç»“æŸäº‹ä»¶ã€‚</p>

<p>è¿™äº›é€»è¾‘çœ‹èµ·æ¥æœ‰äº›éº»çƒ¦ï¼Œä½†æ˜¯å¦‚æœç»™ç¿»è¯‘ç¿»è¯‘çš„è¯ï¼Œä»£ç çœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">startSubscribing</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">publisher</span><span class="p">)</span> <span class="k">in</span> <span class="n">publishers</span><span class="o">.</span><span class="nf">enumerated</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">publisher</span><span class="o">.</span><span class="nf">sink</span><span class="p">(</span>
            <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span>  <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">completion</span> <span class="k">in</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">receiveCompletion</span><span class="p">(</span><span class="n">completion</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">value</span> <span class="k">in</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">receiveValue</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">)</span><span class="o">.</span><span class="nf">store</span><span class="p">(</span><span class="nv">in</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">childSubscriptions</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">func</span> <span class="nf">receiveValue</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Output</span><span class="p">,</span> <span class="n">at</span> <span class="nv">index</span><span class="p">:</span> <span class="kt">Int</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="nf">lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="p">{</span> <span class="n">lock</span><span class="o">.</span><span class="nf">unlock</span><span class="p">()</span> <span class="p">}</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nf">send</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="kd">func</span> <span class="nf">receiveCompletion</span><span class="p">(</span>
    <span class="n">_</span> <span class="nv">event</span><span class="p">:</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">at</span> <span class="nv">index</span><span class="p">:</span> <span class="kt">Int</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="n">lock</span><span class="o">.</span><span class="nf">lock</span><span class="p">()</span>
    <span class="k">defer</span> <span class="p">{</span> <span class="n">lock</span><span class="o">.</span><span class="nf">unlock</span><span class="p">()</span> <span class="p">}</span>

    <span class="k">guard</span> <span class="k">let</span> <span class="nv">subscriber</span> <span class="o">=</span> <span class="n">subscriber</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

    <span class="k">switch</span> <span class="n">event</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">finished</span><span class="p">:</span>
        <span class="n">finishedCount</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">finishedCount</span> <span class="o">==</span> <span class="n">buffer</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
            <span class="n">subscriber</span><span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="o">.</span><span class="n">finished</span><span class="p">)</span>
            <span class="k">self</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="p">}</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">failure</span><span class="p">:</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="n">event</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç„¶åæ˜¯ <code class="highlighter-rouge">Subscription</code> é‡Œçš„å¦ä¸€ä¸ªé‡è¦æ–¹æ³• <code class="highlighter-rouge">send</code>ï¼Œå®ƒè´Ÿè´£æ£€æŸ¥ <code class="highlighter-rouge">buffer</code>ï¼Œå¹¶åœ¨æ»¡è¶³ zip é€»è¾‘çš„æ—¶å€™å‘å¤–å‘å¸ƒä¸€ä¸ªæ–°å€¼ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">func</span> <span class="nf">send</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">subscriber</span> <span class="o">=</span> <span class="n">subscriber</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="k">while</span> <span class="n">leftDemand</span> <span class="o">&gt;</span> <span class="o">.</span><span class="k">none</span><span class="p">,</span> <span class="k">let</span> <span class="nv">outputs</span> <span class="o">=</span> <span class="n">firstRowOutputItems</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">leftDemand</span> <span class="o">-=</span> <span class="o">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">nextDemand</span> <span class="o">=</span> <span class="n">subscriber</span><span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">leftDemand</span> <span class="o">+=</span> <span class="n">nextDemand</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">private</span> <span class="k">var</span> <span class="nv">firstRowOutputItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">Output</span><span class="p">]?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="n">buffer</span><span class="o">.</span><span class="nf">allSatisfy</span><span class="p">({</span> <span class="o">!</span><span class="nv">$0</span><span class="o">.</span><span class="n">isEmpty</span> <span class="p">})</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Output</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">0</span> <span class="o">..&lt;</span> <span class="n">buffer</span><span class="o">.</span><span class="n">count</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">column</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">outputs</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">column</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">outputs</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±æœ‰ä¸€ä¸ªå®Œæ•´çš„ <code class="highlighter-rouge">Subscription</code> è§’è‰²äº†ã€‚æœ€åï¼Œè®©æˆ‘ä»¬å›åˆ° <code class="highlighter-rouge">Publishers.ZipAll</code> ä¸­ï¼ŒæŠŠåˆšæ‰å‰©ä¸‹çš„ <code class="highlighter-rouge">receive(subscriber:)</code> æ–¹æ³•è¡¥å®Œã€‚åˆ›å»ºä¸€ä¸ª <code class="highlighter-rouge">ZipAppSubscription</code> å®ä¾‹ï¼Œè°ƒç”¨ <code class="highlighter-rouge">Subscriber</code> åè®®æ‰€å®šä¹‰çš„ <code class="highlighter-rouge">receive(subscription:)</code> æ–¹æ³•ï¼Œå¹¶å¼€å§‹è®¢é˜…æ‰€æœ‰çš„ publisherï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">ZipAll</span> <span class="o">...</span> <span class="p">{</span>

    <span class="c1">// ...</span>

    <span class="kd">func</span> <span class="n">receive</span><span class="o">&lt;</span><span class="kt">S</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">subscriber</span><span class="p">:</span> <span class="kt">S</span><span class="p">)</span>
        <span class="k">where</span> <span class="kt">S</span> <span class="p">:</span> <span class="kt">Subscriber</span><span class="p">,</span> <span class="kt">Failure</span> <span class="o">==</span> <span class="kt">S</span><span class="o">.</span><span class="kt">Failure</span><span class="p">,</span> <span class="kt">Output</span> <span class="o">==</span> <span class="kt">S</span><span class="o">.</span><span class="kt">Input</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="nv">subscription</span> <span class="o">=</span> <span class="kt">ZipAppSubscription</span><span class="o">&lt;</span><span class="kt">Collection</span><span class="o">.</span><span class="kt">Element</span><span class="o">.</span><span class="kt">Output</span><span class="p">,</span> <span class="kt">Failure</span><span class="o">&gt;</span><span class="p">(</span>
            <span class="nv">subscriber</span><span class="p">:</span> <span class="n">subscriber</span><span class="p">,</span> <span class="nv">publishers</span><span class="p">:</span> <span class="n">publishers</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span> <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="nf">receive</span><span class="p">(</span><span class="nv">subscription</span><span class="p">:</span> <span class="n">subscription</span><span class="p">)</span>
        <span class="n">subscription</span><span class="o">.</span><span class="nf">startSubscribing</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">Publishers.ZipAll</code> æ¥åˆ›å»ºä¸€ä¸ªçœŸæ­£çš„ <code class="highlighter-rouge">ZipAll</code> çš„ <code class="highlighter-rouge">Publisher</code> äº†ã€‚æ¯”å¦‚ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">p1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">publisher</span>
<span class="k">let</span> <span class="nv">p2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">publisher</span>
<span class="k">let</span> <span class="nv">p3</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">publisher</span>

<span class="k">let</span> <span class="nv">zipped</span> <span class="o">=</span> <span class="kt">Publishers</span><span class="o">.</span><span class="kt">ZipAll</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">])</span>
<span class="k">let</span> <span class="nv">subscription</span> <span class="o">=</span> <span class="n">zipped</span><span class="o">.</span><span class="nf">sink</span><span class="p">(</span>
    <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span><span class="n">completion</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"receiveCompletion </span><span class="se">\(</span><span class="n">completion</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">values</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"receiveValues: </span><span class="se">\(</span><span class="n">values</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1">// è¾“å‡ºï¼š</span>
<span class="c1">// receiveValues: [1, 4, 7]</span>
<span class="c1">// receiveValues: [2, 5, 8]</span>
<span class="c1">// receiveValues: [3, 6, 9]</span>
<span class="c1">// receiveCompletion finished</span>
</code></pre></div></div>

<p>å½“ç„¶ï¼Œæœ€åï¼Œæˆ‘ä»¬å¯ä»¥å­¦ä¹  <code class="highlighter-rouge">Publishers</code> ä¸­çš„å…¶ä»–ç±»å‹é‚£æ ·ï¼Œä¸º <code class="highlighter-rouge">ZipAll</code> æä¾›ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œè®©åˆ›å»º <code class="highlighter-rouge">Publishers.ZipAll</code> å˜å¾—ç®€å•ä¸€äº›ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Collection</span> <span class="k">where</span> <span class="kt">Element</span><span class="p">:</span> <span class="kt">Publisher</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">zipAll</span><span class="p">:</span> <span class="kt">Publishers</span><span class="o">.</span><span class="kt">ZipAll</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="kt">Publishers</span><span class="o">.</span><span class="kt">ZipAll</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">zipped</span> <span class="o">=</span> <span class="p">[</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">]</span><span class="o">.</span><span class="n">zipAll</span>
</code></pre></div></div>

<h2 id="ä¸è¶³ä¹‹å¤„å’Œæ”¹è¿›ç©ºé—´">ä¸è¶³ä¹‹å¤„å’Œæ”¹è¿›ç©ºé—´</h2>

<p>è™½ç„¶ <code class="highlighter-rouge">ZipAll</code> åº”è¯¥å·²ç»å¯ä»¥æ­£å¸¸å·¥ä½œäº†ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›å€¼å¾—ä¼˜åŒ–çš„åœ°æ–¹ã€‚</p>

<h3 id="æ€§èƒ½æ”¹è¿›">æ€§èƒ½æ”¹è¿›</h3>

<p>é¦–å…ˆæ˜¯ <code class="highlighter-rouge">firstRowOutputItems</code> ä¸­çš„æ•°ç»„æ“ä½œçš„æ•ˆç‡ã€‚<code class="highlighter-rouge">buffer</code> çš„ç±»å‹æ˜¯ <code class="highlighter-rouge">[[Output]]</code>ï¼Œå®ƒå…¶ä¸­çš„å…ƒç´ ä¹Ÿåªæ˜¯æ™®é€šçš„ <code class="highlighter-rouge">Array</code>ã€‚å› æ­¤ <code class="highlighter-rouge">firstRowOutputItems</code> é‡Œçš„ç§»é™¤é¦–ä¸ªå…ƒç´  <code class="highlighter-rouge">column.remove(at: 0)</code> çš„æ“ä½œï¼Œå…¶å®æ—¶é—´å¤æ‚åº¦æ˜¯ <code class="highlighter-rouge">O(n)</code>ï¼Œè€Œå®ƒåˆå¤„äºä¸€ä¸ª <code class="highlighter-rouge">buffer.count</code> çš„å¾ªç¯ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå¸¦æ¥ä¸€ä¸ª n^2 çš„å¤æ‚åº¦ï¼Œæ˜¯éš¾ä»¥æ¥æ”¶çš„ã€‚æˆ‘ä»¬å¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—çš„æ•°æ®ç»“æ„ï¼ŒæŠŠ <code class="highlighter-rouge">remove(at: 0)</code> çš„æ“ä½œç®€åŒ–ä¸º <code class="highlighter-rouge">O(1)</code> æ¥é¿å…è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>å…¶æ¬¡ï¼Œè¿˜æ˜¯åœ¨ <code class="highlighter-rouge">firstRowOutputItems</code> é‡Œï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½å¯¹â€œæ˜¯å¦ <code class="highlighter-rouge">buffer</code> ä¸­æ‰€æœ‰çš„åˆ—éƒ½è‡³å°‘æœ‰ä¸€ä¸ªå…ƒç´ â€è¿›è¡Œäº†åˆ¤æ–­ï¼š<code class="highlighter-rouge">buffer.allSatisfy({ !$0.isEmpty })</code>ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ª <code class="highlighter-rouge">O(n)</code>ã€‚ä¸€ç§æ›´ç®€å•çš„æ–¹å¼ï¼Œæ˜¯ç»´æŠ¤ä¸€ä¸ªå˜é‡æ¥è®°å½•å½“å‰å·²ç»æ”¶åˆ°çš„å¯åˆå¹¶å€¼çš„ä¸ªæ•°ï¼šåœ¨æ¯æ¬¡æ”¶åˆ°å€¼æ—¶ï¼Œåˆ¤æ–­ <code class="highlighter-rouge">buffer</code> å¯¹åº”çš„ä½ç½®ä¸Šæ˜¯å¦å·²ç»æœ‰å€¼ï¼Œæ¥ç¡®å®šéœ€ä¸éœ€è¦æ›´æ”¹è¿™ä¸ªå˜é‡ã€‚å¦‚æœå‘ç°å·²ç»æ”¶åˆ°çš„å¯åˆå¹¶å€¼çš„ä¸ªæ•°ä¸ publishers çš„æ•°é‡ç›¸ç­‰çš„è¯ï¼Œå°±è¯´æ˜æ‰€æœ‰æ•°æ®éƒ½å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å°†å®ƒä»¬ <code class="highlighter-rouge">zip</code> å¹¶å‘é€ã€‚é€šè¿‡è¿™æ ·ä¸€ä¸ªå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™é‡Œçš„ <code class="highlighter-rouge">O(n)</code> ä¹Ÿç®€åŒ–ä¸º <code class="highlighter-rouge">O(1)</code>ã€‚ç”šè‡³æ›´è¿›ä¸€æ­¥ï¼Œå¯ä»¥è‡ªç„¶è€Œç„¶åœ°åšåˆ°å»æ‰ä¸Šé¢æåˆ°çš„ <code class="highlighter-rouge">buffer.count</code> å¾ªç¯ï¼ŒæŠŠæ•´ä¸ªå‘é€æµç¨‹ä¼˜åŒ–åˆ° <code class="highlighter-rouge">O(1)</code>ã€‚</p>

<h3 id="æœ‰é™-demand">æœ‰é™ Demand</h3>

<p>é™¤äº†é€Ÿåº¦ä¼˜åŒ–å¤–ï¼Œ<code class="highlighter-rouge">ZipAll</code> ç°åœ¨çš„è¡Œä¸ºé€»è¾‘ä¹Ÿæœ‰å€¼å¾—å•†æ¦·çš„åœ°æ–¹ã€‚åœ¨ <code class="highlighter-rouge">startSubscribing</code> é‡Œï¼Œæˆ‘ä»¬ç®€å•åœ°ä½¿ç”¨äº† <code class="highlighter-rouge">sink</code> æ¥å¯¹è¾“å…¥çš„ <code class="highlighter-rouge">publishers</code> è¿›è¡Œè®¢é˜…ã€‚<code class="highlighter-rouge">Sink</code> subscriber åœ¨é€šè¿‡ <code class="highlighter-rouge">receive(subscription:)</code> æ¥æ”¶åˆ°è®¢é˜…åï¼Œä¼šç«‹å³ <code class="highlighter-rouge">request(_:)</code> <code class="highlighter-rouge">.unlimited</code> çš„ <code class="highlighter-rouge">Subscribers.Demand</code>ã€‚è¿™å…¶å®æ²¡æœ‰å°Šé‡ Combine äº‹ä»¶çš„æ‹‰å–æ¨¡å‹åŸåˆ™ï¼šåœ¨æˆ‘ä»¬çš„ <code class="highlighter-rouge">ZipAll</code> å®ç°ä¸­ï¼Œä¸‹æ¸¸è®¢é˜…è€…å¯ä»¥é€šè¿‡æ§åˆ¶ <code class="highlighter-rouge">Demand</code> æ¥æ§åˆ¶æ”¶åˆ°çš„å€¼çš„æ•°é‡ï¼Œä½†æ˜¯å†…éƒ¨çš„ <code class="highlighter-rouge">publishers</code> çš„è®¢é˜…å´å¯ä»¥æ¥å—æ— é™å¤šçš„å€¼ã€‚è¿™ä¹ˆä¸€æ¥ï¼Œä¸€æ—¦åœ¨ <code class="highlighter-rouge">ZipAll</code> å†…éƒ¨äº§ç”Ÿ back pressureï¼Œæ¯”å¦‚å¤–éƒ¨æ‰€éœ€è¦çš„å€¼çš„é¢‘ç‡å°äºå†…éƒ¨ publishers äº§ç”Ÿå€¼çš„é¢‘ç‡çš„è¯ï¼Œ<code class="highlighter-rouge">buffer</code> å°†å¯ä»¥å¤§é‡ç§¯å‹ï¼Œå¯¼è‡´å†…å­˜é—®é¢˜ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸‹æ¸¸è®¢é˜…è€…éœ€è¦çš„å€¼çš„æ•°é‡ï¼Œæ¥å†³å®šæˆ‘ä»¬æ‰€éœ€è¦çš„ publishers ç»™æˆ‘ä»¬çš„å€¼çš„æ•°é‡ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½å°† back pressure çš„å¤„ç†ä¹Ÿåº”ç”¨åˆ°è¢« zip çš„ publishers ä¸­å»ï¼Œä»è€Œé¿å…æº¢å‡ºé—®é¢˜ã€‚</p>

<p>ç›¸å¯¹äºä½¿ç”¨ <code class="highlighter-rouge">Sink</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code class="highlighter-rouge">AnySubscriber</code> æ¥åœ¨æ›´ç»†çš„åŠ›åº¦ä¸Šè¿›è¡Œä¸€äº›æ§åˆ¶ã€‚æ¯”å¦‚åœ¨æ”¶åˆ°è®¢é˜…ååªè¯·æ±‚æœ‰é™ä¸ªäº‹ä»¶ï¼Œåœ¨æ”¶åˆ°æ–°å€¼æ—¶å°Šé‡ä¸‹æ¸¸è®¢é˜…çš„ <code class="highlighter-rouge">Demand</code> ç­‰ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">AnySubscriber</span><span class="p">(</span>
    <span class="nv">receiveSubscription</span><span class="p">:</span> <span class="p">{</span> <span class="n">subscription</span> <span class="k">in</span>
        
    <span class="p">},</span> 
    <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="o">-&gt;</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span> <span class="k">in</span>
    
    <span class="p">},</span> 
    <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span> 

    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>å¯ä»¥çœ‹å‡ºï¼Œæ–‡ä¸­ç»™å‡ºçš„å®ç°æœ‰ä¸å°‘ç¼ºç‚¹ï¼Œè¿™ä¸ªå‚è€ƒå®ç°æ›´å¤šåœ°æ˜¯ä¸ºäº†ä»¥æœ€ç®€å•çš„æ–¹å¼è¯´æ˜è‡ªå®šä¹‰ <code class="highlighter-rouge">Publisher</code> çš„ä¸€èˆ¬æ–¹æ³•ï¼Œè¿˜è¿œè¿œæ²¡æœ‰è¾¾åˆ°å¯ä»¥ç”¨åœ¨äº§å“ä»£ç ä¸­çš„è´¨é‡ã€‚ä¸è¿‡ï¼Œé€šè¿‡è¿™ç§ç›´æ¥çš„ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä¸€äº›å®ç°è‡ªå®šä¹‰ <code class="highlighter-rouge">Publisher</code> æ—¶çš„ä¸€èˆ¬ç»éªŒï¼š</p>

<ol>
  <li><code class="highlighter-rouge">Publisher</code> çš„æ¥å£å’Œå®ƒéœ€è¦å®Œæˆçš„ä»»åŠ¡æ˜¯ç›¸å¯¹å›ºå®šçš„ï¼Œéµå¾ª Combine çš„å·¥ä½œæµç¨‹å›¾ï¼Œæ¥å®ç°å…¶ä¸­å„ä¸ªèŒè´£ç±»å‹çš„å¿…è¦æ–¹æ³•å³å¯ã€‚</li>
  <li>å¦‚æœæ²¡æœ‰ç‰¹æ®Šçš„éœ€æ±‚ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šå°† <code class="highlighter-rouge">Publisher</code> å®šä¹‰ä¸º <code class="highlighter-rouge">struct</code> è€Œé <code class="highlighter-rouge">class</code>ï¼Œè¿™å¯ä»¥è®©å†…å­˜ç®¡ç†å’Œå¤šæ¬¡è®¢é˜…çš„è¡Œä¸ºæ›´åŠ å®¹æ˜“é¢„æµ‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ª <code class="highlighter-rouge">Publisher</code> æœ‰éœ€è¦å…±äº«çš„è¯ï¼Œåº”è¯¥å°†å®ƒå®šä¹‰ä¸ºå¼•ç”¨è¯­ä¹‰ï¼Œæ¯”å¦‚ <a href="https://developer.apple.com/documentation/combine/publishers/share"><code class="highlighter-rouge">Publishers.Share</code></a>ã€‚</li>
  <li>ç›¸å¯¹äº <code class="highlighter-rouge">Publisher</code>ï¼Œå¤§éƒ¨åˆ†æœ‰å…³æ—¶åºçš„æ“ä½œéƒ½è¢«å°è£…åˆ°äº† <code class="highlighter-rouge">Subscription</code> é‡Œã€‚ä½œä¸º <code class="highlighter-rouge">Publisher</code> å’Œ <code class="highlighter-rouge">Subscriber</code> ä¹‹é—´é€šè®¯çš„æ¡¥æ¢ï¼Œ<code class="highlighter-rouge">Subscription</code> è´Ÿè´£å¤§éƒ¨åˆ†é€»è¾‘ï¼Œå¹¶ç»´æŠ¤ Combine æµç¨‹çš„æ­£ç¡®æ€§ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ä¹Ÿæ˜¯åœ¨è‡ªå®šä¹‰ <code class="highlighter-rouge">Publisher</code> æ—¶æˆ‘ä»¬èŠ±è´¹æœ€å¤šæ—¶é—´çš„åœ°æ–¹ã€‚</li>
  <li>æƒ³è¦ç¡®ä¿ä½ çš„è‡ªå®šä¹‰ <code class="highlighter-rouge">Publisher</code> èƒ½åœ¨ Combine çš„ä¸–ç•Œä¸­è¿è¡Œè‰¯å¥½ï¼Œéœ€è¦éµå®ˆåŸºæœ¬çš„è§„åˆ™ã€‚æ¯”å¦‚å°Šé‡ä¸‹æ¸¸çš„ demandï¼Œè€ƒè™‘æ€§èƒ½å› ç´ ç­‰ã€‚</li>
</ol>

<h2 id="ç»ƒä¹ ">ç»ƒä¹ </h2>

<p>ä¸ºäº†ä¿æŒå’Œ<a href="(https://objccn.io/products/swift-ui)">ã€ŠSwiftUI å’Œ Combine ç¼–ç¨‹ã€‹</a>è¿™æœ¬ä¹¦çš„å½¢å¼ä¸Šçš„ç±»ä¼¼ï¼Œæˆ‘ä¹Ÿå‡†å¤‡äº†ä¸€äº›å°ç»ƒä¹ ï¼Œå¸Œæœ›èƒ½å¸®åŠ©è¯»è€…é€šè¿‡å®é™…åŠ¨æ‰‹ç»ƒä¹ æŒæ¡æœ¬æ–‡çš„å†…å®¹ã€‚</p>

<h3 id="1-ä¼˜åŒ–-zipall">1. ä¼˜åŒ– <code class="highlighter-rouge">ZipAll</code></h3>

<p>ä¸Šé¢æå‡ºäº†å…³äºä¼˜åŒ– <code class="highlighter-rouge">ZipAll</code> çš„ä¸€äº›æƒ³æ³•ï¼ŒåŒ…æ‹¬è¿è¡Œæ€§èƒ½çš„ä¼˜åŒ–å’Œé˜²æ­¢ <code class="highlighter-rouge">buffer</code> å †ç§¯ç­‰ã€‚è¯·ä½ åœ¨åŠ›æ‰€èƒ½åŠçš„èŒƒå›´å†…å¯¹ <code class="highlighter-rouge">ZipAll</code> è¿›è¡Œä¿®æ”¹å’Œä¼˜åŒ–ï¼Œå¹¶æ¶è®¾ä¸€äº›æ€§èƒ½æµ‹è¯•æ¥éªŒè¯ä½ çš„ä¿®æ”¹ç¡®å®å‘æŒ¥äº†ä½œç”¨ã€‚</p>

<blockquote>
  <p>æç¤ºï¼Œä¸€èˆ¬æ¥è¯´ï¼Œåœ¨æµ‹è¯•ä¸­æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code class="highlighter-rouge">PassthroughSubject</code> ä½œä¸ºæ•°æ®æºï¼Œå¹¶é€šè¿‡ <a href="https://developer.apple.com/documentation/xctest/xctestcase/1496290-measure"><code class="highlighter-rouge">measure(_:)</code></a> æ¥è®¾ç«‹æ€§èƒ½æµ‹è¯•ã€‚å¦‚æœåœ¨å°è¯•åä½ è¿˜æ˜¯å¯¹å¦‚ä½•ä¼˜åŒ–æ²¡æœ‰æ¦‚å¿µçš„è¯ï¼Œä¸å¦¨å¯ä»¥å‚è€ƒ RxSwift ä¸­å…³äº ZipAll çš„è¿™ä¸ª<a href="https://github.com/ReactiveX/RxSwift/blob/master/RxSwift/Observables/Zip%2BCollection.swift">é«˜æ•ˆå®ç°</a>ã€‚</p>
</blockquote>

<h3 id="2-å®ç°-combinelatestall">2. å®ç° <code class="highlighter-rouge">CombineLatestAll</code></h3>

<p>å’Œ <code class="highlighter-rouge">Zip</code> ç›¸å¯¹åº”çš„æ“ä½œæ˜¯ <code class="highlighter-rouge">CombineLatest</code>ï¼Œæˆ‘ä»¬å¯¹å®ƒåº”è¯¥å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼šå’Œ <code class="highlighter-rouge">Zip</code> ç­‰å¾…<strong>æ‰€æœ‰</strong> <code class="highlighter-rouge">Publisher</code> éƒ½å‘å‡ºå€¼ä¸åŒï¼Œå®ƒä¼šåœ¨<strong>ä»»æ„</strong> <code class="highlighter-rouge">Publisher</code> å‘å‡ºå€¼åå³æŠŠå„ä¸ª <code class="highlighter-rouge">Publisher</code> çš„æœ€æ–°å€¼åˆå¹¶ä¸”å‘å¤–å‘é€ã€‚Combine ä¸­ä¹Ÿåªå®ç°äº† <code class="highlighter-rouge">CombineLatest</code>ï¼Œ<code class="highlighter-rouge">CombineLatest3</code> å’Œ <code class="highlighter-rouge">CombineLatest4</code>ï¼Œä½†æ˜¯æ²¡æœ‰æ›´ä¸€èˆ¬çš„æ¥å—ä»»æ„å¤šä¸ª <code class="highlighter-rouge">Publisher</code> çš„ <code class="highlighter-rouge">CombineLatestAll</code>ã€‚è¯·ä½ ä»¿ç…§ <code class="highlighter-rouge">ZipAll</code> çš„æ–¹å¼ï¼Œå®ç°è‡ªå®šä¹‰çš„ <code class="highlighter-rouge">CombineLatestAll</code>ã€‚</p>
:ET