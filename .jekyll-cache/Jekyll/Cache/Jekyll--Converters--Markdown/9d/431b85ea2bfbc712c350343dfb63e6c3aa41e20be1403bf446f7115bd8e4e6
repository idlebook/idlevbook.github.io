I"À5<h4 id="blockçš„æœ¬è´¨">blockçš„æœ¬è´¨</h4>
<ul>
  <li>blockçš„æ•°æ®ç»“æ„
    <ul>
      <li><img src="/media/15377914436892/15377918585243.jpg" alt="" /></li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>struct __main_block_desc_0 {
    size_t reserved;
    size_t Block_size;
};

struct __block_impl {
    void *isa;
    int Flags;
    int Reserved;
    void *FuncPtr;
};
struct __main_block_impl_0 {
    struct __block_impl impl;
    struct __main_block_desc_0* Desc;
    int age;
};
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>blockæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªOCå¯¹è±¡ï¼Œå®ƒå†…éƒ¨ä¹Ÿæœ‰ä¸ªisaæŒ‡é’ˆ,æœ€ç»ˆç»§æ‰¿ä¸ºNSObect,å¯ä»¥è°ƒç”¨ç›¸å…³æ–¹æ³•</li>
  <li>blockæ˜¯å°è£…äº†å‡½æ•°è°ƒç”¨ä»¥åŠå‡½æ•°è°ƒç”¨ç¯å¢ƒçš„OCå¯¹è±¡
    <ul>
      <li>å‡½æ•°è°ƒç”¨: å°è£…äº†å‡½æ•°æ‰§è¡Œä½“,è¿”å›äº†FuncptræŒ‡é’ˆ</li>
      <li>å‡½æ•°è°ƒç”¨ç¯å¢ƒ: ä¸»è¦æ˜¯æ•æ‰å˜é‡çš„ç¯å¢ƒ</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>        int age = 20;
        
        void (^block)(int, int) =  ^(int a , int b){
            NSLog(@"this is a block! -- %d", age);
            NSLog(@"this is a block!");
            NSLog(@"this is a block!");
            NSLog(@"this is a block!");
        };
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="blockçš„å˜é‡æ•è·capture">blockçš„å˜é‡æ•è·ï¼ˆcaptureï¼‰</h4>
<ul>
  <li>å±€éƒ¨å˜é‡
    <ul>
      <li>auto: è‡ªåŠ¨å˜é‡ï¼Œç¦»å¼€ä½œç”¨åŸŸå°±é”€æ¯.æ•è·, å€¼ä¼ é€’</li>
      <li>static: é™æ€å±€éƒ¨å˜é‡, æ•è·, æŒ‡é’ˆä¼ é€’</li>
    </ul>
  </li>
  <li>å…¨å±€å˜é‡: ä¸æ•è·, ç›´æ¥è®¿é—®</li>
  <li>å¸ƒå±€å˜é‡æ•è·é‚£æ˜¯å› ä¸ºå±€éƒ¨å˜é‡æœ‰å¯èƒ½è¢«é”€æ¯,æ‰€ä»¥è¦ä¿å­˜èµ·æ¥ä»¥ä¾¿è®¿é—®.ä¸»è¦ç‚¹: ç”Ÿå‘½å‘¨æœŸ</li>
  <li>blockè®¿é—®å±æ€§,æ˜¯å¦æ•è·?
    <ul>
      <li>å±æ€§æ˜¯å±äºå½“å‰ç±»self,å½“å‰selfä¸ºéšå¼å‚æ•°, ä¸ºå±€éƒ¨å˜é‡(å‡½æ•°çš„å‚æ•°å),æ•è·.å‡†ç¡®çš„è¯´,æ•è·self,ä»è€Œè®¿é—®å±æ€§</li>
    </ul>
  </li>
</ul>

<h4 id="blockçš„ç±»å‹">blockçš„ç±»å‹</h4>
<ul>
  <li>ä¸‰ç§ç±»å‹
    <ul>
      <li><strong>NSGlobalBlock</strong>: æ²¡æœ‰è®¿é—®autoå˜é‡, ç›¸å½“äºå‡½æ•°è°ƒç”¨, å¾ˆå°‘ç”¨</li>
      <li>
        <p><strong>NSStackBlock</strong>: è®¿é—®äº†autoå˜é‡</p>
      </li>
      <li><strong>NSMallocBlock</strong>: __NSStackBlock__è°ƒç”¨äº†copy</li>
      <li><img src="/media/15377914436892/15377932853987.jpg" alt="" /></li>
    </ul>
  </li>
  <li>æ¯ä¸€ç§ç±»å‹çš„blockè°ƒç”¨copyåçš„ç»“æœå¦‚ä¸‹æ‰€ç¤º
    <ul>
      <li><img src="/media/15377914436892/15377925570880.jpg" alt="" /></li>
    </ul>
  </li>
</ul>

<h4 id="blockçš„copy">blockçš„copy</h4>
<ul>
  <li>åœ¨ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œæ¯”å¦‚ä»¥ä¸‹æƒ…å†µ
    <ul>
      <li>blockä½œä¸ºå‡½æ•°è¿”å›å€¼æ—¶</li>
      <li>å°†blockèµ‹å€¼ç»™__strongæŒ‡é’ˆæ—¶</li>
      <li>blockä½œä¸ºCocoa APIä¸­æ–¹æ³•åå«æœ‰usingBlockçš„æ–¹æ³•å‚æ•°æ—¶</li>
      <li>blockä½œä¸ºGCD APIçš„æ–¹æ³•å‚æ•°æ—¶</li>
      <li>ARCä¸‹blockå±æ€§çš„å»ºè®®å†™æ³•
        <ul>
          <li>@property (strong, nonatomic) void (^block)(void);</li>
          <li>@property (copy, nonatomic) void (^block)(void);</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>MRC, åˆ†é…åˆ°æ ˆä¸Šçš„æœ‰å¯èƒ½Blockè¢«é”€æ¯,è¦è¿›è¡Œcopyæ“ä½œ
    <ul>
      <li>@property (copy, nonatomic) void (^block)(void);</li>
    </ul>
  </li>
</ul>

<h4 id="å¯¹è±¡ç±»å‹çš„autoå˜é‡">å¯¹è±¡ç±»å‹çš„autoå˜é‡</h4>
<ul>
  <li>å½“blockå†…éƒ¨è®¿é—®äº†å¯¹è±¡ç±»å‹çš„autoå˜é‡æ—¶
    <ul>
      <li>å¦‚æœblockæ˜¯åœ¨æ ˆä¸Šï¼Œå°†ä¸ä¼šå¯¹autoå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨(è‡ªå·±åœ¨æ ˆä¸Š,éšæ—¶æœ‰å¯èƒ½è¢«é”€æ¯)</li>
      <li>å¦‚æœblockè¢«æ‹·è´åˆ°å †ä¸Š,ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°â€”&gt; copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°
        <ul>
          <li><img src="/media/15377914436892/15378868978816.jpg" alt="" /></li>
        </ul>
      </li>
      <li>_Block_object_assignå‡½æ•°ä¼šæ ¹æ®autoå˜é‡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>int main(int argc, const char * argv[]) {
    @autoreleasepool {
        
        MJBlock block;
        
        {
            MJPerson *person = [[MJPerson alloc] init];
            person.age = 10;
            

            block = ^{
                NSLog(@"---------%d", person.age);
            };
        }
        
        NSLog(@"------");
    }
    return 0;
}

// blocké‡Œé¢æœ‰ä¸€ä¸ªå¼ºæŒ‡é’ˆå¼•ç”¨Person * p, p æŒ‡å‘Personçš„å†…å­˜ç©ºé—´,blocké”€æ¯äº†,Personæ‰ä¼šè¢«é”€æ¯
// æ‰“å°ç»“æœ: ------10, -------, [Person dealloc]


</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre>int main(int argc, const char * argv[]) {
    @autoreleasepool {
        MJBlock block;

        {
            MJPerson *person = [[MJPerson alloc] init];
            person.age = 10;

            __weak MJPerson *weakPerson = person;
            block = ^{
                NSLog(@"---------%d", weakPerson.age);
            };
        }

        NSLog(@"------");
return 0;
}

// å¼±å¼•ç”¨
// æ‰“å°ç»“æœ: -----10, [Person dealloc]

</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>å¦‚æœblockä»å †ä¸Šç§»é™¤
    <ul>
      <li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•°</li>
      <li>disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°</li>
      <li>_Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„autoå˜é‡ï¼ˆreleaseï¼‰</li>
    </ul>
  </li>
  <li><img src="/media/15377914436892/15378867636745.jpg" alt="" /></li>
  <li>__weaké—®é¢˜è§£å†³
    <ul>
      <li>åœ¨ä½¿ç”¨clangè½¬æ¢OCä¸ºC++ä»£ç æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹é—®é¢˜</li>
      <li>cannot create __weak reference in file using manual reference(å› ä¸ºweakéœ€è¦è¿è¡Œæ—¶æ”¯æŒ)</li>
      <li>è§£å†³æ–¹æ¡ˆï¼šæ”¯æŒARCã€æŒ‡å®šè¿è¡Œæ—¶ç³»ç»Ÿç‰ˆæœ¬ï¼Œæ¯”å¦‚xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-8.0.0 main.m</li>
    </ul>
  </li>
  <li>å‘½ä»¤è¡Œä¸èƒ½åšCGDçš„æµ‹è¯•,å› ä¸ºè¿è¡Œå®Œäº†å°±ç›´æ¥æŒ‚äº†</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event {
    MJPerson *p = [[MJPerson alloc] init];
    
    __weak MJPerson *weakP = p;
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        NSLog(@"1-------%@", p);
        
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            NSLog(@"2-------%@", weakP);
        });
    });
    
    NSLog(@"touchesBegan:withEvent:");
}

// ç†è®ºä¸Šæ¥è¯´,1såç¬¬ä¸€ä¸ªblockæŒ‚äº†,Personä¹Ÿå°±æŒ‚äº†,ä½†æ˜¯ç¼–è¯‘å™¨ä¼šè€ƒè™‘åˆ°æ•´ä½“,3såæ‰ä¼šæŒ‚
</pre></td></tr></tbody></table></code></pre></div></div>
<h4 id="__blockä¿®é¥°ç¬¦">__blockä¿®é¥°ç¬¦</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>// ç¼–è¯‘æŠ¥é”™,é‚£æ˜¯å› ä¸ºå±€éƒ¨å˜é‡çš„åŸºæœ¬æ•°æ®ç±»å‹ä¸ºå€¼ä¼ é€’,åœ¨å„è‡ªçš„å‡½æ•°è°ƒç”¨æ ˆ,ä¿®æ”¹çš„ä¹Ÿæ˜¯å†…éƒ¨çš„age,æ— æ³•ä¿®æ”¹
   int age = 10;
        MJBlock block2 = ^{
            age = 30;
            NSLog(@"age is %d", age);
        };
</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>__blockå¯ä»¥ç”¨äºè§£å†³blockå†…éƒ¨æ— æ³•ä¿®æ”¹autoå˜é‡å€¼çš„é—®é¢˜</li>
  <li>__blockä¸èƒ½ä¿®é¥°å…¨å±€å˜é‡ã€é™æ€å˜é‡ï¼ˆstaticï¼‰(éƒ½å¯ä»¥ç›´æ¥è®¿é—®äº†,æ²¡å¿…è¦ä¿®é¥°)</li>
  <li>ç¼–è¯‘å™¨ä¼šå°†__blockå˜é‡åŒ…è£…æˆä¸€ä¸ªå¯¹è±¡
    <ul>
      <li><img src="/media/15377914436892/15378874780421.jpg" alt="" /></li>
    </ul>
  </li>
  <li><img src="/media/15377914436892/15378875253041.jpg" alt="" /></li>
  <li>fording æŒ‡é’ˆæŒ‡å‘å¯¹è±¡æœ¬èº«,ä¿®æ”¹ageçš„å€¼å…¶å®æ˜¯age-&gt;forwarding-&gt;age = 20</li>
  <li><img src="/media/15377914436892/15394383890806.jpg" alt="" /></li>
  <li>blockå†…éƒ¨çš„ageä¸å¤–é¢çš„ageçš„åœ°å€å€¼ç›¸åŒ<strong>(ä¸ºä»€ä¹ˆä¸€ä¸ªå˜é‡çš„åœ°å€å€¼å¯ä»¥ç›¸åŒ?)</strong>,å…¶å®è®¿é—®çš„æ˜¯blockå†…éƒ¨çš„age,æ˜¯ä¼šå› ä¸ºæ™®é€šå¼€å‘è€…åªæ˜¯è®¤ä¸ºè®¿é—®çš„åªæœ‰å¤–é¢çš„age,ä¸çŸ¥åˆ°é‡Œé¢çš„age,è‹¹æœä¸ºäº†å¯¹å¤–å±è”½ç»†èŠ‚,å°±åƒkvoä¸€æ ·</li>
</ul>

<h3 id="__block-çš„å†…å­˜ç®¡ç†">__block çš„å†…å­˜ç®¡ç†</h3>
<ul>
  <li>å½“blockåœ¨æ ˆä¸Šæ—¶ï¼Œå¹¶ä¸ä¼šå¯¹__blockå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨</li>
  <li>å½“blockè¢«copyåˆ°å †æ—¶
    <ul>
      <li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°</li>
      <li>copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°</li>
      <li>_Block_object_assignå‡½æ•°ä¼šå¯¹__blockå˜é‡å½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰</li>
      <li><img src="/media/15377914436892/15394369199169.jpg" alt="" /></li>
      <li><img src="/media/15377914436892/15394369358495.jpg" alt="" /></li>
    </ul>
  </li>
  <li>å½“blockä»å †ä¸­ç§»é™¤æ—¶
    <ul>
      <li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•°</li>
      <li>disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°</li>
      <li>_Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„__blockå˜é‡ï¼ˆreleaseï¼‰</li>
      <li><img src="/media/15377914436892/15394371121463.jpg" alt="" /></li>
      <li><img src="/media/15377914436892/15394371229851.jpg" alt="" /></li>
    </ul>
  </li>
  <li>blcokçš„fordingæŒ‡é’ˆ
    <ul>
      <li><img src="/media/15377914436892/15394371536475.jpg" alt="" /></li>
      <li>è¿™æ ·è®¾è®¡çš„åŸå› æ˜¯æ— è®ºæ˜¯è®¿é—®æ ˆä¸Šçš„blockè¿˜æ˜¯å †ä¸Šçš„block,éƒ½èƒ½è®¿é—®åˆ°å †ä¸Š,æ‰€ä»¥å±æ€§è®¿é—®çš„æ˜¯å †ä¸Šçš„</li>
    </ul>
  </li>
  <li>å¯¹è±¡ç±»å‹çš„autoå˜é‡ã€__blockå˜é‡
    <ul>
      <li>å½“__blockå˜é‡åœ¨æ ˆä¸Šæ—¶ï¼Œä¸ä¼šå¯¹æŒ‡å‘çš„å¯¹è±¡äº§ç”Ÿå¼ºå¼•ç”¨</li>
      <li>å½“__blockå˜é‡è¢«copyåˆ°å †æ—¶
        <ul>
          <li>ä¼šè°ƒç”¨__blockå˜é‡å†…éƒ¨çš„copyå‡½æ•°</li>
          <li>copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°</li>
          <li>_Block_object_assignå‡½æ•°ä¼šæ ¹æ®æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨<strong>ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä»…é™äºARCæ—¶ä¼šretainï¼ŒMRCæ—¶ä¸ä¼šretainï¼‰</strong></li>
        </ul>
      </li>
      <li>å¦‚æœ__blockå˜é‡ä»å †ä¸Šç§»é™¤
        <ul>
          <li>ä¼šè°ƒç”¨__blockå˜é‡å†…éƒ¨çš„disposeå‡½æ•°</li>
          <li>disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°</li>
          <li>_Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾æŒ‡å‘çš„å¯¹è±¡ï¼ˆreleaseï¼‰
            <h3 id="å¾ªç¯å¼•ç”¨">å¾ªç¯å¼•ç”¨</h3>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>ARCæƒ…å†µä¸‹
    <ul>
      <li>
        <p>ç”¨__weakã€__unsafe_unretainedè§£å†³<img src="/media/15377914436892/15394373924986.jpg" alt="" /></p>
      </li>
      <li>ç”¨__blockè§£å†³<img src="/media/15377914436892/15394373688361.jpg" alt="" /></li>
      <li><img src="/media/15377914436892/15394376799175.jpg" alt="" /></li>
    </ul>
  </li>
  <li>
    <p>MRC æƒ…å†µä¸‹</p>

    <ul>
      <li>ç”¨__unsafe_unretainedè§£å†³
  <img src="/media/15377914436892/15394374580764.jpg" alt="" /></li>
      <li>ç”¨__blockè§£å†³
  <img src="/media/15377914436892/15394374779569.jpg" alt="" />
        <ul>
          <li>å¹¶æ²¡æœ‰æŠŠblockç½®ä¸ºnil,åŸå› æ˜¯_Block_object_assignå‡½æ•°ä¼šæ ¹æ®æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨<strong>ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä»…é™äºARCæ—¶ä¼šretainï¼ŒMRCæ—¶ä¸ä¼š</strong>,æ²¡æœ‰å½¢æˆå¤§ç¯å¼•ç”¨<img src="/media/15377914436892/15394377307427.jpg" alt="" /></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h4 id="æœ‰è¶£çš„èŠ±è¾¹">æœ‰è¶£çš„èŠ±è¾¹</h4>
<ul>
  <li>å¦‚æœæƒ³çŸ¥é“å˜é‡åœ¨å“ªä¸ªæ®µ,å¯é€šè¿‡æ‰“å°å·²çŸ¥çš„æ®µåŒº.åŸç†:æ¯ä¸ªæ®µåŒºçš„åˆ†éš”è¿˜æ˜¯å¾ˆå¤§çš„</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>int age = 10;

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        int a = 10;
        
        NSLog(@"æ•°æ®æ®µï¼šage %p", &amp;age);
        NSLog(@"æ ˆï¼ša %p", &amp;a);
        NSLog(@"å †ï¼šobj %p", [[NSObject alloc] init]);
        NSLog(@"æ•°æ®æ®µï¼šclass %p", [MJPerson class]);
        
        
    }
    return 0;
}
</pre></td></tr></tbody></table></code></pre></div></div>

:ET