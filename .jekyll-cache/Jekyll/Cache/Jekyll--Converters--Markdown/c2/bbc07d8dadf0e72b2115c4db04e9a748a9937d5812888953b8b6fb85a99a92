I"Îİ<blockquote>
  <p>æœ¬æ–‡æ˜¯å¯¹æˆ‘çš„ã€ŠSwiftUI å’Œ Combine ç¼–ç¨‹ã€‹ä¹¦ç±çš„è¡¥å……ï¼Œå¯¹ä¸€äº›è™½ç„¶å¾ˆé‡è¦ï¼Œä½†å’Œä¹¦ä¸­ä¸Šä¸‹æ–‡å†…å®¹ç›¸å»ç•¥è¿œï¼Œæˆ–è€…ä¸€äº›ä¸å¤ªé€‚åˆä»¥ä¹¦æœ¬çš„ç¯‡å¹…è¯¦ç»†å±•å¼€è§£é‡Šçš„å†…å®¹è¿›è¡Œäº†è¿½åŠ è¯´æ˜ã€‚å¦‚æœä½ å¯¹ SwiftUI å’Œ Combine çš„æ›´å¤šè¯é¢˜æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥è€ƒè™‘<a href="https://objccn.io/products/swift-ui">å‚é˜…åŸä¹¦</a>ã€‚</p>
</blockquote>

<p>Combine åœ¨ API è®¾è®¡ä¸Šå¾ˆå¤šåœ°æ–¹éƒ½å‚è€ƒäº† Rx ç³»ï¼Œç‰¹åˆ«æ˜¯ <a href="https://github.com/ReactiveX/RxSwift">RxSwift</a> çš„åšæ³•ã€‚å¦‚æœä½ å·²ç»å¯¹å“åº”å¼ç¼–ç¨‹å¾ˆäº†è§£çš„è¯ï¼Œä» RxSwift è¿ç§»åˆ° Combine åº”è¯¥æ˜¯è½»è€Œæ˜“ä¸¾çš„ã€‚å¦‚æœè¦è¯´èµ· RxSwift å’Œ Combine çš„æœ€æ˜¾è‘—çš„ä¸åŒï¼Œé‚£å°±æ˜¯ RxSwift åœ¨å¯é¢„æœŸçš„æœªæ¥<a href="https://github.com/ReactiveX/RxSwift/issues/1666?source=post_page-----64780a150d89----------------------#issuecomment-395546338">æ²¡æœ‰æ”¯æŒ backpressure çš„è®¡åˆ’</a>ï¼›ä½†æ˜¯ Combine ä¸­åŸç”Ÿå¯¹è¿™ä¸ªç‰¹æ€§è¿›è¡Œäº†æ”¯æŒï¼šåœ¨ Combine ä¸­ä½ å¯ä»¥åœ¨ <code class="highlighter-rouge">Subscriber</code> ä¸­è¿”å›è¿½åŠ æ¥æ”¶çš„äº‹ä»¶æ•°é‡ï¼Œæ¥å®šä¹‰ Backpressure çš„å“åº”è¡Œä¸ºã€‚åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬ä¼šè§£é‡Šè¿™ä¸ªè¡Œä¸ºã€‚</p>

<h2 id="ä»€ä¹ˆæ˜¯-backpressureä¸ºä»€ä¹ˆéœ€è¦å¤„ç†å®ƒ">ä»€ä¹ˆæ˜¯ Backpressureï¼Œä¸ºä»€ä¹ˆéœ€è¦å¤„ç†å®ƒ</h2>

<p>è™½ç„¶åœ¨ iOS å®¢æˆ·ç«¯ä¸­ï¼Œbackpressure ä¹Ÿè®¸ä¸æ˜¯é‚£ä¹ˆå¸¸è§ï¼Œä½†æ˜¯è¿™åœ¨è½¯ä»¶å¼€å‘é‡Œå¯èƒ½æ˜¯ä¸€ä¸ªå¼€å‘è€…æˆ–å¤šæˆ–å°‘éƒ½ä¼šé‡åˆ°çš„è¯é¢˜ã€‚Backpressure è¿™ä¸ªè¯æ¥æºäºæµä½“åŠ›å­¦ï¼Œä¸€èˆ¬è¢«å«åš<strong>èƒŒå‹</strong>æˆ–è€…<strong>å›å‹</strong>ï¼ŒæŒ‡çš„æ˜¯<strong>æµä½“åœ¨ç®¡é“ä¸­æµåŠ¨æ—¶ï¼Œ(ç”±äºé«˜åº¦å·®æˆ–è€…å‹åŠ›æ‰€äº§ç”Ÿçš„é˜»æ») åœ¨é€†æµåŠ¨æ–¹å‘ä¸Šçš„é˜»åŠ›</strong>ã€‚åœ¨å“åº”å¼çš„ç¼–ç¨‹ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šæŠŠç”± Publisherï¼ŒOperator å’Œ Subscriber ç»„æˆçš„äº‹ä»¶å¤„ç†æ–¹å¼æ¯”å–»ä¸ºâ€œç®¡é“â€ï¼ŒæŠŠå¯¹åº”çš„ä¸æ–­å‘ç”Ÿçš„äº‹ä»¶å«åšâ€œäº‹ä»¶æµâ€ã€‚ç±»æ¯”è€Œè¨€ï¼Œåœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œbackpressure æŒ‡çš„æ˜¯<strong>åœ¨äº‹ä»¶æµåŠ¨ä¸­ï¼Œä¸‹æ¸¸ (Operator æˆ–è€… Subscriber) å¯¹ä¸Šæ¸¸ Publisher çš„é˜»åŠ›</strong>ã€‚</p>

<p>ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿè¿™æ ·çš„â€œé˜»åŠ›â€å‘¢ï¼Ÿä¸€ä¸ªæœ€å¸¸è§çš„åŸå› å°±æ˜¯ä¸‹æ¸¸çš„ Subscriber çš„å¤„ç†é€Ÿåº¦æ— æ³•è·Ÿä¸Šä¸Šæ¸¸ Publisher äº§ç”Ÿäº‹ä»¶çš„é€Ÿåº¦ã€‚åœ¨ç†æƒ³ä¸–ç•Œä¸­ï¼Œå¦‚æœæˆ‘ä»¬çš„å¤„ç†é€Ÿåº¦æ— ç©·ï¼Œé‚£ä¹ˆä¸ç®¡ Publisher ä»¥å¤šå¿«çš„é€Ÿåº¦äº§ç”Ÿäº‹ä»¶ï¼ŒSubscriber éƒ½å¯ä»¥æ¶ˆåŒ–å¹¶å¤„ç†è¿™äº›äº‹ä»¶ã€‚ä½†æ˜¯å®é™…æƒ…å†µæ˜¾ç„¶ä¸ä¼šå¦‚æ­¤ï¼Œæœ‰æ—¶å€™ Publisher çš„äº‹ä»¶ç”Ÿæˆé€Ÿåº¦å¯ä»¥è¿œè¶… Subscriber çš„å¤„ç†é€Ÿåº¦ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ã€‚</p>

<p>ä¸¾ä¾‹æ¥è¯´ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ Publisher ä»ä¸€ä¸ªå¿«é€Ÿçš„ web socket æ¥å—æ•°æ®ï¼Œç»è¿‡ä¸€ç³»åˆ—ç±»ä¼¼ <a href="https://developer.apple.com/documentation/combine/publishers/map"><code class="highlighter-rouge">Publishers.Map</code></a> çš„å˜å½¢æ“ä½œï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®è½¬æ¢ä¸º app ä¸­çš„ Modelï¼Œæœ€ç»ˆçš„è®¢é˜…è€…åœ¨æ¥æ”¶åˆ°æ•°æ®åæ‰§è¡Œ UI æ¸²æŸ“çš„å·¥ä½œï¼ŒæŠŠæ•°æ®æ·»åŠ åˆ° Table View é‡Œå¹¶ç»˜åˆ¶ UIã€‚å¾ˆæ˜¾ç„¶ï¼Œç›¸å¯¹äº UI æ¸²æŸ“æ¥è¯´ï¼Œæ¥æ”¶æ•°æ®å’Œæ•°æ®å˜å½¢æ˜¯éå¸¸å¿«çš„ã€‚åœ¨ä¸€å¸§ (60 Hz ä¸‹çš„è¯ï¼Œ16ms) ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¥æ”¶å’Œå¤„ç†æˆåƒä¸Šä¸‡æ¡æ•°æ®ï¼Œä½†æ˜¯å¯èƒ½åªèƒ½åˆ›å»ºå’Œæ¸²æŸ“åå¤šä¸ª cellã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å¤„ç†è¿™äº›æ•°æ®ï¼Œæœ´ç´ æ¥è¯´ï¼Œå¯èƒ½çš„æ–¹å¼æœ‰å››ç§ï¼š</p>

<ol>
  <li>é˜»å¡ä¸»çº¿ç¨‹ï¼Œåœ¨è¿™ä¸€å¸§ä¸­å¤„ç†å®Œè¿™æˆåƒä¸Šä¸‡çš„ cellã€‚</li>
  <li>æŠŠæ¥å—åˆ°çš„æ•°æ®æš‚å­˜åœ¨ä¸€ä¸ª buffer é‡Œï¼Œå–å‡ºåˆé€‚çš„é‡è¿›è¡Œå¤„ç†ã€‚å‰©ä½™éƒ¨åˆ†åˆ™ç­‰å¾…ä¸‹ä¸€å¸§æˆ–è€…ç¨åç©ºé—²æ—¶å†è¿›è¡Œæ¸²æŸ“ã€‚</li>
  <li>åœ¨æ¥æ”¶åˆ°æ•°æ®åï¼Œä½¿ç”¨é‡‡æ ·æ–¹æ³•ä¸¢å¼ƒæ‰ä¸€éƒ¨åˆ†æ•°æ®ï¼Œåªå»å¤„ç†éƒ¨åˆ†æ•°æ®ï¼Œä»¥æ»¡è¶³æ»¡å¸§æ¸²æŸ“ã€‚</li>
  <li>æ§åˆ¶äº‹ä»¶äº§ç”Ÿçš„é€Ÿåº¦ï¼Œè®©äº‹ä»¶çš„å‘ç”Ÿé€Ÿåº¦å‡æ…¢ï¼Œæ¥â€œé€‚åº”â€è®¢é˜…è€…å¤„ç†çš„é€Ÿåº¦ã€‚</li>
</ol>

<p>åœ¨å®¢æˆ·ç«¯å¼€å‘ä¸­ï¼Œæ–¹æ¡ˆ 1 æ˜¯æœ€ä¸å¯å–çš„ï¼Œå¾ˆæ˜¾ç„¶å®ƒä¼šæŠŠ UI æ•´ä¸ªå¡æ­»ï¼Œç”šè‡³è®©æˆ‘ä»¬å¯çˆ±çš„ <a href="https://stackoverflow.com/a/36644249/1468886">watchdog 0x8badf00d (ate bad food)</a> ä»è€Œé€ æˆ app å´©æºƒã€‚æ–¹æ¡ˆ 2 åœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šæœ‰ç”¨ï¼Œä½†æ˜¯å¦‚æœæ•°æ®ä¸€ç›´å †ç§¯ï¼Œbuffer è¿Ÿæ—©ä¼šå‘ç”Ÿæº¢å‡ºã€‚å¯¹äºæ–¹æ¡ˆ 3ï¼Œåœ¨â€œå°†å¤§é‡æ•°æ®æ¸²æŸ“åˆ° UI ä¸Šâ€è¿™ä¸€æƒ…æ™¯ä¸­ï¼ŒUI åˆ·æ–°çš„é€Ÿç‡å°†è¿œè¿œè¶…è¿‡äººèƒ½çœ‹åˆ°å’Œå¤„ç†çš„ä¿¡æ¯é‡ï¼Œæ‰€ä»¥å®ƒæ˜¯å¯è¡Œçš„ï¼Œä¸¢å¼ƒæ‰éƒ¨åˆ†æ•°æ®å¹¶ä¸ä¼šé€ æˆä½¿ç”¨ä½“éªŒä¸Šçš„å½±å“ã€‚æ–¹æ¡ˆ 4 å¦‚æœå¯ä»¥å®ç°çš„è¯ï¼Œåˆ™æ˜¯ç›¸å¯¹ç†æƒ³çš„ backpressure å¤„ç†æ–¹å¼ï¼šè®©å‘é€ç«¯å»é€‚é…æ¥æ”¶ç«¯ï¼Œåœ¨ä¿è¯ä½“éªŒçš„æƒ…å†µä¸‹åŒæ—¶ä¹Ÿä¿éšœäº†æ•°æ®å®Œæ•´æ€§ï¼Œå¹¶ä¸” (è‡³å°‘å¯¹å®¢æˆ·ç«¯æ¥è¯´) ä¸ä¼šå­˜åœ¨ buffer æº¢å‡ºçš„æƒ…å†µã€‚</p>

<p>å¦å¤–ä¸€ä¸ªå¸¸è§çš„ä¾‹å­æ˜¯å¤§å‹æ–‡ä»¶è½¬å­˜ï¼Œä¾‹å¦‚ä»ç£ç›˜çš„æŸä¸ªä½ç½®é€šè¿‡ä¸€ä¸ª stream è¯»å–æ•°æ®ï¼Œç„¶åå°†å®ƒå†™å…¥åˆ°å¦ä¸€ä¸ªåœ°æ–¹ã€‚ç£ç›˜çš„è¯»å†™é€Ÿåº¦å¾€å¾€æ˜¯å­˜åœ¨å·®åˆ«çš„ï¼Œé€šå¸¸æ¥è¯´è¯»é€Ÿè¦æ¯”å†™é€Ÿå¿«å¾ˆå¤šã€‚å‡è®¾ç£ç›˜è¯»å–é€Ÿåº¦ä¸º 100 MB/sï¼Œå†™å…¥é€Ÿåº¦ä¸º 50 MB/sï¼Œå¦‚æœä¸¤ç«¯éƒ½å…¨é€Ÿçš„è¯ï¼Œæ¯ç§’å°†ä¼šå †ç§¯ 50 MB çš„æ•°æ®åˆ° buffer ä¸­ï¼Œå¾ˆå¤šåœºæ™¯ä¸‹è¿™æ˜¯éš¾ä»¥æ¥å—çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡é™åˆ¶è¯»å–é€Ÿåº¦ï¼Œæ¥å®Œç¾è§£å†³è¿™ä¸ªé€Ÿåº¦å·®ï¼Œè€Œè¿™å°±æ˜¯ä¸Šé¢çš„æ–¹æ¡ˆ 4 ä¸­çš„æ€æƒ³ã€‚</p>

<p>ç®€å•æ¥è¯´ï¼Œbackpressure æä¾›äº†ä¸€ç§æ–¹æ¡ˆï¼Œæ¥è§£å†³åœ¨å¼‚æ­¥æ“ä½œä¸­å‘é€ç«¯å’Œæ¥æ”¶ç«¯é€Ÿç‡æ— æ³•åŒ¹é…çš„é—®é¢˜ (é€šå¸¸æ˜¯å‘é€ç«¯å¿«äºæ¥æ”¶ç«¯)ã€‚åœ¨ä¸€ä¸ª (åƒæ˜¯ Combine è¿™æ ·çš„) å¼‚æ­¥å¤„ç†æ¡†æ¶ä¸­ï¼Œæ˜¯å¦èƒ½å¤Ÿæ”¯æŒæ§åˆ¶ä¸Šæ¸¸é€Ÿåº¦æ¥å¤„ç† backpressureï¼Œå…³é”®å–å†³äºä¸€ç‚¹ï¼šäº‹ä»¶çš„å‘é€åˆ°åº•æ˜¯åŸºäº<strong>æ‹‰å–æ¨¡å‹</strong>è¿˜æ˜¯<strong>æ¨é€æ¨¡å‹</strong>ã€‚å¦‚æœæ˜¯æ‹‰å–æ¨¡å‹ï¼Œé‚£ä¹ˆæ‰€å®šä¹‰çš„ Publisher ä¼šæ ¹æ®è¦æ±‚<strong>æŒ‰éœ€å‘é€</strong>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ§åˆ¶äº‹ä»¶å‘é€çš„é¢‘ç‡ï¼Œè¿›è€Œå¤„ç†å‰è¿°çš„ä¸Šä¸‹æ¸¸é€Ÿåº¦ä¸åŒ¹é…çš„é—®é¢˜ã€‚</p>

<h2 id="è‡ªå®šä¹‰-subscriber">è‡ªå®šä¹‰ Subscriber</h2>

<h3 id="combine-æ¡†æ¶åŸºäºæ‹‰å–çš„äº‹ä»¶æ¨¡å‹">Combine æ¡†æ¶åŸºäºæ‹‰å–çš„äº‹ä»¶æ¨¡å‹</h3>

<p>å¥½æ¶ˆæ¯æ˜¯ï¼ŒCombine çš„äº‹ä»¶å‘é€ç¡®å®æ˜¯åŸºäºæ‹‰å–æ¨¡å‹çš„ã€‚æˆ‘ä»¬å›é¡¾ä¸€ä¸‹å…¸å‹çš„ Combine è®¢é˜…å’Œäº‹ä»¶å‘é€çš„æµç¨‹ï¼š</p>

<p><img src="/assets/images/2019/publisher-subscriber-flow.svg" alt="" /></p>

<p>å›¾ä¸­å…±æœ‰ä¸‰ç§ä¸»è¦è§’è‰²ï¼Œé™¤äº†ä¸¤ç«¯çš„ <code class="highlighter-rouge">Publisher</code> å’Œ <code class="highlighter-rouge">Subscriber</code> ä»¥å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªè´Ÿè´£ä½œä¸ºâ€œæ¡¥æ¢â€è¿æ¥ä¸¤è€…çš„ <code class="highlighter-rouge">Subscription</code>ã€‚</p>

<p>æ­¥éª¤ 3ï¼Œ4 å’Œ 5 ä¸­åˆ†åˆ«æ¶‰åŠåˆ° <code class="highlighter-rouge">Subscription</code> å’Œ <code class="highlighter-rouge">Subscriber</code> çš„ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Subscription</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">request</span><span class="p">(</span><span class="n">_</span> <span class="nv">demand</span><span class="p">:</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">protocol</span> <span class="kt">Subscriber</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">_</span> <span class="nv">input</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å®ƒä»¬éƒ½å’Œ <code class="highlighter-rouge">Subscribers.Demand</code> ç›¸å…³ï¼šè¿™ä¸ªå€¼è¡¨ç¤ºäº† <code class="highlighter-rouge">Subscriber</code> å¸Œæœ›æ¥æ”¶çš„äº‹ä»¶æ•°é‡ã€‚Combine æ¡†æ¶ä¸­æœ‰è¿™æ ·çš„çº¦å®šï¼š<code class="highlighter-rouge">Subscriber</code> å¯¹åº”ç€çš„è®¢é˜…æ‰€å‘å‡ºçš„äº‹ä»¶æ€»æ•°ï¼Œä¸åº”è¯¥è¶…è¿‡ <code class="highlighter-rouge">Subscription.request(_:)</code> æ‰€ä¼ å…¥çš„ <code class="highlighter-rouge">Demand</code> å’Œæ¥ä¸‹æ¥æ¯æ¬¡ <code class="highlighter-rouge">Subscriber.receive(_:)</code> è¢«è°ƒç”¨æ—¶è¿”å›çš„ <code class="highlighter-rouge">Demand</code> çš„å€¼çš„ç´¯åŠ ã€‚åŸºäºè¿™ä¸ªè§„åˆ™ï¼Œ<code class="highlighter-rouge">Subscriber</code> å¯ä»¥æ ¹æ®è‡ªèº«æƒ…å†µé€šè¿‡ä½¿ç”¨åˆé€‚çš„ <code class="highlighter-rouge">Demand</code> æ¥æ§åˆ¶ä¸Šæ¸¸ã€‚</p>

<p>è¿™ä¹ˆè¯´ä¼šæœ‰äº›æŠ½è±¡ã€‚åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬ä¼šæŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨ <code class="highlighter-rouge">Subscriber</code> ä¸Šï¼Œé¦–å…ˆæ¥çœ‹çœ‹å¦‚ä½•å®ç°è‡ªå®šä¹‰çš„ <code class="highlighter-rouge">Subscriber</code>ï¼Œç”±æ­¤ç†è§£ Combine çš„æ‹‰å–æ¨¡å‹çš„æ„ä¹‰ã€‚ç„¶åå†å°è¯•å®ç°ä¸€ä¸ªèƒ½å¤Ÿæ§åˆ¶ <code class="highlighter-rouge">Publisher</code> å‘é€äº‹ä»¶çš„ç‰¹æ®Š <code class="highlighter-rouge">Subscriber</code>ã€‚</p>

<p>å…³äºå›¾ä¸­å¦å¤–ä¸¤ç§è§’è‰² <code class="highlighter-rouge">Publisher</code> å’Œ <code class="highlighter-rouge">Subscription</code>ï¼Œæˆ‘å¯èƒ½ä¼šåœ¨å¦å¤–çš„æ–‡ç« é‡Œå†è¿›è¡Œæ›´å¤šè¯´æ˜ã€‚</p>

<h3 id="é‡å†™-sink">é‡å†™ Sink</h3>

<p>åœ¨è®¢é˜…æŸä¸ª <code class="highlighter-rouge">Publisher</code> æ—¶ï¼Œå¤§æ¦‚æœ€å¸¸ç”¨çš„è«è¿‡äº <code class="highlighter-rouge">sink</code> äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="nf">sink</span><span class="p">(</span>
    <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Completion: </span><span class="se">\(</span><span class="n">completion</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Receive value: </span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<p>å®šä¹‰åœ¨ <code class="highlighter-rouge">Publisher</code> ä¸Šçš„æ‰©å±•æ–¹æ³• <code class="highlighter-rouge">sink(receiveCompletion:receiveValue:)</code> åªä¸è¿‡æ˜¯æ ‡å‡†çš„è®¢é˜…æµç¨‹çš„ç®€å†™æ–¹å¼ã€‚æŒ‰ç…§â€œæ­£è§„çš„â€æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ç¡®åœ°åˆ›å»º <code class="highlighter-rouge">Subscriber</code> å¹¶è®©å®ƒè®¢é˜… <code class="highlighter-rouge">Publisher</code>ï¼Œä¸Šé¢çš„ä»£ç ç­‰æ•ˆäºï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">publisher</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">publisher</span>
<span class="k">let</span> <span class="nv">subscriber</span> <span class="o">=</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Sink</span><span class="o">&lt;</span><span class="kt">Int</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Completion: </span><span class="se">\(</span><span class="n">completion</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Receive value: </span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">publisher</span><span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">subscriber</span><span class="p">)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Sink</code> åšçš„äº‹æƒ…éå¸¸ç®€å•ï¼Œå®ƒåœ¨è®¢é˜…æ—¶ç›´æ¥ç”³è¯·æ¥å— <code class="highlighter-rouge">Subscribers.Demand.unlimited</code> ä¸ªå…ƒç´ ã€‚åœ¨æ¯æ¬¡æ”¶åˆ°äº‹ä»¶æ—¶ï¼Œè°ƒç”¨é¢„å…ˆè®¾å®šçš„ blockã€‚ç°åœ¨ï¼Œä½œä¸ºèµ·å§‹ï¼Œæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„ <code class="highlighter-rouge">MySink</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 1</span>
<span class="kd">extension</span> <span class="kt">Subscribers</span> <span class="p">{</span>
    <span class="c1">// 2</span>
    <span class="kd">class</span> <span class="kt">MySink</span><span class="o">&lt;</span><span class="kt">Input</span><span class="p">,</span> <span class="kt">Failure</span><span class="p">:</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">:</span> <span class="kt">Subscriber</span><span class="p">,</span> <span class="kt">Cancellable</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">(</span><span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
        <span class="k">let</span> <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">(</span><span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
        <span class="c1">// 3</span>
        <span class="k">var</span> <span class="nv">subscription</span><span class="p">:</span> <span class="kt">Subscription</span><span class="p">?</span>
        
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>Combine ä¸­çš„ <code class="highlighter-rouge">Publisher</code> å’Œ <code class="highlighter-rouge">Subscriber</code> å¤§éƒ½ä½œä¸ºå†…åµŒç±»å‹ï¼Œå®šä¹‰åœ¨ <code class="highlighter-rouge">Publishers</code> å’Œ <code class="highlighter-rouge">Subscribers</code> ä¸­ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿéµå¾ªè¿™ä¸ªè§„åˆ™ï¼ŒæŠŠ <code class="highlighter-rouge">MySink</code> å†™åœ¨ <code class="highlighter-rouge">Subscribers</code> é‡Œã€‚</li>
  <li>æˆ‘ä»¬æƒ³è®© <code class="highlighter-rouge">MySink</code> æ»¡è¶³ <code class="highlighter-rouge">Cancellable</code>ï¼Œå› æ­¤éœ€è¦æŒæœ‰ <code class="highlighter-rouge">subscription</code>ï¼Œæ‰èƒ½åœ¨æœªæ¥å–æ¶ˆè¿™ä¸ªè®¢é˜…ã€‚åœ¨è¯­ä¹‰ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¸Œæœ›å‘ç”Ÿå¤åˆ¶ï¼Œæ‰€ä»¥ä½¿ç”¨ <code class="highlighter-rouge">class</code> æ¥å£°æ˜ <code class="highlighter-rouge">MySink</code>ã€‚è¿™ä¹Ÿæ˜¯å®ç°è‡ªå®šä¹‰ <code class="highlighter-rouge">Subscriber</code> çš„ä¸€èˆ¬åšæ³•ã€‚</li>
  <li>åœ¨ <code class="highlighter-rouge">Subscriber</code> ä¸­æŒæœ‰ <code class="highlighter-rouge">subscription</code> æ˜¯å¾ˆå¸¸è§çš„æ“ä½œï¼Œé™¤äº†ç”¨æ¥å¯¹åº”å–æ¶ˆä»¥å¤–ï¼Œè¿™è¿˜å¯ä»¥è®©æˆ‘ä»¬çµæ´»å¤„ç†é¢å¤–çš„å€¼çš„è¯·æ±‚ï¼Œç¨åæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™æ–¹é¢çš„å†…å®¹ã€‚</li>
</ol>

<p>æ¥ä¸‹æ¥ï¼Œåˆ›å»ºä¸€ä¸ªåˆå§‹åŒ–æ–¹æ³•ï¼Œå®ƒæ¥å— <code class="highlighter-rouge">receiveCompletion</code> å’Œ <code class="highlighter-rouge">receiveValue</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">init</span><span class="p">(</span>
    <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">,</span>
    <span class="nv">receiveValue</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
<span class="p">)</span>
<span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">receiveCompletion</span> <span class="o">=</span> <span class="n">receiveCompletion</span>
    <span class="k">self</span><span class="o">.</span><span class="n">receiveValue</span> <span class="o">=</span> <span class="n">receiveValue</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æƒ³è¦å®ç° <code class="highlighter-rouge">Subscriber</code> åè®®ï¼Œæˆ‘ä»¬éœ€è¦å®ç°åè®®ä¸­å®šä¹‰çš„æ‰€æœ‰ä¸‰ä¸ªæ–¹æ³•ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">Subscriber</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="nv">subscription</span><span class="p">:</span> <span class="kt">Subscription</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">_</span> <span class="nv">input</span><span class="p">:</span> <span class="k">Self</span><span class="o">.</span><span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span>
    <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="k">Self</span><span class="o">.</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ <code class="highlighter-rouge">MySink</code> é‡Œï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨éµå¾ª <code class="highlighter-rouge">Sink</code> çš„åšæ³•ï¼šåœ¨ä¸€å¼€å§‹æ”¶åˆ°è®¢é˜…æ—¶ï¼Œå°±è¯·æ±‚æ— é™å¤šçš„äº‹ä»¶ï¼›è€Œåœ¨åç»­æ”¶åˆ°å€¼æ—¶ï¼Œåˆ™ä¸å†åš (ä¹Ÿä¸éœ€è¦åš) æ›´å¤šçš„è¯·æ±‚ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="nv">subscription</span><span class="p">:</span> <span class="kt">Subscription</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">subscription</span>
    <span class="n">subscription</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">.</span><span class="n">unlimited</span><span class="p">)</span>
<span class="p">}</span>
        
<span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">_</span> <span class="nv">input</span><span class="p">:</span> <span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span> <span class="p">{</span>
    <span class="nf">receiveValue</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">.</span><span class="k">none</span>
<span class="p">}</span>
        
<span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">receiveCompletion</span><span class="p">(</span><span class="n">completion</span><span class="p">)</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æœ€åï¼Œä¸ºäº†å®ç° <code class="highlighter-rouge">Cancellable</code>ï¼Œæˆ‘ä»¬éœ€è¦å°† <code class="highlighter-rouge">cancel()</code> çš„è°ƒç”¨â€œè½¬å‘â€ç»™ <code class="highlighter-rouge">subscription</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">subscription</span><span class="p">?</span><span class="o">.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="n">subscription</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºäº†é¿å…æ„å¤–çš„å¾ªç¯å¼•ç”¨ (å› ä¸º <code class="highlighter-rouge">Subscription</code> å¾ˆå¤šæƒ…å†µä¸‹ä¹Ÿä¼šæŒæœ‰ <code class="highlighter-rouge">Subscriber</code>)ï¼Œæ‰€ä»¥åœ¨æ”¶åˆ°å®Œæˆäº‹ä»¶æˆ–è€…æ”¶åˆ°å–æ¶ˆè¯·æ±‚æ—¶ï¼Œä¸å†ç»§ç»­éœ€è¦è®¢é˜…çš„æƒ…å†µä¸‹ï¼Œè¦è®°å¾—å°† <code class="highlighter-rouge">subscription</code> ç½®å›ä¸º <code class="highlighter-rouge">nil</code>ã€‚</p>

<p>æœ€åçš„æœ€åï¼Œä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œä¸å¦¨ä¸º <code class="highlighter-rouge">Publisher</code> æä¾›ä¸€ä¸ªæ‰©å±•æ–¹æ³•ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬ç”¨ <code class="highlighter-rouge">MySink</code> åšè®¢é˜…ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Publisher</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mySink</span><span class="p">(</span>
        <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">,</span>
        <span class="nv">receiveValue</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Cancellable</span>
    <span class="p">{</span>
        <span class="k">let</span> <span class="nv">sink</span> <span class="o">=</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">MySink</span><span class="o">&lt;</span><span class="kt">Output</span><span class="p">,</span> <span class="kt">Failure</span><span class="o">&gt;</span><span class="p">(</span>
            <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="n">receiveCompletion</span><span class="p">,</span>
            <span class="nv">receiveValue</span><span class="p">:</span> <span class="n">receiveValue</span>
        <span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">sink</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sink</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="nf">mySink</span><span class="p">(</span>
    <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Completion: </span><span class="se">\(</span><span class="n">completion</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Receive value: </span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="c1">// è¾“å‡ºï¼š</span>
<span class="c1">// Receive value: 1</span>
<span class="c1">// Receive value: 2</span>
<span class="c1">// Receive value: 3</span>
<span class="c1">// Receive value: 4</span>
<span class="c1">// Receive value: 5</span>
<span class="c1">// Completion: finished</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">mySink</code> çš„è¡Œä¸ºå’ŒåŸå§‹çš„ <code class="highlighter-rouge">sink</code> åº”è¯¥æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç€æ‰‹ä¿®æ”¹ <code class="highlighter-rouge">MySink</code> çš„ä»£ç ï¼Œè®©äº‹æƒ…å˜å¾—æ›´æœ‰è¶£ä¸€äº›äº†ã€‚</p>

<h3 id="æŒ‰ç…§-demand-çš„éœ€æ±‚æ¥å‘é€äº‹ä»¶">æŒ‰ç…§ Demand çš„éœ€æ±‚æ¥å‘é€äº‹ä»¶</h3>

<p>æˆ‘ä»¬å¯ä»¥å¯¹ <code class="highlighter-rouge">MySink</code> åšä¸€ç‚¹æ‰‹è„šï¼Œæ¥æ§åˆ¶å®ƒçš„æ‹‰å–è¡Œä¸ºã€‚æ¯”å¦‚å°† <code class="highlighter-rouge">receive(subscription:)</code> é‡Œåˆå§‹çš„è¯·æ±‚æ•°é‡è°ƒæ•´ä¸º <code class="highlighter-rouge">.max(1)</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="nv">subscription</span><span class="p">:</span> <span class="kt">Subscription</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">subscription</span>
    <span class="c1">// subscription.request(.unlimited)</span>
    <span class="n">subscription</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ ·ä¸€æ¥ï¼Œè¾“å‡ºå°±åœç•™åœ¨åªæœ‰ä¸€è¡Œäº†ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Receive value: 1
</code></pre></div></div>

<p>è¿™æ˜¯å› ä¸ºç°åœ¨æˆ‘ä»¬åªåœ¨è®¢é˜…å‘ç”Ÿæ—¶å»è¯·æ±‚äº†ä¸€ä¸ªå€¼ï¼Œè€Œåœ¨ <code class="highlighter-rouge">receive(_:)</code> é‡Œï¼Œæˆ‘ä»¬è¿”å›çš„ <code class="highlighter-rouge">.none</code> ä»£è¡¨ä¸å†éœ€è¦ <code class="highlighter-rouge">Publisher</code> ç»™å‡ºæ–°å€¼äº†ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æœ‰æœºä¼šå†³å®šä¸‹ä¸€æ¬¡çš„äº‹ä»¶è¯·æ±‚æ•°é‡ï¼šå¯ä»¥å°†è¯·æ±‚æ•°ä» <code class="highlighter-rouge">.none</code> è°ƒæ•´ä¸º <code class="highlighter-rouge">.max(1)</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">_</span> <span class="nv">input</span><span class="p">:</span> <span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span> <span class="p">{</span>
    <span class="nf">receiveValue</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="c1">// return .none</span>
    <span class="k">return</span> <span class="o">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¾“å‡ºå°†æ¢å¤åŸæ¥çš„æƒ…å†µï¼šæ¯å½“ <code class="highlighter-rouge">MySink</code> æ”¶åˆ°ä¸€ä¸ªå€¼æ—¶ï¼Œå®ƒä¼šå†å»<strong>æ‹‰å–</strong>ä¸‹ä¸€ä¸ªå€¼ï¼Œç›´åˆ°æœ€åç»“æŸã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸º <code class="highlighter-rouge">Publisher</code> æ·»åŠ  <code class="highlighter-rouge">print()</code> æ¥ä»æ§åˆ¶å°è¾“å‡ºç¡®å®šè¿™ä¸ªè¡Œä¸ºï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// [1,2,3,4,5].publisher</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="nf">print</span><span class="p">()</span>
    <span class="o">.</span><span class="nf">mySink</span><span class="p">(</span>
        <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Completion: </span><span class="se">\(</span><span class="n">completion</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
            <span class="c1">// print("Receive value: \(value)")</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="c1">// è¾“å‡ºï¼š</span>
<span class="c1">// receive subscription: ([1, 2, 3, 4, 5])</span>
<span class="c1">// request max: (1)</span>
<span class="c1">// receive value: (1)</span>
<span class="c1">// request max: (1) (synchronous)</span>
<span class="c1">// receive value: (2)</span>
<span class="c1">// request max: (1) (synchronous)</span>
<span class="c1">// receive value: (3)</span>
<span class="c1">// ... </span>
</code></pre></div></div>

<p>é€šè¿‡åœ¨ <code class="highlighter-rouge">Subscriber</code> é‡Œçš„ <code class="highlighter-rouge">receive(subscription:)</code> å’Œ <code class="highlighter-rouge">receive(_:)</code> æ¥æ§åˆ¶ <code class="highlighter-rouge">Subscribers.Demand</code>ï¼Œæˆ‘ä»¬åšåˆ°äº†æ§åˆ¶ <code class="highlighter-rouge">Publisher</code> çš„äº‹ä»¶å‘é€ã€‚é‚£è¦å¦‚ä½•ä½¿ç”¨è¿™ä¸ªç‰¹æ€§å¤„ç† backpressure çš„æƒ…å†µå‘¢ï¼Ÿ</p>

<h2 id="èƒ½å¤Ÿå¤„ç†-backpressure-çš„-subscriber">èƒ½å¤Ÿå¤„ç† backpressure çš„ Subscriber</h2>

<h3 id="è®©å·²åœæ­¢çš„äº‹ä»¶æµç»§ç»­">è®©å·²åœæ­¢çš„äº‹ä»¶æµç»§ç»­</h3>

<p>æŒ‰ç…§ Combine çº¦å®šï¼Œå½“ <code class="highlighter-rouge">Publisher</code> å‘é€çš„å€¼æ»¡è¶³ <code class="highlighter-rouge">Subscriber</code> æ‰€è¦æ±‚çš„æ•°é‡åï¼Œä¾¿ä¸å†å‘é€æ–°çš„å€¼ã€‚åœ¨ä¸Šé¢çš„ <code class="highlighter-rouge">MySink</code> å®ç°é‡Œï¼Œåªè¦å°† <code class="highlighter-rouge">receive(_:)</code> çš„è¿”å›å€¼è®¾ä¸º <code class="highlighter-rouge">.none</code>ï¼Œé‚£ä¹ˆå°±åªä¼šæœ‰ç¬¬ä¸€ä¸ªå€¼è¢«å‘å‡ºã€‚è¿™æ—¶å€™æˆ‘ä»¬ä¾¿é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå› ä¸ºåç»­çš„å€¼ä¸ä¼šå†è¢«å‘é€ï¼Œ<code class="highlighter-rouge">receive(_:)</code> ä¹Ÿä¸ä¼šå†è¢«è°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬ä¸å†æœ‰æœºä¼šåœ¨ <code class="highlighter-rouge">receive(_:)</code> ä¸­è¿”å›æ–°çš„ <code class="highlighter-rouge">Demand</code>ï¼Œæ¥è®© <code class="highlighter-rouge">Publisher</code> é‡æ–°å¼€å§‹å·¥ä½œã€‚</p>

<p>æˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹å¼æ¥â€œé‡æ–°å¯åŠ¨â€è¿™ä¸ªæµç¨‹ï¼Œé‚£å°±æ˜¯ <code class="highlighter-rouge">Subscription</code> ä¸Šçš„ <code class="highlighter-rouge">request(_ demand: Subscribers.Demand)</code> æ–¹æ³•ã€‚åœ¨è®¢é˜…åˆšå¼€å§‹æ—¶ï¼Œæˆ‘ä»¬å·²ç»ä½¿ç”¨è¿‡å®ƒæ¥å¼€å§‹ç¬¬ä¸€æ¬¡å‘é€ã€‚ç°åœ¨ï¼Œå½“ <code class="highlighter-rouge">Publisher</code> â€œæš‚åœâ€åï¼Œæˆ‘ä¹Ÿä¹Ÿå¯ä»¥ä»å¤–éƒ¨ç”¨å®ƒæ¥é‡å¯å‘é€æµç¨‹ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬è¦æš‚å­˜ <code class="highlighter-rouge">subscription</code> çš„å¦ä¸€ä¸ªé‡è¦ç†ç”±ã€‚</p>

<p>åœ¨ <code class="highlighter-rouge">MySink</code> é‡Œæ·»åŠ  <code class="highlighter-rouge">resume</code> æ–¹æ³•ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">subscription</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åˆ›å»ºä¸€ä¸ª <code class="highlighter-rouge">Resumable</code> åè®®ï¼Œå¹¶è®© <code class="highlighter-rouge">MySink</code> éµå®ˆè¿™ä¸ªåè®®ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Resumable</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Subscribers</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="kt">MySink</span><span class="o">&lt;</span><span class="kt">Input</span><span class="p">,</span> <span class="kt">Failure</span><span class="p">:</span> <span class="kt">Error</span><span class="o">&gt;</span>
    <span class="p">:</span> <span class="kt">Subscriber</span><span class="p">,</span> <span class="kt">Cancellable</span><span class="p">,</span> <span class="kt">Resumable</span> 
    <span class="p">{</span>
        <span class="c1">//...</span>
        <span class="c1">// MySink å·²ç»å®ç°äº† resume()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æœ€åï¼ŒæŠŠ <code class="highlighter-rouge">Publisher.mySink</code> çš„è¿”å›ç±»å‹ä» <code class="highlighter-rouge">Cancellable</code> ä¿®æ”¹ä¸º <code class="highlighter-rouge">Cancellable &amp; Resumable</code> çš„è”åˆï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Publisher</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mySink</span><span class="p">(</span>
        <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">,</span>
        <span class="nv">receiveValue</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Cancellable</span> <span class="o">&amp;</span> <span class="kt">Resumable</span>
    <span class="p">{</span>
      <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œå³ä½¿æˆ‘ä»¬æŠŠ <code class="highlighter-rouge">MySink</code> é‡Œ <code class="highlighter-rouge">receive(_:)</code> çš„è¿”å›å€¼æ”¹å› <code class="highlighter-rouge">.none</code>ï¼Œè®© <code class="highlighter-rouge">Publisher</code> åœ¨è¢«è®¢é˜…ååªå‘å‡ºä¸€æ¬¡å€¼ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å†é€šè¿‡åå¤è°ƒç”¨ <code class="highlighter-rouge">resume(_:)</code> æ¥â€œåˆ†æ‰¹æ¬¡â€æ‹‰å–æ‰€æœ‰å€¼äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Subscribers</span> <span class="p">{</span>
    <span class="kd">class</span> <span class="kt">MySink</span> <span class="c1">//... {</span>
        <span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">_</span> <span class="nv">input</span><span class="p">:</span> <span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span> <span class="p">{</span>
            <span class="nf">receiveValue</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">.</span><span class="k">none</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">subscriber</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="nf">print</span><span class="p">()</span>
    <span class="o">.</span><span class="nf">mySink</span><span class="p">(</span>
        <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Completion: </span><span class="se">\(</span><span class="n">completion</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">},</span>
        <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Receive value: </span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="n">subscriber</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
<span class="n">subscriber</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
<span class="n">subscriber</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
<span class="n">subscriber</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="æ³¨å…¥æ§åˆ¶é€»è¾‘æš‚åœ-publisher-å‘é€">æ³¨å…¥æ§åˆ¶é€»è¾‘ï¼Œæš‚åœ <code class="highlighter-rouge">Publisher</code> å‘é€</h3>

<p>ç°åœ¨æˆ‘ä»¬åªå·®æœ€åä¸€å—æ‹¼å›¾äº†ï¼Œé‚£å°±æ˜¯åˆ°åº•ç”±è°æ¥è´Ÿè´£æš‚åœ <code class="highlighter-rouge">Publisher</code> çš„é€»è¾‘ã€‚å½“å‰çš„ <code class="highlighter-rouge">MySink</code> ä¸­ï¼Œç”±äºå¼€å§‹è®¢é˜…æ—¶åªæ¥å—äº† <code class="highlighter-rouge">.max(1)</code>ï¼ŒåŒæ—¶ï¼Œ <code class="highlighter-rouge">receive(_:)</code> è¿”å›çš„æ˜¯ <code class="highlighter-rouge">.none</code>ï¼Œæ‰€ä»¥åœ¨æ¥åˆ°ç¬¬ä¸€ä¸ªå€¼åï¼Œ<code class="highlighter-rouge">Publisher</code> æ˜¯æ— æ¡ä»¶æš‚åœçš„ã€‚å®é™…ä¸Šï¼Œå’Œ <code class="highlighter-rouge">resume</code> é€»è¾‘ç±»ä¼¼ï¼Œæˆ‘ä»¬ä¼šæ›´å¸Œæœ›å°†æš‚åœçš„é€»è¾‘ä¹Ÿâ€œå§”æ‰˜â€å‡ºå»ï¼Œç”±è°ƒç”¨è€…æ¥å†³å®šåˆé€‚çš„æš‚åœæ—¶æœºï¼š<code class="highlighter-rouge">receiveValue</code> å›è°ƒæ˜¯ä¸€ä¸ªä¸é”™çš„åœ°æ–¹ã€‚å°† <code class="highlighter-rouge">MySink</code> ä¸­çš„ <code class="highlighter-rouge">receiveValue</code> ç­¾åè¿›è¡Œä¿®æ”¹ï¼Œè®©å®ƒè¿”å›ä¸€ä¸ª <code class="highlighter-rouge">Bool</code> æ¥è¡¨ç¤ºæ˜¯å¦åº”è¯¥ç»§ç»­ä¸‹ä¸€æ¬¡è¯·æ±‚ï¼Œå¹¶ä¸º <code class="highlighter-rouge">MySink</code> æ·»åŠ ä¸€ä¸ªå±æ€§æŒæœ‰å®ƒï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">MySink</span> <span class="c1">// ... {</span>
    <span class="c1">// let receiveValue: (Input) -&gt; Void</span>
    <span class="k">let</span> <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">(</span><span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
    
    <span class="k">var</span> <span class="nv">shouldPullNewValue</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">false</span>
    
    <span class="nf">init</span><span class="p">(</span>
        <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">,</span>
        <span class="c1">// receiveValue: @escaping (Input) -&gt; Void</span>
        <span class="nv">receiveValue</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
    <span class="p">)</span>
    <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Publisher</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">mySink</span><span class="p">(</span>
        <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Completion</span><span class="o">&lt;</span><span class="kt">Failure</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">,</span>
        <span class="c1">// receiveValue: @escaping (Output) -&gt; Void</span>
        <span class="nv">receiveValue</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Output</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Cancellable</span> <span class="o">&amp;</span> <span class="kt">Resumable</span>
</code></pre></div></div>

<p>å½“ <code class="highlighter-rouge">shouldPullNewValue</code> ä¸º <code class="highlighter-rouge">true</code> æ—¶ï¼Œåœ¨æ”¶åˆ°æ–°å€¼åï¼Œåº”å½“ç»§ç»­è¯·æ±‚ä¸‹ä¸€ä¸ªå€¼ï¼›å¦åˆ™ï¼Œä¾¿ä¸å†ç»§ç»­è¯·æ±‚ï¼Œå°†äº‹ä»¶æµå…³é—­ï¼Œç­‰å¾…å¤–ç•Œè°ƒç”¨ <code class="highlighter-rouge">resume</code> å†é‡å¯ã€‚</p>

<p>å¯¹ <code class="highlighter-rouge">MySink</code> çš„ç›¸å…³æ–¹æ³•è¿›è¡Œä¿®æ”¹ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="nv">subscription</span><span class="p">:</span> <span class="kt">Subscription</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">subscription</span>
    <span class="nf">resume</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">receive</span><span class="p">(</span><span class="n">_</span> <span class="nv">input</span><span class="p">:</span> <span class="kt">Input</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span> <span class="p">{</span>
    <span class="n">shouldPullNewValue</span> <span class="o">=</span> <span class="nf">receiveValue</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shouldPullNewValue</span> <span class="p">?</span> <span class="o">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">:</span> <span class="o">.</span><span class="k">none</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="o">!</span><span class="n">shouldPullNewValue</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">shouldPullNewValue</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="n">subscription</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ ·ï¼Œå°±å¯ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™é€šè¿‡ <code class="highlighter-rouge">receiveValue</code> é—­åŒ…è¿”å› <code class="highlighter-rouge">false</code> æ¥æš‚åœï¼›åœ¨æš‚åœåï¼Œé€šè¿‡è°ƒç”¨ <code class="highlighter-rouge">resume</code> æ¥ç»§ç»­äº†ã€‚</p>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå·¨å¤§ (ç”šè‡³æ— é™ï¼) çš„æ•°æ®é›†ï¼Œåœ¨ä½¿ç”¨ <code class="highlighter-rouge">sink</code> çš„æƒ…å†µä¸‹ç”±äºå¤„ç†é€Ÿåº¦æ— æ³•è·Ÿä¸Šäº‹ä»¶çš„å‘é€é€Ÿåº¦ï¼Œæˆ‘ä»¬å°†ä¼šè¢«ç›´æ¥å¡æ­»ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="mi">1</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="nf">sink</span><span class="p">(</span>
    <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Completion: </span><span class="se">\(</span><span class="n">completion</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Receive value: </span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div></div>

<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬é€šè¿‡ä½¿ç”¨ <code class="highlighter-rouge">mySink</code> å¹¶è®¾å®šä¸€å®šæ¡ä»¶ï¼Œå°±å¯ä»¥å¾ˆä¼˜é›…åœ°å¤„ç†è¿™ä¸ª backpressureã€‚æ¯”å¦‚æ¯ç§’åªéœ€è¦ <code class="highlighter-rouge">Publisher</code> å‘é€äº”ä¸ªäº‹ä»¶ï¼Œå¹¶è¿›è¡Œå¤„ç†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">buffer</span> <span class="o">=</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]()</span>
<span class="k">let</span> <span class="nv">subscriber</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="nf">print</span><span class="p">()</span><span class="o">.</span><span class="nf">mySink</span><span class="p">(</span>
    <span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Completion: </span><span class="se">\(</span><span class="n">completion</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">value</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Receive value: </span><span class="se">\(</span><span class="n">value</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="n">buffer</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">5</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="k">let</span> <span class="nv">cancellable</span>  <span class="o">=</span> <span class="kt">Timer</span><span class="o">.</span><span class="nf">publish</span><span class="p">(</span><span class="nv">every</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">on</span><span class="p">:</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">in</span><span class="p">:</span> <span class="o">.</span><span class="k">default</span><span class="p">)</span>
    <span class="o">.</span><span class="nf">autoconnect</span><span class="p">()</span>
    <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">_</span> <span class="k">in</span>
        <span class="n">buffer</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span>
        <span class="n">subscriber</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„ <code class="highlighter-rouge">MySink</code> æˆä¸ºäº†ä¸€ä¸ªå¯ä»¥ç”¨äºå¤„ç† backpressure çš„é€šç”¨æ–¹æ¡ˆã€‚</p>

<blockquote>
  <p>ç›¸å…³çš„ä»£ç å¯ä»¥<a href="https://gist.github.com/onevcat/baecc584e3cbfa2cc161290b2dfd300a">åœ¨è¿™é‡Œæ‰¾åˆ°</a>ã€‚</p>
</blockquote>

<h2 id="ç»ƒä¹ ">ç»ƒä¹ </h2>

<p>ä¸ºäº†ä¿æŒå’Œ<a href="(https://objccn.io/products/swift-ui)">ã€ŠSwiftUI å’Œ Combine ç¼–ç¨‹ã€‹</a>è¿™æœ¬ä¹¦çš„å½¢å¼ä¸Šçš„ç±»ä¼¼ï¼Œæˆ‘ä¹Ÿå‡†å¤‡äº†ä¸€äº›å°ç»ƒä¹ ï¼Œå¸Œæœ›èƒ½å¸®åŠ©è¯»è€…é€šè¿‡å®é™…åŠ¨æ‰‹ç»ƒä¹ æŒæ¡æœ¬æ–‡çš„å†…å®¹ã€‚</p>

<h3 id="1-è‡ªå®šä¹‰å®ç°-subscribersassign">1. è‡ªå®šä¹‰å®ç° <code class="highlighter-rouge">Subscribers.Assign</code></h3>

<p>æ–‡ä¸­è‡ªå®šä¹‰äº† <code class="highlighter-rouge">MySink</code>ï¼Œæ¥å¤ç° <code class="highlighter-rouge">Sink</code> çš„åŠŸèƒ½ã€‚ç°åœ¨è¯·ä½ ä¾ç…§ç±»ä¼¼çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªä½ è‡ªå·±çš„ <code class="highlighter-rouge">MyAssign</code> ç±»å‹ï¼Œè®©å®ƒå’Œ <code class="highlighter-rouge">Subscribers.Assign</code> çš„è¡Œä¸ºä¸€è‡´ã€‚ä½œä¸ºæç¤ºï¼Œä¸‹é¢æ˜¯ Combine æ¡†æ¶ä¸­ <code class="highlighter-rouge">Subscribers.Assign</code> çš„ (ç®€åŒ–ç‰ˆçš„) public å£°æ˜ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">Assign</span><span class="o">&lt;</span><span class="kt">Root</span><span class="p">,</span> <span class="kt">Input</span><span class="o">&gt;</span> <span class="p">:</span> <span class="kt">Subscriber</span><span class="p">,</span> <span class="kt">Cancellable</span> <span class="p">{</span>
    <span class="kd">typealias</span> <span class="kt">Failure</span> <span class="o">=</span> <span class="kt">Never</span>
    <span class="k">var</span> <span class="nv">object</span><span class="p">:</span> <span class="kt">Root</span><span class="p">?</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">let</span> <span class="nv">keyPath</span><span class="p">:</span> <span class="kt">ReferenceWritableKeyPath</span><span class="o">&lt;</span><span class="kt">Root</span><span class="p">,</span> <span class="kt">Input</span><span class="o">&gt;</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="2-ä¸€æ¬¡-request-è¶…è¿‡-max1-ä¸ªæ•°çš„äº‹ä»¶">2. ä¸€æ¬¡ request è¶…è¿‡ <code class="highlighter-rouge">.max(1)</code> ä¸ªæ•°çš„äº‹ä»¶</h3>

<p>åœ¨å¼•å…¥ <code class="highlighter-rouge">resume</code> æ—¶ï¼Œæˆ‘ä»¬å°† <code class="highlighter-rouge">.max(1)</code> ç¡¬ç¼–ç åœ¨äº†æ–¹æ³•å†…éƒ¨ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">resume</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">subscription</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="o">.</span><span class="nf">max</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬èƒ½ä¸èƒ½ä¿®æ”¹è¿™ä¸ªæ–¹æ³•çš„ç­¾åï¼Œè®©å®ƒæ›´çµæ´»ä¸€äº›ï¼Œæ¥å—ä¸€ä¸ª <code class="highlighter-rouge">Demand</code> å‚æ•°ï¼Œè®©å®ƒå¯ä»¥å‘ <code class="highlighter-rouge">subscription</code> è¯·æ±‚å¤šä¸ªå€¼ï¼Ÿæ¯”å¦‚ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">resume</span><span class="p">(</span><span class="n">_</span> <span class="nv">demand</span><span class="p">:</span> <span class="kt">Subscribers</span><span class="o">.</span><span class="kt">Demand</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">subscription</span><span class="p">?</span><span class="o">.</span><span class="nf">request</span><span class="p">(</span><span class="n">demand</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¹ˆåšä¼šå¯¹ <code class="highlighter-rouge">Resumable</code> äº§ç”Ÿå½±å“å—ï¼Ÿä¼šå¯¹ä¹‹åæˆ‘ä»¬æƒ³è¦å®ç°çš„æš‚åœé€»è¾‘æœ‰ä»€ä¹ˆå½±å“ï¼Ÿæˆ‘ä»¬è¿˜èƒ½å¤Ÿä½¿ç”¨è¿™æ ·çš„ <code class="highlighter-rouge">resume</code> å†™å‡ºå¯é çš„æš‚åœå’Œé‡å¯é€»è¾‘ä¹ˆï¼Ÿ</p>

<h3 id="3-é€šç”¨çš„-subscriber-å’Œä¸“ç”¨çš„-subscriber">3. é€šç”¨çš„ Subscriber å’Œä¸“ç”¨çš„ Subscriber</h3>

<p>æœ¬æ–‡æœ€åæˆ‘ä»¬å®ç°çš„æ˜¯ä¸€ä¸ªç›¸å¯¹é€šç”¨çš„ Subscriberï¼Œä½†æ˜¯å¦‚æœé€»è¾‘æ›´å¤æ‚ï¼Œæˆ–è€…éœ€è¦å¤§è§„æ¨¡é‡å¤ä½¿ç”¨æ—¶ï¼ŒæŠŠé€»è¾‘æ”¾åœ¨ <code class="highlighter-rouge">receiveValue</code> é—­åŒ…ä¸­ä¼šæœ‰äº›éº»çƒ¦ã€‚</p>

<p>è¯·å°è¯•æŠŠåŸæ–‡ä¸­ ã€Œ<code class="highlighter-rouge">buffer</code> å…ƒç´ æ•°åˆ°è¾¾ 5 æ—¶ï¼Œæš‚åœä¸€ç§’ã€è¿™ä¸ªé€»è¾‘å°è£…èµ·æ¥ï¼Œç”¨ä¸€ä¸ªæ–°çš„ä¸“ç”¨çš„ <code class="highlighter-rouge">Subscriber</code> æ›¿ä»£ã€‚ä½ å¯ä»¥å°è¯•ä¸¤ä¸ªæ–¹å‘ï¼š</p>

<ol>
  <li>ä½¿ç”¨ä¸€ä¸ªæ–°çš„ç±»å‹ï¼ŒåŒ…è£…ç°æœ‰çš„ <code class="highlighter-rouge">MySink</code>ï¼Œå°†åˆ¤æ–­é€»è¾‘æ”¾åˆ°æ–°ç±»å‹ä¸­ï¼›<code class="highlighter-rouge">Subscriber</code> åè°ƒæ‰€éœ€è¦å®šä¹‰çš„æ–¹æ³•ï¼Œé€šè¿‡è½¬å‘çš„æ–¹å¼äº¤ç»™ <code class="highlighter-rouge">MySink</code> å¤„ç†ã€‚</li>
  <li>å®Œå…¨é‡æ–°å®ç°ä¸€ä¸ªå’Œ <code class="highlighter-rouge">MySink</code> æ— å…³çš„ <code class="highlighter-rouge">Subscriber</code>ï¼Œä¸“é—¨ç”¨æ¥å¤„ç†è¿™ç±»å®šæ—¶å¼€å…³çš„äº‹ä»¶æµã€‚</li>
</ol>
:ET