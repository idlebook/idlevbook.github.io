I"Şè<p>View Controller å‘æ¥æ˜¯ MVC (Model-View-View Controller) ä¸­æœ€è®©äººå¤´ç–¼çš„ä¸€ç¯ï¼ŒMVC æ¶æ„æœ¬èº«å¹¶ä¸å¤æ‚ï¼Œä½†å¼€å‘è€…å¾ˆå®¹æ˜“å°†å¤§é‡ä»£ç æ‰”åˆ°ç”¨äºåè°ƒ View å’Œ Model çš„ Controller ä¸­ã€‚ä½ ä¸èƒ½è¯´è¿™æ˜¯ä¸€ç§é”™è¯¯ï¼Œå› ä¸º View Controller æ‰€æ‰¿æ‹…çš„æœ¬æ¥å°±æ˜¯èƒ¶æ°´ä»£ç å’Œä¸šåŠ¡é€»è¾‘çš„éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼ŒæŒç»­è¿™æ ·åšå¿…å®šå°†å¯¼è‡´ Model View Controller å˜æˆ Massive View Controllerï¼Œä»£ç ä¹Ÿå°±ä¸€å¤©å¤©çƒ‚ä¸‹å»ï¼Œç›´åˆ°æ²¡äººæ•¢ç¢°ã€‚</p>

<p>å¯¹äºé‡‡ç”¨ MVC æ¶æ„çš„é¡¹ç›®æ¥è¯´ï¼Œå…¶å®æœ€å¤§çš„æŒ‘æˆ˜åœ¨äºç»´æŠ¤ Controllerã€‚è€Œæƒ³è¦æœ‰è‰¯å¥½ç»´æŠ¤çš„ Controllerï¼Œæœ€å¤§çš„æŒ‘æˆ˜åˆåœ¨äºä¿æŒè‰¯å¥½çš„æµ‹è¯•è¦†ç›–ã€‚å› ä¸ºå¾€å¾€ View Controller ä¸­ä¼šåŒ…å«å¾ˆå¤šçŠ¶æ€ï¼Œè€Œä¸”ä¼šæœ‰ä¸å°‘å¼‚æ­¥æ“ä½œå’Œç”¨æˆ·è§¦å‘çš„äº‹ä»¶ï¼Œæ‰€ä»¥æµ‹è¯• Controller ä»æ¥éƒ½ä¸æ˜¯ä¸€ä»¶ç®€å•çš„äº‹æƒ…ã€‚</p>

<blockquote>
  <p>è¿™ä¸€ç‚¹å¯¹äºä¸€äº›ç±»ä¼¼çš„å…¶ä»–æ¶æ„ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ¯”å¦‚ MVVM æˆ–è€… VIPERï¼Œå¹¿ä¹‰ä¸Šå®ƒä»¬å…¶å®éƒ½æ˜¯ MVCï¼Œåªä¸è¿‡ä½¿ç”¨ View Model æˆ–è€… Presenter æ¥åš Controller è€Œå·²ã€‚å®ƒä»¬å¯¹åº”çš„æ§åˆ¶å™¨çš„èŒè´£ä¾ç„¶æ˜¯åè°ƒ Model å’Œ Viewã€‚</p>
</blockquote>

<p>åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä¼šå…ˆå®ç°ä¸€ä¸ªå¾ˆå¸¸è§çš„ MVC æ¶æ„ï¼Œç„¶åå¯¹çŠ¶æ€å’ŒçŠ¶æ€æ”¹å˜çš„éƒ¨åˆ†è¿›è¡ŒæŠ½è±¡åŠé‡æ„ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªçº¯å‡½æ•°å¼çš„æ˜“äºæµ‹è¯•çš„ View Controller ç±»ã€‚å¸Œæœ›é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œèƒ½å¤Ÿç»™ä½ åœ¨æ—¥å¸¸ç»´æŠ¤ View Controller çš„å·¥ä½œä¸­å¸¦æ¥ä¸€äº›å¯ç¤ºæˆ–è€…å¸®åŠ©ã€‚</p>

<p>å¦‚æœä½ å¯¹ React å’Œ Redux æœ‰æ‰€äº†è§£çš„è¯ï¼Œæ–‡ä¸­çš„ä¸€äº›æ–¹æ³•å¯èƒ½ä½ ä¼šå¾ˆç†Ÿæ‚‰ã€‚ä¸è¿‡å³ä½¿ä½ ä¸äº†è§£å®ƒä»¬ï¼Œä¹Ÿå¹¶ä¸ä¼šå¦¨ç¢ä½ ç†è§£æœ¬æ–‡ã€‚æˆ‘ä¸ä¼šå»ç»†ç©¶æ¦‚å¿µä¸Šçš„ä¸œè¥¿ï¼Œè€Œä¼šä»ä¸€ä¸ªå¤§å®¶éƒ½æ‰€ç†ŸçŸ¥çš„ä¾‹å­å¼€å§‹è¿›è¡Œä»‹ç»ï¼Œæ‰€ä»¥å®Œå…¨ä¸ç”¨æ‹…å¿ƒã€‚ä½ å¯èƒ½éœ€è¦å¯¹ Swift æœ‰ä¸€äº›äº†è§£ï¼Œæœ¬æ–‡ä¼šæ¶‰åŠä¸€äº›åŸºæœ¬çš„å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹çš„åŒºåˆ«ï¼Œå¦‚æœä½ å¯¹æ­¤ä¸æ˜¯å¾ˆæ˜ç™½çš„è¯ï¼Œå¯ä»¥å‚çœ‹ä¸€äº›å…¶ä»–èµ„æ–™ï¼Œæ¯”å¦‚æˆ‘ä»¥å‰å†™çš„<a href="http://swifter.tips/value-reference/">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>

<p>æ•´ä¸ªç¤ºä¾‹é¡¹ç›®æˆ‘æ”¾åœ¨äº† <a href="https://github.com/onevcat/ToDoDemo">GitHub</a> ä¸Šï¼Œä½ å¯ä»¥åœ¨å„ä¸ªåˆ†æ”¯ä¸­æ‰¾åˆ°å¯¹åº”çš„é¡¹ç›®æºç ã€‚</p>

<h2 id="ä¼ ç»Ÿ-mvc-å®ç°">ä¼ ç»Ÿ MVC å®ç°</h2>

<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªç»å…¸çš„ ToDo åº”ç”¨ä½œä¸ºç¤ºä¾‹ã€‚è¿™ä¸ªé¡¹ç›®å¯ä»¥ä»ç½‘ç»œåŠ è½½å¾…åŠäº‹é¡¹ï¼Œæˆ‘ä»¬é€šè¿‡è¾“å…¥æ–‡æœ¬è¿›è¡Œæ·»åŠ ï¼Œæˆ–è€…ç‚¹å‡»å¯¹åº”æ¡ç›®è¿›è¡Œåˆ é™¤ï¼š</p>

<center>
<video width="272" height="480" controls="">
  <source src="/assets/images/2017/todo-video.mp4" type="video/mp4" />
</video>
</center>

<p>æ³¨æ„å‡ ä¸ªç»†èŠ‚ï¼š</p>

<ol>
  <li>æ‰“å¼€åº”ç”¨ååŠ è½½å·²æœ‰å¾…åŠåˆ—è¡¨æ—¶èŠ±è´¹äº†ä¸€äº›æ—¶é—´ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šä»ç½‘ç»œè¯·æ±‚è¿›è¡ŒåŠ è½½ï¼Œè¿™åº”è¯¥æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œã€‚åœ¨ç¤ºä¾‹é¡¹ç›®é‡Œï¼Œæˆ‘ä»¬ä¸ä¼šçœŸçš„å»è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªæœ¬åœ°å­˜å‚¨æ¥æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹ã€‚</li>
  <li>æ ‡é¢˜æ çš„æ•°å­—è¡¨ç¤ºå½“å‰å·²æœ‰çš„å¾…åŠé¡¹ç›®ï¼Œéšç€å¾…åŠçš„å¢å‡ï¼Œè¿™ä¸ªæ•°å­—ä¼šç›¸åº”å˜åŒ–ã€‚</li>
  <li>å¯ä»¥ä½¿ç”¨ç¬¬ä¸€ä¸ª cell è¾“å…¥ï¼Œå¹¶ç”¨å³ä¸Šè§’çš„åŠ å·æ·»åŠ ä¸€ä¸ªå¾…åŠã€‚æˆ‘ä»¬å¸Œæœ›å¾…åŠäº‹é¡¹çš„æ ‡é¢˜é•¿åº¦è‡³å°‘ä¸ºä¸‰ä¸ªå­—ç¬¦ï¼Œåœ¨ä¸æ»¡è¶³é•¿åº¦çš„æ—¶å€™ï¼Œæ·»åŠ æŒ‰é’®ä¸å¯ç”¨ã€‚</li>
</ol>

<p>å®ç°è¿™äº›å¹¶æ²¡æœ‰å¤ªå¤§éš¾åº¦ï¼Œä¸€ä¸ªåˆšå…¥é—¨ iOS çš„æ–°äººä¹Ÿåº”è¯¥èƒ½æ¯«æ— å‹åŠ›æå®šã€‚æˆ‘ä»¬å…ˆæ¥å®ç°æ¨¡æ‹Ÿå¼‚æ­¥è·å–å·²æœ‰å¾…åŠçš„éƒ¨åˆ†ã€‚æ–°å»ºä¸€ä¸ªæ–‡ä»¶ ToDoStore.swift:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">import</span> <span class="kt">Foundation</span>

<span class="k">let</span> <span class="nv">dummy</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"Buy the milk"</span><span class="p">,</span>
    <span class="s">"Take my dog"</span><span class="p">,</span>
    <span class="s">"Rent a car"</span>
<span class="p">]</span>

<span class="kd">struct</span> <span class="kt">ToDoStore</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">shared</span> <span class="o">=</span> <span class="kt">ToDoStore</span><span class="p">()</span>
    <span class="kd">func</span> <span class="nf">getToDoItems</span><span class="p">(</span><span class="nv">completionHandler</span><span class="p">:</span> <span class="p">(([</span><span class="kt">String</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)?)</span> <span class="p">{</span>
        <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="nf">asyncAfter</span><span class="p">(</span><span class="nv">deadline</span><span class="p">:</span> <span class="o">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">completionHandler</span><span class="p">?(</span><span class="n">dummy</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºäº†ç®€æ˜ï¼Œæˆ‘ä»¬ä½¿ç”¨ç®€å•çš„ <code class="highlighter-rouge">String</code> æ¥ä»£è¡¨ä¸€æ¡å¾…åŠã€‚è¿™é‡Œæˆ‘ä»¬ç­‰å¾…äº†ä¸¤ç§’åæ‰è°ƒç”¨å›è°ƒï¼Œä¼ å›ä¸€ç»„é¢„å…ˆå®šä¹‰çš„å¾…åŠäº‹é¡¹ã€‚</p>

<p>ç”±äºæ•´ä¸ªç•Œé¢å°±æ˜¯ä¸€ä¸ª Table Viewï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code class="highlighter-rouge">UITableViewController</code> å­ç±»æ¥å®ç°éœ€æ±‚ã€‚åœ¨ TableViewController.swift ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå±æ€§ <code class="highlighter-rouge">todos</code> æ¥å­˜æ”¾éœ€è¦æ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­çš„å¾…åŠäº‹é¡¹ï¼Œç„¶ååœ¨ <code class="highlighter-rouge">viewDidLoad</code> é‡Œä» <code class="highlighter-rouge">ToDoStore</code> ä¸­è¿›è¡ŒåŠ è½½å¹¶åˆ·æ–° <code class="highlighter-rouge">tableView</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>

    <span class="k">var</span> <span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

        <span class="kt">ToDoStore</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">getToDoItems</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">self</span><span class="o">.</span><span class="n">todos</span> <span class="o">+=</span> <span class="n">data</span>
            <span class="k">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">"TODO - (</span><span class="se">\(</span><span class="k">self</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">)"</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å½“ç„¶ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦æä¾› <code class="highlighter-rouge">UITableViewDataSource</code> çš„ç›¸å…³æ–¹æ³•ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬çš„ Table View æœ‰ä¸¤ä¸ª sectionï¼Œä¸€ä¸ªè´Ÿè´£è¾“å…¥æ–°çš„å¾…åŠï¼Œå¦ä¸€ä¸ªè´Ÿè´£å±•ç¤ºç°æœ‰çš„æ¡ç›®ã€‚ä¸ºäº†è®©ä»£ç æ¸…æ™°è¡¨æ„è‡ªè§£é‡Šï¼Œæˆ‘é€‰æ‹©åœ¨ <code class="highlighter-rouge">TableViewController</code> é‡Œå†…åµŒä¸€ä¸ª <code class="highlighter-rouge">Section</code> æšä¸¾ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="kt">Section</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">todos</span><span class="p">,</span> <span class="n">max</span>
    <span class="p">}</span>
    
    <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç° <code class="highlighter-rouge">UITableViewDataSource</code> æ‰€éœ€è¦çš„æ–¹æ³•äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">numberOfSections</span><span class="p">(</span><span class="k">in</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">Section</span><span class="o">.</span><span class="n">max</span><span class="o">.</span><span class="n">rawValue</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">numberOfRowsInSection</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">section</span> <span class="o">=</span> <span class="kt">Section</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">section</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">fatalError</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="n">section</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">input</span><span class="p">:</span> <span class="k">return</span> <span class="mi">1</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">todos</span><span class="p">:</span> <span class="k">return</span> <span class="n">todos</span><span class="o">.</span><span class="n">count</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">max</span><span class="p">:</span> <span class="nf">fatalError</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">cellForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">section</span> <span class="o">=</span> <span class="kt">Section</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">fatalError</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="k">switch</span> <span class="n">section</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">input</span><span class="p">:</span>
            <span class="c1">// è¿”å› input cell</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">todos</span><span class="p">:</span>
            <span class="c1">// è¿”å› todo item cell</span>
            <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">dequeueReusableCell</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="n">todoCellReuseId</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">todos</span><span class="p">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">cell</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nf">fatalError</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">.todos</code> çš„æƒ…å†µä¸‹å¾ˆç®€å•ï¼Œæˆ‘ä»¬å°±ç”¨æ ‡å‡†çš„ <code class="highlighter-rouge">UITableViewCell</code> å°±å¥½ã€‚å¯¹äº <code class="highlighter-rouge">.input</code> çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦åœ¨ cell é‡ŒåµŒä¸€ä¸ª <code class="highlighter-rouge">UITextField</code>ï¼Œå¹¶ä¸”è¦åœ¨å…¶ä¸­çš„æ–‡æœ¬æ”¹å˜æ—¶èƒ½å‘ŠçŸ¥ <code class="highlighter-rouge">TableViewController</code>ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„ delegate çš„æ¨¡å¼æ¥å®ç°ï¼Œä¸‹é¢æ˜¯ TableViewInputCell.swift çš„å†…å®¹ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">TableViewInputCellDelegate</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">inputChanged</span><span class="p">(</span><span class="nv">cell</span><span class="p">:</span> <span class="kt">TableViewInputCell</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">TableViewInputCell</span><span class="p">:</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">delegate</span><span class="p">:</span> <span class="kt">TableViewInputCellDelegate</span><span class="p">?</span>
    <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">textField</span><span class="p">:</span> <span class="kt">UITextField</span><span class="o">!</span>
    
    <span class="kd">@objc</span> <span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">textFieldValueChanged</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">UITextField</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">delegate</span><span class="p">?</span><span class="o">.</span><span class="nf">inputChanged</span><span class="p">(</span><span class="nv">cell</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="n">sender</span><span class="o">.</span><span class="n">text</span> <span class="p">??</span> <span class="s">""</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬åœ¨ Storyboard ä¸­åˆ›å»ºå¯¹åº”çš„ table view å’Œè¿™ä¸ª cellï¼Œç„¶åå°†å…¶ä¸­çš„ text field çš„ <code class="highlighter-rouge">.editingChanged</code> äº‹ä»¶ç»‘åˆ° <code class="highlighter-rouge">textFieldValueChanged</code> ä¸Šã€‚æ¯æ¬¡å½“ç”¨æˆ·è¿›è¡Œè¾“å…¥æ—¶ï¼Œ<code class="highlighter-rouge">delegate</code> çš„æ–¹æ³•å°†è¢«è°ƒç”¨ã€‚</p>

<p>åœ¨ <code class="highlighter-rouge">TableViewController</code> é‡Œï¼Œç°åœ¨å¯ä»¥è¿”å› <code class="highlighter-rouge">.input</code> çš„ cellï¼Œå¹¶è®¾ç½®å¯¹åº”çš„ä»£ç†æ–¹æ³•æ¥æ›´æ–°æ·»åŠ æŒ‰é’®äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">class</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">cellForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">section</span> <span class="o">=</span> <span class="kt">Section</span><span class="p">(</span><span class="nv">rawValue</span><span class="p">:</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">fatalError</span><span class="p">()</span>
        <span class="p">}</span>
        
        <span class="k">switch</span> <span class="n">section</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">input</span><span class="p">:</span>
            <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">dequeueReusableCell</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="n">inputCellReuseId</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span> <span class="k">as!</span> <span class="kt">TableViewInputCell</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
            <span class="k">return</span> <span class="n">cell</span>
        <span class="c1">//...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">TableViewInputCellDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">inputChanged</span><span class="p">(</span><span class="nv">cell</span><span class="p">:</span> <span class="kt">TableViewInputCell</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">isItemLengthEnough</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span>
        <span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="n">isItemLengthEnough</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œè¿è¡Œç¨‹åºåç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè¯»å…¥çš„å¾…åŠäº‹é¡¹å°±å¯ä»¥è¢«å±•ç¤ºäº†ã€‚æ¥ä¸‹æ¥ï¼Œæ·»åŠ å¾…åŠå’Œç§»é™¤å¾…åŠçš„éƒ¨åˆ†å¾ˆå®¹æ˜“å®ç°ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    <span class="c1">// æ·»åŠ å¾…åŠ</span>
    <span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">addButtonPressed</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">inputIndexPath</span> <span class="o">=</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">Section</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">inputCell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">cellForRow</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">inputIndexPath</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">TableViewInputCell</span><span class="p">,</span>
              <span class="k">let</span> <span class="nv">text</span> <span class="o">=</span> <span class="n">inputCell</span><span class="o">.</span><span class="n">textField</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="n">todos</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">inputCell</span><span class="o">.</span><span class="n">textField</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">""</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">"TODO - (</span><span class="se">\(</span><span class="n">todos</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">)"</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// ç§»é™¤å¾…åŠ</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        
        <span class="n">todos</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s">"TODO - (</span><span class="se">\(</span><span class="n">todos</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">)"</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>ä¸ºäº†ä¿æŒç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥ <code class="highlighter-rouge">tableView.reloadData()</code> äº†ï¼Œè®²é“ç†çš„è¯æ›´å¥½çš„é€‰æ‹©æ˜¯åªé’ˆå¯¹å˜åŠ¨çš„éƒ¨åˆ†åš <code class="highlighter-rouge">insert</code> æˆ–è€… <code class="highlighter-rouge">remove</code>ï¼Œä½†ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°±ç›´æ¥é‡è½½æ•´ä¸ª table view äº†ã€‚</p>
</blockquote>

<p>å¥½äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ä¸€ç™¾è¡Œéƒ½ä¸åˆ°çš„ View Controllerï¼Œå¯èƒ½ä¹Ÿæ˜¯æˆ‘ä»¬æ¯å¤©éƒ½ä¼šå†™çš„ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸å¹æ§è¿™æ ·çš„ä»£ç â€œæ¡ç†æ¸…æ™°â€æˆ–è€…â€œç®€æ´æ˜äº†â€äº†ï¼Œä½ æˆ‘éƒ½çŸ¥é“è¿™åªæ˜¯åœ¨ View Controller è§„æ¨¡å°šå°æ—¶çš„å‡è±¡è€Œå·²ã€‚è®©æˆ‘ä»¬ç›´æ¥æ¥çœ‹çœ‹æ½œåœ¨çš„é—®é¢˜ï¼š</p>

<ol>
  <li>UI ç›¸å…³çš„ä»£ç æ•£è½å„å¤„ - é‡è½½ <code class="highlighter-rouge">tableView</code> å’Œè®¾ç½® <code class="highlighter-rouge">title</code> çš„ä»£ç å‡ºç°äº†ä¸‰æ¬¡ï¼Œè®¾ç½®å³ä¸Š button çš„ <code class="highlighter-rouge">isEnabled</code> çš„ä»£ç å­˜åœ¨äº extension ä¸­ï¼Œæ·»åŠ æ–°é¡¹ç›®æ—¶æˆ‘ä»¬å…ˆè·å–äº†è¾“å…¥çš„ cellï¼Œç„¶åå†è¯»å– cell ä¸­çš„æ–‡æœ¬ã€‚è¿™äº›æ•£è½åœ¨å„å¤„çš„ UI æ“ä½œå°†ä¼šæˆä¸ºéšæ‚£ï¼Œå› ä¸ºä½ å¯èƒ½åœ¨ä»£ç çš„ä»»æ„éƒ¨åˆ†æ“ä½œè¿™äº› UIï¼Œè€Œå®ƒä»¬çš„çŠ¶æ€å°†éšç€ä»£ç çš„å¤æ‚å˜å¾—â€œé£˜å¿½ä¸å®šâ€ã€‚</li>
  <li>å› ä¸º 1 çš„çŠ¶æ€å¤æ‚ï¼Œä½¿å¾— View Controller éš¾ä»¥æµ‹è¯• - ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æƒ³æµ‹è¯• <code class="highlighter-rouge">title</code> çš„æ–‡å­—æ­£ç¡®ï¼Œä½ å¯èƒ½éœ€è¦æ‰‹åŠ¨å‘åˆ—è¡¨é‡Œæ·»åŠ ä¸€ä¸ªå¾…åŠäº‹é¡¹ï¼Œè¿™æ¶‰åŠåˆ°è°ƒç”¨ <code class="highlighter-rouge">addButtonPressed</code>ï¼Œè€Œè¿™ä¸ªæ–¹æ³•éœ€è¦è¯»å– <code class="highlighter-rouge">inputCell</code> çš„æ–‡æœ¬ï¼Œé‚£ä¹ˆä½ å¯èƒ½è¿˜éœ€è¦å…ˆå»è®¾ç½®è¿™ä¸ª cell ä¸­ <code class="highlighter-rouge">UITextField</code> çš„ <code class="highlighter-rouge">text</code> å€¼ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ç”¨ä¾èµ–æ³¨å…¥çš„æ–¹å¼ç»™ <code class="highlighter-rouge">add</code> æ–¹æ³•ä¸€ä¸ªæ–‡æœ¬å‚æ•°ï¼Œæˆ–è€…å°† <code class="highlighter-rouge">todos.insert</code> å’Œä¹‹åçš„å†…å®¹æå–æˆä¸€ä¸ªæ–°çš„æ–¹æ³•ï¼Œä½†æ˜¯æ— è®ºæ€ä¹ˆæ ·ï¼Œå¯¹äº model çš„æ“ä½œå’Œå¯¹äº UI çš„æ›´æ–°éƒ½æ²¡æœ‰åˆ†ç¦» (å› ä¸ºæ¯•ç«Ÿæˆ‘ä»¬å†™çš„å°±æ˜¯â€œèƒ¶æ°´ä»£ç â€)ã€‚è¿™æ­£æ˜¯ä½ è§‰å¾— View Controller éš¾ä»¥æµ‹è¯•çš„æœ€ä¸»è¦åŸå› ã€‚</li>
  <li>å› ä¸º 2 çš„éš¾ä»¥æµ‹è¯•ï¼Œæœ€åè®© View Controller éš¾ä»¥é‡æ„ - çŠ¶æ€å’Œ UI å¤æ‚åº¦çš„å¢åŠ å¾€å¾€ä¼šå¯¼è‡´å¤šä¸ª UI æ“ä½œç»´æŠ¤ç€åŒä¸€ä¸ªå˜é‡ï¼Œæˆ–è€…å¤šä¸ªçŠ¶æ€å˜é‡å»æ›´æ–°åŒä¸€ä¸ª UI å…ƒç´ ã€‚ä¸è®ºæ˜¯å“ªç§æƒ…å†µï¼Œéƒ½è®©æµ‹è¯•å˜å¾—å‡ ä¹ä¸å¯èƒ½ï¼Œä¹Ÿä¼šè®©åç»­çš„å¼€å‘äººå‘˜ (å…¶å®å¾€å¾€å°±æ˜¯ä½ è‡ªå·±ï¼) åœ¨é¢å¯¹å¤æ‚æƒ…å†µä¸‹éš¾ä»¥æ­£ç¡®åœ°ç»§ç»­å¼€å‘ã€‚Massive View Controller æœ€ç»ˆçš„ç»“æœå¸¸å¸¸æ˜¯ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«ï¼Œä¸€ä¸ªå¾®å°çš„æ”¹åŠ¨å¯èƒ½éƒ½éœ€è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´è¿›è¡ŒéªŒè¯ï¼Œè€Œä¸”è¿˜æ²¡æœ‰äººæ•¢æ‹èƒ¸è„¯ä¿è¯æ­£ç¡®æ€§ã€‚è¿™ä¼šè®©é¡¹ç›®é€æ¸é™·å…¥æ³¥æ½­ã€‚</li>
</ol>

<p>è¿™äº›é—®é¢˜æœ€ç»ˆå¯¼è‡´ï¼Œè¿™æ ·ä¸€ä¸ª View Controller éš¾ä»¥ scalingã€‚åœ¨é€æ¸è¢«ä»£ç å¡«æ»¡åˆ°ä¸€ä¸¤åƒè¡Œæ—¶ï¼Œè¿™ä¸ª View Controller å°†å½»åº•â€œæ­»å»â€ï¼Œå¯¹å®ƒçš„ç»´æŠ¤å’Œæ›´æ”¹ä¼šå›°éš¾é‡é‡ã€‚</p>

<blockquote>
  <p>ä½ å¯ä»¥åœ¨ GitHub repo çš„ <a href="https://github.com/onevcat/ToDoDemo/tree/basic">basic åˆ†æ”¯</a>æ‰¾åˆ°å¯¹åº”è¿™éƒ¨åˆ†çš„ä»£ç ã€‚</p>
</blockquote>

<h2 id="åŸºäº-state-çš„-view-controller">åŸºäº State çš„ View Controller</h2>

<h3 id="é€šè¿‡æå–-state-ç»Ÿåˆ-ui-æ“ä½œ">é€šè¿‡æå– State ç»Ÿåˆ UI æ“ä½œ</h3>

<p>ä¸Šé¢çš„ä¸‰ä¸ªé—®é¢˜å…¶å®ç¯ç¯ç›¸æ‰£ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å°† UI ç›¸å…³ä»£ç é›†ä¸­èµ·æ¥ï¼Œå¹¶ç”¨å•ä¸€çš„çŠ¶æ€å»ç®¡ç†å®ƒï¼Œå°±å¯ä»¥è®© View Controller çš„å¤æ‚åº¦é™ä½å¾ˆå¤šã€‚æˆ‘ä»¬å°è¯•çœ‹çœ‹ï¼</p>

<p>åœ¨è¿™ä¸ªç®€å•çš„ç•Œé¢ä¸­ï¼Œå’Œ UI ç›¸å…³çš„ model åŒ…æ‹¬å¾…åŠæ¡ç›® <code class="highlighter-rouge">todos</code> (ç”¨æ¥ç»„ç»‡ table view å’Œæ›´æ–°æ ‡é¢˜æ ) ä»¥åŠè¾“å…¥çš„ <code class="highlighter-rouge">text</code> (ç”¨æ¥å†³å®šæ·»åŠ æŒ‰é’®çš„ enable å’Œæ·»åŠ  todo æ—¶çš„å†…å®¹)ã€‚æˆ‘ä»¬å°†è¿™ä¸¤ä¸ªå˜é‡è¿›è¡Œç®€å•çš„å°è£…ï¼Œåœ¨ <code class="highlighter-rouge">TableViewController</code> é‡Œæ·»åŠ ä¸€ä¸ªå†…åµŒçš„ <code class="highlighter-rouge">State</code> ç»“æ„ä½“ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    
    <span class="kd">struct</span> <span class="kt">State</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
        <span class="k">let</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span>
    <span class="p">}</span>
    
    <span class="k">var</span> <span class="nv">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">text</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±æœ‰ä¸€ä¸ªç»Ÿä¸€æŒ‰ç…§çŠ¶æ€æ›´æ–° UI çš„åœ°æ–¹äº†ã€‚ä½¿ç”¨ <code class="highlighter-rouge">state</code> çš„ <code class="highlighter-rouge">didSet</code> å³å¯ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">text</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">didSet</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">oldValue</span><span class="o">.</span><span class="n">todos</span> <span class="o">!=</span> <span class="n">state</span><span class="o">.</span><span class="n">todos</span> <span class="p">{</span>
            <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">"TODO - (</span><span class="se">\(</span><span class="n">state</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">)"</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">oldValue</span><span class="o">.</span><span class="n">text</span> <span class="o">!=</span> <span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">isItemLengthEnough</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span>
            <span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="n">isItemLengthEnough</span>

            <span class="k">let</span> <span class="nv">inputIndexPath</span> <span class="o">=</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">Section</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">inputCell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">cellForRow</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">inputIndexPath</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">TableViewInputCell</span>
            <span class="n">inputCell</span><span class="p">?</span><span class="o">.</span><span class="n">textField</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">text</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œæˆ‘ä»¬å°†æ–°å€¼å’Œæ—§å€¼è¿›è¡Œäº†ä¸€äº›æ¯”è¾ƒï¼Œä»¥é¿å…ä¸å¿…è¦çš„ UI æ›´æ–°ã€‚æ¥ä¸‹æ¥ï¼Œå°±å¯ä»¥å°†åŸæ¥ <code class="highlighter-rouge">TableViewController</code> ä¸­å¯¹ UI çš„æ“ä½œæ¢æˆå¯¹ <code class="highlighter-rouge">state</code> çš„æ“ä½œäº†ã€‚</p>

<p>æ¯”å¦‚ï¼Œåœ¨ <code class="highlighter-rouge">viewDidLoad</code> ä¸­ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å˜æ›´å‰</span>
<span class="kt">ToDoStore</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">getToDoItems</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">self</span><span class="o">.</span><span class="n">todos</span> <span class="o">+=</span> <span class="n">data</span>
    <span class="k">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">"TODO - (</span><span class="se">\(</span><span class="k">self</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">)"</span>
    <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// å˜æ›´å</span>
<span class="kt">ToDoStore</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">getToDoItems</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">todos</span> <span class="o">+</span> <span class="n">data</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç‚¹å‡» cell ç§»é™¤å¾…åŠæ—¶ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å˜æ›´å‰</span>
<span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">guard</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span> <span class="k">else</span> <span class="p">{</span>
       <span class="k">return</span>
   <span class="p">}</span>
   
   <span class="n">todos</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
   <span class="n">title</span> <span class="o">=</span> <span class="s">"TODO - (</span><span class="se">\(</span><span class="n">todos</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">)"</span>
   <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// å˜æ›´å</span>
<span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">guard</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span>
     <span class="p">}</span>
   
     <span class="k">let</span> <span class="nv">newTodos</span> <span class="o">=</span> <span class="kt">Array</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">todos</span><span class="p">[</span><span class="o">..&lt;</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">todos</span><span class="p">[(</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">...</span><span class="p">])</span>
     <span class="n">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="n">newTodos</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨è¾“å…¥æ¡†é”®å…¥æ–‡å­—æ—¶ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å˜æ›´å‰</span>
<span class="kd">func</span> <span class="nf">inputChanged</span><span class="p">(</span><span class="nv">cell</span><span class="p">:</span> <span class="kt">TableViewInputCell</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">let</span> <span class="nv">isItemLengthEnough</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span>
     <span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="n">isItemLengthEnough</span>
<span class="p">}</span>

<span class="c1">// å˜æ›´å</span>
<span class="kd">func</span> <span class="nf">inputChanged</span><span class="p">(</span><span class="nv">cell</span><span class="p">:</span> <span class="kt">TableViewInputCell</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">todos</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="n">text</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¦å¤–ï¼Œæœ€å€¼å¾—ä¸€æçš„å¯èƒ½æ˜¯æ·»åŠ å¾…åŠäº‹é¡¹æ—¶çš„ä»£ç å˜åŒ–ã€‚å¯ä»¥çœ‹åˆ°å¼•å…¥ç»Ÿä¸€çš„çŠ¶æ€å˜æ›´åï¼Œä»£ç å˜å¾—éå¸¸ç®€å•æ¸…æ™°ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å˜æ›´å‰</span>
<span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">addButtonPressed</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">inputIndexPath</span> <span class="o">=</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">Section</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">inputCell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">cellForRow</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">inputIndexPath</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">TableViewInputCell</span><span class="p">,</span>
          <span class="k">let</span> <span class="nv">text</span> <span class="o">=</span> <span class="n">inputCell</span><span class="o">.</span><span class="n">textField</span><span class="o">.</span><span class="n">text</span> <span class="k">else</span>
    <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="n">todos</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">inputCell</span><span class="o">.</span><span class="n">textField</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">""</span>
    <span class="n">title</span> <span class="o">=</span> <span class="s">"TODO - (</span><span class="se">\(</span><span class="n">todos</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">)"</span>
    <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// å˜æ›´å</span>
<span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">addButtonPressed</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">]</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">todos</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>å¦‚æœä½ å¯¹ React æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œå¯ä»¥ä»ä¸­å‘ç°ä¸€äº›ç±»ä¼¼çš„æ€æƒ³ã€‚React é‡Œæˆ‘ä»¬è‡ªä¸Šè€Œä¸‹ä¼ é€’ <code class="highlighter-rouge">Props</code>ï¼Œå¹¶ä¸”åœ¨ Component è‡ªèº«é€šè¿‡ <code class="highlighter-rouge">setState</code> è¿›è¡ŒçŠ¶æ€ç®¡ç†ã€‚æ‰€æœ‰çš„ <code class="highlighter-rouge">Component</code> éƒ½æ˜¯åŸºäºä¼ å…¥çš„ <code class="highlighter-rouge">Props</code> å’Œè‡ªèº«çš„ <code class="highlighter-rouge">State</code> çš„ã€‚View Controller ä¸­çš„ä¸åŒä¹‹å¤„åœ¨äºï¼ŒReact ä½¿ç”¨äº†æ›´ä¸ºæè¿°å¼çš„æ–¹å¼æ›´æ–° UI (è™šæ‹Ÿ DOM)ï¼Œè€Œç°åœ¨æˆ‘ä»¬å¯èƒ½éœ€è¦ç”¨è¿‡ç¨‹è¯­è¨€è‡ªå·±è¿›è¡Œå®ç°ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä½¿ç”¨ <code class="highlighter-rouge">State</code> çš„ <code class="highlighter-rouge">TableViewController</code> åœ¨å·¥ä½œæ–¹å¼ä¸Šä¸ React çš„ <code class="highlighter-rouge">Component</code> ååˆ†ç±»ä¼¼ã€‚</p>
</blockquote>

<h3 id="æµ‹è¯•-state-view-controller">æµ‹è¯• State View Controller</h3>

<p>åœ¨åŸºäº <code class="highlighter-rouge">State</code> çš„å®ç°ä¸‹ï¼Œç”¨æˆ·çš„æ“ä½œè¢«ç»Ÿä¸€ä¸ºçŠ¶æ€çš„å˜æ›´ï¼Œè€ŒçŠ¶æ€çš„å˜æ›´å°†ç»Ÿä¸€åœ°å»æ›´æ–°å½“å‰çš„ UIã€‚è¿™è®© View Controller çš„æµ‹è¯•å˜å¾—å®¹æ˜“å¾ˆå¤šã€‚æˆ‘ä»¬å¯ä»¥å°†æœ¬æ¥æ··æ‚åœ¨ä¸€èµ·çš„è¡Œä¸ºåˆ†ç¦»å¼€æ¥ï¼šé¦–å…ˆï¼Œæµ‹è¯•çŠ¶æ€å˜æ›´å¯ä»¥å¯¼è‡´æ­£ç¡®çš„ UIï¼›ç„¶åï¼Œæµ‹è¯•ç”¨æˆ·è¾“å…¥å¯ä»¥å¯¼è‡´æ­£ç¡®çš„çŠ¶æ€å˜æ›´ï¼Œè¿™æ ·å³å¯è¦†ç›– View Controller çš„æµ‹è¯•ã€‚</p>

<p>è®©æˆ‘ä»¬å…ˆæ¥æµ‹è¯•çŠ¶æ€å˜æ›´å¯¼è‡´çš„ UI å˜åŒ–ï¼Œåœ¨å•å…ƒæµ‹è¯•ä¸­ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testSettingState</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// åˆå§‹çŠ¶æ€</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">numberOfRows</span><span class="p">(</span><span class="nv">inSection</span><span class="p">:</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">"TODO - (0)"</span><span class="p">)</span>
    <span class="kt">XCTAssertFalse</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">!.</span><span class="n">isEnabled</span><span class="p">)</span>

    <span class="c1">// ([], "") -&gt; (["1", "2", "3"], "abc")</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="s">"1"</span><span class="p">,</span> <span class="s">"2"</span><span class="p">,</span> <span class="s">"3"</span><span class="p">],</span> <span class="nv">text</span><span class="p">:</span> <span class="s">"abc"</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">numberOfRows</span><span class="p">(</span><span class="nv">inSection</span><span class="p">:</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">cellForRow</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="nf">todoItemIndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">))?</span><span class="o">.</span><span class="n">textLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">"2"</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">"TODO - (3)"</span><span class="p">)</span>
    <span class="kt">XCTAssertTrue</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">!.</span><span class="n">isEnabled</span><span class="p">)</span>

    <span class="c1">// (["1", "2", "3"], "abc") -&gt; ([], "")</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">text</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">numberOfRows</span><span class="p">(</span><span class="nv">inSection</span><span class="p">:</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">"TODO - (0)"</span><span class="p">)</span>
    <span class="kt">XCTAssertFalse</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">!.</span><span class="n">isEnabled</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„åˆå§‹çŠ¶æ€æ˜¯æˆ‘ä»¬åœ¨ Storyboard æˆ–è€…ç›¸åº”çš„ <code class="highlighter-rouge">viewDidLoad</code> ä¹‹ç±»çš„æ–¹æ³•é‡Œè®¾å®šçš„ UIã€‚æˆ‘ä»¬ç¨åä¼šå¯¹è¿™ä¸ªçŠ¶æ€è¿›è¡Œè¿›ä¸€æ­¥çš„è®¨è®ºã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æµ‹è¯•ç”¨æˆ·çš„äº¤äº’è¡Œä¸ºå¯¼è‡´çš„çŠ¶æ€å˜æ›´äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testAdding</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">testItem</span> <span class="o">=</span> <span class="s">"Test Item"</span>

    <span class="k">let</span> <span class="nv">originalTodos</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">todos</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="n">originalTodos</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="n">testItem</span><span class="p">)</span>
    <span class="n">controller</span><span class="o">.</span><span class="nf">addButtonPressed</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">todos</span><span class="p">,</span> <span class="p">[</span><span class="n">testItem</span><span class="p">]</span> <span class="o">+</span> <span class="n">originalTodos</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
<span class="p">}</span>
    
<span class="kd">func</span> <span class="nf">testRemoving</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="s">"1"</span><span class="p">,</span> <span class="s">"2"</span><span class="p">,</span> <span class="s">"3"</span><span class="p">],</span> <span class="nv">text</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
    <span class="n">controller</span><span class="o">.</span><span class="nf">tableView</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">tableView</span><span class="p">,</span> <span class="nv">didSelectRowAt</span><span class="p">:</span> <span class="nf">todoItemIndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">))</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">todos</span><span class="p">,</span> <span class="p">[</span><span class="s">"1"</span><span class="p">,</span> <span class="s">"3"</span><span class="p">])</span>
<span class="p">}</span>
    
<span class="kd">func</span> <span class="nf">testInputChanged</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">controller</span><span class="o">.</span><span class="nf">inputChanged</span><span class="p">(</span><span class="nv">cell</span><span class="p">:</span> <span class="kt">TableViewInputCell</span><span class="p">(),</span> <span class="nv">text</span><span class="p">:</span> <span class="s">"Hello"</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">"Hello"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>çœ‹èµ·æ¥å¾ˆèµï¼Œæˆ‘ä»¬çš„å•å…ƒæµ‹è¯•è¦†ç›–äº†å„ç§ç”¨æˆ·äº¤äº’ï¼Œé…åˆä¸Š state å˜æ›´å¯¼è‡´çš„ UI å˜åŒ–ï¼Œæˆ‘ä»¬å‡ ä¹å¯ä»¥ç¡®å®šè¿™ä¸ª View Controller å°†ä¼šæŒ‰ç…§æˆ‘ä»¬çš„è®¾æƒ³æ­£ç¡®å·¥ä½œäº†ï¼</p>

<blockquote>
  <p>åœ¨ä¸Šé¢æˆ‘åªè´´å‡ºäº†ä¸€äº›å…³é”®çš„å˜æ›´ï¼Œå…³äºæµ‹è¯•çš„é…ç½®ä»¥åŠä¸€äº›å…¶ä»–ç»†èŠ‚ï¼Œä½ å¯ä»¥å‚çœ‹ GitHub repo çš„ <a href="https://github.com/onevcat/ToDoDemo/tree/state">state åˆ†æ”¯</a>ã€‚</p>
</blockquote>

<h3 id="state-view-controller-çš„é—®é¢˜">State View Controller çš„é—®é¢˜</h3>

<p>è¿™ç§åŸºäº State çš„ View Controller è™½ç„¶æ¯”åŸæ¥å¥½äº†å¾ˆå¤šï¼Œä½†æ˜¯ä¾ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¹Ÿè¿˜æœ‰å¤§é‡çš„æ”¹è¿›ç©ºé—´ã€‚ä¸‹é¢æ˜¯å‡ ä¸ªä¸»è¦çš„å¿§è™‘ï¼š</p>

<ol>
  <li>
    <p>åˆå§‹åŒ–æ—¶çš„ UI - æˆ‘ä»¬ä¸Šé¢è¯´åˆ°è¿‡ï¼Œåˆå§‹çŠ¶æ€çš„ UI æ˜¯æˆ‘ä»¬åœ¨ Storyboard æˆ–è€…ç›¸åº”çš„ <code class="highlighter-rouge">viewDidLoad</code> ä¹‹ç±»çš„æ–¹æ³•é‡Œè®¾å®šçš„ã€‚è¿™å°†å¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬æ— æ³•é€šè¿‡è®¾ç½® <code class="highlighter-rouge">state</code> å±æ€§çš„æ–¹å¼æ¥è®¾ç½®åˆå§‹ UIã€‚å› ä¸º <code class="highlighter-rouge">state</code> çš„ <code class="highlighter-rouge">didSet</code> ä¸ä¼šåœ¨ controller åˆå§‹åŒ–ä¸­é¦–æ¬¡èµ‹å€¼æ—¶è¢«è°ƒç”¨ï¼Œå› æ­¤å¦‚æœæˆ‘ä»¬åœ¨ <code class="highlighter-rouge">viewDidLoad</code> ä¸­æ·»åŠ å¦‚ä¸‹è¯­å¥çš„è¯ï¼Œä¼šå› ä¸ºæ–°çš„çŠ¶æ€å’Œåˆå§‹ç›¸åŒï¼Œè€Œå¯¼è‡´ UI ä¸å‘ç”Ÿæ›´æ–°ï¼š</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        
     <span class="c1">// UI æ›´æ–°ä¼šè¢«è·³è¿‡ï¼Œå› ä¸ºè¯¥ state å’Œåˆå§‹å€¼çš„ä¸€æ ·</span>
     <span class="n">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">text</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
 <span class="p">}</span>
</code></pre></div>    </div>

    <p>åœ¨åˆå§‹ UI è®¾ç½®æ­£ç¡®çš„æƒ…å†µä¸‹ï¼Œè¿™å€’æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯å¦‚æœ UI çŠ¶æ€åŸæœ¬å­˜åœ¨ä¸å¯¹çš„è¯ï¼Œå°±å°†å¯¼è‡´æ¥ä¸‹æ¥çš„ UI éƒ½æ˜¯é”™è¯¯çš„ã€‚ä»æ›´é«˜å±‚æ¬¡æ¥çœ‹ï¼Œä¹Ÿå°±æ˜¯ <code class="highlighter-rouge">state</code> å±æ€§å¯¹ UI çš„æ§åˆ¶ä¸ä»…ä»…æ¶‰åŠåˆ°æ–°çš„çŠ¶æ€ï¼ŒåŒæ—¶ä¹Ÿå–å†³äºåŸæœ‰çš„ <code class="highlighter-rouge">state</code> å€¼ã€‚è¿™ä¼šå¯¼è‡´ä¸€äº›é¢å¤–å¤æ‚åº¦ï¼Œæ˜¯æˆ‘ä»¬æƒ³è¦é¿å…çš„ã€‚ç†æƒ³çŠ¶æ€ä¸‹ï¼ŒUI çš„æ›´æ–°åº”è¯¥åªå’Œè¾“å…¥æœ‰å…³ï¼Œè€Œä¸å½“å‰çŠ¶æ€æ— å…³ (ä¹Ÿå°±æ˜¯â€œçº¯å‡½æ•°å¼â€ï¼Œæˆ‘ä»¬ç¨åå†å…·ä½“ä»‹ç»)ã€‚</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">State</code> éš¾ä»¥æ‰©å±• - ç°åœ¨ <code class="highlighter-rouge">State</code> ä¸­åªæœ‰ä¸¤ä¸ªå˜é‡ <code class="highlighter-rouge">todos</code> å’Œ <code class="highlighter-rouge">text</code>ï¼Œå¦‚æœ View Controller ä¸­è¿˜éœ€è¦å…¶ä»–çš„å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒç»§ç»­æ·»åŠ åˆ° <code class="highlighter-rouge">State</code> ç»“æ„ä½“ä¸­ã€‚ä¸è¿‡åœ¨å®è·µä¸­è¿™ä¼šååˆ†å›°éš¾ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æ›´æ–°æ‰€æœ‰çš„ <code class="highlighter-rouge">state</code> èµ‹å€¼çš„éƒ¨åˆ†ã€‚æ¯”å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª <code class="highlighter-rouge">loading</code> æ¥è¡¨ç¤ºæ­£åœ¨åŠ è½½å¾…åŠï¼š</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">struct</span> <span class="kt">State</span> <span class="p">{</span>
     <span class="k">let</span> <span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
     <span class="k">let</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span>
     <span class="k">let</span> <span class="nv">loading</span><span class="p">:</span> <span class="kt">Bool</span>
 <span class="p">}</span>
    
 <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        
     <span class="n">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">todos</span> <span class="o">+</span> <span class="n">data</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nv">loading</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
     <span class="kt">ToDoStore</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">getToDoItems</span> <span class="p">{</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">in</span>
         <span class="k">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="kt">State</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">todos</span> <span class="o">+</span> <span class="n">data</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="nv">loading</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>

    <p>é™¤æ­¤ä¹‹å¤–ï¼Œåƒæ˜¯æ·»åŠ å¾…åŠï¼Œåˆ é™¤å¾…åŠç­‰å­˜åœ¨ <code class="highlighter-rouge">state</code> èµ‹å€¼çš„åœ°æ–¹ï¼Œæˆ‘ä»¬éƒ½éœ€è¦åœ¨åŸæ¥çš„åˆå§‹åŒ–æ–¹æ³•ä¸ŠåŠ ä¸Š <code class="highlighter-rouge">loading</code> å‚æ•°ã€‚è¯•æƒ³ï¼Œå¦‚æœæˆ‘ä»¬ç¨ååˆæ·»åŠ äº†ä¸€ä¸ªå˜é‡ï¼Œæˆ‘ä»¬åˆ™éœ€è¦å†æ¬¡ç»´æŠ¤æ‰€æœ‰è¿™äº›åœ°æ–¹ï¼Œè¿™æ˜¾ç„¶æ˜¯æ— æ³•æ¥å—çš„ã€‚</p>

    <p>å½“ç„¶ï¼Œå› ä¸º <code class="highlighter-rouge">State</code> æ˜¯å€¼ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å°† <code class="highlighter-rouge">State</code> ä¸­çš„å˜é‡å£°æ˜ä» <code class="highlighter-rouge">let</code> æ”¹ä¸º <code class="highlighter-rouge">var</code>ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è®¾ç½® <code class="highlighter-rouge">state</code> ä¸­çš„å±æ€§äº†ï¼Œä¾‹å¦‚ï¼š</p>

    <div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">state</span><span class="o">.</span><span class="n">todos</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">todos</span> <span class="o">+</span> <span class="n">data</span>
 <span class="n">state</span><span class="o">.</span><span class="n">loading</span> <span class="o">=</span> <span class="kc">true</span>
</code></pre></div>    </div>

    <p>è¿™ç§æƒ…å†µä¸‹ï¼Œ<code class="highlighter-rouge">State</code> çš„ <code class="highlighter-rouge">didSet</code> å°†è¢«è°ƒç”¨å¤šæ¬¡ï¼Œè™½ç„¶ä¸å¤ªèˆ’æœï¼Œä½†å€’ä¹Ÿä¸æ˜¯å¾ˆå¤§çš„é—®é¢˜ã€‚æ›´å…³é”®çš„åœ°æ–¹åœ¨äºï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬åˆå°†çŠ¶æ€çš„ç»´æŠ¤é›¶æ•£åœ°åˆ†è½åœ¨å„ä¸ªåœ°æ–¹ã€‚å½“çŠ¶æ€ä¸­çš„å˜é‡è¶Šæ¥è¶Šå¤šï¼Œè€Œä¸”çŠ¶æ€è‡ªèº«ä¹‹é—´æœ‰æ‰€ä¾èµ–çš„è¯ï¼Œè¿™ä¹ˆåšåˆå°†æˆ‘ä»¬ç½®äºéº»çƒ¦ä¹‹ä¸­ã€‚æˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ï¼Œå¦‚æœ <code class="highlighter-rouge">State</code> ä¸­åŒ…å«å¼•ç”¨ç±»å‹ï¼Œé‚£ä¹ˆå®ƒå°†å¤±å»å®Œå…¨çš„å€¼è¯­ä¹‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä½ å»æ”¹å˜äº† <code class="highlighter-rouge">state</code> ä¸­å¼•ç”¨ç±»å‹é‡Œçš„æŸä¸ªå˜é‡æ—¶ï¼Œ<code class="highlighter-rouge">state</code> çš„ <code class="highlighter-rouge">didSet</code> å°†ä¸ä¼šè¢«è°ƒç”¨ã€‚è¿™è®©æˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶éœ€è¦å¦‚å±¥è–„å†°ï¼Œä¸€æ—¦è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œè°ƒè¯•ä¹Ÿä¼šç›¸å¯¹å›°éš¾ã€‚</p>
  </li>
  <li>Data Source é‡ç”¨ - æˆ‘ä»¬å…¶å®æœ‰æœºä¼šå°† Table View çš„ Data Source éƒ¨åˆ†æå–å‡ºæ¥ï¼Œè®©å®ƒåœ¨ä¸åŒçš„ View Controller ä¸­è¢«é‡å¤åˆ©ç”¨ã€‚ä½†æ˜¯ç°åœ¨æ–°å¼•å…¥çš„ <code class="highlighter-rouge">state</code> é˜»æ­¢äº†è¿™ä¸€å¯èƒ½æ€§ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦é‡ç”¨ <code class="highlighter-rouge">dataSource</code>ï¼Œæˆ‘ä»¬éœ€è¦å°† <code class="highlighter-rouge">state.todos</code> ä»ä¸­åˆ†ç¦»å‡ºæ¥ï¼Œæˆ–è€…æ˜¯æ‰¾ä¸€ç§æ–¹æ³•åœ¨ <code class="highlighter-rouge">dataSource</code> ä¸­åŒæ­¥å¾…åŠäº‹é¡¹çš„ modelã€‚</li>
  <li>å¼‚æ­¥æ“ä½œçš„æµ‹è¯• - åœ¨ <code class="highlighter-rouge">TableViewController</code> çš„æµ‹è¯•ä¸­ï¼Œæœ‰ä¸€ä¸ªåœ°æ–¹æˆ‘ä»¬æ²¡æœ‰è¦†ç›–åˆ°ï¼Œé‚£å°±æ˜¯ <code class="highlighter-rouge">viewDidLoad</code> ä¸­ç”¨æ¥åŠ è½½å¾…åŠçš„ <code class="highlighter-rouge">ToDoStore.shared.getToDoItems</code>ã€‚åœ¨ä¸å¼•å…¥ stub çš„æƒ…å†µä¸‹ï¼Œæµ‹è¯•è¿™ç±»å¼‚æ­¥æ“ä½œä¼šéå¸¸å›°éš¾ï¼Œä½†æ˜¯å¼•å…¥ stub æœ¬èº«ç°åœ¨çœ‹æ¥ä¹Ÿä¸æ˜¯ç‰¹åˆ«æ–¹ä¾¿ã€‚æˆ‘ä»¬æœ‰æ²¡æœ‰ä»€ä¹ˆå¥½æ–¹æ³•å¯ä»¥æµ‹è¯• View Controller ä¸­çš„å¼‚æ­¥æ“ä½œå‘¢ï¼Ÿ</li>
</ol>

<p>æˆ‘ä»¬å¯ä»¥å¼•å…¥ä¸€äº›æ”¹å˜ï¼Œæ¥å°† <code class="highlighter-rouge">TableViewController</code> çš„ UI éƒ¨åˆ†å˜ä¸ºçº¯å‡½æ•°å¼å®ç°ï¼Œå¹¶åˆ©ç”¨å•å‘æ•°æ®æµæ¥é©±åŠ¨ View Controllerï¼Œå°±å¯ä»¥è§£å†³è¿™äº›é—®é¢˜ã€‚</p>

<h2 id="å¯¹-view-controller-çš„è¿›ä¸€æ­¥æ”¹é€ ">å¯¹ View Controller çš„è¿›ä¸€æ­¥æ”¹é€ </h2>

<p>åœ¨ç€æ‰‹å¤§å¹…è°ƒæ•´ä»£ç ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆä»‹ç»ä¸€äº›åŸºæœ¬æ¦‚å¿µã€‚</p>

<h3 id="ä»€ä¹ˆæ˜¯çº¯å‡½æ•°">ä»€ä¹ˆæ˜¯çº¯å‡½æ•°</h3>

<p>çº¯å‡½æ•° (Pure Function) æ˜¯æŒ‡ä¸€ä¸ªå‡½æ•°å¦‚æœæœ‰ç›¸åŒçš„è¾“å…¥ï¼Œåˆ™å®ƒäº§ç”Ÿç›¸åŒçš„è¾“å‡ºã€‚æ¢è¨€ä¹‹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå‡½æ•°çš„åŠ¨ä½œä¸ä¾èµ–äºå¤–éƒ¨å˜é‡ä¹‹ç±»çš„çŠ¶æ€ï¼Œä¸€æ—¦è¾“å…¥ç»™å®šï¼Œé‚£ä¹ˆè¾“å‡ºåˆ™å”¯ä¸€ç¡®å®šã€‚å¯¹äº app è€Œè¨€ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¼šå’Œä¸€å®šçš„ç”¨æˆ·è¾“å…¥æ‰“äº¤é“ï¼Œä¹Ÿå¿…ç„¶ä¼šéœ€è¦æŒ‰ç…§ç”¨æˆ·çš„è¾“å…¥å’Œå·²çŸ¥çŠ¶æ€æ¥æ›´æ–° UI ä½œä¸ºâ€œè¾“å‡ºâ€ã€‚æ‰€ä»¥åœ¨ app ä¸­ï¼Œç‰¹åˆ«æ˜¯ View Controller ä¸­æ“ä½œ UI çš„éƒ¨åˆ†ï¼Œæˆ‘ä¼šå€¾å‘äºå°†â€œçº¯å‡½æ•°â€å®šä¹‰ä¸ºï¼šåœ¨ç¡®å®šçš„è¾“å…¥ä¸‹ï¼ŒæŸä¸ªå‡½æ•°ç»™å‡ºç¡®å®šçš„ UIã€‚</p>

<p>ä¸Šé¢çš„ <code class="highlighter-rouge">State</code> ä¸ºæˆ‘ä»¬æ‰“é€ ä¸€ä¸ªçº¯å‡½æ•°çš„ View Controller æä¾›äº†åšå®çš„ä¸€æ­¥ï¼Œä½†æ˜¯å®ƒè¿˜å¹¶ä¸æ˜¯çº¯å‡½æ•°ã€‚å¯¹äºä»»æ„çš„æ–°çš„ <code class="highlighter-rouge">state</code>ï¼Œè¾“å‡ºçš„ UI åœ¨ä¸€å®šç¨‹åº¦ä¸Šè¿˜æ˜¯ä¾èµ–äºåŸæ¥çš„ <code class="highlighter-rouge">state</code>ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†åŸæ¥çš„ <code class="highlighter-rouge">state</code> æå–å‡ºæ¥ï¼Œæ¢æˆä¸€ä¸ªç”¨äºæ›´æ–° UI çš„çº¯å‡½æ•°ï¼Œå³å¯è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ–°çš„å‡½æ•°ç­¾åçœ‹èµ·æ¥å¤§æ¦‚ä¼šæ˜¯è¿™æ ·ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">updateViews</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span> <span class="nv">previousState</span><span class="p">:</span> <span class="kt">State</span><span class="p">?)</span>
</code></pre></div></div>

<p>è¿™æ ·ï¼Œå½“æˆ‘ä»¬ç»™å®šåŸçŠ¶æ€å’Œç°çŠ¶æ€æ—¶ï¼Œå°†å¾—åˆ°ç¡®å®šçš„ UIï¼Œæˆ‘ä»¬ç¨åä¼šæ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ã€‚</p>

<h3 id="å•å‘æ•°æ®æµ">å•å‘æ•°æ®æµ</h3>

<p>æˆ‘ä»¬æƒ³è¦å¯¹ State View Controller åšçš„å¦ä¸€ä¸ªæ”¹è¿›æ˜¯ç®€åŒ–å’Œç»Ÿä¸€çŠ¶æ€ç»´æŠ¤çš„ç›¸å…³å·¥ä½œã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä»»ä½•æ–°çš„çŠ¶æ€éƒ½æ˜¯åœ¨åŸæœ‰çŠ¶æ€çš„åŸºç¡€ä¸Šé€šè¿‡ä¸€äº›æ”¹å˜æ‰€å¾—åˆ°çš„ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œåœ¨å¾…åŠäº‹é¡¹çš„ demo ä¸­ï¼Œæ–°åŠ ä¸€ä¸ªå¾…åŠæ„å‘³ç€åœ¨åŸçŠ¶æ€çš„ <code class="highlighter-rouge">state.todos</code> çš„åŸºç¡€ä¸Šï¼Œæ¥æ”¶åˆ°ç”¨æˆ·çš„æ·»åŠ çš„è¡Œä¸ºï¼Œç„¶ååœ¨æ•°ç»„ä¸­åŠ ä¸Šå¾…åŠäº‹é¡¹ï¼Œå¹¶è¾“å‡ºæ–°çš„çŠ¶æ€ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">userWantToAddItem</span> <span class="p">{</span>
    <span class="n">state</span><span class="o">.</span><span class="n">todos</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">todos</span> <span class="o">+</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å…¶ä»–çš„æ“ä½œä¹Ÿçš†æ˜¯å¦‚æ­¤ã€‚å°†è¿™ä¸ªè¿‡æˆè¿›è¡Œä¸€äº›æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°è¿™æ ·ä¸€ä¸ªå…¬å¼ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æ–°çŠ¶æ€ = f(æ—§çŠ¶æ€, ç”¨æˆ·è¡Œä¸º)
</code></pre></div></div>

<p>æˆ–è€…ç”¨ Swift çš„è¯­è¨€ï¼Œå°±æ˜¯ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">reducer</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span> <span class="nv">userAction</span><span class="p">:</span> <span class="kt">Action</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">State</span>
</code></pre></div></div>

<p>å¦‚æœä½ å¯¹å‡½æ•°å¼ç¼–ç¨‹æœ‰æ‰€äº†è§£ï¼Œåº”è¯¥å¾ˆå®¹æ˜“çœ‹å‡ºï¼Œè¿™å…¶å®å°±æ˜¯ <code class="highlighter-rouge">reduce</code> å‡½æ•°çš„ <code class="highlighter-rouge">transformer</code>ï¼Œå®ƒæ¥å—ä¸€ä¸ªå·²æœ‰çŠ¶æ€ <code class="highlighter-rouge">State</code> å’Œä¸€ä¸ªè¾“å…¥ <code class="highlighter-rouge">Action</code>ï¼Œå°† <code class="highlighter-rouge">Action</code> ä½œç”¨äº <code class="highlighter-rouge">state</code>ï¼Œå¹¶ç»™å‡ºæ–°çš„ <code class="highlighter-rouge">State</code>ã€‚ç»“åˆ Swift æ ‡å‡†åº“ä¸­çš„ <code class="highlighter-rouge">reduce</code> çš„å‡½æ•°ç­¾åï¼Œæˆ‘ä»¬å¯ä»¥è½»è€Œæ˜“ä¸¾åœ°çœ‹åˆ°ä¸¤è€…çš„å…³è”ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="n">reduce</span><span class="o">&lt;</span><span class="kt">Result</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">initialResult</span><span class="p">:</span> <span class="kt">Result</span><span class="p">,</span> 
                    <span class="n">_</span> <span class="nv">nextPartialResult</span><span class="p">:</span> <span class="p">(</span><span class="kt">Result</span><span class="p">,</span> <span class="kt">Element</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Result</span><span class="p">)</span> <span class="k">rethrows</span> <span class="o">-&gt;</span> <span class="kt">Result</span>
</code></pre></div></div>

<p>å…¶ä¸­ <code class="highlighter-rouge">reducer</code> å¯¹åº”çš„æ­£æ˜¯ <code class="highlighter-rouge">reduce</code> ä¸­çš„ <code class="highlighter-rouge">nextPartialResult</code> éƒ¨åˆ†ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬å°†å®ƒç§°ä¸º <code class="highlighter-rouge">reducer</code> çš„åŸå› ã€‚</p>

<p>æœ‰äº† <code class="highlighter-rouge">reducer(state: State, userAction: Action) -&gt; State</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥å°†ç”¨æˆ·æ“ä½œæŠ½è±¡ä¸º <code class="highlighter-rouge">Action</code>ï¼Œå¹¶å°†æ‰€æœ‰çš„çŠ¶æ€æ›´æ–°é›†ä¸­å¤„ç†äº†ã€‚ä¸ºäº†è®©è¿™ä¸ªè¿‡ç¨‹ä¸€èˆ¬åŒ–ï¼Œæˆ‘ä»¬ä¼šç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ª <code class="highlighter-rouge">Store</code> ç±»å‹æ¥å­˜å‚¨çŠ¶æ€ï¼Œå¹¶é€šè¿‡å‘ <code class="highlighter-rouge">Store</code> å‘é€ <code class="highlighter-rouge">Action</code> æ¥æ›´æ–°å…¶ä¸­çš„çŠ¶æ€ã€‚è€Œå¸Œæœ›æ¥æ”¶åˆ°çŠ¶æ€æ›´æ–°çš„å¯¹è±¡ (è¿™ä¸ªä¾‹å­ä¸­æ˜¯ <code class="highlighter-rouge">TableViewController</code> å®ä¾‹) å¯ä»¥è®¢é˜…çŠ¶æ€å˜åŒ–ï¼Œä»¥æ›´æ–° UIã€‚è®¢é˜…è€…ä¸å‚ä¸ç›´æ¥æ”¹å˜çŠ¶æ€ï¼Œè€Œåªæ˜¯å‘é€å¯èƒ½æ”¹å˜çŠ¶æ€çš„è¡Œä¸ºï¼Œç„¶åæ¥å—çŠ¶æ€å˜åŒ–å¹¶æ›´æ–° UIï¼Œä»¥æ­¤å½¢æˆå•å‘çš„æ•°æ®æµåŠ¨ã€‚è€Œå› ä¸ºæ›´æ–° UI çš„ä»£ç å°†ä¼šæ˜¯çº¯å‡½æ•°çš„ï¼Œæ‰€ä»¥ View Controller çš„ UI ä¹Ÿå°†æ˜¯å¯é¢„æœŸåŠå¯æµ‹è¯•çš„ã€‚</p>

<h3 id="å¼‚æ­¥çŠ¶æ€">å¼‚æ­¥çŠ¶æ€</h3>

<p>å¯¹äºåƒ <code class="highlighter-rouge">ToDoStore.shared.getToDoItems</code> è¿™æ ·çš„å¼‚æ­¥æ“ä½œï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½å¤Ÿçº³å…¥åˆ° <code class="highlighter-rouge">Action</code> å’Œ <code class="highlighter-rouge">reducer</code> çš„ä½“ç³»ä¸­ã€‚å¼‚æ­¥æ“ä½œå¯¹äºçŠ¶æ€çš„ç«‹å³æ”¹å˜ (æ¯”å¦‚è®¾ç½® <code class="highlighter-rouge">state.loading</code> å¹¶æ˜¾ç¤ºä¸€ä¸ª Loading Indicator)ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘ <code class="highlighter-rouge">State</code> ä¸­æ·»åŠ æˆå‘˜æ¥è¾¾åˆ°ã€‚è¦è§¦å‘è¿™ä¸ªå¼‚æ­¥æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºå®ƒæ·»åŠ ä¸€ä¸ªæ–°çš„ <code class="highlighter-rouge">Action</code>ï¼Œç›¸å¯¹äºæ™®é€š <code class="highlighter-rouge">Action</code> ä»…ä»…åªæ˜¯æ”¹å˜ <code class="highlighter-rouge">state</code>ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒè¿˜èƒ½æœ‰ä¸€å®šâ€œå‰¯ä½œç”¨â€ï¼Œä¹Ÿå°±æ˜¯åœ¨è®¢é˜…è€…ä¸­èƒ½å®é™…è§¦å‘è¿™ä¸ªå¼‚æ­¥æ“ä½œã€‚è¿™éœ€è¦æˆ‘ä»¬ç¨å¾®æ›´æ–°ä¸€ä¸‹ <code class="highlighter-rouge">reducer</code> çš„å®šä¹‰ï¼Œé™¤äº†è¿”å›æ–°çš„ <code class="highlighter-rouge">State</code> ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¸Œæœ›å¯¹å¼‚æ­¥æ“ä½œè¿”å›ä¸€ä¸ªé¢å¤–çš„ <code class="highlighter-rouge">Command</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">reducer</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span> <span class="nv">userAction</span><span class="p">:</span> <span class="kt">Action</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">State</span><span class="p">,</span> <span class="kt">Command</span><span class="p">?)</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Command</code> åªæ˜¯è§¦å‘å¼‚æ­¥æ“ä½œçš„æ‰‹æ®µï¼Œå®ƒä¸åº”è¯¥å’ŒçŠ¶æ€å˜åŒ–æœ‰å…³ï¼Œæ‰€ä»¥å®ƒæ²¡æœ‰å‡ºç°åœ¨ <code class="highlighter-rouge">reducer</code> çš„è¾“å…¥ä¸€ä¾§ã€‚å¦‚æœä½ ç°åœ¨ä¸å¤ªç†è§£çš„è¯ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œå…ˆåªéœ€è¦è®°ä½è¿™ä¸ªå‡½æ•°ç­¾åï¼Œæˆ‘ä»¬ä¼šåœ¨ä¹‹åçš„ä¾‹å­ä¸­è¯¦ç»†åœ°çœ‹åˆ°è¿™éƒ¨åˆ†çš„å·¥ä½œæ–¹å¼ã€‚</p>

<p>å°†è¿™äº›ç»“åˆèµ·æ¥ï¼Œæˆ‘ä»¬å°†è¦å®ç°çš„ View Controller çš„æ¶æ„ç±»ä¼¼äºä¸‹å›¾ï¼š</p>

<p><img src="/assets/images/2017/view-controller-states.svg" alt="" /></p>

<h3 id="ä½¿ç”¨å•å‘æ•°æ®æµå’Œ-reducer-æ”¹è¿›-view-controller">ä½¿ç”¨å•å‘æ•°æ®æµå’Œ reducer æ”¹è¿› View Controller</h3>

<p>å‡†å¤‡å·¥ä½œå¤Ÿå¤šäº†ï¼Œè®©æˆ‘ä»¬æ¥åœ¨ State View Controller çš„åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›å§ã€‚</p>

<p>ä¸ºäº†èƒ½å¤Ÿå°½é‡é€šç”¨ï¼Œæˆ‘ä»¬å…ˆæ¥å®šä¹‰å‡ ä¸ªåè®®ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">ActionType</span> <span class="p">{}</span>
<span class="kd">protocol</span> <span class="kt">StateType</span> <span class="p">{}</span>
<span class="kd">protocol</span> <span class="kt">CommandType</span> <span class="p">{}</span>
</code></pre></div></div>

<p>é™¤äº†é™åˆ¶åè®®ç±»å‹ä»¥å¤–ï¼Œä¸Šé¢è¿™å‡ ä¸ª <code class="highlighter-rouge">protocol</code> å¹¶æ²¡æœ‰å…¶ä»–ç‰¹åˆ«çš„æ„ä¹‰ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨ <code class="highlighter-rouge">TableViewController</code> ä¸­å®šä¹‰å¯¹åº”çš„ <code class="highlighter-rouge">Action</code>ï¼Œ<code class="highlighter-rouge">State</code> å’Œ <code class="highlighter-rouge">Command</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    
    <span class="kd">struct</span> <span class="kt">State</span><span class="p">:</span> <span class="kt">StateType</span> <span class="p">{</span>
        <span class="k">var</span> <span class="nv">dataSource</span> <span class="o">=</span> <span class="kt">TableViewControllerDataSource</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">owner</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="k">var</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">""</span>
    <span class="p">}</span>
    
    <span class="kd">enum</span> <span class="kt">Action</span><span class="p">:</span> <span class="kt">ActionType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nf">updateText</span><span class="p">(</span><span class="nv">text</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span>
        <span class="k">case</span> <span class="nf">addToDos</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">])</span>
        <span class="k">case</span> <span class="nf">removeToDo</span><span class="p">(</span><span class="nv">index</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span>
        <span class="k">case</span> <span class="n">loadToDos</span>
    <span class="p">}</span>
    
    <span class="kd">enum</span> <span class="kt">Command</span><span class="p">:</span> <span class="kt">CommandType</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nf">loadToDos</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="p">([</span><span class="kt">String</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">Void</span> <span class="p">)</span>
    <span class="p">}</span>
    
    
    <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºäº†å°† <code class="highlighter-rouge">dataSource</code> æå–å‡ºæ¥ï¼Œæˆ‘ä»¬åœ¨ <code class="highlighter-rouge">State</code> ä¸­æŠŠåŸæ¥çš„ <code class="highlighter-rouge">todos</code> æ¢æˆäº†æ•´ä¸ªçš„ <code class="highlighter-rouge">dataSource</code>ã€‚<code class="highlighter-rouge">TableViewControllerDataSource</code> å°±æ˜¯æ ‡å‡†çš„ <code class="highlighter-rouge">UITableViewDataSource</code>ï¼Œå®ƒåŒ…å« <code class="highlighter-rouge">todos</code> å’Œç”¨æ¥ä½œä¸º <code class="highlighter-rouge">inputCell</code> è®¾å®š <code class="highlighter-rouge">delegate</code> çš„ <code class="highlighter-rouge">owner</code>ã€‚åŸºæœ¬ä¸Šå°±æ˜¯å°†åŸæ¥ <code class="highlighter-rouge">TableViewController</code> çš„ Data Source éƒ¨åˆ†çš„ä»£ç æ¬è¿‡å»ï¼Œéƒ¨åˆ†å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TableViewControllerDataSource</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">,</span> <span class="kt">UITableViewDataSource</span> <span class="p">{</span>

    <span class="k">var</span> <span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>
    <span class="k">weak</span> <span class="k">var</span> <span class="nv">owner</span><span class="p">:</span> <span class="kt">TableViewController</span><span class="p">?</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">],</span> <span class="nv">owner</span><span class="p">:</span> <span class="kt">TableViewController</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">todos</span> <span class="o">=</span> <span class="n">todos</span>
        <span class="k">self</span><span class="o">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">owner</span>
    <span class="p">}</span>
    
    <span class="c1">//...</span>
    <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">cellForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
        <span class="c1">//...</span>
            <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">dequeueReusableCell</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="n">inputCellReuseId</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span> <span class="k">as!</span> <span class="kt">TableViewInputCell</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">owner</span>
            <span class="k">return</span> <span class="n">cell</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ˜¯åŸºæœ¬çš„å°† Data Source åˆ†ç¦»å‡º View Controller çš„æ–¹æ³•ï¼Œæœ¬èº«å¾ˆç®€å•ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚</p>

<p>æ³¨æ„ <code class="highlighter-rouge">Command</code> ä¸­åŒ…å«çš„ <code class="highlighter-rouge">loadToDos</code> æˆå‘˜ï¼Œå®ƒå…³è”äº†ä¸€ä¸ªæ–¹æ³•ä½œä¸ºç»“æŸæ—¶çš„å›è°ƒï¼Œæˆ‘ä»¬ç¨åä¼šåœ¨è¿™ä¸ªæ–¹æ³•é‡Œå‘ <code class="highlighter-rouge">store</code> å‘é€ <code class="highlighter-rouge">.addToDos</code> çš„ <code class="highlighter-rouge">Action</code>ã€‚</p>

<p>å‡†å¤‡å¥½å¿…è¦çš„ç±»å‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°æ ¸å¿ƒçš„ <code class="highlighter-rouge">reducer</code> äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">lazy</span> <span class="k">var</span> <span class="nv">reducer</span><span class="p">:</span> <span class="p">(</span><span class="kt">State</span><span class="p">,</span> <span class="kt">Action</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span> <span class="nv">command</span><span class="p">:</span> <span class="kt">Command</span><span class="p">?)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">Action</span><span class="p">)</span> <span class="k">in</span>
    
    <span class="k">var</span> <span class="nv">state</span> <span class="o">=</span> <span class="n">state</span>
    <span class="k">var</span> <span class="nv">command</span><span class="p">:</span> <span class="kt">Command</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>

    <span class="k">switch</span> <span class="n">action</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">updateText</span><span class="p">(</span><span class="k">let</span> <span class="nv">text</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">text</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">addToDos</span><span class="p">(</span><span class="k">let</span> <span class="nv">items</span><span class="p">):</span>
        <span class="n">state</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="kt">TableViewControllerDataSource</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="n">items</span> <span class="o">+</span> <span class="n">state</span><span class="o">.</span><span class="n">dataSource</span><span class="o">.</span><span class="n">todos</span><span class="p">,</span> <span class="nv">owner</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">dataSource</span><span class="o">.</span><span class="n">owner</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">removeToDo</span><span class="p">(</span><span class="k">let</span> <span class="nv">index</span><span class="p">):</span>
        <span class="k">let</span> <span class="nv">oldTodos</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dataSource</span><span class="o">.</span><span class="n">todos</span>
        <span class="n">state</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="kt">TableViewControllerDataSource</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="kt">Array</span><span class="p">(</span><span class="n">oldTodos</span><span class="p">[</span><span class="o">..&lt;</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">oldTodos</span><span class="p">[(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">...</span><span class="p">]),</span> <span class="nv">owner</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">dataSource</span><span class="o">.</span><span class="n">owner</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">loadToDos</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="kt">Command</span><span class="o">.</span><span class="n">loadToDos</span> <span class="p">{</span> <span class="n">data</span> <span class="k">in</span>
            <span class="c1">// å‘é€é¢å¤–çš„ .addToDos</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nf">return</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>ä¸ºäº†é¿å… <code class="highlighter-rouge">reducer</code> æŒæœ‰ <code class="highlighter-rouge">self</code> è€Œé€ æˆå†…å­˜æ³„æ¼ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰€å®ç°çš„æ˜¯ä¸€ä¸ª lazy çš„ <code class="highlighter-rouge">reducer</code> æˆå‘˜ã€‚å…¶ä¸­ <code class="highlighter-rouge">self</code> è¢«æ ‡è®°ä¸ºå¼±å¼•ç”¨ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦æ‹…å¿ƒ <code class="highlighter-rouge">store</code>ï¼ŒView Controller å’Œ <code class="highlighter-rouge">reducer</code> ä¹‹é—´çš„å¼•ç”¨ç¯äº†ã€‚</p>
</blockquote>

<p>å¯¹äº <code class="highlighter-rouge">.updateText</code>ï¼Œ<code class="highlighter-rouge">.addToDos</code> å’Œ <code class="highlighter-rouge">.removeToDo</code>ï¼Œæˆ‘ä»¬éƒ½åªæ˜¯æ ¹æ®å·²æœ‰çŠ¶æ€è¡ç”Ÿå‡ºæ–°çš„çŠ¶æ€ã€‚å”¯ä¸€å€¼å¾—æ³¨æ„çš„æ˜¯ <code class="highlighter-rouge">.loadToDos</code>ï¼Œå®ƒå°†è®© <code class="highlighter-rouge">reducer</code> å‡½æ•°è¿”å›éç©ºçš„ <code class="highlighter-rouge">Command</code>ã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå­˜å‚¨çŠ¶æ€å’Œå“åº” <code class="highlighter-rouge">Action</code> çš„ç±»å‹ï¼Œæˆ‘ä»¬å°†å®ƒå«åš <code class="highlighter-rouge">Store</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">Store</span><span class="o">&lt;</span><span class="kt">A</span><span class="p">:</span> <span class="kt">ActionType</span><span class="p">,</span> <span class="kt">S</span><span class="p">:</span> <span class="kt">StateType</span><span class="p">,</span> <span class="kt">C</span><span class="p">:</span> <span class="kt">CommandType</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">reducer</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">S</span><span class="p">,</span> <span class="n">_</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">S</span><span class="p">,</span> <span class="kt">C</span><span class="p">?)</span>
    <span class="k">var</span> <span class="nv">subscriber</span><span class="p">:</span> <span class="p">((</span><span class="n">_</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">S</span><span class="p">,</span> <span class="n">_</span> <span class="nv">previousState</span><span class="p">:</span> <span class="kt">S</span><span class="p">,</span> <span class="n">_</span> <span class="nv">command</span><span class="p">:</span> <span class="kt">C</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)?</span>
    <span class="k">var</span> <span class="nv">state</span><span class="p">:</span> <span class="kt">S</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">reducer</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">S</span><span class="p">,</span> <span class="kt">A</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="kt">S</span><span class="p">,</span> <span class="kt">C</span><span class="p">?),</span> <span class="nv">initialState</span><span class="p">:</span> <span class="kt">S</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">reducer</span> <span class="o">=</span> <span class="n">reducer</span>
        <span class="k">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">initialState</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">dispatch</span><span class="p">(</span><span class="n">_</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">A</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">previousState</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">let</span> <span class="p">(</span><span class="nv">nextState</span><span class="p">,</span> <span class="nv">command</span><span class="p">)</span> <span class="o">=</span> <span class="nf">reducer</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">nextState</span>
        <span class="nf">subscriber</span><span class="p">?(</span><span class="n">state</span><span class="p">,</span> <span class="n">previousState</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">subscribe</span><span class="p">(</span><span class="n">_</span> <span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">S</span><span class="p">,</span> <span class="kt">S</span><span class="p">,</span> <span class="kt">C</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">handler</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">unsubscribe</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">subscriber</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åƒä¸‡ä¸è¦è¢«è¿™äº›æ³›å‹å“åˆ°ï¼Œå®ƒä»¬éƒ½éå¸¸ç®€å•ã€‚è¿™ä¸ª <code class="highlighter-rouge">Store</code> æ¥å—ä¸€ä¸ª <code class="highlighter-rouge">reducer</code> å’Œä¸€ä¸ªåˆå§‹çŠ¶æ€ <code class="highlighter-rouge">initialState</code> ä½œä¸ºè¾“å…¥ã€‚å®ƒæä¾›äº† <code class="highlighter-rouge">dispatch</code> æ–¹æ³•ï¼ŒæŒæœ‰è¯¥ <code class="highlighter-rouge">store</code> çš„ç±»å‹å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">dispatch</code> å‘å…¶å‘é€ <code class="highlighter-rouge">Action</code>ï¼Œ<code class="highlighter-rouge">store</code> å°†æ ¹æ® <code class="highlighter-rouge">reducer</code> æä¾›çš„æ–¹å¼ç”Ÿæˆæ–°çš„ <code class="highlighter-rouge">state</code> å’Œå¿…è¦çš„ <code class="highlighter-rouge">command</code>ï¼Œç„¶åé€šçŸ¥å®ƒçš„è®¢é˜…è€…ã€‚</p>

<p>åœ¨ <code class="highlighter-rouge">TableViewController</code> ä¸­å¢åŠ ä¸€ä¸ª <code class="highlighter-rouge">store</code> å˜é‡ï¼Œå¹¶åœ¨ <code class="highlighter-rouge">viewDidLoad</code> ä¸­åˆå§‹åŒ–å®ƒï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">TableViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">store</span><span class="p">:</span> <span class="kt">Store</span><span class="o">&lt;</span><span class="kt">Action</span><span class="p">,</span> <span class="kt">State</span><span class="p">,</span> <span class="kt">Command</span><span class="o">&gt;!</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        
        <span class="k">let</span> <span class="nv">dataSource</span> <span class="o">=</span> <span class="kt">TableViewControllerDataSource</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">owner</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span>
        <span class="n">store</span> <span class="o">=</span> <span class="kt">Store</span><span class="o">&lt;</span><span class="kt">Action</span><span class="p">,</span> <span class="kt">State</span><span class="p">,</span> <span class="kt">Command</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">reducer</span><span class="p">:</span> <span class="n">reducer</span><span class="p">,</span> <span class="nv">initialState</span><span class="p">:</span> <span class="kt">State</span><span class="p">(</span><span class="nv">dataSource</span><span class="p">:</span> <span class="n">dataSource</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="s">""</span><span class="p">))</span>
        
        <span class="c1">// è®¢é˜… store</span>
        <span class="n">store</span><span class="o">.</span><span class="n">subscribe</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">state</span><span class="p">,</span> <span class="n">previousState</span><span class="p">,</span> <span class="n">command</span> <span class="k">in</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">stateDidChanged</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span> <span class="nv">previousState</span><span class="p">:</span> <span class="n">previousState</span><span class="p">,</span> <span class="nv">command</span><span class="p">:</span> <span class="n">command</span><span class="p">)</span>
        <span class="p">}</span>
        
        <span class="c1">// åˆå§‹åŒ– UI</span>
        <span class="nf">stateDidChanged</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="n">store</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="nv">previousState</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">command</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
        
        <span class="c1">// å¼€å§‹å¼‚æ­¥åŠ è½½ ToDos</span>
        <span class="n">store</span><span class="o">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="o">.</span><span class="n">loadToDos</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1">//...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å°† <code class="highlighter-rouge">stateDidChanged</code> æ·»åŠ åˆ° <code class="highlighter-rouge">store.subscribe</code> åï¼Œæ¯æ¬¡ <code class="highlighter-rouge">store</code> çŠ¶æ€æ”¹å˜æ—¶ï¼Œ<code class="highlighter-rouge">stateDidChanged</code> éƒ½å°†è¢«è°ƒç”¨ã€‚ç°åœ¨æˆ‘ä»¬è¿˜æ²¡æœ‰å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒçš„å…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">func</span> <span class="nf">stateDidChanged</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span> <span class="nv">previousState</span><span class="p">:</span> <span class="kt">State</span><span class="p">?,</span> <span class="nv">command</span><span class="p">:</span> <span class="kt">Command</span><span class="p">?)</span> <span class="p">{</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">command</span> <span class="o">=</span> <span class="n">command</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="n">command</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">.</span><span class="nf">loadToDos</span><span class="p">(</span><span class="k">let</span> <span class="nv">handler</span><span class="p">):</span>
                <span class="kt">ToDoStore</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">getToDoItems</span><span class="p">(</span><span class="nv">completionHandler</span><span class="p">:</span> <span class="n">handler</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">previousState</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="n">previousState</span><span class="o">!.</span><span class="n">dataSource</span><span class="o">.</span><span class="n">todos</span> <span class="o">!=</span> <span class="n">state</span><span class="o">.</span><span class="n">dataSource</span><span class="o">.</span><span class="n">todos</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">dataSource</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">dataSource</span>
            <span class="n">tableView</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="n">dataSource</span>
            <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s">"TODO - (</span><span class="se">\(</span><span class="n">dataSource</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s">)"</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">previousState</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="n">previousState</span><span class="o">!.</span><span class="n">text</span> <span class="o">!=</span> <span class="n">state</span><span class="o">.</span><span class="n">text</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">isItemLengthEnough</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span>
            <span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="n">isItemLengthEnough</span>
            
            <span class="k">let</span> <span class="nv">inputIndexPath</span> <span class="o">=</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">TableViewControllerDataSource</span><span class="o">.</span><span class="kt">Section</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">rawValue</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">inputCell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">cellForRow</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">inputIndexPath</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">TableViewInputCell</span>
            <span class="n">inputCell</span><span class="p">?</span><span class="o">.</span><span class="n">textField</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">text</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>åŒæ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠä¹‹å‰ <code class="highlighter-rouge">Command.loadTodos</code> çš„å›è°ƒè¡¥å…¨äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">lazy</span> <span class="k">var</span> <span class="nv">reducer</span><span class="p">:</span> <span class="p">(</span><span class="kt">State</span><span class="p">,</span> <span class="kt">Action</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span> <span class="nv">command</span><span class="p">:</span> <span class="kt">Command</span><span class="p">?)</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="kt">State</span><span class="p">,</span> <span class="nv">action</span><span class="p">:</span> <span class="kt">Action</span><span class="p">)</span> <span class="k">in</span>
    
    <span class="k">var</span> <span class="nv">state</span> <span class="o">=</span> <span class="n">state</span>
    <span class="k">var</span> <span class="nv">command</span><span class="p">:</span> <span class="kt">Command</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>

    <span class="k">switch</span> <span class="n">action</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">loadToDos</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="kt">Command</span><span class="o">.</span><span class="n">loadToDos</span> <span class="p">{</span> <span class="n">data</span> <span class="k">in</span>
            <span class="c1">// å‘é€é¢å¤–çš„ .addToDos</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="o">.</span><span class="nf">addToDos</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="n">data</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nf">return</span> <span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">stateDidChanged</code> ç°åœ¨æ˜¯ä¸€ä¸ªçº¯å‡½æ•°å¼çš„ UI æ›´æ–°æ–¹æ³•ï¼Œå®ƒçš„è¾“å‡º (UI) åªå–å†³äºè¾“å…¥çš„ <code class="highlighter-rouge">state</code> å’Œ <code class="highlighter-rouge">previousState</code>ã€‚å¦ä¸€ä¸ªè¾“å…¥ <code class="highlighter-rouge">Command</code> è´Ÿè´£è§¦å‘ä¸€äº›ä¸å½±å“è¾“å‡ºçš„â€œå‰¯ä½œç”¨â€ï¼Œåœ¨å®è·µä¸­ï¼Œé™¤äº†å‘é€è¯·æ±‚è¿™æ ·çš„å¼‚æ­¥æ“ä½œå¤–ï¼ŒView Controller çš„è½¬æ¢ï¼Œå¼¹çª—ä¹‹ç±»çš„äº¤äº’éƒ½å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">Command</code> æ¥è¿›è¡Œã€‚<code class="highlighter-rouge">Command</code> æœ¬èº«ä¸åº”è¯¥å½±å“ <code class="highlighter-rouge">State</code> çš„è½¬æ¢ï¼Œå®ƒéœ€è¦é€šè¿‡å†æ¬¡å‘é€ <code class="highlighter-rouge">Action</code> æ¥æ”¹å˜çŠ¶æ€ï¼Œä»¥æ­¤æ‰èƒ½å½±å“ UIã€‚</p>

<p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åŸºæœ¬ä¸Šæ‹¥æœ‰æ‰€æœ‰çš„éƒ¨ä»¶äº†ã€‚æœ€åçš„æ”¶å°¾å·¥ä½œç›¸å½“å®¹æ˜“ï¼ŒæŠŠä¹‹å‰çš„ç›´æ¥çš„çŠ¶æ€å˜æ›´ä»£ç æ¢æˆäº‹ä»¶å‘é€å³å¯ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">section</span> <span class="o">==</span> <span class="kt">TableViewControllerDataSource</span><span class="o">.</span><span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="n">store</span><span class="o">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="o">.</span><span class="nf">removeToDo</span><span class="p">(</span><span class="nv">index</span><span class="p">:</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">))</span>
<span class="p">}</span>
    
<span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">addButtonPressed</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">store</span><span class="o">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="o">.</span><span class="nf">addToDos</span><span class="p">(</span><span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="n">store</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">]))</span>
    <span class="n">store</span><span class="o">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="o">.</span><span class="nf">updateText</span><span class="p">(</span><span class="nv">text</span><span class="p">:</span> <span class="s">""</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">inputChanged</span><span class="p">(</span><span class="nv">cell</span><span class="p">:</span> <span class="kt">TableViewInputCell</span><span class="p">,</span> <span class="nv">text</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">store</span><span class="o">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="o">.</span><span class="nf">updateText</span><span class="p">(</span><span class="nv">text</span><span class="p">:</span> <span class="n">text</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="æµ‹è¯•çº¯å‡½æ•°å¼-view-controller">æµ‹è¯•çº¯å‡½æ•°å¼ View Controller</h3>

<p>æŠ˜è…¾äº†è¿™ä¹ˆåŠå¤©ï¼Œå½’æ ¹ç»“åº•ï¼Œå…¶å®æˆ‘ä»¬æƒ³è¦çš„æ˜¯ä¸€ä¸ªé«˜åº¦å¯æµ‹è¯•çš„ View Controllerã€‚åŸºäºé«˜åº¦å¯æµ‹è¯•æ€§ï¼Œæˆ‘ä»¬å°±èƒ½æ‹¥æœ‰é«˜åº¦çš„å¯ç»´æŠ¤æ€§ã€‚<code class="highlighter-rouge">stateDidChanged</code> ç°åœ¨æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼Œä¸ <code class="highlighter-rouge">controller</code> çš„å½“å‰çŠ¶æ€æ— å…³ï¼Œæµ‹è¯•å®ƒå°†éå¸¸å®¹æ˜“ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testUpdateView</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">state1</span> <span class="o">=</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">State</span><span class="p">(</span>
        <span class="nv">dataSource</span><span class="p">:</span><span class="kt">TableViewControllerDataSource</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[],</span> <span class="nv">owner</span><span class="p">:</span> <span class="kc">nil</span><span class="p">),</span>
        <span class="nv">text</span><span class="p">:</span> <span class="s">""</span>
    <span class="p">)</span>
    <span class="c1">// ä» nil çŠ¶æ€è½¬æ¢ä¸º state1</span>
    <span class="n">controller</span><span class="o">.</span><span class="nf">stateDidChanged</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="n">state1</span><span class="p">,</span> <span class="nv">previousState</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">command</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">"TODO - (0)"</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">numberOfRows</span><span class="p">(</span><span class="nv">inSection</span><span class="p">:</span> <span class="kt">TableViewControllerDataSource</span><span class="o">.</span><span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kt">XCTAssertFalse</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">!.</span><span class="n">isEnabled</span><span class="p">)</span>
        
    <span class="k">let</span> <span class="nv">state2</span> <span class="o">=</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">State</span><span class="p">(</span>
        <span class="nv">dataSource</span><span class="p">:</span><span class="kt">TableViewControllerDataSource</span><span class="p">(</span><span class="nv">todos</span><span class="p">:</span> <span class="p">[</span><span class="s">"1"</span><span class="p">,</span> <span class="s">"3"</span><span class="p">],</span> <span class="nv">owner</span><span class="p">:</span> <span class="kc">nil</span><span class="p">),</span>
        <span class="nv">text</span><span class="p">:</span> <span class="s">"Hello"</span>
    <span class="p">)</span>
    <span class="c1">// ä» state1 çŠ¶æ€è½¬æ¢ä¸º state2</span>
    <span class="n">controller</span><span class="o">.</span><span class="nf">stateDidChanged</span><span class="p">(</span><span class="nv">state</span><span class="p">:</span> <span class="n">state2</span><span class="p">,</span> <span class="nv">previousState</span><span class="p">:</span> <span class="n">state1</span><span class="p">,</span> <span class="nv">command</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">"TODO - (2)"</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">numberOfRows</span><span class="p">(</span><span class="nv">inSection</span><span class="p">:</span> <span class="kt">TableViewControllerDataSource</span><span class="o">.</span><span class="kt">Section</span><span class="o">.</span><span class="n">todos</span><span class="o">.</span><span class="n">rawValue</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">cellForRow</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="nf">todoItemIndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="mi">1</span><span class="p">))?</span><span class="o">.</span><span class="n">textLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">"3"</span><span class="p">)</span>
    <span class="kt">XCTAssertTrue</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">navigationItem</span><span class="o">.</span><span class="n">rightBarButtonItem</span><span class="o">!.</span><span class="n">isEnabled</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä½œä¸ºå•å…ƒæµ‹è¯•ï¼Œèƒ½è¦†ç›–äº§å“ä»£ç å°±æ„å‘³ç€è¦†ç›–äº†ç»å¤§å¤šæ•°ä½¿ç”¨æƒ…å†µã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœä½ æ„¿æ„ï¼Œä½ ä¹Ÿå¯ä»¥å†™å‡ºå„ç§çŠ¶æ€é—´çš„è½¬æ¢ï¼Œè¦†ç›–å°½å¯èƒ½å¤šçš„è¾¹ç•Œæƒ…å†µã€‚è¿™å¯ä»¥ä¿è¯ä½ çš„ä»£ç ä¸ä¼šå› ä¸ºæ–°çš„ä¿®æ”¹å‘ç”Ÿé€€åŒ–ã€‚</p>

<p>è™½ç„¶æˆ‘ä»¬æ²¡æœ‰æ˜è¯´ï¼Œä½†æ˜¯ <code class="highlighter-rouge">TableViewController</code> ä¸­çš„å¦ä¸€ä¸ªé‡è¦çš„å‡½æ•° <code class="highlighter-rouge">reducer</code> ä¹Ÿæ˜¯çº¯å‡½æ•°ã€‚å¯¹å®ƒçš„æµ‹è¯•åŒæ ·ç®€å•ï¼Œæ¯”å¦‚ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testReducerUpdateTextFromEmpty</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">initState</span> <span class="o">=</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">State</span><span class="p">()</span>
    <span class="k">let</span> <span class="nv">state</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="nf">reducer</span><span class="p">(</span><span class="n">initState</span><span class="p">,</span> <span class="o">.</span><span class="nf">updateText</span><span class="p">(</span><span class="nv">text</span><span class="p">:</span> <span class="s">"123"</span><span class="p">))</span><span class="o">.</span><span class="n">state</span>
    <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s">"123"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¾“å‡ºçš„ <code class="highlighter-rouge">state</code> åªä¸è¾“å…¥çš„ <code class="highlighter-rouge">initState</code> å’Œ <code class="highlighter-rouge">action</code> æœ‰å…³ï¼Œå®ƒä¸ View Controller çš„çŠ¶æ€å®Œå…¨æ— å…³ã€‚<code class="highlighter-rouge">reducer</code> ä¸­çš„å…¶ä»–æ–¹æ³•çš„æµ‹è¯•å¦‚å‡ºä¸€è¾™ï¼Œåœ¨æ­¤ä¸å†èµ˜è¨€ã€‚</p>

<p>æœ€åï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ State View Controller ä¸­æ²¡æœ‰è¢«æµ‹è¯•çš„åŠ è½½éƒ¨åˆ†çš„å†…å®¹ã€‚ç”±äºç°åœ¨åŠ è½½æ–°çš„å¾…åŠäº‹é¡¹ä¹Ÿæ˜¯ç”±ä¸€ä¸ª <code class="highlighter-rouge">Action</code> æ¥è§¦å‘çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ <code class="highlighter-rouge">reducer</code> è¿”å›çš„ <code class="highlighter-rouge">Command</code> æ¥ç¡®è®¤åŠ è½½çš„ç»“æœï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testLoadToDos</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">initState</span> <span class="o">=</span> <span class="kt">TableViewController</span><span class="o">.</span><span class="kt">State</span><span class="p">()</span>
    <span class="k">let</span> <span class="p">(</span><span class="nv">_</span><span class="p">,</span> <span class="nv">command</span><span class="p">)</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="nf">reducer</span><span class="p">(</span><span class="n">initState</span><span class="p">,</span> <span class="o">.</span><span class="n">loadToDos</span><span class="p">)</span>
    <span class="kt">XCTAssertNotNil</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">switch</span> <span class="n">command</span><span class="o">!</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">loadToDos</span><span class="p">(</span><span class="k">let</span> <span class="nv">handler</span><span class="p">):</span>
        <span class="nf">handler</span><span class="p">([</span><span class="s">"2"</span><span class="p">,</span> <span class="s">"3"</span><span class="p">])</span>
        <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">controller</span><span class="o">.</span><span class="n">store</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">dataSource</span><span class="o">.</span><span class="n">todos</span><span class="p">,</span> <span class="p">[</span><span class="s">"2"</span><span class="p">,</span> <span class="s">"3"</span><span class="p">])</span>
    <span class="c1">// ç°åœ¨ Command åªæœ‰ .loadToDos ä¸€ä¸ªå‘½ä»¤ã€‚å¦‚æœå­˜åœ¨å¤šä¸ª Commandï¼Œå¯ä»¥å»ä¸‹é¢çš„æ³¨é‡Šï¼Œ</span>
    <span class="c1">// è¿™æ ·åœ¨å‘½ä»¤ä¸ç¬¦æ—¶å¯ä»¥è®©æµ‹è¯•å¤±è´¥</span>
    <span class="c1">// default:</span>
    <span class="c1">//     XCTFail("The command should be .loadToDos")</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬æ£€æŸ¥äº†è¿”å›çš„å‘½ä»¤æ˜¯å¦æ˜¯ <code class="highlighter-rouge">.loadToDos</code>ï¼Œè€Œä¸” <code class="highlighter-rouge">.loadToDos</code> çš„ <code class="highlighter-rouge">handler</code> å……å½“äº†å¤©ç„¶çš„ stubã€‚é€šè¿‡ç”¨ä¸€ç»„ dummy æ•°æ® (<code class="highlighter-rouge">["2", "3"]</code>) è¿›è¡Œè°ƒç”¨ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥ <code class="highlighter-rouge">store</code> ä¸­çš„çŠ¶æ€æ˜¯å¦å¦‚æˆ‘ä»¬é¢„æœŸï¼Œè¿™æ ·æˆ‘ä»¬å°±ç”¨åŒæ­¥çš„æ–¹å¼æµ‹è¯•äº†å¼‚æ­¥åŠ è½½çš„è¿‡ç¨‹ï¼</p>

<blockquote>
  <p>å¯èƒ½æœ‰åŒå­¦ä¼šæœ‰ç–‘é—®ï¼Œè®¤ä¸ºè¿™é‡Œæ²¡æœ‰æµ‹è¯• <code class="highlighter-rouge">ToDoStore.shared.getToDoItems</code>ã€‚ä½†æ˜¯è®°ä½ï¼Œæˆ‘ä»¬è¿™é‡Œè¦æµ‹è¯•çš„æ˜¯ View Controllerï¼Œè€Œä¸æ˜¯ç½‘ç»œå±‚ã€‚å¯¹äº <code class="highlighter-rouge">ToDoStore</code> çš„æµ‹è¯•åº”è¯¥æ”¾åœ¨å•ç‹¬çš„åœ°æ–¹è¿›è¡Œã€‚</p>

  <p>ä½ å¯ä»¥åœ¨ GitHub repo çš„ <a href="https://github.com/onevcat/ToDoDemo/tree/reducer">reducer åˆ†æ”¯</a>ä¸­æ‰¾åˆ°å¯¹åº”è¿™éƒ¨åˆ†çš„ä»£ç ã€‚</p>
</blockquote>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>å¯èƒ½ä½ å·²ç»è§è¿‡ç±»ä¼¼çš„å•å‘æ•°æ®æµçš„æ–¹å¼äº†ï¼Œæ¯”å¦‚ <a href="https://github.com/reactjs/redux">Redux</a>ï¼Œæˆ–è€…æ›´å¤è€ä¸€äº›çš„ <a href="http://facebook.github.io/flux/">Flux</a>ã€‚ç”šè‡³åœ¨ Swift ä¸­ï¼Œä¹Ÿæœ‰ <a href="https://github.com/ReSwift/ReSwift">ReSwift</a> å®ç°äº†ç±»ä¼¼çš„æƒ³æ³•ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¿æŒäº†åŸºæœ¬çš„ MVC æ¶æ„ï¼Œè€Œä½¿ç”¨äº†è¿™ç§æ–¹æ³•æ”¹è¿›äº† View Controller çš„è®¾è®¡ã€‚</p>

<p>åœ¨ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çš„ <code class="highlighter-rouge">Store</code> ä½äº View Controller ä¸­ã€‚å…¶å®åªè¦å­˜åœ¨çŠ¶æ€å˜åŒ–ï¼Œè¿™å¥—æ–¹å¼å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹é€‚ç”¨ã€‚ä½ å®Œå…¨å¯ä»¥åœ¨å…¶ä»–çš„å±‚çº§ä¸­å¼•å…¥ <code class="highlighter-rouge">Store</code>ã€‚åªè¦èƒ½ä¿è¯æ•°æ®çš„å•å‘æµåŠ¨ï¼Œä»¥åŠå®Œæ•´çš„çŠ¶æ€å˜æ›´è¦†ç›–æµ‹è¯•ï¼Œè¿™å¥—æ–¹å¼å°±å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ã€‚</p>

<p>ç›¸å¯¹äºå¤§åˆ€é˜”æ–§åœ°æ”¹é€ ï¼Œæˆ–è€…ä½¿ç”¨å…¨æ–°çš„è®¾è®¡æ¨¡å¼ï¼Œè¿™ç§ç¨å¾®å°ä¸€äº›æ”¹è¿›æ›´å®¹æ˜“åœ¨æ—¥å¸¸ä¸­è¿›è¡Œæ¢ç´¢å’Œå®è·µï¼Œå®ƒä¸å­˜åœ¨ä»€ä¹ˆå¤–éƒ¨ä¾èµ–ï¼Œå¯ä»¥è¢«ç›´æ¥ç”¨åœ¨æ–°å»ºçš„ View Controller ä¸­ï¼Œä½ ä¹Ÿå¯ä»¥é€æ­¥å°†å·²æœ‰ç±»è¿›è¡Œæ”¹é€ ã€‚æ¯•ç«Ÿç»å¤§å¤šæ•° iOS å¼€å‘è€…å¯èƒ½éƒ½ä¼šæŠŠå¤§é‡æ—¶é—´èŠ±åœ¨ View Controller ä¸Šï¼Œæ‰€ä»¥èƒ½å¦å†™å‡ºæ˜“äºæµ‹è¯•ï¼Œæ˜“äºç»´æŠ¤çš„ View Controllerï¼Œå¤šå°‘å°†å†³å®šä¸€ä¸ª iOS å¼€å‘è€…çš„å¹¸ç¦ç¨‹åº¦ã€‚æ‰€ä»¥èŠ±ä¸€äº›æ—¶é—´ç¢ç£¨å¦‚ä½•å†™å¥½ View Controllerï¼Œåº”è¯¥æ˜¯æ¯ä¸ª iOSer çš„å¿…ä¿®è¯¾ã€‚</p>

<h3 id="ä¸€äº›æ¨èçš„å‚è€ƒèµ„æ–™">ä¸€äº›æ¨èçš„å‚è€ƒèµ„æ–™</h3>

<p>å¦‚æœä½ å¯¹å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€äº›æ¦‚å¿µæ„Ÿå…´è¶£ï¼Œä¸å¦¨çœ‹çœ‹æˆ‘å’Œä¸€äº›åŒä»ç¿»è¯‘çš„<a href="https://objccn.io/products/functional-swift/">ã€Šå‡½æ•°å¼ Swiftã€‹</a>ä¸€ä¹¦ï¼Œé‡Œé¢å¯¹åƒæ˜¯å€¼ç±»å‹ã€çº¯å‡½æ•°ã€å¼•ç”¨é€æ˜ç­‰ç‰¹æ€§è¿›è¡Œäº†è¯¦ç»†çš„é˜è¿°ã€‚å¦‚æœä½ æƒ³æ›´å¤šæ¥è§¦ä¸€äº›ç±»ä¼¼çš„æ¶æ„æ–¹æ³•ï¼Œæˆ‘ä¸ªäººæ¨èç ”è¯»ä¸€ä¸‹ <a href="https://facebook.github.io/react/">React</a> çš„èµ„æ–™ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•<a href="https://facebook.github.io/react/docs/thinking-in-react.html">ä»¥ React çš„æ€æƒ³æ€è€ƒ</a>çš„ç›¸å…³å†…å®¹ã€‚å¦‚æœä½ è¿˜æœ‰ä½™åŠ›ï¼Œå³ä½¿ä½ æ—¥å¸¸æ¯å¤©è¿˜æ˜¯åš CocoaTouch çš„ native å¼€å‘ï¼Œä¹Ÿä¸å¦¨å°è¯•ç”¨ React Native æ¥æ„å»ºä¸€äº›é¡¹ç›®ã€‚ç›¸ä¿¡ä½ ä¼šåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¼€é˜”çœ¼ç•Œï¼Œå¾—åˆ°æ–°çš„é¢†æ‚Ÿã€‚</p>

:ET