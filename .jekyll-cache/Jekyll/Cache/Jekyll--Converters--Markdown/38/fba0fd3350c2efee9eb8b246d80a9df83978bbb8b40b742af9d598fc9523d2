I"ì<p><img src="/assets/images/2018/matrix.jpg" alt="" /></p>

<h2 id="æ¦‚è¿°">æ¦‚è¿°</h2>

<p>è¿™æ˜¯å…³äº JOSE å’Œå¯†ç å­¦çš„ä¸‰ç¯‡ç³»åˆ—æ–‡ç« ä¸­çš„æœ€åä¸€ç¯‡ï¼Œä½ å¯ä»¥åœ¨ä¸‹é¢çš„é“¾æ¥ä¸­æ‰¾åˆ°å…¶ä»–éƒ¨åˆ†ï¼š</p>

<ol>
  <li><a href="/2018/12/jose-1/">åŸºç¡€ - ä»€ä¹ˆæ˜¯ JWT ä»¥åŠ JOSE</a></li>
  <li><a href="/2018/12/jose-2/">ç†è®º - JOSE ä¸­çš„ç­¾åå’ŒéªŒè¯æµç¨‹</a></li>
  <li>å®è·µ - å¦‚ä½•ä½¿ç”¨ Security.framework å¤„ç† JOSE ä¸­çš„éªŒè¯ (æœ¬æ–‡)</li>
</ol>

<p>è¿™ä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬ä¼šåœ¨ JOSE åŸºç¡€ç¯‡å’Œç†è®ºç¯‡çš„çŸ¥è¯†æ¶æ„ä¸Šï¼Œä½¿ç”¨ iOS (æˆ–è€…è¯´ Cocoa) çš„ç›¸å…³æ¡†æ¶æ¥å®Œæˆå¯¹ JWT çš„è§£æï¼Œå¹¶åˆ©ç”¨ JWK å¯¹å®ƒçš„ç­¾åè¿›è¡ŒéªŒè¯ã€‚åœ¨æœ€åï¼Œæˆ‘ä¼šç»™å‡ºä¸€äº›æˆ‘è‡ªå·±åœ¨å®ç°å’Œå­¦ä¹ è¿™äº›å†…å®¹æ—¶çš„æ€è€ƒï¼Œå¹¶æŠŠä¸€äº›ç›¸å…³å·¥å…·å’Œæ ‡å‡†åˆ—ä¸¾ä¸€ä¸‹ã€‚</p>

<h2 id="è§£ç -jwt">è§£ç  JWT</h2>

<p>JWTï¼Œæˆ–è€…æ›´ç²¾ç¡®ä¸€ç‚¹ï¼ŒJWS ä¸­çš„ Header å’Œ Payload éƒ½æ˜¯ Base64Url ç¼–ç çš„ã€‚ä¸ºäº†è·å–åŸæ–‡å†…å®¹ï¼Œå…ˆéœ€è¦å¯¹ Header å’Œ Payload è§£ç ã€‚</p>

<h3 id="base64url">Base64Url</h3>

<p>Base64 ç›¸ä¿¡å¤§å®¶éƒ½å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œéšç€ç½‘ç»œæ™®åŠï¼Œè¿™å¥—ç¼–ç æœ‰ä¸€ä¸ªå¾ˆå¤§çš„â€œç¼ºç‚¹â€ï¼Œå°±æ˜¯ä½¿ç”¨äº† <code class="highlighter-rouge">+</code>ï¼Œ<code class="highlighter-rouge">/</code> å’Œ <code class="highlighter-rouge">=</code>ã€‚è¿™äº›å­—ç¬¦åœ¨ URL é‡Œæ˜¯å¾ˆä¸å‹å¥½çš„ï¼Œåœ¨ä½œä¸ºä¼ è¾“æ—¶éœ€è¦é¢å¤–åš escapingã€‚Base64Url å°±æ˜¯é’ˆå¯¹è¿™ä¸ªé—®é¢˜çš„æ”¹è¿›ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ï¼š</p>

<ol>
  <li>å°† <code class="highlighter-rouge">+</code> æ›¿æ¢ä¸º <code class="highlighter-rouge">-</code>ï¼›</li>
  <li>å°† <code class="highlighter-rouge">/</code> æ›¿æ¢ä¸º <code class="highlighter-rouge">_</code>ï¼›</li>
  <li>å°†æœ«å°¾çš„ <code class="highlighter-rouge">=</code> å¹²æ‰ã€‚</li>
</ol>

<p>ç›¸å…³ä»£ç çš„è¯éå¸¸ç®€å•ï¼Œä¸º <code class="highlighter-rouge">Data</code> å’Œ <code class="highlighter-rouge">String</code> åˆ†åˆ«æ·»åŠ  extension æ¥ç›¸äº’è½¬æ¢å°±å¥½ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Data</span> <span class="p">{</span>
    <span class="c1">// Encode `self` with URL escaping considered.</span>
    <span class="k">var</span> <span class="nv">base64URLEncoded</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">base64Encoded</span> <span class="o">=</span> <span class="nf">base64EncodedString</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">base64Encoded</span>
            <span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"+"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"-"</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"/"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"_"</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"="</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="c1">// Returns the data of `self` (which is a base64 string), with URL related characters decoded.</span>
    <span class="k">var</span> <span class="nv">base64URLDecoded</span><span class="p">:</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">paddingLength</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">4</span>
        <span class="c1">// Filling = for %4 padding.</span>
        <span class="k">let</span> <span class="nv">padding</span> <span class="o">=</span> <span class="p">(</span><span class="n">paddingLength</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">?</span> <span class="kt">String</span><span class="p">(</span><span class="nv">repeating</span><span class="p">:</span> <span class="s">"="</span><span class="p">,</span> <span class="nv">count</span><span class="p">:</span> <span class="n">paddingLength</span><span class="p">)</span> <span class="p">:</span> <span class="s">""</span>
        <span class="k">let</span> <span class="nv">base64EncodedString</span> <span class="o">=</span> <span class="k">self</span>
            <span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"-"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"+"</span><span class="p">)</span>
            <span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"_"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"/"</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">padding</span>
        <span class="k">return</span> <span class="kt">Data</span><span class="p">(</span><span class="nv">base64Encoded</span><span class="p">:</span> <span class="n">base64EncodedString</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ç»“åˆä½¿ç”¨-jsondecoder-å’Œ-base64url-æ¥å¤„ç†-jwt">ç»“åˆä½¿ç”¨ <code class="highlighter-rouge">JSONDecoder</code> å’Œ Base64Url æ¥å¤„ç† JWT</h3>

<p>å› ä¸º JWT çš„ Header å’Œ Payload éƒ¨åˆ†å®é™…ä¸Šæ˜¯æœ‰æ•ˆçš„ JSONï¼Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Swift çš„ Codable æ¥è§£æ JWTã€‚ä¸ºäº†ç®€åŒ–å¤„ç†ï¼Œå¯ä»¥å°è£…ä¸€ä¸ªé’ˆå¯¹ä»¥ Base64Url è¡¨ç¤ºçš„ JSON çš„ decoderï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span>  <span class="kt">Base64URLJSONDecoder</span><span class="p">:</span> <span class="kt">JSONDecoder</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="n">decode</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">T</span><span class="o">.</span><span class="k">Type</span><span class="p">,</span> <span class="n">from</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">T</span> <span class="k">where</span> <span class="kt">T</span> <span class="p">:</span> <span class="kt">Decodable</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">string</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="o">.</span><span class="n">ascii</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// é”™è¯¯å¤„ç†</span>
        <span class="p">}</span>
        
        <span class="k">return</span> <span class="k">try</span> <span class="nf">decode</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">string</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="n">decode</span><span class="o">&lt;</span><span class="kt">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">T</span><span class="o">.</span><span class="k">Type</span><span class="p">,</span> <span class="n">from</span> <span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">T</span> <span class="k">where</span> <span class="kt">T</span> <span class="p">:</span> <span class="kt">Decodable</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">decodedData</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">base64URLDecoded</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// é”™è¯¯å¤„ç†</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">try</span> <span class="k">super</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">decodedData</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Base64URLJSONDecoder</code> å°† Base64Url çš„è½¬æ¢å°è£…åˆ°è§£ç è¿‡ç¨‹ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦è·å– JWTï¼Œå°†å®ƒç”¨ <code class="highlighter-rouge">.</code> åˆ†å‰²å¼€ï¼Œç„¶åä½¿ç”¨ <code class="highlighter-rouge">Base64URLJSONDecoder</code> å°±èƒ½æŠŠ Header å’Œ Payload è½»æ˜“è½¬æ¢äº†ï¼Œæ¯”å¦‚ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">Header</span><span class="p">:</span> <span class="kt">Codable</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">algorithm</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">tokenType</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="k">let</span> <span class="nv">keyID</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>

    <span class="kd">enum</span> <span class="kt">CodingKeys</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="kt">CodingKey</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">algorithm</span> <span class="o">=</span> <span class="s">"alg"</span>
        <span class="k">case</span> <span class="n">tokenType</span> <span class="o">=</span> <span class="s">"typ"</span>
        <span class="k">case</span> <span class="n">keyID</span> <span class="o">=</span> <span class="s">"kid"</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">jwtRaw</span> <span class="o">=</span> <span class="s">"eyJhbGciOiJSUzI1NiI..."</span> <span class="c1">// JWT å­—ç¬¦ä¸²ï¼Œåé¢éƒ¨åˆ†çœç•¥äº†</span>
<span class="k">let</span> <span class="nv">rawComponents</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="nf">components</span><span class="p">(</span><span class="nv">separatedBy</span><span class="p">:</span> <span class="s">"."</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">decoder</span> <span class="o">=</span> <span class="kt">Base64JSONDecoder</span><span class="p">()</span>
<span class="k">let</span> <span class="nv">header</span> <span class="o">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">Header</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">rawComponents</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">guard</span> <span class="k">let</span> <span class="nv">keyID</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">keyID</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* éªŒè¯å¤±è´¥ */</span> <span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ Header ä¸­ï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥æ‰¾åˆ°æŒ‡å®šäº†éªŒè¯ç­¾åæ‰€éœ€è¦ä½¿ç”¨çš„å…¬é’¥çš„ <code class="highlighter-rouge">keyID</code>ã€‚å¦‚æœæ²¡æœ‰çš„è¯ï¼ŒéªŒè¯å¤±è´¥ï¼Œç™»å½•è¿‡ç¨‹ç»ˆæ­¢ã€‚</p>

<p>å¯¹äºç­¾åï¼Œæˆ‘ä»¬å°†è§£ç åçš„åŸå§‹çš„ <code class="highlighter-rouge">Data</code> ä¿å­˜ä¸‹æ¥ï¼Œç¨åä½¿ç”¨ã€‚åŒæ ·åœ°ï¼Œæˆ‘ä»¬æœ€å¥½ä¹Ÿä¿å­˜ä¸€ä¸‹ <code class="highlighter-rouge">{Header}.{Payload}</code> çš„éƒ¨åˆ†ï¼Œå®ƒåœ¨éªŒè¯ä¸­ä¹Ÿä¼šè¢«ä½¿ç”¨åˆ°ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">signature</span> <span class="o">=</span> <span class="n">rawComponents</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">base64URLDecoded</span><span class="o">!</span>
<span class="k">let</span> <span class="nv">plainText</span> <span class="o">=</span> <span class="s">"</span><span class="se">\(</span><span class="n">rawComponents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="se">)</span><span class="s">.</span><span class="se">\(</span><span class="n">rawComponents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="se">)</span><span class="s">"</span>
</code></pre></div></div>

<blockquote>
  <p>è¿™é‡Œçš„ä»£ç åŸºæœ¬éƒ½æ²¡æœ‰è€ƒè™‘é”™è¯¯å¤„ç†ï¼Œå¤§éƒ¨åˆ†æ˜¯ç›´æ¥è®©ç¨‹åºå´©æºƒã€‚å®é™…çš„äº§å“ä¸­éªŒè¯ç­¾åè¿‡ç¨‹ä¸­çš„é”™è¯¯åº”è¯¥è¢«æ°å½“å¤„ç†ï¼Œè€Œä¸æ˜¯ç²—æš´æŒ‚æ‰ã€‚</p>
</blockquote>

<h2 id="åœ¨-securityframework-ä¸­å¤„ç†ç­¾å">åœ¨ Security.framework ä¸­å¤„ç†ç­¾å</h2>

<p>æˆ‘ä»¬å·²ç»å‡†å¤‡å¥½ç­¾åçš„æ•°æ®å’ŒåŸæ–‡äº†ï¼Œä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ å¯†é’¥ã€‚</p>

<h3 id="å¤„ç†å¯†é’¥">å¤„ç†å¯†é’¥</h3>

<p>é€šè¿‡ <code class="highlighter-rouge">keyID</code>ï¼Œåœ¨é¢„å…ˆè®¾å®šçš„ JWT Host ä¸­æˆ‘ä»¬åº”è¯¥å¯ä»¥æ‰¾åˆ°ä»¥ JWK å½¢å¼è¡¨ç¤ºçš„å¯†é’¥ã€‚æˆ‘ä»¬è®¡åˆ’ä½¿ç”¨ Security.framework æ¥å¤„ç†å¯†é’¥å’Œç­¾åéªŒè¯ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯éµå®ˆæ¡†æ¶å’Œ JWA çš„è§„èŒƒï¼Œé€šè¿‡ JWK çš„å¯†é’¥ç”Ÿæˆ Security æ¡†æ¶å–œæ¬¢çš„ <code class="highlighter-rouge">SecKey</code> å€¼ã€‚</p>

<p>åœ¨å…¶ä»–å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šä»ä¸€ä¸ªè¯ä¹¦ (certificateï¼Œä¸ç®¡æ˜¯ä»ç½‘ç»œä¸‹è½½çš„ PEM è¿˜æ˜¯å­˜å‚¨åœ¨æœ¬åœ°çš„è¯ä¹¦æ–‡ä»¶) é‡Œè·å–å…¬é’¥ã€‚åƒæ˜¯å¤„ç† HTTPS challenge æˆ–è€… SSL Pinning çš„æ—¶å€™ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æˆ‘ä»¬æ‹¿åˆ°çš„æ˜¯å®Œæ•´çš„è¯ä¹¦æ•°æ®ï¼Œé€šè¿‡ <code class="highlighter-rouge">SecCertificateCreateWithData</code> ä½¿ç”¨ DER ç¼–ç çš„æ•°æ®åˆ›å»ºè¯ä¹¦å¹¶è·å–å…¬é’¥ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">guard</span> <span class="k">let</span> <span class="nv">cert</span> <span class="o">=</span> <span class="kt">SecCertificateCreateWithData</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">data</span> <span class="k">as</span> <span class="kt">CFData</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// é”™è¯¯å¤„ç†</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">policy</span> <span class="o">=</span> <span class="kt">SecPolicyCreateBasicX509</span><span class="p">()</span>
<span class="k">var</span> <span class="nv">trust</span><span class="p">:</span> <span class="kt">SecTrust</span><span class="p">?</span> <span class="o">=</span> <span class="kc">nil</span>
<span class="kt">SecTrustCreateWithCertificates</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trust</span><span class="p">)</span>
<span class="k">guard</span> <span class="k">let</span> <span class="nv">t</span> <span class="o">=</span> <span class="n">trust</span><span class="p">,</span> <span class="k">let</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">SecKey</span> <span class="o">=</span> <span class="kt">SecTrustCopyPublicKey</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// é”™è¯¯å¤„ç†</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="nf">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</code></pre></div></div>

<p>ä½†æ˜¯ï¼Œåœ¨ JWK çš„åœºåˆï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰ X.509 è¯ä¹¦çš„ã€‚JWK ç›´æ¥å°†å¯†é’¥ç±»å‹å’Œå‚æ•°ç¼–ç åœ¨ JSON ä¸­ï¼Œæˆ‘ä»¬å½“ç„¶å¯ä»¥æŒ‰ç…§ DER ç¼–ç è§„åˆ™å°†è¿™äº›ä¿¡æ¯ç¼–ç å›ä¸€ä¸ªç¬¦åˆ X.509 è¦æ±‚çš„è¯ä¹¦ï¼Œç„¶åä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•å†ä»ä¸­è·å–è¯ä¹¦ã€‚ä¸è¿‡è¿™æ˜¾ç„¶æ˜¯ç”»è›‡æ·»è¶³ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥ç›´æ¥é€šè¿‡è¿™äº›å‚æ•°ï¼Œä½¿ç”¨ç‰¹å®šæ ¼å¼çš„æ•°æ®æ¥ç›´æ¥ç”Ÿæˆ <code class="highlighter-rouge">SecKey</code>ã€‚</p>

<blockquote>
  <p>æœ‰å¯èƒ½æœ‰åŒå­¦ä¼šè¿·æƒ‘äºâ€œå…¬é’¥â€å’Œâ€œè¯ä¹¦â€è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚ä¸€ä¸ªè¯ä¹¦ï¼Œé™¤äº†åŒ…å«æœ‰å…¬é’¥ä»¥å¤–ï¼Œè¿˜åŒ…å«æœ‰åƒæ˜¯è¯ä¹¦å‘è¡Œè€…ï¼Œè¯ä¹¦ç›®çš„ï¼Œä»¥åŠå…¶ä»–ä¸€äº›å…ƒæ•°æ®çš„ä¿¡æ¯ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªè¯ä¹¦ä¸­ï¼Œæå–å®ƒæ‰€å­˜å‚¨çš„å…¬é’¥ã€‚</p>

  <p>å¦å¤–ï¼Œè¯ä¹¦æœ¬èº«ä¸€èˆ¬ä¼šç”±å¦å¤–ä¸€ä¸ªç§é’¥è¿›è¡Œç­¾åï¼Œå¹¶ç”±é¢å‘æœºæ„æˆ–è€…å—ä¿¡ä»»çš„æœºæ„è¿›è¡ŒéªŒè¯ä¿è¯å…¶çœŸå®æ€§ã€‚</p>
</blockquote>

<p>ä½¿ç”¨ <a href="https://developer.apple.com/documentation/security/1643701-seckeycreatewithdata"><code class="highlighter-rouge">SecKeyCreateWithData</code></a> å°±å¯ä»¥ç›´æ¥é€šè¿‡å…¬é’¥å‚æ•°æ¥ç”Ÿæˆäº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="kt">SecKeyCreateWithData</span><span class="p">(</span><span class="n">_</span> <span class="nv">keyData</span><span class="p">:</span> <span class="kt">CFData</span><span class="p">,</span> 
                          <span class="n">_</span> <span class="nv">attributes</span><span class="p">:</span> <span class="kt">CFDictionary</span><span class="p">,</span> 
                          <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">UnsafeMutablePointer</span><span class="o">&lt;</span><span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">CFError</span><span class="o">&gt;</span><span class="p">?</span><span class="o">&gt;</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">SecKey</span><span class="p">?</span>
</code></pre></div></div>

<p>ç¬¬äºŒä¸ªå‚æ•° <code class="highlighter-rouge">attributes</code> éœ€è¦çš„æ˜¯å¯†é’¥ç§ç±» (RSA è¿˜æ˜¯ EC)ï¼Œå¯†é’¥ç±»å‹ (å…¬é’¥è¿˜æ˜¯ç§é’¥)ï¼Œå¯†é’¥å°ºå¯¸ (æ•°æ® bit æ•°) ç­‰ä¿¡æ¯ï¼Œæ¯”è¾ƒç®€å•ã€‚</p>

<p>å…³äºæ‰€éœ€è¦çš„æ•°æ®æ ¼å¼ï¼Œæ ¹æ®å¯†é’¥ç§ç±»ä¸åŒï¼Œè€Œæœ‰æ‰€åŒºåˆ«ã€‚åœ¨<a href="https://developer.apple.com/documentation/security/1643698-seckeycopyexternalrepresentation">è¿™ä¸ªé£é©¬ç‰›ä¸ç›¸åŠçš„é¡µé¢</a> ä»¥åŠ <a href="https://opensource.apple.com/source/Security/Security-58286.41.2/keychain/SecKey.h">SecKey æºç </a> çš„æ³¨é‡Šä¸­æœ‰æ‰€æåŠï¼š</p>

<blockquote>
  <p>The method returns data in the PKCS #1 format for an RSA key. For an elliptic curve public key, 
the format follows the ANSI X9.63 standard using a byte string of 04 || X || Y.  â€¦  All of 
these representations use constant size integers, including leading zeros as needed.</p>
</blockquote>

<blockquote>
  <p>The requested data format depend on the type of key (kSecAttrKeyType) being created:</p>

  <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kSecAttrKeyTypeRSA               PKCS#1 format, public key can be also in x509 public key format
kSecAttrKeyTypeECSECPrimeRandom  ANSI X9.63 format (04 || X || Y [ || K])
</code></pre></div>  </div>
</blockquote>

<h4 id="jwa---rsa">JWA - RSA</h4>

<p>ç®€å•è¯´ï¼ŒRSA çš„å…¬é’¥éœ€è¦éµå®ˆ  PKCS#1ï¼Œä½¿ç”¨ X.509 ç¼–ç å³å¯ã€‚æ‰€ä»¥å¯¹äº RSA çš„ JWK é‡Œçš„ <code class="highlighter-rouge">n</code> å’Œ <code class="highlighter-rouge">e</code>ï¼Œæˆ‘ä»¬ç”¨ DER æŒ‰ç…§ X.509 ç¼–ç æˆåºåˆ—åï¼Œå°±å¯ä»¥æ‰”ç»™ Security æ¡†æ¶äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">JWK</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">RSA</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">modulus</span><span class="p">:</span> <span class="kt">String</span>
        <span class="k">let</span> <span class="nv">exponent</span><span class="p">:</span> <span class="kt">String</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">jwk</span><span class="p">:</span> <span class="kt">JWK</span><span class="o">.</span><span class="kt">RSA</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">guard</span> <span class="k">let</span> <span class="nv">n</span> <span class="o">=</span> <span class="n">jwk</span><span class="o">.</span><span class="n">modulus</span><span class="o">.</span><span class="n">base64URLDecoded</span> <span class="k">else</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="k">guard</span> <span class="k">let</span> <span class="nv">e</span> <span class="o">=</span> <span class="n">jwk</span><span class="o">.</span><span class="n">exponent</span><span class="o">.</span><span class="n">base64URLDecoded</span> <span class="k">else</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>

<span class="k">var</span> <span class="nv">modulusBytes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">](</span><span class="n">n</span><span class="p">)</span>            
<span class="k">if</span> <span class="k">let</span> <span class="nv">firstByte</span> <span class="o">=</span> <span class="n">modulusBytes</span><span class="o">.</span><span class="n">first</span><span class="p">,</span> <span class="n">firstByte</span> <span class="o">&gt;=</span> <span class="mh">0x80</span> <span class="p">{</span>
    <span class="n">modulusBytes</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">let</span> <span class="nv">exponentBytes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">](</span><span class="n">e</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">modulusEncoded</span> <span class="o">=</span> <span class="n">modulusBytes</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">exponentEncoded</span> <span class="o">=</span> <span class="n">exponentBytes</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span>
<span class="k">let</span> <span class="nv">sequenceEncoded</span> <span class="o">=</span> <span class="p">(</span><span class="n">modulusEncoded</span> <span class="o">+</span> <span class="n">exponentEncoded</span><span class="p">)</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">sequence</span><span class="p">)</span>

<span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">sequenceEncoded</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>å…³äº DER ç¼–ç éƒ¨åˆ†çš„ä»£ç ï¼Œå¯ä»¥åœ¨<a href="https://github.com/line/line-sdk-ios-swift/blob/8c2476d9d00225cf4b33c0e245e9bd580c59f4d8/LineSDK/LineSDK/Crypto/JWK/JWA.swift#L185-L240">è¿™é‡Œ</a>æ‰¾åˆ°ã€‚å¯¹äº <code class="highlighter-rouge">modulusBytes</code>ï¼Œé¦–ä½å¤§äºç­‰äº <code class="highlighter-rouge">0x80</code> æ—¶éœ€è¦è¿½åŠ  <code class="highlighter-rouge">0x00</code> çš„åŸå› ï¼Œä¹Ÿå·²ç»åœ¨<a href="/2018/jose-1/">ç¬¬ä¸€ç¯‡</a>ä¸­æåŠã€‚å¦‚æœä½ ä¸çŸ¥é“æˆ‘åœ¨è¯´ä»€ä¹ˆï¼Œå»ºè®®å›å¤´ä»”ç»†å†çœ‹ä¸€ä¸‹å‰ä¸¤ç¯‡çš„å†…å®¹ã€‚</p>
</blockquote>

<p>ä½¿ç”¨ä¸Šé¢çš„ <code class="highlighter-rouge">data</code> å°±å¯ä»¥è·å– RSA çš„å…¬é’¥äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">sizeInBits</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="kt">MemoryLayout</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;.</span><span class="n">size</span>
<span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">CFString</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nv">kSecAttrKeyType</span><span class="p">:</span> <span class="n">kSecAttrKeyTypeRSA</span><span class="p">,</span>
    <span class="nv">kSecAttrKeyClass</span><span class="p">:</span> <span class="n">kSecAttrKeyClassPublic</span><span class="p">,</span>
    <span class="nv">kSecAttrKeySizeInBits</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">sizeInBits</span><span class="p">)</span>
<span class="p">]</span>
<span class="k">var</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">CFError</span><span class="o">&gt;</span><span class="p">?</span>
<span class="k">guard</span> <span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="kt">SecKeyCreateWithData</span><span class="p">(</span><span class="n">data</span> <span class="k">as</span> <span class="kt">CFData</span><span class="p">,</span> <span class="n">attributes</span> <span class="k">as</span> <span class="kt">CFDictionary</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// é”™è¯¯å¤„ç†</span>
<span class="p">}</span>
<span class="nf">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1">// ä¸€åˆ‡æ­£å¸¸çš„è¯ï¼Œæ‰“å°ç±»ä¼¼è¿™æ ·ï¼š</span>
<span class="c1">// &lt;SecKeyRef algorithm id: 1, key type: RSAPublicKey, version: 4, </span>
<span class="c1">// block size: 1024 bits, exponent: {hex: 10001, decimal: 65537}, </span>
<span class="c1">// modulus: DD95AB518D18E8828DD6A238061C51D82EE81D516018F624..., </span>
<span class="c1">// addr: 0x6000027ffb00&gt;</span>
</code></pre></div></div>

<h4 id="jwa---ecsda">JWA - ECSDA</h4>

<p>æŒ‰ç…§è¯´æ˜ï¼Œå¯¹äº EC å…¬é’¥ï¼ŒæœŸæœ›çš„æ•°æ®æ˜¯ç¬¦åˆ X9.63 ä¸­æœªå‹ç¼©çš„æ¤­åœ†æ›²çº¿ç‚¹åº§æ ‡ï¼š<code class="highlighter-rouge">04 || X || Y</code>ã€‚ä¸è¿‡ï¼Œè™½ç„¶åœ¨æ–‡æ¡£è¯´æ˜é‡ŒæåŠï¼š</p>

<blockquote>
  <p>All of these representations use constant size integers, including leading zeros as needed.</p>
</blockquote>

<p>ä½†äº‹å®æ˜¯ <code class="highlighter-rouge">SecKeyCreateWithData</code> å¹¶ä¸å–œæ¬¢åœ¨é¦–ä½è¿½åŠ  <code class="highlighter-rouge">0x00</code> çš„åšæ³•ã€‚è¿™é‡Œçš„ <code class="highlighter-rouge">X</code> å’Œ <code class="highlighter-rouge">Y</code> <strong>å¿…é¡»</strong>æ˜¯æ»¡è¶³æ¤­åœ†æ›²çº¿å¯¹åº”è¦æ±‚çš„å¯†é’¥ä½æ•°çš„æ•´æ•°å€¼ï¼Œå¦‚æœåœ¨é¦–ä½å¤§äºç­‰äº <code class="highlighter-rouge">0x80</code> çš„å€¼å‰é¢è¿½åŠ  <code class="highlighter-rouge">0x00</code>ï¼Œåè€Œä¼šå¯¼è‡´æ— æ³•åˆ›å»º <code class="highlighter-rouge">SecKey</code>ã€‚æ‰€ä»¥ï¼Œåœ¨ç»„ç»‡æ•°æ®æ—¶ï¼Œä¸ä»…ä¸éœ€è¦æ·»åŠ  <code class="highlighter-rouge">0x00</code>ï¼Œæˆ‘ä»¬åè€Œæœ€å¥½æ£€æŸ¥ä¸€ä¸‹è·å–çš„ JWKï¼Œå¦‚æœé¦–ä½æœ‰ä¸å¿…è¦çš„ <code class="highlighter-rouge">0x00</code> çš„è¯ï¼Œåº”è¯¥å°†å…¶å»é™¤ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">JWK</span> <span class="p">{</span>
    <span class="kd">struct</span> <span class="kt">RSA</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">x</span><span class="p">:</span> <span class="kt">String</span>
        <span class="k">let</span> <span class="nv">y</span><span class="p">:</span> <span class="kt">String</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">jwk</span><span class="p">:</span> <span class="kt">JWK</span><span class="o">.</span><span class="kt">RSA</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">guard</span> <span class="k">let</span> <span class="nv">decodedXData</span> <span class="o">=</span> <span class="n">jwk</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">base64URLDecoded</span> <span class="k">else</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>
<span class="k">guard</span> <span class="k">let</span> <span class="nv">decodedYData</span> <span class="o">=</span> <span class="n">jwk</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">base64URLDecoded</span> <span class="k">else</span> <span class="p">{</span> <span class="o">...</span> <span class="p">}</span>

<span class="k">let</span> <span class="nv">xBytes</span><span class="p">:</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">]</span>
<span class="k">if</span> <span class="n">decodedXData</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">curve</span><span class="o">.</span><span class="n">coordinateOctetLength</span> <span class="p">{</span>
    <span class="n">xBytes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">](</span><span class="n">decodedXData</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">xBytes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">](</span><span class="n">decodedXData</span><span class="p">)</span><span class="o">.</span><span class="n">dropFirst</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="p">}</span>
<span class="p">}</span>
            
<span class="k">let</span> <span class="nv">yBytes</span><span class="p">:</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">]</span>
<span class="k">if</span> <span class="n">decodedYData</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="n">curve</span><span class="o">.</span><span class="n">coordinateOctetLength</span> <span class="p">{</span>
    <span class="n">yBytes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">](</span><span class="n">decodedYData</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">yBytes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">](</span><span class="n">decodedYData</span><span class="p">)</span><span class="o">.</span><span class="n">dropFirst</span> <span class="p">{</span> <span class="nv">$0</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">let</span> <span class="nv">uncompressedIndicator</span><span class="p">:</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x04</span><span class="p">]</span>
<span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> <span class="n">uncompressedIndicator</span> <span class="o">+</span> <span class="n">xBytes</span> <span class="o">+</span> <span class="n">yBytes</span><span class="p">)</span>
</code></pre></div></div>

<p>åˆ›å»ºå…¬é’¥æ—¶å’Œ RSA ç±»ä¼¼ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">sizeInBits</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">count</span> <span class="o">*</span> <span class="kt">MemoryLayout</span><span class="o">&lt;</span><span class="kt">UInt8</span><span class="o">&gt;.</span><span class="n">size</span>
<span class="k">let</span> <span class="nv">attributes</span><span class="p">:</span> <span class="p">[</span><span class="kt">CFString</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nv">kSecAttrKeyType</span><span class="p">:</span> <span class="n">kSecAttrKeyTypeECSECPrimeRandom</span><span class="p">,</span>
    <span class="nv">kSecAttrKeyClass</span><span class="p">:</span> <span class="n">kSecAttrKeyClassPublic</span><span class="p">,</span>
    <span class="nv">kSecAttrKeySizeInBits</span><span class="p">:</span> <span class="kt">NSNumber</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">sizeInBits</span><span class="p">)</span>
<span class="p">]</span>
<span class="k">var</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">CFError</span><span class="o">&gt;</span><span class="p">?</span>
<span class="k">guard</span> <span class="k">let</span> <span class="nv">key</span> <span class="o">=</span> <span class="kt">SecKeyCreateWithData</span><span class="p">(</span><span class="n">data</span> <span class="k">as</span> <span class="kt">CFData</span><span class="p">,</span> <span class="n">attributes</span> <span class="k">as</span> <span class="kt">CFDictionary</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// é”™è¯¯å¤„ç†</span>
<span class="p">}</span>
<span class="nf">print</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="c1">// ä¸€åˆ‡æ­£å¸¸çš„è¯ï¼Œæ‰“å°ç±»ä¼¼è¿™æ ·ï¼š</span>
<span class="c1">// &lt;SecKeyRef curve type: kSecECCurveSecp256r1, algorithm id: 3, </span>
<span class="c1">// key type: ECPublicKey, version: 4, block size: 256 bits, </span>
<span class="c1">// y: 3D4F8B27B29E5C77FCF877367245F3D75C2FBA806C54A0A0C05807E1B536E68A, </span>
<span class="c1">// x: FFB00CF903B79BB0F6C049208A59C448049BE0A2A1AF4692C486085CBD9057EF, </span>
<span class="c1">// addr: 0x7fcafd80ced0&gt;</span>
</code></pre></div></div>

<h3 id="éªŒè¯ç­¾å">éªŒè¯ç­¾å</h3>

<p>Security æ¡†æ¶ä¸­ä¸ºä½¿ç”¨å…¬é’¥è¿›è¡Œç­¾åéªŒè¯å‡†å¤‡äº†ä¸€ä¸ªæ–¹æ³•ï¼š<a href="https://developer.apple.com/documentation/security/1643715-seckeyverifysignature"><code class="highlighter-rouge">SecKeyVerifySignature</code></a>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="kt">SecKeyVerifySignature</span><span class="p">(</span><span class="n">_</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">SecKey</span><span class="p">,</span> 
                         <span class="n">_</span> <span class="nv">algorithm</span><span class="p">:</span> <span class="kt">SecKeyAlgorithm</span><span class="p">,</span> 
                         <span class="n">_</span> <span class="nv">signedData</span><span class="p">:</span> <span class="kt">CFData</span><span class="p">,</span> 
                         <span class="n">_</span> <span class="nv">signature</span><span class="p">:</span> <span class="kt">CFData</span><span class="p">,</span> 
                         <span class="n">_</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">UnsafeMutablePointer</span><span class="o">&lt;</span><span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">CFError</span><span class="o">&gt;</span><span class="p">?</span><span class="o">&gt;</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">key</code> æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†ï¼Œ<code class="highlighter-rouge">signedData</code> å°±æ˜¯ä¹‹å‰æˆ‘ä»¬å‡†å¤‡çš„ <code class="highlighter-rouge">{Header}.{Payload}</code> çš„å­—ç¬¦ä¸²çš„æ•°æ®è¡¨ç¤º (ä¹Ÿå°±æ˜¯ <code class="highlighter-rouge">plainText.data(using: .ascii)</code>ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ <code class="highlighter-rouge">plainText</code> ä¸æ˜¯ä¸€ä¸ª Base64Url å­—ç¬¦ä¸²ï¼ŒJWS ç­¾åæ‰€é’ˆå¯¹çš„å°±æ˜¯è¿™ä¸ªæ‹¼å‡‘åçš„å­—ç¬¦ä¸²çš„æ•£åˆ—å€¼)ã€‚æˆ‘ä»¬éœ€è¦ä¸ºä¸åŒçš„ç­¾åç®—æ³•æŒ‡å®šåˆé€‚çš„ <code class="highlighter-rouge">SecKeyAlgorithm</code>ï¼Œé€šè¿‡è®¿é—® <code class="highlighter-rouge">SecKeyAlgorithm</code> çš„é™æ€æˆå‘˜ï¼Œå°±å¯ä»¥è·å– Security æ¡†æ¶é¢„å…ˆå®šä¹‰çš„ç®—æ³•äº†ã€‚æ¯”å¦‚å¸¸ç”¨çš„ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let ecdsa256 = SecKeyAlgorithm.ecdsaSignatureMessageX962SHA256
let rsa256 = SecKeyAlgorithm.rsaSignatureDigestPKCS1v15SHA256
</code></pre></div></div>

<p>ä½ å¯ä»¥åœ¨ Apple çš„<a href="https://developer.apple.com/documentation/security/seckeyalgorithm">æ–‡æ¡£é‡Œ</a>æ‰¾åˆ°æ‰€æœ‰æ”¯æŒçš„ç®—æ³•çš„å®šä¹‰ï¼Œä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œè¿™äº›ç®—æ³•éƒ½åªæœ‰åå­—ï¼Œæ²¡æœ‰å…·ä½“è¯´æ˜ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨èŒƒä¾‹ã€‚æƒ³è¦å…·ä½“çŸ¥é“æŸä¸ªç®—æ³•çš„ç”¨æ³•ï¼Œå¯èƒ½éœ€è¦åœ¨<a href="https://opensource.apple.com/source/Security/Security-57740.51.3/keychain/SecKey.h">æºç çº§åˆ«</a>å»å‚è€ƒæ³¨é‡Šã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œå¯¹äºç­¾åéªŒè¯ç›¸å…³çš„ä¸€äº›å¸¸ç”¨ç®—æ³•ï¼Œæˆ‘åˆ—äº†ä¸€ä¸ªè¡¨è¯´æ˜å¯¹åº”å…³ç³»ï¼š</p>

<table>
  <thead>
    <tr>
      <th>ç®—æ³•</th>
      <th>è¾“å…¥æ•°æ® (signedData)</th>
      <th>ç­¾å (signature)</th>
      <th>å¯¹åº” JWT ç®—æ³•</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>rsaSignatureDigestPKCS1v15SHA{x}</td>
      <td>åŸæ•°æ®çš„ SHA-x æ‘˜è¦</td>
      <td>PKCS#1 v1.5 padding çš„ç­¾å</td>
      <td>RS{x}</td>
    </tr>
    <tr>
      <td>rsaSignatureMessagePKCS1v15SHA{x}</td>
      <td>åŸæ•°æ®æœ¬èº«ï¼Œæ¡†æ¶è´Ÿè´£è®¡ç®— SHA-x æ‘˜è¦</td>
      <td>PKCS#1 v1.5 padding çš„ç­¾å</td>
      <td>RS{x}</td>
    </tr>
    <tr>
      <td>rsaSignatureDigestPSSSHA{x}</td>
      <td>åŸæ•°æ®çš„ SHA-x æ‘˜è¦</td>
      <td>ä½¿ç”¨ PSS çš„ PKCS#1 v2.1 ç­¾å</td>
      <td>PS{x}</td>
    </tr>
    <tr>
      <td>rsaSignatureMessagePSSSHA{x}</td>
      <td>åŸæ•°æ®æœ¬èº«ï¼Œæ¡†æ¶è´Ÿè´£è®¡ç®— SHA-x æ‘˜è¦</td>
      <td>ä½¿ç”¨ PSS çš„ PKCS#1 v2.1 ç­¾å</td>
      <td>PS{x}</td>
    </tr>
    <tr>
      <td>ecdsaSignatureDigestX962SHA{x}</td>
      <td>åŸæ•°æ®çš„ SHA-x æ‘˜è¦</td>
      <td>DER x9.62 ç¼–ç çš„ r å’Œ s</td>
      <td>ES{x}</td>
    </tr>
    <tr>
      <td>ecdsaSignatureMessageX962SHA{x}</td>
      <td>åŸæ•°æ®æœ¬èº«ï¼Œæ¡†æ¶è´Ÿè´£è®¡ç®— SHA-x æ‘˜è¦</td>
      <td>DER x9.62 ç¼–ç çš„ r å’Œ s</td>
      <td>ES{x}</td>
    </tr>
  </tbody>
</table>

<p>ä¸éš¾çœ‹å‡ºï¼Œè¿™äº›ç­¾åç®—æ³•åŸºæœ¬å°±æ˜¯ <code class="highlighter-rouge">{ç®—æ³•ç±»å‹} + {æ•°æ®å¤„ç†æ–¹å¼} + {ç­¾åæ ¼å¼}</code> çš„ç»„åˆã€‚å¦å¤–è¿˜æœ‰ä¸€äº›æ›´ä¸ºæ³›ç”¨çš„ç­¾åç®—æ³•ï¼Œåƒæ˜¯ <code class="highlighter-rouge">.ecdsaSignatureRFC4754</code> æˆ–è€… <code class="highlighter-rouge">.rsaSignatureRaw</code>ï¼Œä½ éœ€è¦æŒ‰ç…§æºç æ³¨é‡Šç»™å…¥åˆé€‚çš„è¾“å…¥ï¼Œä¸è¿‡ä¸€èˆ¬æ¥è¯´è¿˜æ˜¯ç›´æ¥ä½¿ç”¨é¢„è®¾çš„æ•£åˆ—çš„ <code class="highlighter-rouge">__Message__SHA___</code> è¿™ç±»ç®—æ³•æœ€ä¸ºæ–¹ä¾¿ã€‚</p>

<blockquote>
  <p><code class="highlighter-rouge">SecKeyAlgorithm</code> ä¸­é™¤äº†ç­¾åç®—æ³•ï¼Œä¹ŸåŒ…æ‹¬äº†ä½¿ç”¨ RSA å’Œ EC è¿›è¡ŒåŠ å¯†çš„ç›¸å…³ç®—æ³•ã€‚æ•´ä½“ä¸Šå’Œç­¾åç®—æ³•çš„å‘½åæ–¹å¼ç±»ä¼¼ï¼Œæœ‰å…´è¶£å’Œéœ€è¦ç›¸å…³å†…å®¹çš„åŒå­¦å¯ä»¥è‡ªè¡Œç ”ç©¶ã€‚</p>
</blockquote>

<p>å¯¹äº JWT æ¥è¯´ï¼ŒRS ç®—æ³•çš„ç­¾åå·²ç»æ˜¯ PKCS#1 v1.5 padding çš„äº†ï¼Œæ‰€ä»¥ç›´æ¥å°† <code class="highlighter-rouge">signedData</code> å’Œ <code class="highlighter-rouge">signature</code> é…åˆä½¿ç”¨ <code class="highlighter-rouge">rsaSignatureMessagePKCS1v15SHA{x}</code> å°±å¯ä»¥å®ŒæˆéªŒè¯ã€‚</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">CFError</span><span class="o">&gt;</span><span class="p">?</span>
<span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="kt">SecKeyVerifySignature</span><span class="p">(</span>
    <span class="n">key</span><span class="p">,</span> 
    <span class="o">.</span><span class="n">rsaSignatureMessagePKCS1v15SHA256</span><span class="p">,</span> 
    <span class="n">signedData</span> <span class="k">as</span> <span class="kt">CFData</span><span class="p">,</span> 
    <span class="n">signature</span> <span class="k">as</span> <span class="kt">CFData</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">)</span>
</code></pre></div></div>

<p>å¯¹äº ES çš„ JWT æ¥è¯´ï¼Œäº‹æƒ…è¦éº»çƒ¦ä¸€äº›ã€‚æˆ‘ä»¬æ”¶åˆ°çš„ JWT é‡Œçš„ç­¾ååªæ˜¯ {r, s} çš„ç®€å•è¿æ¥ï¼Œæ‰€ä»¥éœ€è¦é¢„å…ˆè¿›è¡Œå¤„ç†ã€‚æŒ‰ç…§ X9.62 ä¸­å¯¹ <code class="highlighter-rouge">signature</code> çš„ç¼–ç å®šä¹‰ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ECDSA-Sig-Value ::= SEQUENCE {
    r INTEGER,
    s INTEGER }
</code></pre></div></div>

<p>å› æ­¤ï¼Œåœ¨è°ƒç”¨ <code class="highlighter-rouge">SecKeyVerifySignature</code> ä¹‹å‰ï¼Œå…ˆå¤„ç†ç­¾åï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">count</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">count</span>
<span class="k">guard</span> <span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// é”™è¯¯ï¼Œç­¾ååº”è¯¥æ˜¯ä¸¤ä¸ªç­‰é•¿çš„æ•´æ•°</span>
<span class="p">}</span>
<span class="k">var</span> <span class="nv">rBytes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">](</span><span class="n">signature</span><span class="p">[</span><span class="o">..&lt;</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)])</span>
<span class="k">var</span> <span class="nv">sBytes</span> <span class="o">=</span> <span class="p">[</span><span class="kt">UInt8</span><span class="p">](</span><span class="n">signature</span><span class="p">[(</span><span class="n">count</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">...</span><span class="p">])</span>

<span class="c1">// å¤„ç†é¦–ä½ï¼Œæˆ‘ä»¬å·²ç»åšè¿‡å¾ˆå¤šæ¬¡äº†ã€‚</span>
<span class="k">if</span> <span class="n">rBytes</span><span class="o">.</span><span class="n">first</span><span class="o">!</span> <span class="o">&gt;=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rBytes</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">sBytes</span><span class="o">.</span><span class="n">first</span><span class="o">!</span> <span class="o">&gt;=</span> <span class="kt">UInt8</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sBytes</span><span class="o">.</span><span class="nf">insert</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="nv">at</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// å®Œæˆç­¾åçš„ DER ç¼–ç </span>
<span class="k">let</span> <span class="nv">processedSignature</span> <span class="o">=</span> <span class="kt">Data</span><span class="p">(</span><span class="nv">bytes</span><span class="p">:</span> 
    <span class="p">(</span><span class="n">rBytes</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">integer</span><span class="p">)</span> <span class="o">+</span> <span class="n">sBytes</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">integer</span><span class="p">))</span>
    <span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="nv">as</span><span class="p">:</span> <span class="o">.</span><span class="n">sequence</span><span class="p">))</span>

<span class="k">var</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">Unmanaged</span><span class="o">&lt;</span><span class="kt">CFError</span><span class="o">&gt;</span><span class="p">?</span>
<span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="kt">SecKeyVerifySignature</span><span class="p">(</span>
    <span class="n">key</span><span class="p">,</span> 
    <span class="o">.</span><span class="n">ecdsaSignatureMessageX962SHA256</span><span class="p">,</span> 
    <span class="n">signedData</span> <span class="k">as</span> <span class="kt">CFData</span><span class="p">,</span> 
    <span class="n">processedSignature</span> <span class="k">as</span> <span class="kt">CFData</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">)</span>
</code></pre></div></div>

<blockquote>
  <p>ä¸Šé¢ RSA å’Œ ECDSA çš„éªŒè¯ï¼Œéƒ½å‡è®¾äº†ä½¿ç”¨ SHA-256 ä½œä¸ºæ•£åˆ—ç®—æ³•ã€‚å¦‚æœä½ é‡‡ç”¨çš„æ˜¯å…¶ä»–çš„æ•£åˆ—ç®—æ³•ï¼Œè®°å¾—æ›¿æ¢ã€‚</p>
</blockquote>

<h3 id="éªŒè¯-payload-å†…å®¹">éªŒè¯ Payload å†…å®¹</h3>

<p>ç­¾åæ­£ç¡®å®ŒæˆéªŒè¯ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ JWT Payload é‡Œçš„å†…å®¹è¿›è¡ŒéªŒè¯äº†ï¼šåŒ…æ‹¬ä½†ä¸é™äº â€œissâ€ï¼Œâ€subâ€ï¼Œâ€expâ€ï¼Œâ€iatâ€ è¿™äº›ä¿ç•™å€¼æ˜¯å¦æ­£ç¡®ã€‚å½“ç­¾åå’Œå†…å®¹éƒ½éªŒè¯æ— è¯¯åï¼Œå°±å¯ä»¥å®‰å¿ƒä½¿ç”¨è¿™ä¸ª JWT äº†ã€‚</p>

<h2 id="ä¸€äº›é—®é¢˜">ä¸€äº›é—®é¢˜</h2>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬ä»æœ€åˆçš„ JWT å®šä¹‰å¼€å§‹ï¼Œå¼•ä¼¸å‡º JWAï¼ŒJWK ç­‰ä¸€ç³»åˆ— JOSE æ¦‚å¿µã€‚ç„¶åæˆ‘ä»¬ç ”ç©¶äº†äº’è”ç½‘å®‰å…¨é¢†åŸŸçš„é€šç”¨ç¼–ç æ–¹å¼å’Œå‡ ç§æœ€å¸¸è§çš„å¯†é’¥çš„æ„æˆã€‚æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™äº›çŸ¥è¯†åœ¨ Security æ¡†æ¶çš„å¸®åŠ©ä¸‹ï¼Œå®Œæˆäº† JWT çš„ç­¾åéªŒè¯çš„æ•´ä¸ªæµç¨‹ã€‚</p>

<p>äº‹åçœ‹ä¸Šå»æ²¡æœ‰å¤ªå¤§éš¾åº¦ï¼Œä½†æ˜¯ç”±äºæ¶‰åŠåˆ°çš„åè¯æ¦‚å¿µå¾ˆå¤šï¼Œç›¸å…³æ ‡å‡†é”™ç»¼å¤æ‚ï¼Œå› æ­¤åˆä¸Šæ‰‹æƒ³è¦æŠŠå…¨ç›˜éƒ½å¼„æ˜ç™½ï¼Œè¿˜æ˜¯ä¼šæœ‰ä¸€å®šå›°éš¾ã€‚å¸Œæœ›è¿™ç³»åˆ—æ–‡ç« èƒ½å¤Ÿå¸®åŠ©ä½ åœ¨èµ·æ­¥é˜¶æ®µå°±å»ºç«‹ç›¸å¯¹æ¸…æ™°çš„çŸ¥è¯†ä½“ç³»ï¼Œè¿™æ ·åœ¨é˜…è¯»å…¶ä»–çš„ç›¸å…³ä¿¡æ¯æ—¶ï¼Œå¯ä»¥å¯¹æ–°çš„çŸ¥è¯†è¿›è¡Œæ›´å¥½çš„åˆ†ç±»æ•´ç†ã€‚</p>

<p>æœ€åï¼Œæ˜¯ä¸€äº›æˆ‘è‡ªå·±åœ¨å­¦ä¹ å’Œå®è·µä¸­çš„è€ƒè™‘ã€‚åœ¨æ­¤ä¸€å¹¶åˆ—å‡ºï¼Œä»¥ä¾›å‚è€ƒã€‚å¦‚æœæ‚¨æœ‰ä»€ä¹ˆæŒ‡æ­£å’Œè¡¥å……ï¼Œä¹Ÿæ¬¢è¿ç•™è¨€è¯„è®ºã€‚</p>

<h4 id="ä¸ºä»€ä¹ˆä¸ç”¨å·²æœ‰çš„ç›¸å…³å¼€æºæ¡†æ¶">ä¸ºä»€ä¹ˆä¸ç”¨å·²æœ‰çš„ç›¸å…³å¼€æºæ¡†æ¶</h4>

<p>ç°å­˜çš„å’Œè¿™ä¸ªä¸»é¢˜ç›¸å…³çš„ iOS æˆ–è€… Swift æ¡†æ¶æœ‰ä¸€äº›ï¼Œæ¯”å¦‚ <a href="https://github.com/airsidemobile/JOSESwift">JOSESwift</a>ï¼Œ<a href="https://github.com/kylef/JSONWebToken.swift">JSONWebToken.swift</a>ï¼Œ<a href="https://github.com/IBM-Swift/Swift-JWT">Swift-JWT</a>ï¼Œ<a href="https://github.com/vapor/jwt">vaper/jwt</a> ç­‰ç­‰ã€‚æ¥å›æ¯”è¾ƒè€ƒå¯Ÿï¼Œå®ƒä»¬ç°åœ¨ (2018 å¹´ 12 æœˆ) æˆ–å¤šæˆ–å°‘å­˜åœ¨ä¸‹é¢çš„ä¸è¶³ï¼š</p>

<ul>
  <li>æ²¡æœ‰ä¸€ä¸ªä» JWK å¼€å§‹åˆ° JWT çš„å®Œæ•´æ–¹æ¡ˆã€‚JWT ç›¸å…³çš„æ¡†æ¶åŸºæœ¬éƒ½æ˜¯ä»æœ¬åœ°è¯ä¹¦è·å–å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œè€Œæˆ‘éœ€è¦ä» JWK è·å–è¯ä¹¦</li>
  <li>æ”¯æŒ JWK çš„æ¡†æ¶åªå®ç°äº†éƒ¨åˆ†ç®—æ³•ï¼Œæ¯”å¦‚åªæœ‰ RSAï¼Œæ²¡æœ‰ ECDSA æ”¯æŒã€‚</li>
  <li>ä¸€äº›æ¡†æ¶ä¾èµ–å…³ç³»å¤ªå¤æ‚ï¼Œè€Œä¸”å¤§éƒ¨åˆ†å®ç°æ˜¯é¢å‘ Swift Server Sideï¼Œè€Œé iOS çš„ã€‚</li>
</ul>

<p>åœ¨ <a href="https://github.com/line/line-sdk-ios-swift">LINE SDK</a> ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ï¼Œä¸”åªéœ€è¦åœ¨ iOS ä¸Šåˆ©ç”¨ Security æ¡†æ¶å®ŒæˆéªŒè¯ã€‚åŒæ—¶ Server å¯èƒ½ä¼šå˜æ›´é…ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŒæ—¶æ”¯æŒ RSA å’Œ ECDSA (å½“å‰é»˜è®¤ä½¿ç”¨ ECDSA)ã€‚å¦å¤–ï¼Œæœ¬èº«ä½œä¸ºä¸€ä¸ªæä¾›ç»™ç¬¬ä¸‰æ–¹å¼€å‘è€…çš„ SDKï¼Œæˆ‘ä»¬ä¸å…è®¸å¼•å…¥ä¸å¯é çš„å¤æ‚ä¾èµ–å…³ç³» (æœ€ç†æƒ³çš„æƒ…å†µæ˜¯é›¶ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯ LINE SDK çš„ç°çŠ¶)ã€‚åŸºäºè¿™äº›åŸå› ï¼Œæˆ‘æ²¡æœ‰ä½¿ç”¨ç°æœ‰çš„å¼€æºä»£ç ï¼Œè€Œæ˜¯è‡ªå·±ä»å¤´è¿›è¡Œå®ç°ã€‚</p>

<h4 id="ä¸ºä»€ä¹ˆä¸æŠŠä½ åšçš„ç›¸å…³å†…å®¹æ•´ç†å¼€æº">ä¸ºä»€ä¹ˆä¸æŠŠä½ åšçš„ç›¸å…³å†…å®¹æ•´ç†å¼€æº</h4>

<p>åœ¨ LINE SDK ä¸­çš„æ–¹æ¡ˆæ˜¯ä¸å®Œå¤‡çš„ï¼Œå®ƒæ˜¯ JOSE ä¸­æ»¡è¶³æˆ‘ä»¬çš„ JWT è§£æå’ŒéªŒè¯éœ€æ±‚çš„æœ€å°å­é›†ï¼Œå› æ­¤æ²¡æœ‰å¾ˆé«˜çš„æ³›ç”¨æ€§ï¼Œä¸é€‚åˆä½œä¸ºå•ç‹¬é¡¹ç›®å¼€æºã€‚ä¸è¿‡å› ä¸º LINE SDK æ•´ä¸ªé¡¹ç›®æ˜¯å¼€æºçš„ï¼ŒJOSE éƒ¨åˆ†çš„ä»£ç å…¶å®ä¹Ÿéƒ½æ˜¯å…¬å¼€ä¸”ç›¸å¯¹ç‹¬ç«‹çš„ã€‚å¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥åœ¨ LINE SDK çš„ <a href="https://github.com/line/line-sdk-ios-swift/tree/master/LineSDK/LineSDK/Crypto">Crypto æ–‡ä»¶å¤¹</a>ä¸‹æ‰¾åˆ°æ‰€æœ‰ç›¸å…³ä»£ç ã€‚</p>

<h4 id="ä¸ºä»€ä¹ˆè¦ç”¨éå¯¹ç§°ç®—æ³•å„ç®—æ³•ä¹‹é—´æœ‰ä»€ä¹ˆä¼˜åŠ£">ä¸ºä»€ä¹ˆè¦ç”¨éå¯¹ç§°ç®—æ³•ï¼Œå„ç®—æ³•ä¹‹é—´æœ‰ä»€ä¹ˆä¼˜åŠ£</h4>

<p>ä¸å°‘ JWT ä½¿ç”¨ HS çš„ç®—æ³• (HMAC)ã€‚å’Œ RSA æˆ– ECDSA ä¸åŒï¼ŒHMAC æ˜¯å¯¹ç§°åŠ å¯†ç®—æ³•ã€‚å¯¹ç§°ç®—æ³•åŠ å¯†å’Œè§£å¯†æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºå¯†é’¥ç›¸åŒï¼Œæ‰€ä»¥æ¯”è¾ƒé€‚åˆç”¨åœ¨ Server to Server è¿™ç§åŒæ–¹å¯ä¿¡çš„åœºåˆã€‚å¦‚æœåœ¨å®¢æˆ·ç«¯ä¸Šä½¿ç”¨å¯¹ç§°ç®—æ³•ï¼Œé‚£å°±éœ€è¦å°†è¿™ä¸ªå¯†é’¥å­˜æ”¾åœ¨å®¢æˆ·ç«¯ä¸Šï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å¯æ¥å—çš„ã€‚å¯¹äº Client - Server çš„é€šè®¯ï¼Œéå¯¹ç§°ç®—æ³•åº”è¯¥æ˜¯æ¯‹åº¸ç½®ç–‘çš„é€‰æ‹©ã€‚</p>

<p>ç›¸æ¯”ä¸ RSAï¼ŒECDSA å¯ä»¥ä½¿ç”¨æ›´çŸ­çš„å¯†é’¥å®ç°å’Œæ•°å€é•¿äºè‡ªå·±çš„ RSA ç›¸åŒçš„å®‰å…¨æ€§èƒ½ã€‚</p>

<blockquote>
  <p>For example, at a security level of 80 bits (meaning an attacker requires a maximum of about 
2^80 operations to find the private key) the size of an ECDSA public key would be 160 bits, whereas the size of a DSA public key is at least 1024 bits.</p>
</blockquote>

<p>ç”±äº ECDSA æ˜¯ä¸“ç”¨çš„ DSA ç®—æ³•ï¼Œåªèƒ½ç”¨äºç­¾åï¼Œè€Œä¸èƒ½ç”¨ä½œåŠ å¯†å’Œå¯†é’¥äº¤æ¢ï¼Œæ‰€ä»¥å®ƒæ¯” RSA è¦å¿«å¾ˆå¤šã€‚å¦å¤–ï¼Œæ›´å°çš„å¯†é’¥ä¹Ÿå¸¦æ¥äº†æ›´å°çš„è®¡ç®—é‡ã€‚è¿™äº›ç‰¹æ€§å¯¹äºå‡å°‘ Server è´Ÿæ‹…éå¸¸é‡è¦ã€‚å…³äº ECDSA çš„ä¼˜åŠ¿å’Œå®ƒç›¸å¯¹äº RSA çš„å¯¹æ¯”ï¼Œå¯ä»¥å‚è€ƒ Cloudflare çš„<a href="https://blog.cloudflare.com/ecdsa-the-digital-signature-algorithm-of-a-better-internet/">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>

<h4 id="ç­¾åçš„å®‰å…¨æ€§">ç­¾åçš„å®‰å…¨æ€§</h4>

<p>JWT ç­¾åçš„ä¼ªé€ ä¸€ç›´æ˜¯ä¸€ä¸ªå›°æ‰°äººçš„é—®é¢˜ã€‚å› ä¸º JWT çš„ Header å’Œ Payload å†…å®¹ä¸€æ—¦ç¡®å®šçš„è¯ï¼Œå®ƒçš„ç­¾åä¹Ÿå°±ç¡®å®šäº† (è™½ç„¶ ECDSA ä¼šäº§ç”Ÿéšæœºæ•°ä½¿ç­¾åæ¯æ¬¡éƒ½ä¸åŒï¼Œä½†æ˜¯è¿™äº›ç­¾åéƒ½å¯ä»¥é€šè¿‡éªŒè¯)ã€‚è¿™å¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æˆªå–ä»¥å‰çš„æœ‰æ•ˆçš„ JWTï¼Œç„¶åæŠŠå®ƒä½œä¸ºæ–°çš„å“åº”å‘ç»™ç”¨æˆ·ã€‚è¿™ç±» JWT ä¾ç„¶å¯ä»¥æ­£ç¡®é€šè¿‡ç­¾åéªŒè¯ã€‚</p>

<p>å› æ­¤ï¼Œæˆ‘ä»¬å¿…é¡»æ¯æ¬¡ç”Ÿæˆä¸åŒçš„ JWTï¼Œæ¥é˜²æ­¢è¿™ç§æ›¿æ¢æ”»å‡»ã€‚æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åœ¨å†…å­˜ä¸­å­˜å‚¨éšæœºå€¼ï¼Œå‘é€ JWT è¯·æ±‚æ—¶é™„å¸¦è¿™ä¸ªéšæœºå€¼ï¼Œç„¶å Server å°†è¿™ä¸ªéšæœºå€¼åµŒå…¥åœ¨è¿”å›çš„ JWT çš„ Payload ä¸­ã€‚Client æ”¶åˆ°åï¼Œå†ä¸å†…å­˜ä¸­ä¿å­˜çš„å€¼è¿›è¡Œæ¯”å¯¹ã€‚è¿™æ ·ä¿è¯äº†æ¯æ¬¡è¿”å›çš„ JWT éƒ½ä¸ç›¸åŒï¼Œè®©ç­¾åéªŒè¯æ›´åŠ å®‰å…¨ã€‚</p>

<h4 id="openssl-ç‰ˆæœ¬çš„é—®é¢˜">OpenSSL ç‰ˆæœ¬çš„é—®é¢˜</h4>

<p>macOS ä¸Šè‡ªå¸¦çš„ OpenSSL ç‰ˆæœ¬ä¸€èˆ¬æ¯”è¾ƒæ—§ï¼Œè€Œå¤§éƒ¨åˆ† Linux ç³»ç»Ÿçš„ OpenSSL æ›´æ–°ä¸€äº›ã€‚ä¸åŒç‰ˆæœ¬çš„ OpenSSL (æˆ–è€…å…¶ä»–çš„å¸¸ç”¨å®‰å…¨æ¡†æ¶) å®ç°ç»†èŠ‚ä¸Šä¼šæœ‰å·®å¼‚ï¼Œæ¯”å¦‚æœ‰äº›ç‰ˆæœ¬ä¼šåœ¨è´Ÿæ•°é¦–ä½è¡¥ <code class="highlighter-rouge">0x00</code> ç­‰ã€‚åœ¨æµ‹è¯•æ—¶ï¼Œæœ€å¥½è®© Server çš„å°ä¼™ä¼´ç¡®è®¤ä¸€ä¸‹ä½¿ç”¨çš„ OpenSSL ç‰ˆæœ¬ï¼Œè¿™æ ·èƒ½åœ¨éªŒè¯å’Œä½¿ç”¨å¯†é’¥ä¸Šé¿å…ä¸€äº›ä¸å¿…è¦çš„éº»çƒ¦ã€‚(è¯·ä¸è¦é—®æˆ‘ç»†èŠ‚ï¼éƒ½æ˜¯æ³ª)</p>

<h4 id="jwt-å¯ä»¥ç”¨æ¥åšä»€ä¹ˆåº”è¯¥ç”¨æ¥åšä»€ä¹ˆ">JWT å¯ä»¥ç”¨æ¥åšä»€ä¹ˆï¼Œåº”è¯¥ç”¨æ¥åšä»€ä¹ˆ</h4>

<p>JWT æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯æœ‰ä¸¤ä¸ªï¼š</p>

<ul>
  <li><strong>æˆæƒ</strong>ï¼šç”¨æˆ·ç™»å½•åï¼Œåœ¨åç»­çš„è¯·æ±‚ä¸­å¸¦ä¸Šä¸€ä¸ªæœ‰æ•ˆçš„ JWTï¼Œå…¶ä¸­åŒ…å«è¯¥ç”¨æˆ·å¯ä»¥è®¿é—®çš„è·¯å¾„æˆ–æƒé™ç­‰ã€‚æœåŠ¡å™¨éªŒè¯ JWT æœ‰æ•ˆæ€§åå¯¹è®¿é—®è¿›è¡Œæˆæƒã€‚ç›¸æ¯”äºä¼ ç»Ÿåƒæ˜¯ OAuth çš„ token æ¥è¯´ï¼ŒæœåŠ¡å™¨å¹¶ä¸éœ€è¦å­˜å‚¨è¿™äº› tokenï¼Œå¯ä»¥å®ç°æ— çŠ¶æ€çš„æˆæƒï¼Œå› æ­¤å®ƒçš„å¼€é”€è¾ƒå°ï¼Œä¹Ÿæ›´å®¹æ˜“å®ç°å’Œç†è§£ã€‚å¦å¤–ï¼Œç”±äº JWT ä¸éœ€è¦ä¾èµ– Cookie çš„ç‰¹æ€§ï¼Œè·¨ç«™æˆ–è€…è·¨æœåŠ¡ä¾ç„¶å¯èƒ½ä½¿ç”¨ï¼Œè¿™è®©å•ç‚¹ç™»å½•éå¸¸ç®€å•ã€‚</li>
  <li><strong>ä¿¡æ¯äº¤æ¢</strong>ï¼šLINE SDK ä¸­å¯¹ç”¨æˆ·ä¿¡æ¯è¿›è¡Œç­¾åå’ŒéªŒè¯ï¼Œå°±å±äºä¿¡æ¯äº¤æ¢çš„èŒƒç•´ã€‚ä¾èµ– JWT çš„ç­¾åç‰¹æ€§ï¼Œæ¥æ”¶æ–¹å¯ä»¥ç¡®ä¿ JWT ä¸­çš„å†…å®¹æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œæ˜¯ä¸€ç§å®‰å…¨çš„ä¿¡æ¯äº¤æ¢æ–¹å¼ã€‚</li>
</ul>

<p>æœ€è¿‘æœ‰éå¸¸å¤šçš„å…³äºåå¯¹ä½¿ç”¨ JWT è¿›è¡Œæˆæƒçš„å£°éŸ³ï¼Œæ¯”å¦‚<a href="http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/">è¿™ç¯‡æ–‡ç« </a>å’Œ<a href="https://paragonie.com/blog/2017/03/jwt-json-web-tokens-is-bad-standard-that-everyone-should-avoid">è¿™ç¯‡æ–‡ç« </a>ã€‚JWT ä½œä¸ºæˆæƒ token æ¥ä½¿ç”¨ï¼Œæœ€å¤§çš„é—®é¢˜åœ¨äºæ— æ³•è¿‡æœŸæˆ–è€…ä½œåºŸï¼Œå¦å¤–ï¼Œä¸€äº›ä¸¥æ ¼éµå®ˆæ ‡å‡†çš„å®ç°ï¼Œåè€Œå¯èƒ½<a href="https://auth0.com/blog/critical-vulnerabilities-in-json-web-token-libraries/">å¼•å…¥ä¸¥é‡çš„å®‰å…¨é—®é¢˜</a>ã€‚</p>

<p>ä¸è¿‡å¯¹äºç¬¬äºŒç§ç”¨æ³•ï¼Œä¹Ÿå°±æ˜¯ä¿¡æ¯äº¤æ¢æ¥è¯´ï¼ŒJWT æ‰€æä¾›çš„ä¾¿æ·å’Œå®‰å…¨æ€§æ˜¯æ— äººè´¨ç–‘çš„ã€‚</p>

<h4 id="æˆ‘ä¹Ÿæƒ³è¯»è¯»çœ‹ç›¸å…³æ ‡å‡†">æˆ‘ä¹Ÿæƒ³è¯»è¯»çœ‹ç›¸å…³æ ‡å‡†</h4>

<p>å¦‚ä½ æ‰€æ„¿ï¼Œæˆ‘æ•´ç†äº†ä¸€ä¸‹æ¶‰åŠåˆ°çš„æ ‡å‡†ã€‚ç¥æ­¦è¿æ˜Œéš†ï¼</p>

<h5 id="å…³äºç¼–ç å’Œç®—æ³•">å…³äºç¼–ç å’Œç®—æ³•</h5>

<ul>
  <li><a href="https://www.itu.int/ITU-T/studygroups/com17/languages/X.680-0207.pdf">X.680 - ASN.1 çš„æ ‡å‡†å’ŒåŸºæœ¬æ ‡æ³¨æ–¹å¼</a>ï¼šASN.1 æ˜¯è¿™å¥—æ–¹æ³•çš„åå­—ï¼Œè€Œå¯¹åº”çš„æ ‡å‡†å·æ˜¯ X.680ã€‚</li>
  <li><a href="https://www.itu.int/ITU-T/studygroups/com17/languages/X.690-0207.pdf">X.690 - DER ç¼–ç è§„åˆ™</a>ï¼šä¹ŸåŒ…æ‹¬äº†å…¶ä»–çš„ï¼Œæ¯”å¦‚ BER å’Œ CER çš„ç¼–ç è§„åˆ™ã€‚</li>
  <li><a href="https://tools.ietf.org/html/rfc3279">RFC 3279 - å…³äº X.509 å¦‚ä½•ç¼–ç å¯†é’¥å’Œç­¾å</a>ï¼šåœ¨ X.509 åº”ç”¨å±‚é¢ä¸Šå¯†é’¥ä»¥åŠç­¾åçš„æ„æˆã€‚</li>
  <li><a href="http://www.secg.org/sec2-v2.pdf">SEC 2 - å…³äºæ¤­åœ†æ›²çº¿ç®—æ³•å‚æ•°</a>ï¼šECDSA çš„å„ç§ OIDs å®šä¹‰å’Œæ¤­åœ†æ›²çº¿ G å€¼çš„è¡¨ç¤ºæ–¹å¼ã€‚</li>
  <li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.202.2977&amp;rep=rep1&amp;type=pdf">X9.62 - æ¤­åœ†æ›²çº¿çš„åº”ç”¨å’Œç›¸å…³ç¼–ç æ–¹å¼</a>ï¼šæè¿°äº† ECDSA ç®—æ³•å’Œå¯†é’¥çš„è¡¨ç¤ºæ–¹å¼ã€‚å®ƒåœ¨ SEC 2 çš„åŸºç¡€ä¸Šæ·»åŠ äº†å…³äºæ›²çº¿ç‚¹ (ä¹Ÿå°±æ˜¯å®é™…çš„å¯†é’¥æœ¬èº«) çš„å®šä¹‰ã€‚</li>
  <li><a href="https://tools.ietf.org/html/rfc5480">RFC 5480 - æ¤­åœ†æ›²çº¿å…¬é’¥çš„ä¿¡æ¯</a>ï¼šEC å…¬é’¥çš„å®šä¹‰ï¼Œè¡¨ç¤ºæ–¹å¼ï¼Œä½¿ç”¨æ›²çº¿å’Œå¯¹åº”çš„å¯†é’¥ä½æ•°åŠæ•£åˆ—ç®—æ³•çš„å…³ç³»ã€‚</li>
  <li><a href="https://tools.ietf.org/html/rfc8017">RFC 8017 - RSA ç®—æ³•ç›¸å…³çš„æ ‡å‡†</a>ï¼šåŒ…æ‹¬åƒæ˜¯ RSA key çš„ ASN.1 å®šä¹‰ï¼Œæ‰€æ³¨å†Œçš„ OIDs ã€‚</li>
</ul>

<h5 id="å…³äº-jose">å…³äº JOSE</h5>

<ul>
  <li><a href="https://tools.ietf.org/html/rfc7515">RFC 7515 - JSON Web Signature (JWS)</a></li>
  <li><a href="https://tools.ietf.org/html/rfc7516">RFC 7516 - JSON Web Encryption (JWE)</a></li>
  <li><a href="https://tools.ietf.org/html/rfc7517">RFC 7517 - JSON Web Key (JWK)</a></li>
  <li><a href="https://tools.ietf.org/html/rfc7518">RFC 7518 - JSON Web Algorithms (JWA)</a></li>
  <li><a href="https://tools.ietf.org/html/rfc7519">RFC 7519 - JSON Web Token (JWT)</a></li>
  <li><a href="https://tools.ietf.org/html/rfc7165">RFC 7165 - JOSE çš„ä½¿ç”¨ä¾‹å­å’Œè¦æ±‚</a></li>
</ul>

<h5 id="æ‚é¡¹">æ‚é¡¹</h5>

<ul>
  <li><a href="https://tools.ietf.org/html/rfc4648">RFC 4648 - å…³äº Base64Url çš„ç¼–ç è§„åˆ™</a>ï¼šJOSE ä¸­çš„æ•°æ®éƒ½æ˜¯ä½¿ç”¨ Base64Url è¿›è¡Œç¼–ç çš„ã€‚</li>
  <li><a href="https://openid.net/specs/openid-connect-discovery-1_0.html">OpenID Connect Discovery</a>ï¼šOpenID ç›¸å…³çš„ profile å–å¾—æ–¹å¼ï¼Œä»¥åŠå…¶ä¸­é”®å€¼å¯¹çš„å®šä¹‰ã€‚å…³äº Discovery Document çš„æ›´å¥½çš„è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒ <a href="https://developers.google.com/identity/protocols/OpenIDConnect#discovery">Google çš„è¿™ä¸ªæŒ‡å—</a>ã€‚</li>
</ul>

<h4 id="éªŒè¯å’Œé€ŸæŸ¥å·¥å…·æ±‡æ€»">éªŒè¯å’Œé€ŸæŸ¥å·¥å…·æ±‡æ€»</h4>

<ul>
  <li><a href="https://holtstrom.com/michael/tools/asn1decoder.php">ASN.1 è§£ç å™¨</a>ï¼šå°†ä¸€æ®µ DER æ•°æ®è§£ç ä¸ºå¯è¯»çš„ ASN.1 è¡¨ç¤ºã€‚</li>
  <li><a href="https://cryptii.com/pipes/base64-to-hex">æ•°æ®æ ¼å¼è½¬æ¢</a>ï¼šå°†æ•°æ®åœ¨ Base64ã€æ–‡æœ¬å’Œå­—èŠ‚è¡¨ç¤ºä¹‹é—´è¿›è¡Œä»»æ„è½¬æ¢ã€‚</li>
  <li><a href="https://www.alvestrand.no/objectid/top.html">ASN.1 ä¸­çš„ OIDs è½¬æ¢</a>ï¼šå¸®åŠ©è§£ç å’Œç¼–ç  OBJECT IDENTIFIER å€¼ã€‚</li>
  <li><a href="https://8gwifi.org/jwkconvertfunctions.jsp">JWK å’Œ PEM ç›¸äº’è½¬æ¢</a>ï¼šå°† JWK æˆ–è€… PEM çš„å¯†é’¥ç›¸äº’è½¬æ¢çš„å·¥å…·ã€‚</li>
</ul>

<h4 id="ä½ çš„è¿™ç¯‡æ–‡ç« æˆ–è€…ä»£ç å¥½åƒæœ‰é—®é¢˜">ä½ çš„è¿™ç¯‡æ–‡ç« æˆ–è€…ä»£ç å¥½åƒæœ‰é—®é¢˜ï¼</h4>

<p>æˆ‘æ˜¯åˆå­¦è€…ï¼Œæ–‡ç« ä¸­çš„çº°æ¼è¯·ä¸åèµæ•™æŒ‡å‡ºï¼</p>

<p>å…³äºä»£ç æ–¹é¢çš„ä¸è¶³ï¼Œ<a href="https://github.com/line/line-sdk-ios-swift">LINE SDK</a> æ¬¢è¿å„ç§ PRã€‚ä½†æ˜¯å¦‚æœæ‚¨å‘ç°çš„é—®é¢˜æ¶‰åŠå®‰å…¨æ¼æ´ï¼Œæˆ–è€…ä¼šå¯¼è‡´æ¯”è¾ƒä¸¥é‡åæœçš„è¯ï¼Œè¿˜è¯·<strong>å…ˆä¸è¦å…¬å¼€å…¬å¸ƒ</strong>ã€‚å¦‚æœèƒ½æŒ‰ç…§<a href="https://github.com/line/line-sdk-ios-swift/blob/master/.github/ISSUE_TEMPLATE.md">è¿™é‡Œçš„è¯´æ˜</a>ç»™æˆ‘ä»¬å‘é€é‚®ä»¶è”ç³»çš„è¯ï¼Œå®åœ¨æ„Ÿæ¿€ä¸å°½ã€‚</p>

:ET