I"›t<p>è¿™æ˜¯æˆ‘çš„WWDC2013ç³»åˆ—ç¬”è®°ä¸­çš„ä¸€ç¯‡ï¼Œå®Œæ•´çš„ç¬”è®°åˆ—è¡¨è¯·å‚çœ‹<a href="http://onevcat.com/2013/06/developer-should-know-about-ios7/">è¿™ç¯‡æ€»è§ˆ</a>ã€‚æœ¬æ–‡ä»…ä½œä¸ºä¸ªäººè®°å½•ä½¿ç”¨ï¼Œä¹Ÿæ¬¢è¿åœ¨<a href="http://creativecommons.org/licenses/by-nc/3.0/deed.zh">è®¸å¯åè®®</a>èŒƒå›´å†…è½¬è½½æˆ–ä½¿ç”¨ï¼Œä½†æ˜¯è¿˜çƒ¦è¯·ä¿ç•™åŸæ–‡é“¾æ¥ï¼Œè°¢è°¢æ‚¨çš„ç†è§£åˆä½œã€‚å¦‚æœæ‚¨è§‰å¾—æœ¬ç«™å¯¹æ‚¨èƒ½æœ‰å¸®åŠ©ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<a href="http://onevcat.com/atom.xml">RSS</a>æˆ–<a href="http://eepurl.com/wNSkj">é‚®ä»¶</a>æ–¹å¼è®¢é˜…æœ¬ç«™ï¼Œè¿™æ ·æ‚¨å°†èƒ½åœ¨ç¬¬ä¸€æ—¶é—´è·å–æœ¬ç«™ä¿¡æ¯ã€‚</p>

<p>æœ¬æ–‡æ¶‰åŠåˆ°çš„WWDC2013 Sessionæœ‰</p>

<ul>
  <li>Session 206 Getting Started with UIKit Dynamics</li>
  <li>Session 217 Exploring Scroll Views in iOS7</li>
</ul>

<p>UIScrollViewå¯ä»¥è¯´æ˜¯UIKitä¸­æœ€é‡è¦çš„ç±»ä¹‹ä¸€äº†ï¼ŒåŒ…æ‹¬UITableViewå’ŒUICollectionViewç­‰é‡è¦çš„æ•°æ®å®¹å™¨ç±»éƒ½æ˜¯UIScrollViewçš„å­ç±»ã€‚åœ¨å†å¹´çš„WWDCä¸Šï¼ŒUIScrollViewå’Œç›¸å…³çš„APIéƒ½æœ‰ä¸“é—¨çš„ä¸»é¢˜è¿›è¡Œä»‹ç»ï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸ªç±»çš„ä½¿ç”¨å’Œå˜åŒ–ä¹‹å¿«ã€‚ä»Šå¹´ä¹Ÿä¸ä¾‹å¤–ï¼Œå› ä¸ºiOS7å®Œå…¨é‡æ–°å®šä¹‰äº†UIï¼Œè¿™ä½¿å¾—UIScrollViewé‡ŒåŸæ¥ä¸å¤ªä¼šä½¿ç”¨çš„ä¸€äº›ç”¨æ³•å’Œå®ç°çš„æ•ˆæœåœ¨æ–°çš„ç³»ç»Ÿä¸­å¾—åˆ°äº†å¾ˆå¥½çš„è¡¨ç°ã€‚å¦å¤–ï¼Œç”±äºå¼•å…¥äº†UIKit Dynamicsï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç»“åˆScrollViewåšå‡ºä¸€äº›ä»¥å‰ä¸å¤ªå¯èƒ½æˆ–è€…éœ€è¦èŠ±è´¹å¾ˆå¤§åŠ›æ°”æ¥å®ç°çš„æ•ˆæœï¼ŒåŒ…æ‹¬å¸¦æœ‰é‡åŠ›çš„swipeæˆ–è€…æ˜¯ç±»ä¼¼æ–°çš„ä¿¡æ¯appä¸­çš„å¸¦æœ‰å¼¹ç°§æ•ˆæœèŠå¤©æ³¡æ³¡ç­‰ã€‚å¦‚æœæ‚¨è¿˜ä¸å¤ªäº†è§£iOS7ä¸­ä¿¡æ¯appçš„æ•ˆæœï¼Œè¿™é‡Œæœ‰ä¸€å¼ gifå›¾å¯ä»¥å¸®æ‚¨å¤§æ¦‚äº†è§£ä¸€ä¸‹ï¼š</p>

<p><img src="/assets/images/2013/ios7-message-app-spring.gif" alt="iOS7ä¸­ä¿¡æ¯appçš„å¼¹ç°§æ•ˆæœ" /></p>

<p>è¿™æ¬¡ç¬”è®°çš„å†…å®¹ä¸»è¦å°±æ˜¯å®ç°ä¸€ä¸ªè¿™æ ·çš„æ•ˆæœã€‚ä¸ºäº†é¿å…é‡å¤é€ è½®å­ï¼Œæˆ‘å¯¹è¿™ä¸ªæ•ˆæœè¿›è¡Œäº†ä¸€äº›ç®€å•çš„å°è£…ï¼Œå¹¶è¿åŒè¿™ç¯‡ç¬”è®°çš„demoä¸€èµ·æ‰”åœ¨äº†Githubä¸Šï¼Œæœ‰éœ€è¦çš„ç«¥é‹å¯ä»¥<a href="https://github.com/onevcat/VVSpringCollectionViewFlowLayout">åˆ°è¿™é‡Œ</a>è‡ªå–ã€‚</p>

<p>iOS7çš„SDKä¸­Appleæœ€å¤§çš„é‡å¿ƒå…¶å®æ˜¯æƒ³ç”¨SpriteKitæ¥ç»“æŸiOSå¹³å°æ¸¸æˆå¼€å‘ï¼ˆè‡³å°‘æ˜¯2Dæ¸¸æˆå¼€å‘ï¼‰çš„ä¹±æˆ˜ï¼Œç»Ÿä¸€æ¸¸æˆå¼€å‘çš„æ–¹å¼å¹¶å»ºç«‹è‰¯æ€§ç¤¾åŒºã€‚è€ŒUIKit Dynamicsï¼Œä¸ªäººçŒœæµ‹Appleåœ¨èŠ±è´¹åŠ›æ°”ä¸ºSpriteKitå¼€å‘äº†ç‰©ç†å¼•æ“çš„åŒæ—¶ï¼Œå‘ç°åœ¨UIKitä¸­ä¹Ÿå¯ä»¥ä½¿ç”¨ï¼Œå¹¶èƒ½å¾—åˆ°ä¸é”™çš„æ•ˆæœï¼Œäºæ˜¯é¡ºä¾¿é©æ–°äº†ä¸€ä¸‹è®¾è®¡ç†å¿µï¼Œåœ¨UIè®¾è®¡ä¸­å¼•å…¥äº†ä¸å°‘ç‰©ç†çš„æ¦‚å¿µã€‚åœ¨iOSç³»ç»Ÿä¸­ï¼Œæœ€ä¸ºå…¸å‹çš„åº”ç”¨æ˜¯é”å±ç•Œé¢æ‰“å¼€ç›¸æœºæ—¶ä¸­é€”æ”¾å¼ƒåçš„é‡åŠ›ä¸‹å +åå¼¹çš„æ•ˆæœï¼Œå¦ä¸€ä¸ªå°±æ˜¯ä¿¡æ¯åº”ç”¨ä¸­çš„åŠ å…¥å¼¹æ€§çš„æ¶ˆæ¯åˆ—è¡¨äº†ã€‚å¼¹æ€§åˆ—è¡¨åœ¨æˆ‘è‡ªå·±ä¸Šæ‰‹è¯•è¿‡ä»¥åè§‰å¾—è¡¨ç°å½¢å¼ç¡®å®å¾ˆç”ŸåŠ¨ï¼Œå¯ä»¥æ¶ˆé™¤åŸæ¥åˆ—è¡¨é‚£ç§å†·å†°å†°çš„æ„Ÿè§‰ï¼Œæ˜¯æœ‰å¯èƒ½åœ¨ä»Šåçš„è®¾è®¡ä¸­è¢«å¤§é‡ä½¿ç”¨çš„ï¼Œå› æ­¤å†³å®šå­¦ä¸Šä¸€å­¦ã€‚</p>

<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“è¦å¦‚ä½•å®ç°è¿™æ ·ä¸€ç§æ•ˆæœï¼Œæˆ‘ä»¬ä¼šç”¨åˆ°å“ªäº›ä¸œè¥¿ã€‚æ¯‹åº¸ç½®ç–‘ï¼Œå¦‚æœä¸ä½¿ç”¨UIKit Dynamicsçš„è¯ï¼Œè‡ªå·±ä»å¤´å¼€å§‹æ¥å®Œæˆä¼šæ˜¯ä¸€ä»¶éå¸¸è´¹åŠ›çš„äº‹æƒ…ï¼Œä½ å¯èƒ½éœ€è¦å®ç°ä¸€å¥—ä½ç½®è®¡ç®—å’Œç‰©ç†æ¨¡æ‹Ÿæ¥ä½¿æ•ˆæœçœ‹èµ·æ¥çœŸå®æ»‘æ¶¦ã€‚è€ŒUIKit Dynamicsä¸­å·²ç»ç»™æˆ‘ä»¬æä¾›äº†ç°æˆçš„å¼¹ç°§æ•ˆæœï¼Œå¯ä»¥ç”¨<code class="highlighter-rouge">UIAttachmentBehavior</code>è¿›è¡Œå®ç°ã€‚å¦å¤–ï¼Œåœ¨è¯´åˆ°å¼¹æ€§æ•ˆæœçš„æ—¶å€™ï¼Œæˆ‘ä»¬å…¶å®æ˜¯åœ¨æè¿°ä¸€ä¸ªåˆ—è¡¨ä¸­çš„å„ä¸ªcellä¹‹é—´çš„å…³ç³»ï¼Œå¯¹äºä¼ ç»Ÿçš„UITableViewæ¥è¯´ï¼Œæè¿°UITableViewCellä¹‹é—´çš„å…³ç³»æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼ˆå› ä¸ºAppleå·²ç»æŠŠç»å¤§å¤šæ•°å·¥ä½œåšäº†ï¼ŒåŒ…æ‹¬è®¡ç®—cellä½ç½®å’Œä½ç§»ç­‰ã€‚ä½¿ç”¨è¶Šç®€å•ï¼Œå®šåˆ¶å°±ä¼šè¶Šéº»çƒ¦åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯çœŸç†ï¼‰ã€‚è€ŒUICollectionViewåˆ™é€šè¿‡layoutæ¥å®Œæˆcellä¹‹é—´ä½ç½®å…³ç³»çš„æè¿°ï¼Œç»™äº†å¼€å‘è€…è¾ƒå¤§çš„ç©ºé—´æ¥å®ç°å¸ƒå±€ã€‚å¦å¤–ï¼ŒUIKit Dynamicsä¸ºUICollectionViewåšäº†å¾ˆå¤šæ–¹ä¾¿çš„Catagoryï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°â€œæŒ‡å¯¼â€UICollectionViewåˆ©ç”¨åŠ å…¥ç‰©ç†ç‰¹æ€§è®¡ç®—åçš„ç»“æœï¼Œåœ¨å®ç°å¼¹æ€§æ•ˆæœçš„æ—¶å€™ï¼ŒUICollectionViewæ˜¯æˆ‘ä»¬ä¸äºŒçš„é€‰æ‹©ã€‚</p>

<p>å¦‚æœæ‚¨åœ¨é˜…è¯»è¿™ç¯‡ç¬”è®°çš„æ—¶å€™é‡åˆ°å›°éš¾çš„è¯ï¼Œå»ºè®®æ‚¨å¯ä»¥çœ‹çœ‹æˆ‘ä¹‹å‰çš„ä¸€äº›ç¬”è®°ï¼ŒåŒ…æ‹¬ä»Šå¹´çš„<a href="http://onevcat.com/2013/06/uikit-dynamics-started/">UIKit Dynamicsçš„ä»‹ç»</a>å’Œå»å¹´çš„<a href="http://onevcat.com/2012/06/introducing-collection-views/">UICollectionViewä»‹ç»</a>ã€‚</p>

<p>è¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬å¼€å·¥ã€‚é¦–å…ˆå‡†å¤‡ä¸€ä¸ªUICollectionViewFlowLayoutçš„å­ç±»ï¼ˆåœ¨è¿™é‡Œå«åš<code class="highlighter-rouge">VVSpringCollectionViewFlowLayout</code>ï¼‰ï¼Œç„¶ååœ¨ViewControllerä¸­ç”¨è¿™ä¸ªlayoutå®ç°ä¸€ä¸ªç®€å•çš„collectionViewï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ViewController.m</span>

<span class="k">@interface</span> <span class="nc">ViewController</span> <span class="p">()</span><span class="o">&lt;</span><span class="n">UICollectionViewDataSource</span><span class="p">,</span> <span class="n">UICollectionViewDelegate</span><span class="o">&gt;</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">VVSpringCollectionViewFlowLayout</span> <span class="o">*</span><span class="n">layout</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">static</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">reuseId</span> <span class="o">=</span> <span class="s">@"collectionViewCellReuseId"</span><span class="p">;</span>

<span class="k">@implementation</span> <span class="nc">ViewController</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">viewDidLoad</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">viewDidLoad</span><span class="p">];</span>
	<span class="c1">// Do any additional setup after loading the view, typically from a nib.</span>
    
	<span class="n">self</span><span class="p">.</span><span class="n">layout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">VVSpringCollectionViewFlowLayout</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">itemSize</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">44</span><span class="p">);</span>
    <span class="n">UICollectionView</span> <span class="o">*</span><span class="n">collectionView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UICollectionView</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithFrame</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">view</span><span class="p">.</span><span class="n">frame</span> <span class="nf">collectionViewLayout</span><span class="p">:</span><span class="n">self</span><span class="p">.</span><span class="n">layout</span><span class="p">];</span>
    
    <span class="n">collectionView</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">clearColor</span><span class="p">];</span>
    
    <span class="p">[</span><span class="n">collectionView</span> <span class="nf">registerClass</span><span class="p">:[</span><span class="n">UICollectionViewCell</span> <span class="nf">class</span><span class="p">]</span> <span class="nf">forCellWithReuseIdentifier</span><span class="p">:</span><span class="n">reuseId</span><span class="p">];</span>
    
    <span class="n">collectionView</span><span class="p">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">view</span> <span class="nf">insertSubview</span><span class="p">:</span><span class="n">collectionView</span> <span class="nf">atIndex</span><span class="p">:</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="cp">#pragma mark - UICollectionViewDataSource
</span><span class="k">-</span> <span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">collectionView</span><span class="p">:(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> <span class="nf">numberOfItemsInSection</span><span class="p">:(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">section</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="mi">50</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">-</span> <span class="p">(</span><span class="n">UICollectionViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nf">collectionView</span><span class="p">:(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> <span class="nf">cellForItemAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span>
<span class="p">{</span>
    <span class="n">UICollectionViewCell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="p">[</span><span class="n">collectionView</span> <span class="nf">dequeueReusableCellWithReuseIdentifier</span><span class="p">:</span><span class="n">reuseId</span> <span class="nf">forIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">];</span>
    
    <span class="c1">//Just give a random color to the cell. See https://gist.github.com/kylefox/1689973</span>
    <span class="n">cell</span><span class="p">.</span><span class="n">contentView</span><span class="p">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIColor</span> <span class="nf">randomColor</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">cell</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>è¿™éƒ¨åˆ†æ²¡ä»€ä¹ˆå¯ä»¥å¤šè¯´çš„ï¼Œç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªæ ‡å‡†çš„FlowLayoutçš„UICollectionViewäº†ã€‚é€šè¿‡ä½¿ç”¨UICollectionViewFlowLayoutçš„å­ç±»æ¥ä½œä¸ºå¼€å§‹çš„layoutï¼Œæˆ‘ä»¬å¯ä»¥èŠ‚çœä¸‹æ‰€æœ‰çš„åˆå§‹cellä½ç½®è®¡ç®—çš„ä»£ç ï¼Œåœ¨ä¸Šé¢ä»£ç çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªcollectionViewçš„è¡¨ç°å’Œä¸€ä¸ªæ™®é€šçš„tableViewå¹¶æ²¡æœ‰å¤ªå¤§ä¸åŒã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ç€é‡æ¥çœ‹çœ‹è¦å¦‚ä½•å®ç°å¼¹æ€§çš„layoutã€‚å¯¹äºå¼¹æ€§æ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯è¿æ¥ä¸€ä¸ªitemå’Œä¸€ä¸ªé”šç‚¹é—´å¼¹æ€§è¿æ¥çš„<code class="highlighter-rouge">UIAttachmentBehavior</code>ï¼Œå¹¶èƒ½åœ¨æ»šåŠ¨æ—¶è®¾ç½®æ–°çš„é”šç‚¹ä½ç½®ã€‚æˆ‘ä»¬åœ¨scrollçš„æ—¶å€™ï¼Œåªè¦ä½¿ç”¨UIKit Dynamicsçš„è®¡ç®—ç»“æœï¼Œæ›¿ä»£æ‰åŸæ¥çš„ä½ç½®æ›´æ–°è®¡ç®—ï¼ˆå…¶å®å°±æ˜¯ç®€å•çš„scrollViewçš„contentOffsetçš„æ”¹å˜ï¼‰ï¼Œå°±å¯ä»¥æ¨¡æ‹Ÿå‡ºå¼¹æ€§çš„æ•ˆæœäº†ã€‚</p>

<p>é¦–å…ˆåœ¨<code class="highlighter-rouge">-prepareLayout</code>ä¸­ä¸ºcellæ·»åŠ <code class="highlighter-rouge">UIAttachmentBehavior</code>ã€‚</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//VVSpringCollectionViewFlowLayout.m</span>
<span class="k">@interface</span> <span class="nc">VVSpringCollectionViewFlowLayout</span><span class="p">()</span>
<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">UIDynamicAnimator</span> <span class="o">*</span><span class="n">animator</span><span class="p">;</span>
<span class="k">@end</span>

<span class="k">@implementation</span> <span class="nc">VVSpringCollectionViewFlowLayout</span>
<span class="c1">//...</span>

<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">prepareLayout</span> <span class="p">{</span>
    <span class="p">[</span><span class="n">super</span> <span class="nf">prepareLayout</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_animator</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_animator</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIDynamicAnimator</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithCollectionViewLayout</span><span class="p">:</span><span class="n">self</span><span class="p">];</span>
        <span class="n">CGSize</span> <span class="n">contentSize</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span> <span class="nf">collectionViewContentSize</span><span class="p">];</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">super</span> <span class="nf">layoutAttributesForElementsInRect</span><span class="p">:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">contentSize</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">contentSize</span><span class="p">.</span><span class="n">height</span><span class="p">)];</span>
        
        <span class="k">for</span> <span class="p">(</span><span class="n">UICollectionViewLayoutAttributes</span> <span class="o">*</span><span class="n">item</span> <span class="k">in</span> <span class="n">items</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">UIAttachmentBehavior</span> <span class="o">*</span><span class="n">spring</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIAttachmentBehavior</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">initWithItem</span><span class="p">:</span><span class="n">item</span> <span class="nf">attachedToAnchor</span><span class="p">:</span><span class="n">item</span><span class="p">.</span><span class="n">center</span><span class="p">];</span>
            
            <span class="n">spring</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">spring</span><span class="p">.</span><span class="n">damping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
            <span class="n">spring</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">;</span>
            
            <span class="p">[</span><span class="n">_animator</span> <span class="nf">addBehavior</span><span class="p">:</span><span class="n">spring</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>prepareLayoutå°†åœ¨CollectionViewè¿›è¡Œæ’ç‰ˆçš„æ—¶å€™è¢«è°ƒç”¨ã€‚é¦–å…ˆå½“ç„¶æ˜¯callä¸€ä¸‹superçš„prepareLayoutï¼Œä½ è‚¯å®šä¸ä¼šæƒ³è¦å…¨éƒ½è¦è‡ªå·±è¿›è¡Œè®¾ç½®çš„ã€‚æ¥ä¸‹æ¥ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„è¯ï¼Œå…ˆåˆå§‹åŒ–ä¸€ä¸ªUIDynamicAnimatorå®ä¾‹ï¼Œæ¥è´Ÿè´£ä¹‹åçš„åŠ¨ç”»æ•ˆæœã€‚iOS7 SDKä¸­ï¼ŒUIDynamicAnimatorç±»ä¸“é—¨æœ‰ä¸€ä¸ªé’ˆå¯¹UICollectionViewçš„Categoryï¼Œä»¥ä½¿UICollectionViewèƒ½å¤Ÿè½»æ˜“åœ°åˆ©ç”¨UIKit Dynamicsçš„ç»“æœã€‚åœ¨<code class="highlighter-rouge">UIDynamicAnimator.h</code>ä¸­èƒ½å¤Ÿæ‰¾åˆ°è¿™ä¸ªCategoryï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">UIDynamicAnimator</span> <span class="p">(</span><span class="nl">UICollectionViewAdditions</span><span class="p">)</span>

<span class="c1">// When you initialize a dynamic animator with this method, you should only associate collection view layout attributes with your behaviors.</span>
<span class="c1">// The animator will employ thecollection view layoutâ€™s content size coordinate system.</span>
<span class="k">-</span> <span class="p">(</span><span class="n">instancetype</span><span class="p">)</span><span class="nf">initWithCollectionViewLayout</span><span class="p">:(</span><span class="n">UICollectionViewLayout</span><span class="o">*</span><span class="p">)</span><span class="nv">layout</span><span class="p">;</span>

<span class="c1">// The three convenience methods returning layout attributes (if associated to behaviors in the animator) if the animator was configured with collection view layout</span>
<span class="k">-</span> <span class="p">(</span><span class="n">UICollectionViewLayoutAttributes</span><span class="o">*</span><span class="p">)</span><span class="nf">layoutAttributesForCellAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span><span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">UICollectionViewLayoutAttributes</span><span class="o">*</span><span class="p">)</span><span class="nf">layoutAttributesForSupplementaryViewOfKind</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">kind</span> <span class="nf">atIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">UICollectionViewLayoutAttributes</span><span class="o">*</span><span class="p">)</span><span class="nf">layoutAttributesForDecorationViewOfKind</span><span class="p">:(</span><span class="n">NSString</span><span class="o">*</span><span class="p">)</span><span class="nv">decorationViewKind</span> <span class="nf">atIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>äºæ˜¯é€šè¿‡<code class="highlighter-rouge">-initWithCollectionViewLayout:</code>è¿›è¡Œåˆå§‹åŒ–åï¼Œè¿™ä¸ªUIDynamicAnimatorå®ä¾‹ä¾¿å’Œæˆ‘ä»¬çš„layoutè¿›è¡Œäº†ç»‘å®šï¼Œä¹‹åè¿™ä¸ªlayoutå¯¹åº”çš„attributeséƒ½åº”è¯¥ç”±ç»‘å®šçš„UIDynamicAnimatorçš„å®ä¾‹ç»™å‡ºã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//VVSpringCollectionViewFlowLayout.m</span>
<span class="k">@implementation</span> <span class="nc">VVSpringCollectionViewFlowLayout</span>

<span class="c1">//...</span>

<span class="k">-</span><span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="nf">layoutAttributesForElementsInRect</span><span class="p">:(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">rect</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_animator</span> <span class="nf">itemsInRect</span><span class="p">:</span><span class="n">rect</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">-</span><span class="p">(</span><span class="n">UICollectionViewLayoutAttributes</span> <span class="o">*</span><span class="p">)</span><span class="nf">layoutAttributesForItemAtIndexPath</span><span class="p">:(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">_animator</span> <span class="nf">layoutAttributesForCellAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">@end</span>
</code></pre></div></div>

<p>è®©æˆ‘ä»¬å›åˆ°<code class="highlighter-rouge">-prepareLayout</code>æ–¹æ³•ä¸­ï¼Œåœ¨åˆ›å»ºäº†UIDynamicAnimatorå®ä¾‹åï¼Œæˆ‘ä»¬å¯¹äºè¿™ä¸ªlayoutä¸­çš„æ¯ä¸ªattributeså¯¹åº”çš„ç‚¹ï¼Œéƒ½åˆ›å»ºå¹¶æ·»åŠ ä¸€ä¸ªæ·»åŠ ä¸€ä¸ª<code class="highlighter-rouge">UIAttachmentBehavior</code>ï¼ˆåœ¨iOS7 SDKä¸­ï¼ŒUICollectionViewLayoutAttributeså·²ç»å®ç°äº†UIDynamicItemæ¥å£ï¼Œå¯ä»¥ç›´æ¥å‚ä¸UIKit Dynamicçš„è®¡ç®—ä¸­å»ï¼‰ã€‚åˆ›å»ºæ—¶æˆ‘ä»¬å¸Œæœ›collectionViewçš„æ¯ä¸ªcellå°±ä¿æŒåœ¨åŸä½ï¼Œå› æ­¤æˆ‘ä»¬è®¾å®šäº†é”šç‚¹ä¸ºå½“å‰attributeæœ¬èº«çš„centerã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬è€ƒè™‘æ»‘åŠ¨æ—¶çš„å¼¹æ€§æ•ˆæœçš„å®ç°ã€‚åœ¨ç³»ç»Ÿçš„ä¿¡æ¯appä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¼¹æ€§æ•ˆæœæœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š</p>

<ul>
  <li>éšç€æ»‘åŠ¨çš„é€Ÿåº¦å¢å¤§ï¼Œåˆå§‹çš„æ‹‰ä¼¸å’Œå‹ç¼©çš„å¹…åº¦å°†å˜å¤§</li>
  <li>éšç€cellè·ç¦»å±å¹•è§¦æ‘¸ä½ç½®è¶Šè¿œï¼Œæ‹‰ä¼¸å’Œå‹ç¼©çš„å¹…åº¦</li>
</ul>

<p>å¯¹äºè€ƒè™‘åˆ°è¿™ä¸¤æ–¹é¢çš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬æ‰€æœŸæœ›çš„æ»‘åŠ¨æ—¶çš„å„cellé”šç‚¹çš„å˜åŒ–åº”è¯¥æ˜¯ç±»ä¼¼è¿™æ ·çš„ï¼š</p>

<p><img src="/assets/images/2013/spring-list-ios7.png" alt="å‘ä¸Šæ‹–åŠ¨æ—¶çš„é”šç‚¹å˜åŒ–ç¤ºæ„" /></p>

<p>ç°åœ¨æˆ‘ä»¬æ¥å®ç°è¿™ä¸ªé”šç‚¹çš„å˜åŒ–ã€‚æ—¢ç„¶éƒ½æ˜¯æ»‘åŠ¨ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è€ƒè™‘åœ¨UIScrollViewçš„<code class="highlighter-rouge">â€“scrollViewDidScroll:</code>å§”æ‰˜æ–¹æ³•ä¸­æ¥è®¾å®šæ–°çš„Behavioré”šç‚¹å€¼å‘¢ï¼Ÿç†è®ºä¸Šæ¥è¯´å½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å¦‚æœè¿™æ ·çš„è¯æˆ‘ä»¬å¤§æ¦‚å°±ä¸å¾—ä¸é¢ä¸´ç€å°†åˆšæ‰çš„layoutå®ä¾‹è®¾ç½®ä¸ºcollectionViewçš„delegateè¿™æ ·ä¸€ä¸ªäº‹å®ã€‚ä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“layoutåº”è¯¥åšçš„äº‹æƒ…æ˜¯ç»™collectionViewæä¾›å¿…è¦çš„å¸ƒå±€ä¿¡æ¯ï¼Œè€Œä¸åº”è¯¥è´Ÿè´£å»å¤„ç†å®ƒçš„å§”æ‰˜äº‹ä»¶ã€‚å¤„ç†collectionViewçš„å›è°ƒæ›´æ°å½“åœ°åº”è¯¥ç”±å¤„äºcollectionViewçš„controllerå±‚çº§çš„ç±»æ¥å®Œæˆï¼Œè€Œä¸åº”è¯¥ç”±ä¸€ä¸ªç»™collectionViewæä¾›æ•°æ®å’Œä¿¡æ¯çš„ç±»æ¥å“åº”ã€‚åœ¨<code class="highlighter-rouge">UICollectionViewLayout</code>ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå«åš<code class="highlighter-rouge">-shouldInvalidateLayoutForBoundsChange:</code>çš„æ–¹æ³•ï¼Œæ¯æ¬¡layoutçš„boundså‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼ŒcollectionViewéƒ½ä¼šè¯¢é—®è¿™ä¸ªæ–¹æ³•æ˜¯å¦éœ€è¦ä¸ºè¿™ä¸ªæ–°çš„è¾¹ç•Œå’Œæ›´æ–°layoutã€‚ä¸€èˆ¬æƒ…å†µä¸‹åªè¦layoutæ²¡æœ‰æ ¹æ®è¾¹ç•Œä¸åŒè€Œå‘ç”Ÿå˜åŒ–çš„è¯ï¼Œè¿™ä¸ªæ–¹æ³•ç›´æ¥ä¸åšå¤„ç†åœ°è¿”å›NOï¼Œè¡¨ç¤ºä¿æŒç°åœ¨çš„layoutå³å¯ï¼Œè€Œæ¯æ¬¡boundsæ”¹å˜æ—¶è¿™ä¸ªæ–¹æ³•éƒ½ä¼šè¢«è°ƒç”¨çš„ç‰¹ç‚¹æ­£å¥½å¯ä»¥æ»¡è¶³æˆ‘ä»¬æ›´æ–°é”šç‚¹çš„éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œé¢å®Œæˆé”šç‚¹çš„æ›´æ–°ã€‚</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//VVSpringCollectionViewFlowLayout.m</span>
<span class="k">@implementation</span> <span class="nc">VVSpringCollectionViewFlowLayout</span>

<span class="c1">//...</span>

<span class="k">-</span><span class="p">(</span><span class="n">BOOL</span><span class="p">)</span><span class="nf">shouldInvalidateLayoutForBoundsChange</span><span class="p">:(</span><span class="n">CGRect</span><span class="p">)</span><span class="nv">newBounds</span> <span class="p">{</span>
    <span class="n">UIScrollView</span> <span class="o">*</span><span class="n">scrollView</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">collectionView</span><span class="p">;</span>
    <span class="n">CGFloat</span> <span class="n">scrollDelta</span> <span class="o">=</span> <span class="n">newBounds</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">scrollView</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
    
    <span class="c1">//Get the touch point</span>
    <span class="n">CGPoint</span> <span class="n">touchLocation</span> <span class="o">=</span> <span class="p">[</span><span class="n">scrollView</span><span class="p">.</span><span class="n">panGestureRecognizer</span> <span class="nf">locationInView</span><span class="p">:</span><span class="n">scrollView</span><span class="p">];</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">UIAttachmentBehavior</span> <span class="o">*</span><span class="n">spring</span> <span class="k">in</span> <span class="n">_animator</span><span class="p">.</span><span class="n">behaviors</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CGPoint</span> <span class="n">anchorPoint</span> <span class="o">=</span> <span class="n">spring</span><span class="p">.</span><span class="n">anchorPoint</span><span class="p">;</span>
        
        <span class="n">CGFloat</span> <span class="n">distanceFromTouch</span> <span class="o">=</span> <span class="n">fabsf</span><span class="p">(</span><span class="n">touchLocation</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">anchorPoint</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
        <span class="n">CGFloat</span> <span class="n">scrollResistance</span> <span class="o">=</span> <span class="n">distanceFromTouch</span> <span class="o">/</span> <span class="mi">500</span><span class="p">;</span>
        
        <span class="n">UICollectionViewLayoutAttributes</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="p">[</span><span class="n">spring</span><span class="p">.</span><span class="n">items</span> <span class="nf">firstObject</span><span class="p">];</span>
        <span class="n">CGPoint</span> <span class="n">center</span> <span class="o">=</span> <span class="n">item</span><span class="p">.</span><span class="n">center</span><span class="p">;</span>

		<span class="c1">//In case the added value bigger than the scrollDelta, which leads an unreasonable effect</span>
        <span class="n">center</span><span class="p">.</span><span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">scrollDelta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">?</span> <span class="n">MIN</span><span class="p">(</span><span class="n">scrollDelta</span><span class="p">,</span> <span class="n">scrollDelta</span> <span class="o">*</span> <span class="n">scrollResistance</span><span class="p">)</span>
                                      <span class="p">:</span> <span class="n">MAX</span><span class="p">(</span><span class="n">scrollDelta</span><span class="p">,</span> <span class="n">scrollDelta</span> <span class="o">*</span> <span class="n">scrollResistance</span><span class="p">);</span>
        <span class="n">item</span><span class="p">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span><span class="p">;</span>
        
        <span class="p">[</span><span class="n">_animator</span> <span class="nf">updateItemUsingCurrentState</span><span class="p">:</span><span class="n">item</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>é¦–å…ˆæˆ‘ä»¬è®¡ç®—äº†è¿™æ¬¡scrollçš„è·ç¦»<code class="highlighter-rouge">scrollDelta</code>ï¼Œä¸ºäº†å¾—åˆ°æ¯ä¸ªitemä¸è§¦æ‘¸ç‚¹çš„ä¹‹é—´çš„è·ç¦»ï¼Œæˆ‘ä»¬å½“ç„¶è¿˜éœ€è¦çŸ¥é“è§¦æ‘¸ç‚¹çš„åæ ‡<code class="highlighter-rouge">touchLocation</code>ã€‚æ¥ä¸‹æ¥ï¼Œå¯ä»¥æ ¹æ®è·ç¦»å¯¹æ¯ä¸ªé”šç‚¹è¿›è¡Œè®¾ç½®äº†ï¼šç®€å•åœ°è®¡ç®—äº†åŸæ¥é”šç‚¹ä¸è§¦æ‘¸ç‚¹ä¹‹é—´çš„è·ç¦»<code class="highlighter-rouge">distanceFromTouch</code>ï¼Œå¹¶ç”±æ­¤è®¡ç®—ä¸€ä¸ªç³»æ•°ã€‚æ¥ä¸‹æ¥ï¼Œå¯¹äºå½“å‰çš„itemï¼Œæˆ‘ä»¬è·å–å…¶å½“å‰é”šç‚¹ä½ç½®ï¼Œç„¶åå°†å…¶æ ¹æ®<code class="highlighter-rouge">scrollDelta</code>çš„æ•°å€¼å’Œåˆšæ‰è®¡ç®—çš„ç³»æ•°ï¼Œé‡æ–°è®¾å®šé”šç‚¹çš„ä½ç½®ã€‚æœ€åæˆ‘ä»¬éœ€è¦å‘Šè¯‰UIDynamicAnimatoræˆ‘ä»¬å·²ç»å®Œæˆäº†å¯¹å†’ç‚¹çš„æ›´æ–°ï¼Œç°åœ¨å¯ä»¥å¼€å§‹æ›´æ–°ç‰©ç†è®¡ç®—ï¼Œå¹¶éšæ—¶å‡†å¤‡collectionViewæ¥å–LayoutAttributesçš„æ•°æ®äº†ã€‚</p>

<p>ä¹Ÿè®¸ä½ è¿˜æ²¡æœ‰ç¼“è¿‡ç¥æ¥ï¼Ÿä½†æ˜¯æˆ‘ä»¬ç¡®å®å·²ç»åšå®Œäº†ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å®é™…çš„æ•ˆæœå§ï¼š</p>

<p><img src="/assets/images/2013/spring-collection-view-over-ios7.gif" alt="å¸¦æœ‰å¼¹æ€§æ•ˆæœçš„collecitonView" /></p>

<p>å½“ç„¶ï¼Œé€šè¿‡è°ƒèŠ‚<code class="highlighter-rouge">damping</code>ï¼Œ<code class="highlighter-rouge">frequency</code>å’Œ<code class="highlighter-rouge">scrollResistance</code>çš„ç³»æ•°ç­‰å‚æ•°ï¼Œå¯ä»¥å¾—åˆ°å¼¹æ€§ä¸åŒçš„æ•ˆæœï¼Œæ¯”å¦‚æ›´å¤šçš„éœ‡è¡æˆ–è€…æ›´å¤§çš„å¹…åº¦ç­‰ç­‰ã€‚</p>

<p>è¿™ä¸ªlayoutå®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œæˆ‘é¡ºä¾¿å°è£…äº†ä¸€ä¸‹æ”¾åˆ°äº†Githubä¸Šï¼Œå¤§å®¶æœ‰éœ€è¦çš„è¯å¯ä»¥<a href="https://github.com/onevcat/VVSpringCollectionViewFlowLayout">ç‚¹å‡»è¿™é‡Œä¸‹è½½</a>å¹¶ç›´æ¥ä½¿ç”¨ã€‚</p>

:ET