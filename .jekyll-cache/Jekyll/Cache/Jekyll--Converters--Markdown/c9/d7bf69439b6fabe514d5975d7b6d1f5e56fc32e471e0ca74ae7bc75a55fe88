I"‰İ<p>æœ¬æ–‡æ˜¯ç¬”è€…åœ¨ MDCC 16 (ç§»åŠ¨å¼€å‘è€…å¤§ä¼š) ä¸Š iOS ä¸“åœºä¸­çš„ä¸»é¢˜æ¼”è®²çš„æ–‡å­—æ•´ç†ã€‚æ‚¨å¯ä»¥åœ¨<a href="https://speakerdeck.com/onevcat/mian-xiang-xie-yi-bian-cheng-yu-cocoa-de-xie-hou">è¿™é‡Œ</a>æ‰¾åˆ°æ¼”è®²ä½¿ç”¨çš„ Keynoteï¼Œéƒ¨åˆ†ç¤ºä¾‹ä»£ç å¯ä»¥åœ¨ MDCC 2016 çš„<a href="https://github.com/MDCC2016/ProtocolNetwork">å®˜æ–¹ repo</a> ä¸­æ‰¾åˆ°ã€‚</p>

<p>åœ¨<a href="/2016/11/pop-cocoa-1/">ä¸ŠåŠéƒ¨åˆ†</a>ä¸»è¦ä»‹ç»äº†ä¸€äº›ç†è®ºæ–¹é¢çš„å†…å®¹ï¼ŒåŒ…æ‹¬é¢å‘å¯¹è±¡ç¼–ç¨‹å­˜åœ¨çš„é—®é¢˜ï¼Œé¢å‘åè®®çš„åŸºæœ¬æ¦‚å¿µå’Œå†³ç­–æ¨¡å‹ç­‰ã€‚æœ¬æ–‡ (ä¸‹) ä¸»è¦å±•ç¤ºäº†ä¸€äº›ç¬”è€…æ—¥å¸¸ä½¿ç”¨é¢å‘åè®®æ€æƒ³å’Œ Cocoa å¼€å‘ç»“åˆçš„ç¤ºä¾‹ä»£ç ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä¸€äº›è§£è¯´ã€‚</p>

<h2 id="è½¬çƒ­æ‹---åœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨åè®®">è½¬ãƒ»çƒ­æ‹ - åœ¨æ—¥å¸¸å¼€å‘ä¸­ä½¿ç”¨åè®®</h2>

<p>WWDC 2015 åœ¨ POP æ–¹é¢æœ‰ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„ä¸»é¢˜æ¼”è®²ï¼š<a href="https://developer.apple.com/videos/play/wwdc2015/408/">#408 Protocol-Oriented Programming in Swift</a>ã€‚Apple çš„å·¥ç¨‹å¸ˆé€šè¿‡ä¸¾äº†ç”»å›¾è¡¨å’Œæ’åºä¸¤ä¸ªä¾‹å­ï¼Œæ¥é˜é‡Š POP çš„æ€æƒ³ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ POP æ¥è§£è€¦ï¼Œé€šè¿‡ç»„åˆçš„æ–¹å¼è®©ä»£ç æœ‰æ›´å¥½çš„é‡ç”¨æ€§ã€‚ä¸è¿‡åœ¨ #408 ä¸­ï¼Œæ¶‰åŠçš„å†…å®¹åå‘ç†è®ºï¼Œè€Œæˆ‘ä»¬æ¯å¤©çš„ app å¼€å‘æ›´å¤šçš„é¢ä¸´çš„è¿˜æ˜¯å’Œ Cocoa æ¡†æ¶æ‰“äº¤é“ã€‚åœ¨çœ‹è¿‡ #408 ä»¥åï¼Œæˆ‘ä»¬å°±ä¸€ç›´åœ¨æ€è€ƒï¼Œå¦‚ä½•æŠŠ POP çš„æ€æƒ³è¿ç”¨åˆ°æ—¥å¸¸çš„å¼€å‘ä¸­ï¼Ÿ</p>

<p>æˆ‘ä»¬åœ¨è¿™ä¸ªéƒ¨åˆ†ä¼šä¸¾ä¸€ä¸ªå®é™…çš„ä¾‹å­ï¼Œæ¥çœ‹çœ‹ POP æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬å†™å‡ºæ›´å¥½çš„ä»£ç çš„ã€‚</p>

<h3 id="åŸºäº-protocol-çš„ç½‘ç»œè¯·æ±‚">åŸºäº Protocol çš„ç½‘ç»œè¯·æ±‚</h3>

<p>ç½‘ç»œè¯·æ±‚å±‚æ˜¯å®è·µ POP çš„ä¸€ä¸ªç†æƒ³åœºæ‰€ã€‚æˆ‘ä»¬åœ¨æ¥ä¸‹çš„ä¾‹å­ä¸­å°†ä»é›¶å¼€å§‹ï¼Œç”¨æœ€ç®€å•çš„é¢å‘åè®®çš„æ–¹å¼å…ˆæ„å»ºä¸€ä¸ªä¸é‚£ä¹ˆå®Œç¾çš„ç½‘ç»œè¯·æ±‚å’Œæ¨¡å‹å±‚ï¼Œå®ƒå¯èƒ½åŒ…å«ä¸€äº›ä¸åˆç†çš„è®¾è®¡å’Œè€¦åˆï¼Œä½†æ˜¯å´æ˜¯åˆæ­¥æœ€å®¹æ˜“å¾—åˆ°çš„ç»“æœã€‚ç„¶åæˆ‘ä»¬å°†é€æ­¥æ‹æ¸…å„éƒ¨åˆ†çš„æ‰€å±ï¼Œå¹¶ç”¨åˆ†ç¦»èŒè´£çš„æ–¹å¼æ¥è¿›è¡Œé‡æ„ã€‚æœ€åæˆ‘ä»¬ä¼šä¸ºè¿™ä¸ªç½‘ç»œè¯·æ±‚å±‚è¿›è¡Œæµ‹è¯•ã€‚é€šè¿‡è¿™ä¸ªä¾‹å­ï¼Œæˆ‘å¸Œæœ›èƒ½å¤Ÿè®¾è®¡å‡ºåŒ…æ‹¬ç±»å‹å®‰å…¨ï¼Œè§£è€¦åˆï¼Œæ˜“äºæµ‹è¯•å’Œè‰¯å¥½çš„æ‰©å±•æ€§ç­‰è¯¸å¤šä¼˜ç§€ç‰¹æ€§åœ¨å†…çš„ POP ä»£ç ã€‚</p>

<blockquote>
  <p>Talk is cheap, show me the code.</p>
</blockquote>

<h4 id="åˆæ­¥å®ç°">åˆæ­¥å®ç°</h4>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬æƒ³è¦åšçš„äº‹æƒ…æ˜¯ä»ä¸€ä¸ª API è¯·æ±‚ä¸€ä¸ª JSONï¼Œç„¶åå°†å®ƒè½¬æ¢ä¸º Swift ä¸­å¯ç”¨çš„å®ä¾‹ã€‚ä½œä¸ºä¾‹å­çš„ API éå¸¸ç®€å•ï¼Œä½ å¯ä»¥ç›´æ¥è®¿é—® <a href="https://api.onevcat.com/users/onevcat">https://api.onevcat.com/users/onevcat</a> æ¥æŸ¥çœ‹è¿”å›ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">onevcat</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Welcome to MDCC 16!</span><span class="dl">"</span><span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶æ·»åŠ  <code class="highlighter-rouge">User.swift</code> æ¥ä½œä¸ºæ¨¡å‹ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// User.swift</span>
<span class="kd">import</span> <span class="kt">Foundation</span>

<span class="kd">struct</span> <span class="kt">User</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
    <span class="k">let</span> <span class="nv">message</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="nf">init</span><span class="p">?(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">obj</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">jsonObject</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[])</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">name</span> <span class="o">=</span> <span class="n">obj</span><span class="p">?[</span><span class="s">"name"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">message</span> <span class="o">=</span> <span class="n">obj</span><span class="p">?[</span><span class="s">"message"</span><span class="p">]</span> <span class="k">as?</span> <span class="kt">String</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        
        <span class="k">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">User.init(data:)</code> å°†è¾“å…¥çš„æ•°æ® (ä»ç½‘ç»œè¯·æ±‚ API è·å–) è§£æä¸º JSON å¯¹è±¡ï¼Œç„¶åä»ä¸­å–å‡º <code class="highlighter-rouge">name</code> å’Œ <code class="highlighter-rouge">message</code>ï¼Œå¹¶æ„å»ºä»£è¡¨ API è¿”å›çš„ <code class="highlighter-rouge">User</code> å®ä¾‹ï¼Œéå¸¸ç®€å•ã€‚</p>

<p>ç°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹æœ‰è¶£çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å¦‚ä½•ä½¿ç”¨ POP çš„æ–¹å¼ä» URL è¯·æ±‚æ•°æ®ï¼Œå¹¶ç”Ÿæˆå¯¹åº”çš„ <code class="highlighter-rouge">User</code>ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª protocol æ¥ä»£è¡¨è¯·æ±‚ã€‚å¯¹äºä¸€ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å®ƒçš„è¯·æ±‚è·¯å¾„ï¼ŒHTTP æ–¹æ³•ï¼Œæ‰€éœ€è¦çš„å‚æ•°ç­‰ä¿¡æ¯ã€‚ä¸€å¼€å§‹è¿™ä¸ªåè®®å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">enum</span> <span class="kt">HTTPMethod</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kt">GET</span>
    <span class="k">case</span> <span class="kt">POST</span>
<span class="p">}</span>

<span class="kd">protocol</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">host</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">path</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="k">var</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">parameter</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å°† <code class="highlighter-rouge">host</code> å’Œ <code class="highlighter-rouge">path</code> æ‹¼æ¥èµ·æ¥å¯ä»¥å¾—åˆ°æˆ‘ä»¬éœ€è¦è¯·æ±‚çš„ API åœ°å€ã€‚ä¸ºäº†ç®€åŒ–ï¼Œ<code class="highlighter-rouge">HTTPMethod</code> ç°åœ¨åªåŒ…å«äº† <code class="highlighter-rouge">GET</code> å’Œ <code class="highlighter-rouge">POST</code> ä¸¤ç§è¯·æ±‚æ–¹å¼ï¼Œè€Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªä¼šä½¿ç”¨åˆ° <code class="highlighter-rouge">GET</code> è¯·æ±‚ã€‚</p>

<p>ç°åœ¨ï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ª <code class="highlighter-rouge">UserRequest</code> æ¥å®ç° <code class="highlighter-rouge">Request</code> åè®®ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">UserRequest</span><span class="p">:</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">name</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="k">let</span> <span class="nv">host</span> <span class="o">=</span> <span class="s">"https://api.onevcat.com"</span>
    <span class="k">var</span> <span class="nv">path</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">"/users/</span><span class="se">\(</span><span class="n">name</span><span class="se">)</span><span class="s">"</span>
    <span class="p">}</span>
    <span class="k">let</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span> <span class="o">=</span> <span class="o">.</span><span class="kt">GET</span>
    <span class="k">let</span> <span class="nv">parameter</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">UserRequest</code> ä¸­æœ‰ä¸€ä¸ªæœªå®šä¹‰åˆå§‹å€¼çš„ <code class="highlighter-rouge">name</code> å±æ€§ï¼Œå…¶ä»–çš„å±æ€§éƒ½æ˜¯ä¸ºäº†æ»¡è¶³åè®®æ‰€å®šä¹‰çš„ã€‚å› ä¸ºè¯·æ±‚çš„å‚æ•°ç”¨æˆ·å <code class="highlighter-rouge">name</code> ä¼šé€šè¿‡ URL è¿›è¡Œä¼ é€’ï¼Œæ‰€ä»¥ <code class="highlighter-rouge">parameter</code> æ˜¯ä¸€ä¸ªç©ºå­—å…¸å°±è¶³å¤Ÿäº†ã€‚æœ‰äº†åè®®å®šä¹‰å’Œä¸€ä¸ªæ»¡è¶³å®šä¹‰çš„å…·ä½“è¯·æ±‚ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å‘é€è¯·æ±‚ã€‚ä¸ºäº†ä»»æ„è¯·æ±‚éƒ½å¯ä»¥é€šè¿‡åŒæ ·çš„æ–¹æ³•å‘é€ï¼Œæˆ‘ä»¬å°†å‘é€çš„æ–¹æ³•å®šä¹‰åœ¨ <code class="highlighter-rouge">Request</code> åè®®æ‰©å±•ä¸Šï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">User</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ... send çš„å®ç°</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨ <code class="highlighter-rouge">send(handler:)</code> çš„å‚æ•°ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†å¯é€ƒé€¸çš„ <code class="highlighter-rouge">(User?) -&gt; Void</code>ï¼Œåœ¨è¯·æ±‚å®Œæˆåï¼Œæˆ‘ä»¬è°ƒç”¨è¿™ä¸ª <code class="highlighter-rouge">handler</code> æ–¹æ³•æ¥é€šçŸ¥è°ƒç”¨è€…è¯·æ±‚æ˜¯å¦å®Œæˆï¼Œå¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œåˆ™å°†ä¸€ä¸ª <code class="highlighter-rouge">User</code> å®ä¾‹ä¼ å›ï¼Œå¦åˆ™ä¼ å› <code class="highlighter-rouge">nil</code>ã€‚</p>

<p>æˆ‘ä»¬æƒ³è¦è¿™ä¸ª <code class="highlighter-rouge">send</code> æ–¹æ³•å¯¹äºæ‰€æœ‰çš„ <code class="highlighter-rouge">Request</code> éƒ½é€šç”¨ï¼Œæ‰€ä»¥æ˜¾ç„¶å›è°ƒçš„å‚æ•°ç±»å‹ä¸èƒ½æ˜¯ <code class="highlighter-rouge">User</code>ã€‚é€šè¿‡åœ¨ <code class="highlighter-rouge">Request</code> åè®®ä¸­æ·»åŠ ä¸€ä¸ªå…³è”ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥å°†å›è°ƒå‚æ•°è¿›è¡ŒæŠ½è±¡ã€‚åœ¨ <code class="highlighter-rouge">Request</code> æœ€åæ·»åŠ ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="kd">associatedtype</span> <span class="kt">Response</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç„¶ååœ¨ <code class="highlighter-rouge">UserRequest</code> ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿç›¸åº”åœ°æ·»åŠ ç±»å‹å®šä¹‰ï¼Œä»¥æ»¡è¶³åè®®ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">UserRequest</span><span class="p">:</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="kd">typealias</span> <span class="kt">Response</span> <span class="o">=</span> <span class="kt">User</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥é‡æ–°å®ç° <code class="highlighter-rouge">send</code> æ–¹æ³•ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code class="highlighter-rouge">Response</code> ä»£æ›¿å…·ä½“çš„ <code class="highlighter-rouge">User</code>ï¼Œè®© <code class="highlighter-rouge">send</code> ä¸€èˆ¬åŒ–ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨ <code class="highlighter-rouge">URLSession</code> æ¥å‘é€è¯·æ±‚ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Response</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">host</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">!</span>
        <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">httpMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">rawValue</span>
        
        <span class="c1">// åœ¨ç¤ºä¾‹ä¸­æˆ‘ä»¬ä¸éœ€è¦ `httpBody`ï¼Œå®è·µä¸­å¯èƒ½éœ€è¦å°† parameter è½¬ä¸º data</span>
        <span class="c1">// request.httpBody = ...</span>
        
        <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
            <span class="c1">// å¤„ç†ç»“æœ</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡æ‹¼æ¥ <code class="highlighter-rouge">host</code> å’Œ <code class="highlighter-rouge">path</code>ï¼Œå¯ä»¥å¾—åˆ° API çš„ entry pointã€‚æ ¹æ®è¿™ä¸ª URL åˆ›å»ºè¯·æ±‚ï¼Œè¿›è¡Œé…ç½®ï¼Œç”Ÿæˆ data task å¹¶å°†è¯·æ±‚å‘é€ã€‚å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯å°†å›è°ƒä¸­çš„ <code class="highlighter-rouge">data</code> è½¬æ¢ä¸ºåˆé€‚çš„å¯¹è±¡ç±»å‹ï¼Œå¹¶è°ƒç”¨ <code class="highlighter-rouge">handler</code> é€šçŸ¥å¤–éƒ¨è°ƒç”¨è€…äº†ã€‚å¯¹äº <code class="highlighter-rouge">User</code> æˆ‘ä»¬çŸ¥é“å¯ä»¥ä½¿ç”¨ <code class="highlighter-rouge">User.init(data:)</code>ï¼Œä½†æ˜¯å¯¹äºä¸€èˆ¬çš„ <code class="highlighter-rouge">Response</code>ï¼Œæˆ‘ä»¬è¿˜ä¸çŸ¥é“è¦å¦‚ä½•å°†æ•°æ®è½¬ä¸ºæ¨¡å‹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code class="highlighter-rouge">Request</code> é‡Œå†å®šä¹‰ä¸€ä¸ª <code class="highlighter-rouge">parse(data:)</code> æ–¹æ³•ï¼Œæ¥è¦æ±‚æ»¡è¶³è¯¥åè®®çš„å…·ä½“ç±»å‹æä¾›åˆé€‚çš„å®ç°ã€‚è¿™æ ·ä¸€æ¥ï¼Œæä¾›è½¬æ¢æ–¹æ³•çš„ä»»åŠ¡å°±è¢«â€œä¸‹æ”¾â€åˆ°äº† <code class="highlighter-rouge">UserRequest</code>ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="kd">associatedtype</span> <span class="kt">Response</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Response</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">UserRequest</span><span class="p">:</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="o">...</span>
    <span class="kd">typealias</span> <span class="kt">Response</span> <span class="o">=</span> <span class="kt">User</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">User</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">User</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æœ‰äº†å°† <code class="highlighter-rouge">data</code> è½¬æ¢ä¸º <code class="highlighter-rouge">Response</code> çš„æ–¹æ³•åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹è¯·æ±‚çš„ç»“æœè¿›è¡Œå¤„ç†äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Response</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">host</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">!</span>
        <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">httpMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">rawValue</span>
        
        <span class="c1">// åœ¨ç¤ºä¾‹ä¸­æˆ‘ä»¬ä¸éœ€è¦ `httpBody`ï¼Œå®è·µä¸­å¯èƒ½éœ€è¦å°† parameter è½¬ä¸º data</span>
        <span class="c1">// request.httpBody = ...</span>
        
        <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="k">let</span> <span class="nv">res</span> <span class="o">=</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">handler</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">handler</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è¯•è¯•çœ‹è¯·æ±‚ä¸€ä¸‹è¿™ä¸ª APIï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">UserRequest</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"onevcat"</span><span class="p">)</span>
<span class="n">request</span><span class="o">.</span><span class="n">send</span> <span class="p">{</span> <span class="n">user</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">user</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">user</span><span class="o">.</span><span class="n">message</span><span class="se">)</span><span class="s"> from </span><span class="se">\(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Welcome to MDCC 16! from onevcat</span>
</code></pre></div></div>

<h4 id="é‡æ„å…³æ³¨ç‚¹åˆ†ç¦»">é‡æ„ï¼Œå…³æ³¨ç‚¹åˆ†ç¦»</h4>

<p>è™½ç„¶èƒ½å¤Ÿå®ç°éœ€æ±‚ï¼Œä½†æ˜¯ä¸Šé¢çš„å®ç°å¯ä»¥è¯´éå¸¸ç³Ÿç³•ã€‚è®©æˆ‘ä»¬çœ‹çœ‹ç°åœ¨ <code class="highlighter-rouge">Request</code> çš„å®šä¹‰å’Œæ‰©å±•ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">host</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">path</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="k">var</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">parameter</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="kd">associatedtype</span> <span class="kt">Response</span>
    <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Response</span><span class="p">?</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Response</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œæœ€å¤§çš„é—®é¢˜åœ¨äºï¼Œ<code class="highlighter-rouge">Request</code> ç®¡ç†äº†å¤ªå¤šçš„ä¸œè¥¿ã€‚ä¸€ä¸ª <code class="highlighter-rouge">Request</code> åº”è¯¥åšçš„äº‹æƒ…åº”è¯¥ä»…ä»…æ˜¯å®šä¹‰è¯·æ±‚å…¥å£å’ŒæœŸæœ›çš„å“åº”ç±»å‹ï¼Œè€Œç°åœ¨ <code class="highlighter-rouge">Request</code> ä¸å…‰å®šä¹‰äº† <code class="highlighter-rouge">host</code> çš„å€¼ï¼Œè¿˜å¯¹å¦‚ä½•è§£ææ•°æ®äº†å¦‚æŒ‡æŒã€‚æœ€å <code class="highlighter-rouge">send</code> æ–¹æ³•è¢«ç»‘æ­»åœ¨äº† <code class="highlighter-rouge">URLSession</code> çš„å®ç°ä¸Šï¼Œè€Œä¸”æ˜¯ä½œä¸º <code class="highlighter-rouge">Request</code> çš„ä¸€éƒ¨åˆ†å­˜åœ¨ã€‚è¿™æ˜¯å¾ˆä¸åˆç†çš„ï¼Œå› ä¸ºè¿™æ„å‘³ç€æˆ‘ä»¬æ— æ³•åœ¨ä¸æ›´æ”¹è¯·æ±‚çš„æƒ…å†µä¸‹æ›´æ–°å‘é€è¯·æ±‚çš„æ–¹å¼ï¼Œå®ƒä»¬è¢«è€¦åˆåœ¨äº†ä¸€èµ·ã€‚è¿™æ ·çš„ç»“æ„è®©æµ‹è¯•å˜å¾—å¼‚å¸¸å›°éš¾ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦é€šè¿‡ stub å’Œ mock çš„æ–¹å¼å¯¹è¯·æ±‚æ‹¦æˆªï¼Œç„¶åè¿”å›æ„é€ çš„æ•°æ®ï¼Œè¿™ä¼šç”¨åˆ° <code class="highlighter-rouge">NSURLProtocol</code> çš„å†…å®¹ï¼Œæˆ–è€…æ˜¯å¼•å…¥ä¸€äº›ç¬¬ä¸‰æ–¹çš„æµ‹è¯•æ¡†æ¶ï¼Œå¤§å¤§å¢åŠ äº†é¡¹ç›®çš„å¤æ‚åº¦ã€‚åœ¨ Objective-C æ—¶æœŸè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¯é€‰é¡¹ï¼Œä½†æ˜¯åœ¨ Swift çš„æ–°æ—¶ä»£ï¼Œæˆ‘ä»¬æœ‰å¥½å¾—å¤šçš„æ–¹æ³•æ¥å¤„ç†è¿™ä»¶äº‹æƒ…ã€‚</p>

<p>è®©æˆ‘ä»¬å¼€å§‹ç€æ‰‹é‡æ„åˆšæ‰çš„ä»£ç ï¼Œå¹¶ä¸ºå®ƒä»¬åŠ ä¸Šæµ‹è¯•å§ã€‚é¦–å…ˆæˆ‘ä»¬å°† <code class="highlighter-rouge">send(handler:)</code> ä» <code class="highlighter-rouge">Request</code> åˆ†ç¦»å‡ºæ¥ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå•ç‹¬çš„ç±»å‹æ¥è´Ÿè´£å‘é€è¯·æ±‚ã€‚è¿™é‡ŒåŸºäº POP çš„å¼€å‘æ–¹å¼ï¼Œæˆ‘ä»¬ä»å®šä¹‰ä¸€ä¸ªå¯ä»¥å‘é€è¯·æ±‚çš„åè®®å¼€å§‹ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Client</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">send</span><span class="p">(</span><span class="n">_</span> <span class="nv">r</span><span class="p">:</span> <span class="kt">Request</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">Request</span><span class="o">.</span><span class="kt">Response</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ç¼–è¯‘é”™è¯¯</span>
</code></pre></div></div>

<p>ä»ä¸Šé¢çš„å£°æ˜ä»è¯­ä¹‰ä¸Šæ¥è¯´æ˜¯æŒºæ˜ç¡®çš„ï¼Œä½†æ˜¯å› ä¸º <code class="highlighter-rouge">Request</code> æ˜¯å«æœ‰å…³è”ç±»å‹çš„åè®®ï¼Œæ‰€ä»¥å®ƒå¹¶ä¸èƒ½ä½œä¸ºç‹¬ç«‹çš„ç±»å‹æ¥ä½¿ç”¨ï¼Œæˆ‘ä»¬åªèƒ½å¤Ÿå°†å®ƒä½œä¸ºç±»å‹çº¦æŸï¼Œæ¥é™åˆ¶è¾“å…¥å‚æ•° <code class="highlighter-rouge">request</code>ã€‚æ­£ç¡®çš„å£°æ˜æ–¹å¼åº”å½“æ˜¯ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Client</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="n">send</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Request</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">r</span><span class="p">:</span> <span class="kt">T</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="kt">Response</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span>

    <span class="k">var</span> <span class="nv">host</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é™¤äº†ä½¿ç”¨ <code class="highlighter-rouge">&lt;T: Request&gt;</code> è¿™ä¸ªæ³›å‹æ–¹å¼ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å°† <code class="highlighter-rouge">host</code> ä» <code class="highlighter-rouge">Request</code> ç§»åŠ¨åˆ°äº† <code class="highlighter-rouge">Client</code> é‡Œï¼Œè¿™æ˜¯æ›´é€‚åˆå®ƒçš„åœ°æ–¹ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå«æœ‰ <code class="highlighter-rouge">send</code> çš„ <code class="highlighter-rouge">Request</code> åè®®æ‰©å±•åˆ é™¤ï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªç±»å‹æ¥æ»¡è¶³ <code class="highlighter-rouge">Client</code> äº†ã€‚å’Œä¹‹å‰ä¸€æ ·ï¼Œå®ƒå°†ä½¿ç”¨ <code class="highlighter-rouge">URLSession</code> æ¥å‘é€è¯·æ±‚ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">URLSessionClient</span><span class="p">:</span> <span class="kt">Client</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">host</span> <span class="o">=</span> <span class="s">"https://api.onevcat.com"</span>
    
    <span class="kd">func</span> <span class="n">send</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Request</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">r</span><span class="p">:</span> <span class="kt">T</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="kt">Response</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">host</span><span class="o">.</span><span class="nf">appending</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">path</span><span class="p">))</span><span class="o">!</span>
        <span class="k">var</span> <span class="nv">request</span> <span class="o">=</span> <span class="kt">URLRequest</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">request</span><span class="o">.</span><span class="n">httpMethod</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">rawValue</span>
        
        <span class="k">let</span> <span class="nv">task</span> <span class="o">=</span> <span class="kt">URLSession</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">dataTask</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="k">let</span> <span class="nv">res</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">handler</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kt">DispatchQueue</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span> <span class="nf">handler</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">task</span><span class="o">.</span><span class="nf">resume</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨å‘é€è¯·æ±‚çš„éƒ¨åˆ†å’Œè¯·æ±‚æœ¬èº«åˆ†ç¦»å¼€äº†ï¼Œè€Œä¸”æˆ‘ä»¬ä½¿ç”¨åè®®çš„æ–¹å¼å®šä¹‰äº† <code class="highlighter-rouge">Client</code>ã€‚é™¤äº† <code class="highlighter-rouge">URLSessionClient</code> ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä»»æ„çš„ç±»å‹æ¥æ»¡è¶³è¿™ä¸ªåè®®ï¼Œå¹¶å‘é€è¯·æ±‚ã€‚è¿™æ ·ç½‘ç»œå±‚çš„å…·ä½“å®ç°å’Œè¯·æ±‚æœ¬èº«å°±ä¸å†ç›¸å…³äº†ï¼Œæˆ‘ä»¬ä¹‹ååœ¨æµ‹è¯•çš„æ—¶å€™ä¼šè¿›ä¸€æ­¥çœ‹åˆ°è¿™ä¹ˆåšæ‰€å¸¦æ¥çš„å¥½å¤„ã€‚</p>

<p>ç°åœ¨è¿™ä¸ªçš„å®ç°é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯ <code class="highlighter-rouge">Request</code> çš„ <code class="highlighter-rouge">parse</code> æ–¹æ³•ã€‚è¯·æ±‚ä¸åº”è¯¥ä¹Ÿä¸éœ€è¦çŸ¥é“å¦‚ä½•è§£æå¾—åˆ°çš„æ•°æ®ï¼Œè¿™é¡¹å·¥ä½œåº”è¯¥äº¤ç»™ <code class="highlighter-rouge">Response</code> æ¥åšã€‚è€Œç°åœ¨æˆ‘ä»¬æ²¡æœ‰å¯¹ <code class="highlighter-rouge">Response</code> è¿›è¡Œä»»ä½•é™å®šã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ–°å¢ä¸€ä¸ªåè®®ï¼Œæ»¡è¶³è¿™ä¸ªåè®®çš„ç±»å‹å°†çŸ¥é“å¦‚ä½•å°†ä¸€ä¸ª <code class="highlighter-rouge">data</code> è½¬æ¢ä¸ºå®é™…çš„ç±»å‹ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">Decodable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">Self</span><span class="p">?</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Decodable</code> å®šä¹‰äº†ä¸€ä¸ªé™æ€çš„ <code class="highlighter-rouge">parse</code> æ–¹æ³•ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨ <code class="highlighter-rouge">Request</code> çš„ <code class="highlighter-rouge">Response</code> å…³è”ç±»å‹ä¸­ä¸ºå®ƒåŠ ä¸Šè¿™ä¸ªé™åˆ¶ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ä¿è¯æ‰€æœ‰çš„ <code class="highlighter-rouge">Response</code> éƒ½å¯ä»¥å¯¹æ•°æ®è¿›è¡Œè§£æï¼ŒåŸæ¥ <code class="highlighter-rouge">Request</code> ä¸­çš„ <code class="highlighter-rouge">parse</code> å£°æ˜ä¹Ÿå°±å¯ä»¥ç§»é™¤äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æœ€ç»ˆçš„ Request åè®®</span>
<span class="kd">protocol</span> <span class="kt">Request</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">path</span><span class="p">:</span> <span class="kt">String</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">method</span><span class="p">:</span> <span class="kt">HTTPMethod</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">parameter</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Any</span><span class="p">]</span> <span class="p">{</span> <span class="k">get</span> <span class="p">}</span>
    
    <span class="c1">// associatedtype Response</span>
    <span class="c1">// func parse(data: Data) -&gt; Response?</span>
    <span class="kd">associatedtype</span> <span class="kt">Response</span><span class="p">:</span> <span class="kt">Decodable</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æœ€åè¦åšçš„å°±æ˜¯è®© <code class="highlighter-rouge">User</code> æ»¡è¶³ <code class="highlighter-rouge">Decodable</code>ï¼Œå¹¶ä¸”ä¿®æ”¹ä¸Šé¢ <code class="highlighter-rouge">URLSessionClient</code> çš„è§£æéƒ¨åˆ†çš„ä»£ç ï¼Œè®©å®ƒä½¿ç”¨ <code class="highlighter-rouge">Response</code> ä¸­çš„ <code class="highlighter-rouge">parse</code> æ–¹æ³•ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">User</span><span class="p">:</span> <span class="kt">Decodable</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">User</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">User</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">URLSessionClient</span><span class="p">:</span> <span class="kt">Client</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="n">send</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Request</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">r</span><span class="p">:</span> <span class="kt">T</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="kt">Response</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">...</span>
     <span class="c1">// if let data = data, let res = parse(data: data) {</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="k">let</span> <span class="nv">res</span> <span class="o">=</span> <span class="kt">T</span><span class="o">.</span><span class="kt">Response</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æœ€åï¼Œå°† <code class="highlighter-rouge">UserRequest</code> ä¸­ä¸å†éœ€è¦çš„ <code class="highlighter-rouge">host</code> å’Œ <code class="highlighter-rouge">parse</code> ç­‰æ¸…ç†ä¸€ä¸‹ï¼Œä¸€ä¸ªç±»å‹å®‰å…¨ï¼Œè§£è€¦åˆçš„é¢å‘åè®®çš„ç½‘ç»œå±‚å°±å‘ˆç°åœ¨æˆ‘ä»¬çœ¼å‰äº†ã€‚æƒ³è¦è°ƒç”¨ <code class="highlighter-rouge">UserRequest</code> æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">URLSessionClient</span><span class="p">()</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="kt">UserRequest</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"onevcat"</span><span class="p">))</span> <span class="p">{</span> <span class="n">user</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">user</span> <span class="o">=</span> <span class="n">user</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">user</span><span class="o">.</span><span class="n">message</span><span class="se">)</span><span class="s"> from </span><span class="se">\(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥ä¸º <code class="highlighter-rouge">URLSessionClient</code> æ·»åŠ ä¸€ä¸ªå•ä¾‹æ¥å‡å°‘è¯·æ±‚æ—¶çš„åˆ›å»ºå¼€é”€ï¼Œæˆ–è€…ä¸ºè¯·æ±‚æ·»åŠ  Promise çš„è°ƒç”¨æ–¹å¼ç­‰ç­‰ã€‚åœ¨ POP çš„ç»„ç»‡ä¸‹ï¼Œè¿™äº›æ”¹åŠ¨éƒ½å¾ˆè‡ªç„¶ï¼Œä¹Ÿä¸ä¼šç‰µæ‰¯åˆ°è¯·æ±‚çš„å…¶ä»–éƒ¨åˆ†ã€‚ä½ å¯ä»¥ç”¨å’Œ <code class="highlighter-rouge">UserRequest</code> ç±»å‹ç›¸ä¼¼çš„æ–¹å¼ï¼Œä¸ºç½‘ç»œå±‚æ·»åŠ å…¶ä»–çš„ API è¯·æ±‚ï¼Œåªéœ€è¦å®šä¹‰è¯·æ±‚æ‰€å¿…è¦çš„å†…å®¹ï¼Œè€Œä¸ç”¨æ‹…å¿ƒä¼šè§¦åŠç½‘ç»œæ–¹é¢çš„å…·ä½“å®ç°ã€‚</p>

<h4 id="ç½‘ç»œå±‚æµ‹è¯•">ç½‘ç»œå±‚æµ‹è¯•</h4>

<p>å°† <code class="highlighter-rouge">Client</code> å£°æ˜ä¸ºåè®®ç»™æˆ‘ä»¬å¸¦æ¥äº†é¢å¤–çš„å¥½å¤„ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬ä¸åœ¨å±€é™äºä½¿ç”¨æŸç§ç‰¹å®šçš„æŠ€æœ¯ (æ¯”å¦‚è¿™é‡Œçš„ <code class="highlighter-rouge">URLSession</code>) æ¥å®ç°ç½‘ç»œè¯·æ±‚ã€‚åˆ©ç”¨ POPï¼Œä½ åªæ˜¯å®šä¹‰äº†ä¸€ä¸ªå‘é€è¯·æ±‚çš„åè®®ï¼Œä½ å¯ä»¥å¾ˆå®¹æ˜“åœ°ä½¿ç”¨åƒæ˜¯ AFNetworking æˆ–è€… Alamofire è¿™æ ·çš„æˆç†Ÿçš„ç¬¬ä¸‰æ–¹æ¡†æ¶æ¥æ„å»ºå…·ä½“çš„æ•°æ®å¹¶å¤„ç†è¯·æ±‚çš„åº•å±‚å®ç°ã€‚æˆ‘ä»¬ç”šè‡³å¯ä»¥æä¾›ä¸€ç»„â€œè™šå‡â€çš„å¯¹è¯·æ±‚çš„å“åº”ï¼Œç”¨æ¥è¿›è¡Œæµ‹è¯•ã€‚è¿™å’Œä¼ ç»Ÿçš„ stub &amp; mock çš„æ–¹å¼åœ¨æ¦‚å¿µä¸Šæ˜¯æ¥è¿‘çš„ï¼Œä½†æ˜¯å®ç°èµ·æ¥è¦ç®€å•å¾—å¤šï¼Œä¹Ÿæ˜ç¡®å¾—å¤šã€‚æˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€çœ‹å…·ä½“åº”è¯¥æ€ä¹ˆåšã€‚</p>

<p>æˆ‘ä»¬å…ˆå‡†å¤‡ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå°†å®ƒæ·»åŠ åˆ°é¡¹ç›®çš„æµ‹è¯• target ä¸­ï¼Œä½œä¸ºç½‘ç»œè¯·æ±‚è¿”å›çš„å†…å®¹ï¼š</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ–‡ä»¶åï¼šusers:onevcat</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Wei Wang</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">hello</span><span class="dl">"</span><span class="p">}</span>
</code></pre></div></div>

<p>æ¥ä¸‹æ¥ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œè®©å®ƒæ»¡è¶³ <code class="highlighter-rouge">Client</code> åè®®ã€‚ä½†æ˜¯ä¸ <code class="highlighter-rouge">URLSessionClient</code> ä¸åŒï¼Œè¿™ä¸ªæ–°ç±»å‹çš„ <code class="highlighter-rouge">send</code> æ–¹æ³•å¹¶ä¸ä¼šå®é™…å»åˆ›å»ºè¯·æ±‚ï¼Œå¹¶å‘é€ç»™æœåŠ¡å™¨ã€‚æˆ‘ä»¬åœ¨æµ‹è¯•æ—¶éœ€è¦éªŒè¯çš„æ˜¯ä¸€ä¸ªè¯·æ±‚å‘å‡ºåå¦‚æœæœåŠ¡å™¨æŒ‰ç…§æ–‡æ¡£æ­£ç¡®å“åº”ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥ä¹Ÿå¯ä»¥å¾—åˆ°æ­£ç¡®çš„æ¨¡å‹å®ä¾‹ã€‚æ‰€ä»¥è¿™ä¸ªæ–°çš„ <code class="highlighter-rouge">Client</code> éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯ä»æœ¬åœ°æ–‡ä»¶ä¸­åŠ è½½å®šä¹‰å¥½çš„ç»“æœï¼Œç„¶åéªŒè¯æ¨¡å‹å®ä¾‹æ˜¯å¦æ­£ç¡®ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">LocalFileClient</span><span class="p">:</span> <span class="kt">Client</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="n">send</span><span class="o">&lt;</span><span class="kt">T</span> <span class="p">:</span> <span class="kt">Request</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">r</span><span class="p">:</span> <span class="kt">T</span><span class="p">,</span> <span class="nv">handler</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="kt">Response</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">r</span><span class="o">.</span><span class="n">path</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s">"/users/onevcat"</span><span class="p">:</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">fileURL</span> <span class="o">=</span> <span class="kt">Bundle</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="kt">ProtocolNetworkTests</span><span class="o">.</span><span class="k">self</span><span class="p">)</span><span class="o">.</span><span class="nf">url</span><span class="p">(</span><span class="nv">forResource</span><span class="p">:</span> <span class="s">"users:onevcat"</span><span class="p">,</span> <span class="nv">withExtension</span><span class="p">:</span> <span class="s">""</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nf">fatalError</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">Data</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">fileURL</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nf">fatalError</span><span class="p">()</span>
            <span class="p">}</span>
            <span class="nf">handler</span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="kt">Response</span><span class="o">.</span><span class="nf">parse</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">))</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nf">fatalError</span><span class="p">(</span><span class="s">"Unknown path"</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// ä¸ºäº†æ»¡è¶³ `Client` çš„è¦æ±‚ï¼Œå®é™…æˆ‘ä»¬ä¸ä¼šå‘é€è¯·æ±‚</span>
    <span class="k">let</span> <span class="nv">host</span> <span class="o">=</span> <span class="s">""</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">LocalFileClient</code> åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œå®ƒå…ˆæ£€æŸ¥è¾“å…¥è¯·æ±‚çš„ <code class="highlighter-rouge">path</code> å±æ€§ï¼Œå¦‚æœæ˜¯ <code class="highlighter-rouge">/users/onevcat</code> (ä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦æµ‹è¯•çš„è¯·æ±‚)ï¼Œé‚£ä¹ˆå°±ä»æµ‹è¯•çš„ bundle ä¸­è¯»å–é¢„å…ˆå®šä¹‰çš„æ–‡ä»¶ï¼Œå°†å…¶ä½œä¸ºè¿”å›ç»“æœè¿›è¡Œ <code class="highlighter-rouge">parse</code>ï¼Œç„¶åè°ƒç”¨ <code class="highlighter-rouge">handler</code>ã€‚å¦‚æœæˆ‘ä»¬éœ€è¦å¢åŠ å…¶ä»–è¯·æ±‚çš„æµ‹è¯•ï¼Œå¯ä»¥æ·»åŠ æ–°çš„ <code class="highlighter-rouge">case</code> é¡¹ã€‚å¦å¤–ï¼ŒåŠ è½½æœ¬åœ°æ–‡ä»¶èµ„æºçš„éƒ¨åˆ†åº”è¯¥ä½¿ç”¨æ›´é€šç”¨çš„å†™æ³•ï¼Œä¸è¿‡å› ä¸ºæˆ‘ä»¬è¿™é‡Œåªæ˜¯ç¤ºä¾‹ï¼Œå°±ä¸è¿‡å¤šçº ç»“äº†ã€‚</p>

<p>åœ¨ <code class="highlighter-rouge">LocalFileClient</code> çš„å¸®åŠ©ä¸‹ï¼Œç°åœ¨å¯ä»¥å¾ˆå®¹æ˜“åœ°å¯¹ <code class="highlighter-rouge">UserRequest</code> è¿›è¡Œæµ‹è¯•äº†ï¼š</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">testUserRequest</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">client</span> <span class="o">=</span> <span class="kt">LocalFileClient</span><span class="p">()</span>
    <span class="n">client</span><span class="o">.</span><span class="nf">send</span><span class="p">(</span><span class="kt">UserRequest</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="s">"onevcat"</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">user</span> <span class="k">in</span>
        <span class="kt">XCTAssertNotNil</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="kt">XCTAssertEqual</span><span class="p">(</span><span class="n">user</span><span class="o">!.</span><span class="n">name</span><span class="p">,</span> <span class="s">"Wei Wang"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬æ²¡æœ‰ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹æµ‹è¯•åº“ï¼Œä¹Ÿæ²¡æœ‰ä½¿ç”¨ url ä»£ç†æˆ–è€…è¿è¡Œæ—¶æ¶ˆæ¯è½¬å‘ç­‰ç­‰è¿™äº›å¤æ‚çš„æŠ€æœ¯ï¼Œå°±å¯ä»¥è¿›è¡Œè¯·æ±‚æµ‹è¯•äº†ã€‚ä¿æŒç®€å•çš„ä»£ç å’Œé€»è¾‘ï¼Œå¯¹äºé¡¹ç›®ç»´æŠ¤å’Œå‘å±•æ˜¯è‡³å…³é‡è¦çš„ã€‚</p>

<h4 id="å¯æ‰©å±•æ€§">å¯æ‰©å±•æ€§</h4>

<p>å› ä¸ºé«˜åº¦è§£è€¦ï¼Œè¿™ç§åŸºäº POP çš„å®ç°ä¸ºä»£ç çš„æ‰©å±•æä¾›äº†ç›¸å¯¹å®½æ¾çš„å¯èƒ½æ€§ã€‚æˆ‘ä»¬åˆšæ‰å·²ç»è¯´è¿‡ï¼Œä½ ä¸å¿…è‡ªè¡Œå»å®ç°ä¸€ä¸ªå®Œæ•´çš„ <code class="highlighter-rouge">Client</code>ï¼Œè€Œå¯ä»¥ä¾èµ–äºç°æœ‰çš„ç½‘ç»œè¯·æ±‚æ¡†æ¶ï¼Œå®ç°è¯·æ±‚å‘é€çš„æ–¹æ³•å³å¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ ä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“åœ°å°†æŸä¸ªæ­£åœ¨ä½¿ç”¨çš„è¯·æ±‚æ–¹å¼æ›¿æ¢ä¸ºå¦å¤–çš„æ–¹å¼ï¼Œè€Œä¸ä¼šå½±å“åˆ°è¯·æ±‚çš„å®šä¹‰å’Œä½¿ç”¨ã€‚ç±»ä¼¼åœ°ï¼Œåœ¨ <code class="highlighter-rouge">Response</code> çš„å¤„ç†ä¸Šï¼Œç°åœ¨æˆ‘ä»¬å®šä¹‰äº† <code class="highlighter-rouge">Decodable</code>ï¼Œç”¨è‡ªå·±æ‰‹å†™çš„æ–¹å¼åœ¨è§£ææ¨¡å‹ã€‚æˆ‘ä»¬å®Œå…¨ä¹Ÿå¯ä»¥ä½¿ç”¨ä»»æ„çš„ç¬¬ä¸‰æ–¹ JSON è§£æåº“ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬è¿…é€Ÿæ„å»ºæ¨¡å‹ç±»å‹ï¼Œè¿™ä»…ä»…åªéœ€è¦å®ç°ä¸€ä¸ªå°† <code class="highlighter-rouge">Data</code> è½¬æ¢ä¸ºå¯¹åº”æ¨¡å‹ç±»å‹çš„æ–¹æ³•å³å¯ã€‚</p>

<p>å¦‚æœä½ å¯¹ POP æ–¹å¼çš„ç½‘ç»œè¯·æ±‚å’Œæ¨¡å‹è§£ææ„Ÿå…´è¶£çš„è¯ï¼Œä¸å¦¨å¯ä»¥çœ‹çœ‹ <a href="https://github.com/ishkawa/APIKit">APIKit</a> è¿™ä¸ªæ¡†æ¶ï¼Œæˆ‘ä»¬åœ¨ç¤ºä¾‹ä¸­æ‰€å±•ç¤ºçš„æ–¹æ³•ï¼Œæ­£æ˜¯è¿™ä¸ªæ¡†æ¶çš„æ ¸å¿ƒæ€æƒ³ã€‚</p>

<h2 id="åˆé™ªä¼´---ä½¿ç”¨åè®®å¸®åŠ©æ”¹å–„ä»£ç è®¾è®¡">åˆãƒ»é™ªä¼´ - ä½¿ç”¨åè®®å¸®åŠ©æ”¹å–„ä»£ç è®¾è®¡</h2>

<p>é€šè¿‡é¢å‘åè®®çš„ç¼–ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¼ ç»Ÿçš„ç»§æ‰¿ä¸Šè§£æ”¾å‡ºæ¥ï¼Œç”¨ä¸€ç§æ›´çµæ´»çš„æ–¹å¼ï¼Œæ­ç§¯æœ¨ä¸€æ ·å¯¹ç¨‹åºè¿›è¡Œç»„è£…ã€‚æ¯ä¸ªåè®®ä¸“æ³¨äºè‡ªå·±çš„åŠŸèƒ½ï¼Œç‰¹åˆ«å¾—ç›Šäºåè®®æ‰©å±•ï¼Œæˆ‘ä»¬å¯ä»¥å‡å°‘ç±»å’Œç»§æ‰¿å¸¦æ¥çš„å…±äº«çŠ¶æ€çš„é£é™©ï¼Œè®©ä»£ç æ›´åŠ æ¸…æ™°ã€‚</p>

<p>é«˜åº¦çš„åè®®åŒ–æœ‰åŠ©äºè§£è€¦ã€æµ‹è¯•ä»¥åŠæ‰©å±•ï¼Œè€Œç»“åˆæ³›å‹æ¥ä½¿ç”¨åè®®ï¼Œæ›´å¯ä»¥è®©æˆ‘ä»¬å…äºåŠ¨æ€è°ƒç”¨å’Œç±»å‹è½¬æ¢çš„è‹¦æ¼ï¼Œä¿è¯äº†ä»£ç çš„å®‰å…¨æ€§ã€‚</p>

<h2 id="æé—®ç¯èŠ‚">æé—®ç¯èŠ‚</h2>

<p>ä¸»é¢˜æ¼”è®²åæœ‰å‡ ä½æœ‹å‹æäº†ä¸€äº›å¾ˆæœ‰æ„ä¹‰çš„é—®é¢˜ï¼Œåœ¨è¿™é‡Œæˆ‘ä¹Ÿç¨ä½œæ•´ç†ã€‚æœ‰å¯èƒ½é—®é¢˜å’Œå›ç­”ä¸å½“æ—¶çš„æƒ…å½¢ä¼šæœ‰å°çš„å‡ºå…¥ï¼Œä»…ä¾›å‚è€ƒã€‚</p>

<p><strong>æˆ‘åˆšæ‰åœ¨çœ‹ demo çš„æ—¶å€™å‘ç°ï¼Œä½ éƒ½æ˜¯ç›´æ¥å…ˆå†™ <code class="highlighter-rouge">protocol</code>ï¼Œè€Œä¸æ˜¯ <code class="highlighter-rouge">struct</code> æˆ–è€… <code class="highlighter-rouge">class</code>ã€‚æ˜¯ä¸æ˜¯æˆ‘ä»¬åœ¨å®è·µ POP çš„æ—¶å€™éƒ½åº”è¯¥ç›´æ¥å…ˆå®šä¹‰åè®®ï¼Ÿ</strong></p>

<blockquote>
  <p>æˆ‘ç›´æ¥å†™ <code class="highlighter-rouge">protocol</code> æ˜¯å› ä¸ºæˆ‘å·²ç»å¯¹æˆ‘è¦åšä»€ä¹ˆæœ‰å……åˆ†çš„äº†è§£ï¼Œå¹¶ä¸”å¸Œæœ›æ¼”è®²ä¸è¦è¶…æ—¶ã€‚ä½†æ˜¯å®é™…å¼€å‘çš„æ—¶å€™ä½ å¯èƒ½ä¼šæ— æ³•ä¸€å¼€å§‹å°±å†™å‡ºåˆé€‚çš„åè®®å®šä¹‰ã€‚å»ºè®®å¯ä»¥åƒæˆ‘åœ¨ demo ä¸­åšçš„é‚£æ ·ï¼Œå…ˆâ€œç²—ç•¥â€åœ°è¿›è¡Œå®šä¹‰ï¼Œç„¶åé€šè¿‡ä¸æ–­é‡æ„æ¥å¾—åˆ°ä¸€ä¸ªæœ€ç»ˆçš„ç‰ˆæœ¬ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å…ˆç”¨çº¸ç¬”å‹¾å‹’ä¸€ä¸ªè½®å»“ï¼Œç„¶åå†å»å®šä¹‰å’Œå®ç°åè®®ã€‚å½“ç„¶äº†ï¼Œä¹Ÿæ²¡äººè§„å®šä¸€å®šéœ€è¦å…ˆå®šä¹‰åè®®ï¼Œä½ å®Œå…¨ä¹Ÿå¯ä»¥ä»æ™®é€šç±»å‹å¼€å§‹å†™èµ·ï¼Œç„¶åç­‰å‘ç°å…±é€šç‚¹æˆ–è€…é‡åˆ°æˆ‘ä»¬ä¹‹å‰æåˆ°çš„å›°å¢ƒæ—¶ï¼Œå†å›å¤´çœ‹çœ‹æ˜¯ä¸æ˜¯é¢å‘åè®®æ›´åŠ åˆé€‚ï¼Œè¿™éœ€è¦ä¸€å®šçš„ POP ç»éªŒã€‚</p>
</blockquote>

<p><strong>æ—¢ç„¶ POP æœ‰è¿™ä¹ˆå¤šå¥½å¤„ï¼Œé‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯ä¸å†éœ€è¦é¢å‘å¯¹è±¡ï¼Œå¯ä»¥å…¨é¢è½¬å‘é¢å‘åè®®äº†ï¼Ÿ</strong></p>

<blockquote>
  <p>ç­”æ¡ˆå¯èƒ½è®©ä½ å¤±æœ›ã€‚åœ¨æˆ‘ä»¬çš„æ—¥å¸¸é¡¹ç›®ä¸­ï¼Œæ¯å¤©æ‰“äº¤é“çš„ Cocoa å…¶å®è¿˜æ˜¯ä¸€ä¸ªå¸¦æœ‰æµ“åš OOP è‰²å½©çš„æ¡†æ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯èƒ½ä¸€æ®µæ—¶æœŸå†…æˆ‘ä»¬ä¸å¯èƒ½æŠ›å¼ƒ OOPã€‚ä¸è¿‡ POP å…¶å®å¯ä»¥å’Œ OOP â€œå’Œè°å…±å¤„â€ï¼Œæˆ‘ä»¬ä¹Ÿå·²ç»çœ‹åˆ°äº†ä¸å°‘ä½¿ç”¨ POP æ”¹å–„ä»£ç è®¾è®¡çš„ä¾‹å­ã€‚å¦å¤–éœ€è¦è¡¥å……çš„æ˜¯ï¼ŒPOP å…¶å®ä¹Ÿå¹¶ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒæœ‰ä¸å¥½çš„ä¸€é¢ã€‚æœ€å¤§çš„é—®é¢˜æ˜¯åè®®ä¼šå¢åŠ ä»£ç çš„æŠ½è±¡å±‚çº§ (è¿™ç‚¹ä¸Šå’Œç±»ç»§æ‰¿æ˜¯ä¸€æ ·çš„)ï¼Œç‰¹åˆ«æ˜¯å½“ä½ çš„åè®®åˆç»§æ‰¿äº†å…¶ä»–åè®®çš„æ—¶å€™ï¼Œè¿™ä¸ªé—®é¢˜å°¤ä¸ºä¸¥é‡ã€‚åœ¨ç»è¿‡è‹¥å¹²å±‚çš„ç»§æ‰¿åï¼Œæ»¡è¶³æœ«ç«¯çš„åè®®ä¼šå˜å¾—å›°éš¾ï¼Œä½ ä¹Ÿéš¾ä»¥ç¡®å®šæŸä¸ªæ–¹æ³•ç©¶ç«Ÿæ»¡è¶³çš„æ˜¯å“ªä¸ªåè®®çš„è¦æ±‚ã€‚è¿™ä¼šè®©ä»£ç è¿…é€Ÿå˜å¾—å¤æ‚ã€‚å¦‚æœä¸€ä¸ªåè®®å¹¶æ²¡æœ‰èƒ½æè¿°å¾ˆå¤šå…±é€šç‚¹ï¼Œæˆ–è€…è¯´èƒ½è®©äººå¾ˆå¿«ç†è§£çš„è¯ï¼Œå¯èƒ½ä½¿ç”¨åŸºæœ¬çš„ç±»å‹è¿˜ä¼šæ›´ç®€å•ä¸€äº›ã€‚</p>
</blockquote>

<p><strong>è°¢è°¢ä½ çš„æ¼”è®²ï¼Œæƒ³é—®ä¸€ä¸‹ä½ ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ POP çš„æƒ…å†µ</strong></p>

<blockquote>
  <p>æˆ‘ä»¬åœ¨é¡¹ç›®é‡Œç”¨äº†å¾ˆå¤š POP çš„æ¦‚å¿µã€‚ä¸Šé¢ demo é‡Œçš„ç½‘ç»œè¯·æ±‚çš„ä¾‹å­å°±æ˜¯ä»å®é™…é¡¹ç›®ä¸­æŠ½å‡ºæ¥çš„ï¼Œæˆ‘ä»¬è§‰å¾—è¿™æ ·çš„è¯·æ±‚å†™èµ·æ¥éå¸¸è½»æ¾ï¼Œå› ä¸ºä»£ç å¾ˆç®€å•ï¼Œæ–°äººè¿›æ¥äº¤æ¥ä¹Ÿååˆ†æƒ¬æ„ã€‚é™¤äº†æ¨¡å‹å±‚ä¹‹å¤–ï¼Œæˆ‘ä»¬åœ¨ view å’Œ view controller å±‚ä¹Ÿç”¨äº†ä¸€äº› POP çš„ä»£ç ï¼Œæ¯”å¦‚ä» nib åˆ›å»º view çš„ <code class="highlighter-rouge">NibCreatable</code>ï¼Œæ”¯æŒåˆ†é¡µè¯·æ±‚ tableview controller çš„ <code class="highlighter-rouge">NextPageLoadable</code>ï¼Œç©ºåˆ—è¡¨æ—¶æ˜¾ç¤ºé¡µé¢çš„ <code class="highlighter-rouge">EmptyPage</code> ç­‰ç­‰ã€‚å› ä¸ºæ—¶é—´æœ‰é™ï¼Œä¸å¯èƒ½å±•å¼€ä¸€ä¸€è¯´æ˜ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘åªæŒ‘é€‰äº†ä¸€ä¸ªå…·æœ‰ä»£è¡¨æ€§ï¼Œåˆä¸æ˜¯å¾ˆå¤æ‚çš„ç½‘ç»œçš„ä¾‹å­ã€‚å…¶å®æ¯ä¸ªåè®®éƒ½è®©æˆ‘ä»¬çš„ä»£ç ï¼Œç‰¹åˆ«æ˜¯ View Controller å˜çŸ­ï¼Œè€Œä¸”ä½¿æµ‹è¯•å˜ä¸ºå¯èƒ½ã€‚å¯ä»¥è¯´ï¼Œæˆ‘ä»¬çš„é¡¹ç›®ä» POP å—ç›Šè‰¯å¤šï¼Œè€Œä¸”æˆ‘ä»¬åº”è¯¥ä¼šç»§ç»­ä½¿ç”¨ä¸‹å»ã€‚</p>
</blockquote>

<h2 id="æ¨èèµ„æ–™">æ¨èèµ„æ–™</h2>

<p>å‡ ä¸ªæˆ‘è®¤ä¸ºåœ¨ POP å®è·µä¸­å€¼å¾—ä¸€çœ‹çš„èµ„æ–™ï¼Œæ„¿æ„å†è¿›è¡Œæ·±å…¥äº†è§£çš„æœ‹å‹ä¸å¦¨ä¸€çœ‹ã€‚</p>

<ul>
  <li><a href="https://developer.apple.com/videos/play/wwdc2015/408/">Protocol-Oriented Programming in Swift</a> - WWDC 15 #408</li>
  <li><a href="https://www.youtube.com/watch?v=XWoNjiSPqI8">Protocols with Associated Types</a> - @alexisgallagher</li>
  <li><a href="http://matthewpalmer.net/blog/2015/08/30/protocol-oriented-programming-in-the-real-world/">Protocol Oriented Programming in the Real World</a> - @_matthewpalmer</li>
  <li><a href="https://realm.io/news/appbuilders-natasha-muraschev-practical-protocol-oriented-programming/">Practical Protocol-Oriented-Programming</a> - @natashatherobot</li>
</ul>

:ET