<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>关于 MVC 的一个常见的误用</title>
  <meta name="description" content="  写在前面：ObjC 中国 (或者说我个人) 现在正和 objc.io 合作打造一本关于 app 架构的书籍。英文版本已经提前预售，书本身也进入了最后的 review 阶段。我们也将在第一时间进行本书中文版的工作，还请大家关注。  本文的内容也是有关 app 架构的一些思考，如果你对架构方面的话题有兴趣的话，我...">
  <meta name="author" content="Wei Wang">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="关于 MVC 的一个常见的误用">
  <meta name="twitter:description" content="  写在前面：ObjC 中国 (或者说我个人) 现在正和 objc.io 合作打造一本关于 app 架构的书籍。英文版本已经提前预售，书本身也进入了最后的 review 阶段。我们也将在第一时间进行本书中文版的工作，还请大家关注。  本文的内容也是有关 app 架构的一些思考，如果你对架构方面的话题有兴趣的话，我...">
  
  <meta property="og:type" content="article">
  <meta property="og:title" content="关于 MVC 的一个常见的误用">
  <meta property="og:description" content="  写在前面：ObjC 中国 (或者说我个人) 现在正和 objc.io 合作打造一本关于 app 架构的书籍。英文版本已经提前预售，书本身也进入了最后的 review 阶段。我们也将在第一时间进行本书中文版的工作，还请大家关注。  本文的内容也是有关 app 架构的一些思考，如果你对架构方面的话题有兴趣的话，我...">
  
  <link rel="icon" type="image/png" href="/assets/images/favicon.png" />
  <link href="/assets/images/favicon.png" rel="shortcut icon" type="image/png">
  
  <link rel="stylesheet" href="/css/main.css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="http://localhost:4000/2018/05/mvc-wrong-use/">
  <link rel="alternate" type="application/rss+xml" title="OneV's Den" href="http://localhost:4000/feed.xml">
  
  <meta name="google-site-verification" content="1-1ZlHoRvM0T2FqPbW2S-qLgYXN6rsn52kErlMPd_gw" />
  
</head>


  <body>

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>
    
    <header class="panel-cover panel-cover--collapsed" style="background-image: url('/assets/images/background-cover.jpg')">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/#blog" title="前往 OneV's Den 的主页" class="blog-button"><img src="/assets/images/avatar.jpg" width="80" alt="OneV's Den logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/#blog" title="link to homepage for OneV's Den" class="blog-button">OneV's Den</a></h1>

        
        <span class="panel-cover__subtitle panel-subtitle">上善若水，人淡如菊</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">嗨，我是王巍 (@onevcat)，一名 iOS 开发者。</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        
        
        <p class="panel-cover__description"><a href="https://objccn.io/products/">我组织的 ObjC 中国与 objc.io 合作发布了一系列 iOS/Swift 相关图书，欢迎访问了解更多</a></p>
        
        
        <div class="navigation-wrapper">
          <div>
            <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                <li class="navigation__item"><a href="/#blog" title="访问博客" class="blog-button">博客</a></li>
                
                  <li class="navigation__item"><a href="//onev.cat" target="_blank" title="我的简历">简历</a></li>
                
                  <li class="navigation__item"><a href="/apps" target="_blank" title="我所使用的 app 们">工具</a></li>
                
              </ul>
            </nav>
          </div>
          
          <div><nav class="cover-navigation navigation--social">
  <ul class="navigation">

  
  <!-- Weibo -->
  <li class="navigation__item">
    <a href="http://weibo.com/onevcat" title="@onevcat 的微博" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li>
  

  
  <!-- Github -->
  <li class="navigation__item">
    <a href="https://github.com/onevcat" title="@onevcat 的 Github" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>
  
  
  
  <!-- Twitter -->
  <li class="navigation__item">
    <a href="http://twitter.com/onevcat" title="@onevcat" target="_blank">
      <i class='social fa fa-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li>
  

  

  <!-- RSS -->
  <li class="navigation__item">
    <a href="/feed.xml" rel="author" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>

  
  <!-- Email -->
  <li class="navigation__item">
    <a href="mailto:onev@onevcat.com" title="Contact me">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>
  

  </ul>
</nav>
</div>
        </div>
      </div>
    </div>
    
    
    <div class="panel-cover--overlay cover-blue"></div>
    
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="2018-05-11 08:15:00 +0800" itemprop="datePublished" class="post-meta__date date">2018-05-11</time> &#8226; <span class="post-meta__tags tags">能工巧匠集</span>
    </div>
    <h1 class="post-title">关于 MVC 的一个常见的误用</h1>
  </header>

  <section class="post">
    <blockquote>
  <p>写在前面：<a href="https://objccn.io">ObjC 中国</a> (或者说我个人) 现在正和 objc.io 合作打造一本关于 <a href="https://www.objc.io/books/app-architecture/">app 架构</a>的书籍。英文版本已经提前预售，书本身也进入了最后的 review 阶段。我们也将在第一时间进行本书中文版的工作，还请大家关注。</p>

  <p>本文的内容也是有关 app 架构的一些思考，如果你对架构方面的话题有兴趣的话，我之前还写过一篇利用 reducer 的<a href="https://onevcat.com/2017/07/state-based-viewcontroller/">单向数据流动的函数式 View Controller</a> 的文章可供参考。</p>
</blockquote>

<p>如何避免把 Model View Controller 写成 Massive View Controller 已经是老生常谈的问题了。不管是拆分 View Controller 的功能 (使用多个 Child View Controller)，还是换用“广义”的 MVC 框架 (比如 MVVM 或者 VIPER)，又或者更激进一点，转换思路使用 Reactive 模式或 Reducer 模式，其实所想要解决的问题本质在于，我们要如何才能更清晰地管理“用户操作，模型变更，UI 反馈”这一数据流动的方式。</p>

<p>非传统的 MVC 可以帮助我们遵循一些更不容易犯错的编程范式 (这一点和 Java 很像，使用冗杂的 pattern 来规范开发，让新人也能写出“成熟”的代码)，但是如果不从根本上理解数据流动在 MVC 中的角色，那不过就是末学肤受，迟早会出现问题。</p>

<h3 id="例子">例子</h3>

<p>举一个非常简单的 View Controller 的例子。假设我们有一个 Table View Controller 来记录 To Do 列表，我们可以通过点击导航栏的加号按钮来追加一个条目，用 Swipe cell 的方式删除条目。我们希望最多同时只能存在 10 条待办项目。这个 View Controller 的代码非常简单，可能也是很多开发者每天会写的代码。包括设置 Playground 和添加按钮等等，一共也就 60 行。我将它放到了<a href="https://gist.github.com/onevcat/4042d4d0f156b986e4755a7d4370bb9c">这个 gist 中</a>，你可以全部复制下来扔到 Playground 里查看效果。</p>

<p>这里简单对比较关键的代码进行一些解释。首先是模型定义：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 定义简单的 ToDo Model</span>
<span class="kd">struct</span> <span class="kt">ToDoItem</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">id</span><span class="p">:</span> <span class="kt">UUID</span>
    <span class="k">let</span> <span class="nv">title</span><span class="p">:</span> <span class="kt">String</span>
    
    <span class="nf">init</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="kt">UUID</span><span class="p">()</span>
        <span class="k">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>然后我们使用 <code class="highlighter-rouge">UITableViewController</code> 的子类进行待办事项的展示和添加：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">ToDoListViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    <span class="c1">// 保存当前待办事项</span>
    <span class="k">var</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">ToDoItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1">// 点击添加按钮</span>
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">addButtonPressed</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">newCount</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">let</span> <span class="nv">title</span> <span class="o">=</span> <span class="s">"ToDo Item </span><span class="se">\(</span><span class="n">newCount</span><span class="se">)</span><span class="s">"</span>
        
        <span class="c1">// 更新 `items`</span>
        <span class="n">items</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="n">title</span><span class="p">))</span>
        
        <span class="c1">// 为 table view 添加新行</span>
        <span class="k">let</span> <span class="nv">indexPath</span> <span class="o">=</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="n">newCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">insertRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="p">[</span><span class="n">indexPath</span><span class="p">],</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        
        <span class="c1">// 确定是否达到列表上限，如果达到，禁用 addButton</span>
        <span class="k">if</span> <span class="n">newCount</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="p">{</span>
            <span class="n">addButton</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>接下来，处理 table view 的展示，这部分内容乏善可陈：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">ToDoListViewController</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">numberOfRowsInSection</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">items</span><span class="o">.</span><span class="n">count</span>
    <span class="p">}</span>
    
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">cellForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">dequeueReusableCell</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="n">cellIdentifier</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span>
        <span class="n">cell</span><span class="o">.</span><span class="n">textLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">title</span>
        <span class="k">return</span> <span class="n">cell</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>最后，实现滑动 cell 删除的功能：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">ToDoListViewController</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">trailingSwipeActionsConfigurationForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UISwipeActionsConfiguration</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">deleteAction</span> <span class="o">=</span> <span class="kt">UIContextualAction</span><span class="p">(</span><span class="nv">style</span><span class="p">:</span> <span class="o">.</span><span class="n">destructive</span><span class="p">,</span> <span class="nv">title</span><span class="p">:</span> <span class="s">"Delete"</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">done</span> <span class="k">in</span>
            <span class="c1">// 用户确认删除，从 `items` 中移除该事项</span>
            <span class="k">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
            <span class="c1">// 从 table view 中移除对应行</span>
            <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="p">[</span><span class="n">indexPath</span><span class="p">],</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
            <span class="c1">// 维护 addButton 状态</span>
            <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">addButton</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="kc">true</span>
            <span class="p">}</span>
            <span class="nf">done</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kt">UISwipeActionsConfiguration</span><span class="p">(</span><span class="nv">actions</span><span class="p">:</span> <span class="p">[</span><span class="n">deleteAction</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>效果如下：</p>

<p><img src="/assets/images/2018/todo-demo.gif" alt="" /></p>

<p>看起来一切正常工作！不过，你能看出有什么问题吗？抑或说你觉得这段代码已经完美无瑕了？</p>

<h3 id="风险">风险</h3>

<p>简单来说，这也已经是对 MVC 的误用了。上面的代码存在着这些潜在问题：</p>

<ol>
  <li>
    <p>Model 层“寄生”在ViewController 中</p>

    <p>在这段代码中，View Controller 里的 <code class="highlighter-rouge">items</code> 充当了 model。</p>

    <p>这导致了几个问题：我们难以从外界维护或者同步 <code class="highlighter-rouge">items</code> 的状态，添加和删除操作被“绑定”在了这个 View Controller 里，如果你还想通过其他 View Controller 维护待办列表的话，就不得不考虑数据同步的问题 (我们会在稍后看到几个具体的这方面的例子)；另外，这样的设置导致 <code class="highlighter-rouge">items</code> 难以测试。你几乎无法为添加/删除/修改待办列表进行 Model 层的测试。</p>
  </li>
  <li>
    <p>违反数据流动规则和单一职责规则</p>

    <p>如果我们仔细思考，会发现，用户点击添加按钮，或者侧滑删除 cell 时，在 View Controller 中其实发生了这些事情：</p>

    <ol>
      <li>维护 Model (也就是 <code class="highlighter-rouge">items</code>)</li>
      <li>增删 table view 的 cell</li>
      <li>维护 <code class="highlighter-rouge">addButton</code> 的可用状态</li>
    </ol>

    <p>也就是说，UI 操作不仅导致了 Model 的变更，还同时导致了 UI 的变化。理想化的数据流动应该是单向的：UI 操作 -&gt; 经由 View Controller 进行模型更新 -&gt; 新的模型经由 View Controller 更新 UI -&gt; 等待新的 UI 操作，而在例子中，我们变成了“经由 View Controller 进行模型更新以及 UI 操作”。虽然看起来这是很不起眼的变更，但是会在项目复杂后带来麻烦。</p>
  </li>
</ol>

<p>也许你现在并不觉得有什么问题，让我们来假设一些情景，你可以思考一下如何实现吧。</p>

<h4 id="场景一">场景一</h4>

<p>首先来看看待办条目的编辑，我们可能需要一个详情页面，用来编辑某个待办的细节，比如为 <code class="highlighter-rouge">ToDoItem</code> 添加上 <code class="highlighter-rouge">date</code>，<code class="highlighter-rouge">location</code> 和 <code class="highlighter-rouge">detail</code> 这类的属性。另外，PM 和用户也许希望在详情页面中也能直接删除这个正在编辑的待办。</p>

<p>以现在的实现来看，一个很朴素的想法是新建 <code class="highlighter-rouge">ToDoEditViewController</code>，然后设置 <code class="highlighter-rouge">delegate</code> 来告诉 <code class="highlighter-rouge">ToDoListViewController</code> 某个 <code class="highlighter-rouge">ToDoItem</code> 发生了变化，然后在 <code class="highlighter-rouge">ToDoListViewController</code> 进行对 <code class="highlighter-rouge">items</code> 进行操作：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protocol</span> <span class="kt">ToDoEditViewControllerDelegate</span><span class="p">:</span> <span class="kd">class</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">editViewController</span><span class="p">(</span><span class="n">_</span> <span class="nv">viewController</span><span class="p">:</span> <span class="kt">ToDoEditViewController</span><span class="p">,</span> <span class="n">editToDoItem</span> <span class="nv">original</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">,</span> <span class="n">to</span> <span class="nv">new</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">editViewController</span><span class="p">(</span><span class="n">_</span> <span class="nv">viewController</span><span class="p">:</span> <span class="kt">ToDoEditViewController</span><span class="p">,</span> <span class="n">remove</span> <span class="nv">item</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 在 ToDoListViewController 中</span>
<span class="kd">extension</span> <span class="kt">ToDoListViewController</span><span class="p">:</span> <span class="kt">ToDoEditViewControllerDelegate</span> <span class="p">{</span>
    <span class="kd">func</span> <span class="nf">editViewController</span><span class="p">(</span><span class="n">_</span> <span class="nv">viewController</span><span class="p">:</span> <span class="kt">ToDoEditViewController</span><span class="p">,</span> <span class="n">remove</span> <span class="nv">item</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">items</span><span class="o">.</span><span class="n">index</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">item</span><span class="o">.</span><span class="n">id</span> <span class="p">})</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="n">items</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">indexPath</span> <span class="o">=</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="p">[</span><span class="n">indexPath</span><span class="p">],</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">addButton</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">editViewController</span><span class="p">(</span><span class="n">_</span> <span class="nv">viewController</span><span class="p">:</span> <span class="kt">ToDoEditViewController</span><span class="p">,</span> <span class="n">editToDoItem</span> <span class="nv">original</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">,</span> <span class="n">to</span> <span class="nv">new</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>有一部分和之前重复的代码，虽然可以通过将它们提取成像是 <code class="highlighter-rouge">removeItem(at index: Int)</code> 这样的方法，但是并不能改变非单一功能的问题。<code class="highlighter-rouge">ToDoEditViewController</code> 本身也无法和 <code class="highlighter-rouge">items</code> 通讯，因此它扮演的角色几乎就是一个“专用”的 View，一旦脱离了 <code class="highlighter-rouge">ToDoListViewController</code>，则“难堪重任”。</p>

<h4 id="场景二">场景二</h4>

<p>另外，纯单机的 app 已经跟不上时代了，不管是 iCloud 同步还是自建服务器，我们总是想要一个后端来为用户跨设备保存列表，这是一个非常可能的增强。在现有架构下，把从服务器获取已有条目的逻辑放到 <code class="highlighter-rouge">ToDoListViewController</code> 也是很自然的想法：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
    <span class="c1">//..</span>
    <span class="kt">NetworkService</span><span class="o">.</span><span class="nf">getExistingToDoItems</span><span class="p">()</span><span class="o">.</span><span class="n">then</span> <span class="p">{</span> <span class="n">items</span> <span class="k">in</span> 
        <span class="k">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>
        <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
        <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">addButton</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="kc">false</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这种简单的实现面临很多挑战，是我们在实际 app 中不得不考虑的：</p>

<ol>
  <li>是不是应该需要在 <code class="highlighter-rouge">getExistingToDoItems</code> 过程中 block 掉 UI，否则用户在请求完成前所添加的条目将被覆盖。</li>
  <li>在添加和删除条目的时候，我们都需要进行网络请求，另外我们也需要根据请求返回的状态更新添加按钮的状态。</li>
  <li>Block 用户输入将让 app 变为没网无法使用，不进行 block 的话则需要考虑数据同步的问题。</li>
  <li>另外，我们需不需要在没网时依然让用户可以进行增加或删除，并缓存操作，等到有网时再将这些缓存反映给服务器。</li>
  <li>如果需要实现 4，那么还要考虑操作结果导致超出条目最大数量限制的错误处理，以及多设备间数据冲突处理的问题。</li>
</ol>

<p>是不是突然感觉有些头大？</p>

<h3 id="改善">改善</h3>

<p>这些问题的来源其实都是我们为了“省事”，选择了一个<strong>不那么有效的 Model</strong>，以及<strong>存在风险的数据流动方式</strong>。或者说，我们没有正确和严格地使用 MVC 架构。</p>

<p>关于 MVC，斯坦福的 CS193p Paul 老师有一张非常经典的图，相信很多 iOS 的开发者也都看过：</p>

<p><img src="/assets/images/2018/mvc.png" alt="" /></p>

<p>我们的例子中，我们等于把 Model 放到了 Controller 里，而且 Model 也无法与 Controller 进行有效的通讯 (图中的 Notification &amp; KVO 部分)。这导致 Controller 承载了太多的功能，这往往是光荣地迈向 Massive View Controller 的第一步。</p>

<h4 id="单独的-model">单独的 Model</h4>

<p>当务之急是将 Model 层提取出来，为了说明简单，暂时先只考虑纯本地的情况：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">ToDoItem</span><span class="p">:</span> <span class="kt">Equatable</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">func</span> <span class="o">==</span> <span class="p">(</span><span class="nv">lhs</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">,</span> <span class="nv">rhs</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">lhs</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">id</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ToDoStore</span> <span class="p">{</span>
    <span class="kd">static</span> <span class="k">let</span> <span class="nv">shared</span> <span class="o">=</span> <span class="kt">ToDoStore</span><span class="p">()</span>
    
    <span class="kd">private(set)</span> <span class="k">var</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">ToDoItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">private</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{}</span>
    
    <span class="kd">func</span> <span class="nf">append</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">items</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">append</span><span class="p">(</span><span class="nv">newItems</span><span class="p">:</span> <span class="p">[</span><span class="kt">ToDoItem</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">items</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">contentsOf</span><span class="p">:</span> <span class="n">newItems</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">remove</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">item</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">remove</span><span class="p">(</span><span class="n">at</span> <span class="nv">index</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">items</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">index</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">edit</span><span class="p">(</span><span class="nv">original</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">,</span> <span class="nv">new</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">index</span> <span class="o">=</span> <span class="n">items</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">original</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="n">items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span>
    <span class="p">}</span>
    
    <span class="k">var</span> <span class="nv">count</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">items</span><span class="o">.</span><span class="n">count</span>
    <span class="p">}</span>
    
    <span class="kd">func</span> <span class="nf">item</span><span class="p">(</span><span class="n">at</span> <span class="nv">index</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ToDoItem</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>当然，为了一步到位，也可以直接把上面的 <code class="highlighter-rouge">NetworkService</code> 加上，写成异步 API，例如：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">getAll</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Promise</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">ToDoItem</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">NetworkService</span><span class="o">.</span><span class="nf">getExistingToDoItems</span><span class="p">()</span>
      <span class="o">.</span><span class="n">then</span> <span class="p">{</span> <span class="n">items</span> <span class="k">in</span>
          <span class="k">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">items</span>
          <span class="k">return</span> <span class="kt">Promise</span><span class="o">.</span><span class="nf">value</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
      <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">append</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="kt">ToDoItem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Promise</span><span class="o">&lt;</span><span class="kt">Void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">NetworkService</span><span class="o">.</span><span class="nf">appendToDoItem</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="n">item</span><span class="p">)</span>
      <span class="o">.</span><span class="n">then</span> <span class="p">{</span>
          <span class="k">self</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
          <span class="k">return</span> <span class="kt">Promise</span><span class="o">.</span><span class="nf">value</span><span class="p">(())</span>
      <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>为了好看，这里用了一些 <a href="https://github.com/mxcl/PromiseKit">PromiseKit 的东西</a>，如果你不熟悉 Promise，也不用担心，可以将它们简单地看作 closure 的形式就好，这并不会影响继续阅读本文：</p>
</blockquote>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">getAll</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="kd">@escaping</span> <span class="p">(([</span><span class="kt">ToDoItem</span><span class="p">]?,</span> <span class="kt">Error</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)?)</span> <span class="p">{</span>
    <span class="kt">NetworkService</span><span class="o">.</span><span class="n">getExistingToDoItems</span> <span class="p">{</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="nf">completion</span><span class="p">?(</span><span class="kc">nil</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">items</span> 
            <span class="nf">completion</span><span class="p">?(</span><span class="n">response</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这样，我们就可以将 <code class="highlighter-rouge">items</code> 从 <code class="highlighter-rouge">ToDoListViewController</code> 拿出来。对单独提取的 Model 进行测试变得非常容易，纯 Model 的操作与 Controller 无关，<code class="highlighter-rouge">ToDoEditViewController</code> 也不再需要将行为 delegate 回 <code class="highlighter-rouge">ToDoListViewController</code>，编辑条目的 View Controller 可以通过成为了真正意义上的 View Controller，而不止是 <code class="highlighter-rouge">ToDoListViewController</code> 的“隶属 View”。</p>

<p>单独的 <code class="highlighter-rouge">ToDoStore</code> 作为模型带来的另一个好处是，因为它与具体的 View Controller 分离了，在进行持久化时，我们可以有更多的选择。不论是从网络获取，还是保存在本地的数据库，这些操作都不必 (也不应写在 View Controller 中)。如果有多种数据来源，我们可以轻松地创建类似 <code class="highlighter-rouge">ToDoStoreCoordinator</code> 或者 <code class="highlighter-rouge">ToDoStoreDataProvider</code> 这样的类型。既可以满足单一职责，也易于覆盖完整的测试。</p>

<h4 id="单向数据流动">单向数据流动</h4>

<p>接下来，将数据流动按照 MVC 的标准进行梳理就是自然而然的事情了。我们的目标是避免 UI 行为直接影响 UI，而是由 Model 的状态通过 Controller 来确定 UI 状态。这需要我们的 Model 能够以某种“非直接”的方式向 Controller 进行汇报。按照上面的 MVC 图，我们使用 Notification 来搞定。</p>

<p>对 <code class="highlighter-rouge">ToDoStore</code> 进行一些改造：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">ToDoStore</span> <span class="p">{</span>
    <span class="kd">enum</span> <span class="kt">ChangeBehavior</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nf">add</span><span class="p">([</span><span class="kt">Int</span><span class="p">])</span>
        <span class="k">case</span> <span class="nf">remove</span><span class="p">([</span><span class="kt">Int</span><span class="p">])</span>
        <span class="k">case</span> <span class="n">reload</span>
    <span class="p">}</span>
    
    <span class="kd">static</span> <span class="kd">func</span> <span class="nf">diff</span><span class="p">(</span><span class="nv">original</span><span class="p">:</span> <span class="p">[</span><span class="kt">ToDoItem</span><span class="p">],</span> <span class="nv">now</span><span class="p">:</span> <span class="p">[</span><span class="kt">ToDoItem</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kt">ChangeBehavior</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">originalSet</span> <span class="o">=</span> <span class="kt">Set</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
        <span class="k">let</span> <span class="nv">nowSet</span> <span class="o">=</span> <span class="kt">Set</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">originalSet</span><span class="o">.</span><span class="nf">isSubset</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">nowSet</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Appended</span>
            <span class="k">let</span> <span class="nv">added</span> <span class="o">=</span> <span class="n">nowSet</span><span class="o">.</span><span class="nf">subtracting</span><span class="p">(</span><span class="n">originalSet</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">indexes</span> <span class="o">=</span> <span class="n">added</span><span class="o">.</span><span class="n">compactMap</span> <span class="p">{</span> <span class="n">now</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
            <span class="k">return</span> <span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nowSet</span><span class="o">.</span><span class="nf">isSubset</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="n">originalSet</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// Removed</span>
            <span class="k">let</span> <span class="nv">removed</span> <span class="o">=</span> <span class="n">originalSet</span><span class="o">.</span><span class="nf">subtracting</span><span class="p">(</span><span class="n">nowSet</span><span class="p">)</span>
            <span class="k">let</span> <span class="nv">indexes</span> <span class="o">=</span> <span class="n">removed</span><span class="o">.</span><span class="n">compactMap</span> <span class="p">{</span> <span class="n">original</span><span class="o">.</span><span class="nf">index</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
            <span class="k">return</span> <span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="n">indexes</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Both appended and removed</span>
            <span class="k">return</span> <span class="o">.</span><span class="n">reload</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="k">var</span> <span class="nv">items</span><span class="p">:</span> <span class="p">[</span><span class="kt">ToDoItem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span> <span class="p">{</span>
        <span class="k">didSet</span> <span class="p">{</span>
            <span class="k">let</span> <span class="nv">behavior</span> <span class="o">=</span> <span class="kt">ToDoStore</span><span class="o">.</span><span class="nf">diff</span><span class="p">(</span><span class="nv">original</span><span class="p">:</span> <span class="n">oldValue</span><span class="p">,</span> <span class="nv">now</span><span class="p">:</span> <span class="n">items</span><span class="p">)</span>
            <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">post</span><span class="p">(</span>
                <span class="nv">name</span><span class="p">:</span> <span class="o">.</span><span class="n">toDoStoreDidChangedNotification</span><span class="p">,</span>
                <span class="nv">object</span><span class="p">:</span> <span class="k">self</span><span class="p">,</span>
                <span class="nv">typedUserInfo</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="nv">toDoStoreDidChangedChangeBehaviorKey</span><span class="p">:</span> <span class="n">behavior</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>这里添加了 <code class="highlighter-rouge">ChangeBehavior</code> 作为“提示”，来具体告诉外界 Model 中发生了什么。<code class="highlighter-rouge">diff</code> 方法通过比较原始 <code class="highlighter-rouge">items</code> 和当前 <code class="highlighter-rouge">items</code> 来确定发生了哪种 <code class="highlighter-rouge">ChangeBehavior</code>。最后，使用 <code class="highlighter-rouge">items</code> 的 <code class="highlighter-rouge">didSet</code> 来发送 Notification。</p>

<blockquote>
  <p>由于 Swift 的数组是值类型，对于 <code class="highlighter-rouge">items</code> 的元素增加，删除，修改或者整体变量替换，都会触发 <code class="highlighter-rouge">didSet</code> 的调用。Swift 的值语义编程带来了很大的便利。</p>
</blockquote>

<p>在 <code class="highlighter-rouge">ToDoListViewController</code>，现在只需要订阅这个通知，然后根据消息内容进行 UI 反馈即可：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">ToDoListViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>
        <span class="c1">//...</span>
        <span class="kt">NotificationCenter</span><span class="o">.</span><span class="k">default</span><span class="o">.</span><span class="nf">addObserver</span><span class="p">(</span>
            <span class="k">self</span><span class="p">,</span> 
            <span class="nv">selector</span><span class="p">:</span> <span class="kd">#selector(</span><span class="nf">todoItemsDidChange</span><span class="kd">)</span><span class="p">,</span>
            <span class="nv">name</span><span class="p">:</span> <span class="o">.</span><span class="n">toDoStoreDidChangedNotification</span><span class="p">,</span> 
            <span class="nv">object</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">syncTableView</span><span class="p">(</span><span class="k">for</span> <span class="nv">behavior</span><span class="p">:</span> <span class="kt">ToDoStore</span><span class="o">.</span><span class="kt">ChangeBehavior</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="n">behavior</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">add</span><span class="p">(</span><span class="k">let</span> <span class="nv">indexes</span><span class="p">):</span>
            <span class="k">let</span> <span class="nv">indexPathes</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">}</span>
            <span class="n">tableView</span><span class="o">.</span><span class="nf">insertRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">indexPathes</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="k">let</span> <span class="nv">indexes</span><span class="p">):</span>
            <span class="k">let</span> <span class="nv">indexPathes</span> <span class="o">=</span> <span class="n">indexes</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">IndexPath</span><span class="p">(</span><span class="nv">row</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span> <span class="nv">section</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span> <span class="p">}</span>
            <span class="n">tableView</span><span class="o">.</span><span class="nf">deleteRows</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">indexPathes</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="o">.</span><span class="n">automatic</span><span class="p">)</span>
        <span class="k">case</span> <span class="o">.</span><span class="nv">reload</span><span class="p">:</span>
            <span class="n">tableView</span><span class="o">.</span><span class="nf">reloadData</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kd">private</span> <span class="kd">func</span> <span class="nf">updateAddButtonState</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">addButton</span><span class="p">?</span><span class="o">.</span><span class="n">isEnabled</span> <span class="o">=</span> <span class="kt">ToDoStore</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">10</span>
    <span class="p">}</span>

    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">todoItemsDidChange</span><span class="p">(</span><span class="n">_</span> <span class="nv">notification</span><span class="p">:</span> <span class="kt">Notification</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">behavior</span> <span class="o">=</span> <span class="n">notification</span><span class="o">.</span><span class="nf">getUserInfo</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="o">.</span><span class="n">toDoStoreDidChangedChangeBehaviorKey</span><span class="p">)</span>
        <span class="nf">syncTableView</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">behavior</span><span class="p">)</span>
        <span class="nf">updateAddButtonState</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Notification 本身有很长的历史，是一套基于字符串的松散 API。这里通过扩展和泛型的方式，由 <code class="highlighter-rouge">.toDoStoreDidChangedNotification</code>，<code class="highlighter-rouge">.toDoStoreDidChangedChangeBehaviorKey</code> 和 <code class="highlighter-rouge">post(name:object:typedUserInfo)</code> 以及 <code class="highlighter-rouge">getUserInfo(for:)</code> 构成了一套更 Swifty 的类型安全的 <code class="highlighter-rouge">NotificationCenter</code> 和 <code class="highlighter-rouge">userInfo</code> 的使用方式。如果你感兴趣的话，可以参看<a href="https://gist.github.com/onevcat/9e08111cebb1967cb96a737ed40f9f14">最后的代码</a>。</p>
</blockquote>

<p>最后，我们可以把之前用来维护 table view cell 和 <code class="highlighter-rouge">addButton</code> 状态的代码都删除了。用户操作 UI 唯一的作用就是触发模型的更新，然后模型更新通过通知来刷新 UI：</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="kt">ToDoListViewController</span><span class="p">:</span> <span class="kt">UITableViewController</span> <span class="p">{</span>
    <span class="c1">// 保存当前待办事项</span>
    <span class="c1">// var items: [ToDoItem] = []</span>
    
    <span class="c1">// 点击添加按钮</span>
    <span class="kd">@objc</span> <span class="kd">func</span> <span class="nf">addButtonPressed</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// let newCount = items.count + 1</span>
        <span class="c1">// let title = "ToDo Item \(newCount)"</span>
        
        <span class="c1">// 更新 `items`</span>
        <span class="c1">// items.append(.init(title: title))</span>
        
        <span class="c1">// 为 table view 添加新行</span>
        <span class="c1">// let indexPath = IndexPath(row: newCount - 1, section: 0)</span>
        <span class="c1">// tableView.insertRows(at: [indexPath], with: .automatic)</span>
        
        <span class="c1">// 确定是否达到列表上限，如果达到，禁用 addButton</span>
        <span class="c1">// if newCount &gt;= 10 {</span>
        <span class="c1">//    addButton?.isEnabled = false</span>
        <span class="c1">// }</span>
        <span class="k">let</span> <span class="nv">store</span> <span class="o">=</span> <span class="kt">ToDoStore</span><span class="o">.</span><span class="n">shared</span>
        <span class="k">let</span> <span class="nv">newCount</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">let</span> <span class="nv">title</span> <span class="o">=</span> <span class="s">"ToDo Item </span><span class="se">\(</span><span class="n">newCount</span><span class="se">)</span><span class="s">"</span>
        
        <span class="n">store</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="o">.</span><span class="nf">init</span><span class="p">(</span><span class="nv">title</span><span class="p">:</span> <span class="n">title</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ToDoListViewController</span> <span class="p">{</span>
    <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">trailingSwipeActionsConfigurationForRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UISwipeActionsConfiguration</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">deleteAction</span> <span class="o">=</span> <span class="kt">UIContextualAction</span><span class="p">(</span><span class="nv">style</span><span class="p">:</span> <span class="o">.</span><span class="n">destructive</span><span class="p">,</span> <span class="nv">title</span><span class="p">:</span> <span class="s">"Delete"</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">done</span> <span class="k">in</span>
            <span class="c1">// 用户确认删除，从 `items` 中移除该事项</span>
            <span class="c1">// self.items.remove(at: indexPath.row)</span>
            <span class="c1">// 从 table view 中移除对应行</span>
            <span class="c1">// self.tableView.deleteRows(at: [indexPath], with: .automatic)</span>
            <span class="c1">// 维护 addButton 状态</span>
            <span class="c1">// if self.items.count &lt; 10 {</span>
            <span class="c1">//     self.addButton?.isEnabled = true</span>
            <span class="c1">// }</span>
            <span class="kt">ToDoStore</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="nf">remove</span><span class="p">(</span><span class="nv">at</span><span class="p">:</span> <span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">)</span>
            <span class="nf">done</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kt">UISwipeActionsConfiguration</span><span class="p">(</span><span class="nv">actions</span><span class="p">:</span> <span class="p">[</span><span class="n">deleteAction</span><span class="p">])</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>现在，不妨再考虑一下上一节中场景一 (编辑条目) 和场景二 (网络同步) 的需求，是不是觉得结构会清晰很多呢？</p>

<ol>
  <li>我们现在有了一个单独的可以测试的 Model 层，通过简单的 Mock，<code class="highlighter-rouge">ToDoListViewController</code> 也可以被方便地测试。</li>
  <li>UI 操作 -&gt; 经由 Controller 进行模型变更 -&gt; 经由 Controller 将当前模型“映射”为 UI 状态，这个数据流动方向是严格可预测的 (并且应当时刻牢记需要保持这个循环)。这大大减少了 Controller 层的负担。</li>
  <li>由于模型层不再被单一 View Controller 持有，其他的 Controller (不单指像是编辑用的 Edit View Controller 这样的视图控制器，也包括比如负责下载的 Controller 等等这类数据控制器) 也可以操作模型层。在此同时，所有的模型结果会被自动且正确地反应到 View 上，这为多 Controller 协同工作和更复杂的场景提供了坚实的基础。</li>
</ol>

<p>这个例子的修改后的最终版本<a href="https://gist.github.com/onevcat/9e08111cebb1967cb96a737ed40f9f14">可以在这里找到</a>。</p>

<h4 id="其他选项">其他选项</h4>

<p>MVC 本身的概念相当简单，同时它也给了开发者很大的自由度。Massive View Controller 往往就是利用了这个自由度，“随意”地将逻辑放在 controller 层所造成的后果。</p>

<p>有一些其他架构选择，最常用的比如 MVVM 和响应式编程 (比如 RxSwift)。MVVM 可以说几乎就是一个 MVC，不过通过 View Model 层来将数据和视图进行绑定。如果你写过 Reactive 架构的话，可能会发现我们在本文中 MVC 的 Controller 层的通知接收和 Rx 的事件流非常相似。不同之处在于，响应式编程“借用”了 MVVM 的思路，提供了一套 API 将事件流与 UI 状态进行绑定 (RxCocoa)。</p>

<p>这些“超越” MVC 的架构方式无一例外地加入了额外的规则和限制，提供了相对 MVC 来说更小的自由度。这可以在一定程度上规范开发者的行为，提供更加统一的代码 (当然代价是额外的学习成本)。完全理解和严格遵守 MVC 的思想，我们其实也可以将 MVC 用得“小而美”。第一步，就从避免文中这类常见“错误”开始吧~</p>

<blockquote>
  <p>能够使用简单的架构来搭建复杂的工程，制作出让其他开发者可以轻松理解的软件，避免高额的后续维护成本，让软件可持续发展并长期活跃，应该是每个开发者在构建软件是必须考虑的事情。</p>
</blockquote>


  </section>
</article>

<section class="read-more">
   
   
   <div class="read-more-item">
       <span class="read-more-item-dim">最近的文章</span>
       <h2 class="post-list post-list__post-title post-title"><a href="/2018/06/wwdc-2018/" title="link to 开发者所需要知道的 WWDC 2018 新特性">开发者所需要知道的 WWDC 2018 新特性</a></h2>
       <p class="excerpt">一直阅读我的博客的朋友可能知道，我在每年 WWDC 之后都会写 (水) 一篇关于新 SDK 和开发工具的文章。之前这个系列叫做《开发者所需要知道的 iOS SDK 新特性》，但是最近虽然 Craig 嘴上说着不要，身体却很诚实地将 iOS 和 macOS 带到一起，所以今年我觉得可以改一改题目，就总览一下作为 Apple 生态圈的开发者，在今年 WWDC 上我个人的一些观察，以及可能应该注意的有趣的地方。在会前，Apple 就已经放出消息要放慢增加新功能的脚步，转而提升软件稳定性和可靠性。...&hellip;</p>
       <div class="post-list__meta"><time datetime="2018-06-05 11:15:00 +0800" class="post-list__meta--date date">2018-06-05</time> &#8226; <span class="post-list__meta--tags tags">能工巧匠集</span><a class="btn-border-small" href=/2018/06/wwdc-2018/>继续阅读</a></div>
   </div>
   
   
   
   
   <div class="read-more-item">
       <span class="read-more-item-dim">更早的文章</span>
       <h2 class="post-list post-list__post-title post-title"><a href="/2018/03/swift-meta/" title="link to 不同角度看问题 - 从 Codable 到 Swift 元编程">不同角度看问题 - 从 Codable 到 Swift 元编程</a></h2>
       <p class="excerpt">  最近开设了一个小专栏，用来记录日常开发时遇到的问题和解决方案，同时也会收藏一些学习时记录的笔记，随想等。其中一些长文 (包括本文) 会首发于专栏，之后再同步到博客这边。虽然现在的文章还不多，但是因为计划更新比较勤快，所以适当进行收费，也算是对自己写作的一种鼓励和鞭笞。欢迎感兴趣的同学进行订阅，谢谢~起源前几天看到同事的一个 P-R，里面有将一个类型转换为字典的方法。在我们所使用的 API 中，某些方法需要接受 JSON 兼容的字典 (也就是说，字典中键值对的 value 只能是数字，字...&hellip;</p>
       <div class="post-list__meta"><time datetime="2018-03-12 08:15:00 +0800" class="post-list__meta--date date">2018-03-12</time> &#8226; <span class="post-list__meta--tags tags">能工巧匠集</span><a class="btn-border-small" href=/2018/03/swift-meta/>继续阅读</a></div>
   </div>
   
</section>



            <section class="footer">
    <footer>
    	<span class="footer__copyright">本站点采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a></span>
        <span class="footer__copyright">由 <a href="https://jekyllrb.com">Jekyll</a> 于 2020-05-14 生成</span>
        <span class="footer__copyright">本站由 <a href="https://onev.cat">@onevcat</a> 创建，采用 <a href="https://github.com/onevcat/vno-jekyll">Vno - Jekyll</a> 作为主题，您可以在 GitHub 找到<a href="https://github.com/onevcat/OneV-s-Den">本站源码</a> - &copy; 2020</span>
    </footer>
</section>

        </div>
    </div>
    
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>



<script type="text/javascript" src="/js/main.js"></script>


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-25719337-1', 'onevcat.com');
    ga('send', 'pageview');
</script>


    
  </body>

</html>
